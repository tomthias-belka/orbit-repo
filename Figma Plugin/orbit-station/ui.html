<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Clara Tokens
  </title>

  <!-- Using system fonts - Inter (Figma default) -->

  <!-- Embedded ZIP Library (no external dependencies) -->
  <script>
    // Embedded ZIP implementation (creates real ZIP files without external dependencies)
    class EmbeddedZip {
      constructor() {
        this.files = [];
      }

      file(name, data) {
        this.files.push({ name, data });
        return this;
      }

      async generateAsync(options = {}) {
        return this.createZipBlob();
      }

      createZipBlob() {
        const encoder = new TextEncoder();
        let offset = 0;
        const centralDirectory = [];
        const fileData = [];

        // xProcess each file
        this.files.forEach(file => {
          const fileName = encoder.encode(file.name);
          const fileContent = encoder.encode(file.data);

          // Local file header
          const localFileHeader = new Uint8Array(30 + fileName.length);
          const view = new DataView(localFileHeader.buffer);

          // Local file header signature (0x04034b50)
          view.setUint32(0, 0x04034b50, true);
          // Version needed to extract (2.0)
          view.setUint16(4, 20, true);
          // General purpose bit flag
          view.setUint16(6, 0, true);
          // Compression method (0 = stored, no compression)
          view.setUint16(8, 0, true);
          // File last modification time
          view.setUint16(10, 0, true);
          // File last modification date
          view.setUint16(12, 0, true);
          // CRC-32
          view.setUint32(14, this.crc32(fileContent), true);
          // Compressed size
          view.setUint32(18, fileContent.length, true);
          // Uncompressed size
          view.setUint32(22, fileContent.length, true);
          // File name length
          view.setUint16(26, fileName.length, true);
          // Extra field length
          view.setUint16(28, 0, true);

          // Copy filename
          localFileHeader.set(fileName, 30);

          // Store for central directory
          centralDirectory.push({
            fileName,
            fileContent,
            localHeaderOffset: offset,
            crc: this.crc32(fileContent)
          });

          // Add to file data
          fileData.push(localFileHeader);
          fileData.push(fileContent);

          offset += localFileHeader.length + fileContent.length;
        });

        // Create central directory
        const centralDirStart = offset;
        const centralDirData = [];

        centralDirectory.forEach(entry => {
          const centralDirEntry = new Uint8Array(46 + entry.fileName.length);
          const view = new DataView(centralDirEntry.buffer);

          // Central directory file header signature (0x02014b50)
          view.setUint32(0, 0x02014b50, true);
          // Version made by
          view.setUint16(4, 20, true);
          // Version needed to extract
          view.setUint16(6, 20, true);
          // General purpose bit flag
          view.setUint16(8, 0, true);
          // Compression method
          view.setUint16(10, 0, true);
          // File last modification time
          view.setUint16(12, 0, true);
          // File last modification date
          view.setUint16(14, 0, true);
          // CRC-32
          view.setUint32(16, entry.crc, true);
          // Compressed size
          view.setUint32(20, entry.fileContent.length, true);
          // Uncompressed size
          view.setUint32(24, entry.fileContent.length, true);
          // File name length
          view.setUint16(28, entry.fileName.length, true);
          // Extra field length
          view.setUint16(30, 0, true);
          // File comment length
          view.setUint16(32, 0, true);
          // Disk number start
          view.setUint16(34, 0, true);
          // Internal file attributes
          view.setUint16(36, 0, true);
          // External file attributes
          view.setUint32(38, 0, true);
          // Relative offset of local header
          view.setUint32(42, entry.localHeaderOffset, true);

          // Copy filename
          centralDirEntry.set(entry.fileName, 46);

          centralDirData.push(centralDirEntry);
          offset += centralDirEntry.length;
        });

        // End of central directory record
        const endOfCentralDir = new Uint8Array(22);
        const endView = new DataView(endOfCentralDir.buffer);

        // End of central dir signature (0x06054b50)
        endView.setUint32(0, 0x06054b50, true);
        // Number of this disk
        endView.setUint16(4, 0, true);
        // Number of the disk with the start of the central directory
        endView.setUint16(6, 0, true);
        // Total number of entries in the central directory on this disk
        endView.setUint16(8, this.files.length, true);
        // Total number of entries in the central directory
        endView.setUint16(10, this.files.length, true);
        // Size of the central directory
        endView.setUint32(12, offset - centralDirStart, true);
        // Offset of start of central directory
        endView.setUint32(16, centralDirStart, true);
        // ZIP file comment length
        endView.setUint16(20, 0, true);

        // Combine all parts
        const totalSize = fileData.reduce((sum, arr) => sum + arr.length, 0) +
          centralDirData.reduce((sum, arr) => sum + arr.length, 0) +
          endOfCentralDir.length;

        const zipData = new Uint8Array(totalSize);
        let pos = 0;

        // Copy file data
        fileData.forEach(data => {
          zipData.set(data, pos);
          pos += data.length;
        });

        // Copy central directory
        centralDirData.forEach(data => {
          zipData.set(data, pos);
          pos += data.length;
        });

        // Copy end of central directory
        zipData.set(endOfCentralDir, pos);

        return new Blob([zipData], { type: 'application/zip' });
      }

      // Simple CRC32 implementation
      crc32(data) {
        const crcTable = this.getCrcTable();
        let crc = 0xFFFFFFFF;

        for (let i = 0; i < data.length; i++) {
          crc = (crc >>> 8) ^ crcTable[(crc ^ data[i]) & 0xFF];
        }

        return (crc ^ 0xFFFFFFFF) >>> 0;
      }

      getCrcTable() {
        if (this._crcTable) return this._crcTable;

        this._crcTable = new Array(256);
        for (let i = 0; i < 256; i++) {
          let c = i;
          for (let j = 0; j < 8; j++) {
            c = (c & 1) ? (0xEDB88320 ^ (c >>> 1)) : (c >>> 1);
          }
          this._crcTable[i] = c;
        }
        return this._crcTable;
      }
    }

    // Make available globally for compatibility
    window.JSZip = EmbeddedZip;
    window.EmbeddedZip = EmbeddedZip;
  </script>

  <style>
    /* ===== MODERN DESIGN SYSTEM ===== */
    :root {


      /* Primary Blue Palette */
      --color-primary: #2473BD;
      --color-primary-dark: #1A5488;
      --color-primary-active: #0D3B66;
      --color-primary-light: #E3F2FD;
      --color-primary-hover: #3B88DB;
      --color-primary-alpha-10: #2473BD1A;
      --color-primary-alpha-20: #2473BD33;



      /* Semantic Colors */
      --color-success: #09a070;
      --color-success-bg: #ECFDF5;
      --color-success-border: #A7F3D0;

      --color-warning: #D97706;
      --color-warning-bg: #FFFBEB;
      --color-warning-border: #FDE68A;

      --color-error: #b03535;
      --color-error-bg: #fcf6f6;
      --color-error-border: #f8cece;

      /* JSON Editor & Search (Light Mode) */
      --json-editor-bg: #f8f9fa;
      --json-action-btn-bg: rgba(0, 0, 0, 0.05);
      --json-action-btn-border: rgba(0, 0, 0, 0.1);
      --json-action-btn-text: var(--color-text-secondary);
      --search-toolbar-bg: var(--color-bg-secondary);
      --search-toolbar-border: var(--color-border);
      --search-field-bg: var(--color-bg-secondary);
      --search-field-border: var(--color-border);
      --search-field-focus-bg: var(--color-bg-secondary);
      --search-field-text: var(--color-text);
      --search-placeholder: var(--color-text-muted);

      /* Syntax Highlighting (Light Mode) */
      --syntax-property: #24292f;
      --syntax-value: #0550ae;
      --syntax-string: #0a3069;
      --syntax-number: #0550ae;
      --syntax-boolean: #cf222e;
      --syntax-punctuation: #24292f;

      /* Tooltips */
      --tooltip-bg: var(--color-gray-900);
      --tooltip-text: white;

      /* Type Pills */
      --type-color: #d73a49;
      --type-color-bg: rgba(215, 58, 73, 0.1);
      --type-number: #6f42c1;
      --type-number-bg: rgba(111, 66, 193, 0.1);
      --type-string: #0366d6;
      --type-string-bg: rgba(3, 102, 214, 0.1);
      --type-boolean: #28a745;
      --type-boolean-bg: rgba(40, 167, 69, 0.1);
      --type-alias: #ff8c00;
      --type-alias-bg: rgba(255, 140, 0, 0.1);

      /* Draft Badge */
      --draft-text: #856404;
      --draft-bg: #fff3cd;
      --draft-border: #ffc107;
      --draft-text-active: #664d03;
      --draft-bg-active: #ffeb9c;
      --draft-border-active: #ffcd39;

      /* Chips */
      --chip-bg: var(--color-gray-100);
      --chip-text: var(--color-text-secondary);
      --chip-bg-hover: var(--color-gray-200);
      --chip-border-active: rgba(0, 102, 255, 0.3);
      --chip-text-active: #0066ff;

      /* Neutral Grays (Modern) */
      --color-gray-50: #F9FAFB;
      --color-gray-100: #F3F4F6;
      --color-gray-200: #E5E7EB;
      --color-gray-300: #D1D5DB;
      --color-gray-400: #9CA3AF;
      --color-gray-500: #6B7280;
      --color-gray-600: #4B5563;
      --color-gray-700: #374151;
      --color-gray-800: #1F2937;
      --color-gray-900: #020B1B;

      /* Semantic Usage */
      --color-bg: var(--color-gray-50);
      --color-bg-secondary: white;
      --color-border: var(--color-gray-200);
      --color-border-light: var(--color-gray-100);
      --color-border-primary: var(--color-primary);
      --color-text: var(--color-gray-900);
      --color-text-secondary: var(--color-gray-600);
      --color-text-muted: var(--color-gray-500);
      --color-text-on-primary: white;

      /* Typography */
      --font-family: Inter, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      --font-size-xs: 12px;
      --font-size-sm: 14px;
      --font-size-base: 16px;
      --font-size-lg: 18px;
      --font-size-xl: 20px;
      --font-size-2xl: 24px;

      --font-weight-normal: 400;
      --font-weight-medium: 500;
      --font-weight-semibold: 600;
      --font-weight-bold: 700;

      /* Spacing (8px grid) */
      --space-1: 4px;
      --space-2: 8px;
      --space-3: 12px;
      --space-4: 16px;
      --space-5: 20px;
      --space-6: 24px;
      --space-8: 32px;
      --space-10: 40px;

      /* Border Radius */
      --radius-sm: 6px;
      --radius-md: 8px;
      --radius-lg: 12px;
      --radius-xl: 16px;
      --radius-full: 9999px;

      /* Shadows (Minimal) */
      --shadow-xs: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);

      /* Focus Ring */
      --focus-ring: 0 0 0 3px var(--color-primary-alpha-20);

      /* Unified Menu System Variables */
      --menu-bg: var(--color-bg);
      --menu-bg-secondary: var(--color-bg-secondary);
      --menu-border: var(--color-border);
      --menu-shadow: var(--shadow-lg);
      --menu-border-radius: var(--radius-md);
      --menu-item-hover-bg: var(--color-gray-100);
      --menu-item-selected-bg: var(--color-primary-light);
      --menu-item-selected-border: var(--color-primary);
      --menu-trigger-bg: var(--color-bg-secondary);
      --menu-trigger-border: var(--color-border-light);

      /* Transitions */
      --transition-fast: 150ms ease;
      --transition-normal: 200ms ease;
      --transition-slow: 300ms ease;
    }

    /* ===== RESET & BASE ===== */
    *,
    *::before,
    *::after {
      box-sizing: border-box;
    }

    * {
      margin: 0;
      padding: 0;
    }

    body {
      font-family: var(--font-family);
      font-size: var(--font-size-sm);
      line-height: 1.6;
      color: var(--color-text);
      background-color: var(--color-bg);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      height: 100vh;
      overflow: hidden;
    }

    /* ===== LAYOUT ===== */

    /* ===== SIMPLE LINEAR PROGRESS BAR ===== */
    .simple-progress-bar {
      position: fixed;
      top: 0;
      /* Posizionata in alto, sopra tutto */
      left: 0;
      right: 0;
      height: 3px;
      background: transparent;
      z-index: 10001;
      /* Sopra tutto per massima visibilit√† */
      opacity: 0;
      visibility: hidden;
      transition: opacity var(--transition-normal) ease, visibility var(--transition-normal) ease;
    }

    .simple-progress-bar.show {
      opacity: 1;
      visibility: visible;
    }

    .simple-progress-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, var(--color-primary), var(--color-primary-hover));
      border-radius: 0;
      transition: width var(--transition-fast) ease;
      box-shadow: 0 0 8px var(--color-primary);
    }

    /* ===== SIDEBAR NAVIGATION ===== */
    .app-container {
      display: flex;
      flex-direction: row;
      height: 100vh;
      background: var(--color-bg-secondary);
      overflow: hidden;
    }

    .sidebar-nav {
      display: flex;
      flex-direction: column;
      width: 56px;
      background: var(--color-bg-secondary);
      border-right: 1px solid var(--color-border);
      padding: var(--space-6) 0;
      gap: var(--space-4);
      flex-shrink: 0;
      z-index: 1;
    }

    .nav-icon-button {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: var(--space-1);
      background: none;
      border: none;
      border-left: 3px solid transparent;
      color: var(--color-text-secondary);
      cursor: pointer;
      transition: all var(--transition-fast);
      position: relative;
    }

    .nav-icon-button svg {
      width: 24px;
      height: 24px;
      fill: currentColor;
      transition: all var(--transition-fast);
    }

    .nav-label {
      display: none;
    }

    .nav-icon-button:hover {
      background: var(--color-gray-300);
      color: var(--color-text);
    }

    .nav-icon-button.active {
      background: var(--color-primary-50);
      color: var(--color-primary);
    }

    .nav-icon-button:focus {
      outline: none;
    }

    .main-view {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      min-height: 0;
      padding-bottom: 60px;
    }

    /* ===== CONTENT ===== */
    .tab-content {
      display: none;
      flex: 1;
      overflow: hidden;
      min-height: 0;
    }

    .tab-content.active {
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    .scrollable-content {
      flex: 1;
      overflow-y: auto;
      padding: var(--space-6);
      background-color: var(--color-bg);
    }

    /* ===== NUOVO LAYOUT A DUE COLONNE ===== */
    .scrollable-content {
      padding: 0;
      overflow: hidden;
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .main-content-container {
      display: flex;
      flex: 1;
      height: 100%;
      padding: var(--space-3);
      gap: 0;
      overflow: hidden;
    }

    .left-panel {
      width: 100%;
      max-width: 400px;
      overflow-y: auto;
      flex-shrink: 0;
    }

    /* Import JSON tab: left panel same width */
    #json-to-variables-tab .left-panel {
      width: 400px;
      min-width: 280px;
    }

    .panel-separator {
      width: 2px;
      background: var(--color-primary, #4F46E5);
      cursor: col-resize;
      position: relative;
      user-select: none;
      flex-shrink: 0;
      opacity: 0.3;
      transition: opacity 0.2s ease;
      margin: 0 24px;
    }

    .panel-separator:hover {
      opacity: 0.8;
    }

    .panel-separator::before {
      content: '';
      position: absolute;
      left: -4px;
      right: -4px;
      top: 0;
      bottom: 0;
      background: transparent;
    }

    .panel-separator::after {
      content: '';
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      width: 12px;
      height: 32px;
      background: var(--color-primary, #4F46E5);
      border-radius: 6px;
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .panel-separator:hover::after {
      opacity: 1;
    }

    .right-panel {
      position: relative;
      flex: 1;
      min-width: 0;
      display: flex;
      flex-direction: column;
      height: 100%;
      overflow: hidden;
    }

    .right-panel textarea {
      flex-grow: 1;
      /* Fa in modo che la textarea riempia tutto lo spazio verticale */
      height: 100%;
      resize: none;
      /* Disabilita il ridimensionamento manuale */
    }

    /* ===== JSON EDITOR STYLES (Import JSON Tab Only) ===== */
    #json-to-variables-tab .json-editor-container {
      display: flex;
      flex-direction: column;
      height: 100%;
      background: var(--json-editor-bg);
      border-radius: 8px;
      overflow: hidden;
      position: relative;
    }

    /* JSON Editor Action Buttons (Top Right) */
    .json-editor-actions {
      position: absolute;
      top: 12px;
      right: 12px;
      display: flex;
      gap: 8px;
      z-index: 50;
    }

    .json-action-btn {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--json-action-btn-bg);
      border: 1px solid var(--json-action-btn-border);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
      padding: 0;
      color: var(--json-action-btn-text);
    }

    .json-action-btn:hover {
      background: rgba(255, 255, 255, 0.12);
      border-color: rgba(255, 255, 255, 0.2);
      color: rgba(255, 255, 255, 0.9);
      transform: translateY(-1px);
    }

    .json-action-btn:active {
      transform: translateY(0);
      background: rgba(255, 255, 255, 0.06);
    }

    .json-action-btn svg {
      width: 16px;
      height: 16px;
    }

    /* Find & Replace Toolbar */
    .json-search-toolbar {
      position: absolute;
      top: 8px;
      right: 8px;
      background: var(--search-toolbar-bg);
      backdrop-filter: blur(10px);
      border: 1px solid var(--search-toolbar-border);
      border-radius: 4px;
      padding: 4px 6px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
      min-width: 380px;
      z-index: 100;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      animation: slideDown 0.2s ease-out;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .search-toolbar-inner {
      position: relative;
    }

    .search-row,
    .replace-row {
      display: flex;
      gap: 4px;
      align-items: center;
      margin-bottom: 4px;
      min-height: 24px;
    }

    .replace-row {
      margin-bottom: 0;
    }

    .search-field {
      flex: 1;
      background: var(--search-field-bg);
      border: 1px solid var(--search-field-border);
      color: var(--search-field-text);
      padding: 3px 8px;
      border-radius: 3px;
      font-size: 13px;
      height: 24px;
      line-height: normal;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      outline: none;
      transition: all 0.15s;
      box-sizing: border-box;
    }

    .search-field::placeholder {
      color: var(--search-placeholder);
      opacity: 1;
    }

    .search-field:focus {
      border-color: var(--color-primary);
      background: var(--search-field-focus-bg);
      color: var(--search-field-text);
    }

    .search-controls,
    .replace-controls {
      display: flex;
      gap: 4px;
      align-items: center;
    }

    .search-counter {
      font-size: 11px;
      color: var(--color-text-muted);
      padding: 0 6px;
      white-space: nowrap;
      min-width: 50px;
      text-align: center;
    }

    .search-nav-btn,
    .search-toggle-btn,
    .search-close-btn {
      background: transparent;
      border: 1px solid var(--search-field-border);
      color: var(--color-text-secondary);
      width: 24px;
      height: 24px;
      border-radius: 3px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 11px;
      transition: all 0.15s;
      padding: 0;
      flex-shrink: 0;
      box-sizing: border-box;
    }

    .search-nav-btn:hover,
    .search-toggle-btn:hover {
      background: var(--chip-bg-hover);
      border-color: var(--color-primary);
    }

    .search-nav-btn:hover svg path,
    .toggle-replace-btn:hover svg path {
      fill: currentColor;
    }

    .search-toggle-btn.active {
      background: var(--color-primary);
      border-color: var(--color-primary);
      color: white;
    }

    .search-close-btn {
      font-size: 18px;
      font-weight: 300;
      line-height: 1;
      border: none;
      width: 24px;
      height: 24px;
    }

    .search-close-btn:hover {
      background: var(--color-error);
      color: white;
    }

    .replace-btn {
      background: var(--color-primary);
      border: none;
      color: white;
      padding: 0 10px;
      border-radius: 3px;
      font-size: 12px;
      height: 24px;
      line-height: 24px;
      cursor: pointer;
      transition: background 0.15s;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      white-space: nowrap;
      box-sizing: border-box;
    }

    .replace-btn:hover {
      background: var(--color-primary-hover);
    }

    .replace-btn:active {
      background: var(--color-primary-active);
    }

    .toggle-replace-btn {
      position: absolute;
      left: -26px;
      top: 5px;
      background: #3c3c3c;
      border: 1px solid #5a5a5a;
      border-radius: 3px;
      width: 20px;
      height: 20px;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.15s;
      box-sizing: border-box;
    }

    .toggle-replace-btn:hover {
      background: #464646;
      border-color: #007acc;
    }

    .toggle-replace-btn .replace-chevron {
      transition: transform 0.2s;
    }

    .toggle-replace-btn.collapsed .replace-chevron {
      transform: rotate(-90deg);
    }

    /* JSON Editor Main Area */
    .json-editor-main {
      display: flex;
      flex: 1;
      overflow: hidden;
      background: var(--json-editor-bg);
      position: relative;
    }

    .line-numbers {
      min-width: 50px;
      background: var(--json-editor-bg);
      color: var(--color-primary);
      text-align: right;
      padding: 12px 10px 12px 4px;
      font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.6;
      user-select: none;
      border-right: 1px solid var(--search-toolbar-border);
      overflow: hidden;
      white-space: pre;
      z-index: 1;
    }

    /* Syntax Highlighting Overlay */
    .json-syntax-highlight {
      position: absolute;
      top: 0;
      left: 50px;
      /* After line numbers */
      right: 0;
      bottom: 0;
      padding: 12px;
      font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.6;
      white-space: pre;
      overflow: hidden;
      pointer-events: none;
      /* Don't block textarea interaction */
      z-index: 0;
      color: var(--syntax-punctuation);
      /* Default text color */
    }

    /* Syntax Colors (Theme-aware) */
    .json-syntax-highlight .json-key {
      color: var(--syntax-value);
      /* Keys color */
    }

    .json-syntax-highlight .json-string {
      color: var(--syntax-string);
      /* Strings color */
    }

    .json-syntax-highlight .json-number {
      color: var(--syntax-number);
      /* Numbers color */
    }

    .json-syntax-highlight .json-boolean,
    .json-syntax-highlight .json-null {
      color: var(--syntax-boolean);
      /* Boolean/null color */
    }

    .json-syntax-highlight .json-punctuation {
      color: var(--syntax-punctuation);
      /* Punctuation {}[],: */
    }

    /* Search match highlighting */
    .json-syntax-highlight .json-search-match {
      background-color: rgba(255, 200, 0, 0.3);
      /* Yellow highlight for all matches */
      border-radius: 2px;
    }

    .json-syntax-highlight .json-search-match-current {
      background-color: rgba(255, 165, 0, 0.5);
      /* Orange highlight for current match */
      border: 1px solid rgba(255, 165, 0, 0.8);
      border-radius: 2px;
      margin: -1px;
      padding: 0 1px;
    }

    .json-editor-textarea {
      flex: 1;
      background: transparent;
      /* See-through to show highlight */
      color: transparent;
      /* Text invisible */
      -webkit-text-fill-color: transparent;
      /* Force transparent text */
      caret-color: white;
      /* Cursor always visible */
      border: none;
      padding: 12px;
      font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.6;
      resize: none;
      outline: none;
      tab-size: 2;
      overflow-y: auto;
      overflow-x: auto;
      white-space: pre;
      position: relative;
      z-index: 1;
    }

    .json-editor-textarea::placeholder {
      color: var(--search-placeholder);
      -webkit-text-fill-color: var(--search-placeholder);
      opacity: 1;
    }

    .json-editor-textarea::-webkit-input-placeholder {
      color: var(--search-placeholder);
      -webkit-text-fill-color: var(--search-placeholder);
    }

    .json-editor-textarea::-moz-placeholder {
      color: var(--search-placeholder);
      opacity: 1;
    }

    .json-editor-textarea::-webkit-scrollbar {
      width: 12px;
      height: 12px;
    }

    .json-editor-textarea::-webkit-scrollbar-track {
      background: var(--json-editor-bg);
    }

    .json-editor-textarea::-webkit-scrollbar-thumb {
      background: var(--chip-bg-hover);
      border-radius: 6px;
      border: 3px solid var(--json-editor-bg);
    }

    .json-editor-textarea::-webkit-scrollbar-thumb:hover {
      background: #4e4e4e;
    }

    /* Status Bar */
    .json-editor-status {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 12px;
      background: var(--color-primary-light);
      color: var(--color-text);
      font-size: 12px;
    }

    .status-left,
    .status-right {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .syntax-status {
      font-weight: 500;
    }

    .syntax-status.valid {
      color: var(--color-text);
    }

    .syntax-status.error {
      color: #f48771;
      font-weight: 600;
    }

    .cursor-pos {
      color: var(--color-text);
      font-size: 11px;
    }

    /* ===== DROP ZONE ===== */
    .drop-zone-container {
      position: relative;
      flex: 1;
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .drop-zone-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--color-bg);
      border: 2px dashed var(--color-border);
      border-radius: var(--radius-lg);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: var(--space-3);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease, background 0.2s ease, border-color 0.2s ease;
      z-index: 10;
    }

    .drop-zone-overlay svg {
      color: var(--color-text-secondary);
      opacity: 0.5;
      transition: all 0.2s ease;
    }

    .drop-zone-text {
      font-size: 18px;
      font-weight: 600;
      color: var(--color-text);
      transition: color 0.2s ease;
    }

    .drop-zone-hint {
      font-size: 14px;
      color: var(--color-text-secondary);
      opacity: 0.8;
    }

    .drop-zone-container.drag-over .drop-zone-overlay {
      opacity: 1;
      pointer-events: all;
      background: rgba(79, 70, 229, 0.05);
      border-color: var(--color-primary);
    }

    .drop-zone-container.drag-over .drop-zone-overlay svg {
      color: var(--color-primary);
      opacity: 1;
      transform: scale(1.1);
    }

    .drop-zone-container.drag-over .drop-zone-text {
      color: var(--color-primary);
    }

    /* ===== SECTIONS ===== */
    .section {
      background: var(--color-bg-secondary);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-lg);
      padding: var(--space-6);
      margin-top: var(--space-6);
      margin-bottom: var(--space-6);
      box-shadow: var(--shadow-xs);
    }

    .section:last-child {
      margin-bottom: 0;
    }

    .section-title {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      font-size: var(--font-size-lg);
      font-weight: var(--font-weight-semibold);
      color: var(--color-text);
      margin-bottom: var(--space-5);
    }

    .section-title .icon {
      width: 20px;
      height: 20px;
      color: var(--color-primary);
    }

    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: var(--space-5);
    }

    .section-header h3 {
      font-size: var(--font-size-base);
      font-weight: var(--font-weight-semibold);
      color: var(--color-text);
    }

    /* ===== FORMS ===== */
    .form-group {
      margin-bottom: var(--space-5);
    }

    .form-label {
      display: block;
      font-size: var(--font-size-sm);
      font-weight: var(--font-weight-medium);
      color: var(--color-text);
      margin-bottom: var(--space-2);
    }

    .form-help {
      font-size: var(--font-size-xs);
      color: var(--color-text-muted);
      margin-top: var(--space-2);
      line-height: 1.5;
    }

    /* ===== INPUTS ===== */
    input[type="text"],
    input[type="number"],
    input[type="password"],
    textarea,
    select {
      width: 100%;
      padding: var(--space-3) var(--space-4);
      font-size: var(--font-size-sm);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      background-color: var(--color-bg-secondary);
      color: var(--color-text);
      transition: all var(--transition-fast);
    }

    input[type="text"]:focus,
    input[type="number"]:focus,
    input[type="password"]:focus,
    textarea:focus,
    select:focus {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: var(--focus-ring);
    }

    textarea {
      min-height: 120px;
      resize: vertical;
      font-family: ui-monospace, SFMono-Regular, "SF Mono", Monaco, Consolas, monospace;
      font-size: var(--font-size-xs);
      line-height: 1.5;
    }

    /* ===== TOKEN TREE VIEW STYLES ===== */
    .token-tree-container {
      max-height: 400px;
      overflow-y: auto;
      overflow-x: hidden;
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      background-color: var(--color-bg);
      padding: var(--space-4);
    }

    .token-tree-root {
      font-size: 13px;
    }

    /* Collection Group */
    .token-collection {
      margin-bottom: var(--space-3);
    }

    .token-collection-header {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-2) var(--space-6);
      background-color: var(--color-bg-secondary);
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-weight: var(--font-weight-semibold);
      transition: background-color var(--transition-fast);
      user-select: none;
      height: 56px;
      border-color: var(--color-border);
      border-width: 1px;
    }

    .token-collection-header:hover {
      background-color: var(--color-gray-100);
      border-color: var(--color-border);
    }

    .token-collection-header.collapsed {
      margin-bottom: 0;
    }

    /* Token Group (nested groups like colors.primary) */
    .token-group {
      margin-left: var(--space-4);
      margin-top: var(--space-2);
    }

    .token-group-header {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-2) var(--space-3);
      cursor: pointer;
      font-weight: var(--font-weight-medium);
      color: var(--color-text-secondary);
      transition: all var(--transition-fast);
      border-radius: var(--radius-sm);
      user-select: none;
    }

    .token-group-header:hover {
      background-color: var(--color-bg-secondary);
      color: var(--color-text);
    }

    /* Chevron Icon */
    .token-chevron {
      width: 12px;
      height: 12px;
      transition: transform var(--transition-fast);
      flex-shrink: 0;
    }

    .token-chevron.collapsed {
      transform: rotate(-90deg);
    }

    /* Mode Chip */
    .mode-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 12px;
      margin-left: auto;
      background: var(--color-primary-alpha-10);
      border: 1px solid var(--color-primary-alpha-20);
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
      color: var(--color-primary);
      cursor: pointer;
      transition: all 0.15s;
      position: relative;
    }

    .mode-chip:hover {
      background: var(--color-primary-alpha-20);
      border-color: var(--color-primary);
    }

    .mode-chip-label {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .mode-chip-label svg {
      width: 16px;
      height: 16px;
      flex-shrink: 0;
    }

    .mode-chip-arrow {
      width: 10px;
      height: 10px;
      opacity: 0.7;
      transition: transform 0.15s;
    }

    .mode-chip.active .mode-chip-arrow {
      transform: rotate(180deg);
    }

    .mode-chip-dropdown {
      position: fixed;
      background: var(--color-bg-secondary);
      border: 1px solid var(--color-gray-200);
      border-radius: var(--radius-md);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      padding: 4px;
      min-width: 140px;
      z-index: 10000;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-4px);
      transition: all 0.15s;
      pointer-events: none;
    }

    .mode-chip.active .mode-chip-dropdown {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
      pointer-events: auto;
    }

    .mode-option {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 6px 10px;
      background: none;
      border: none;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-size: 12px;
      color: var(--color-text);
      transition: background-color 0.12s;
      text-align: left;
    }

    .mode-option:hover {
      background-color: var(--color-gray-100);
    }

    .mode-option.selected {
      background-color: var(--color-primary-alpha-10);
      color: var(--color-primary);
      font-weight: 500;
    }

    .mode-option-check {
      width: 12px;
      height: 12px;
      opacity: 0;
      color: var(--color-primary);
    }

    .mode-option.selected .mode-option-check {
      opacity: 1;
    }

    /* Token List */
    .token-list {
      margin-left: var(--space-1);
      margin-top: var(--space-1);
    }

    .token-list.hidden {
      display: none;
    }

    /* Individual Token Item */
    .token-item {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      padding: var(--space-2) var(--space-3);
      cursor: pointer;
      transition: all var(--transition-fast);
      border-radius: var(--radius-sm);
      position: relative;
    }

    .token-item:hover {
      background-color: var(--color-bg-secondary);
    }

    .token-item.editing {
      background-color: var(--color-primary-alpha-10);
    }

    /* Token Swatch (Color Preview) */
    .token-swatch {
      width: 20px;
      height: 20px;
      border-radius: 4px;
      border: 1px solid var(--color-border);
      flex-shrink: 0;
      background: linear-gradient(45deg, #ccc 25%, transparent 25%, transparent 75%, #ccc 75%, #ccc),
        linear-gradient(45deg, #ccc 25%, transparent 25%, transparent 75%, #ccc 75%, #ccc);
      background-size: 8px 8px;
      background-position: 0 0, 4px 4px;
      position: relative;
    }

    .token-swatch-color {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border-radius: 3px;
    }

    /* Token Icon (for non-color tokens) */
    .token-icon {
      width: 20px;
      height: 20px;
      flex-shrink: 0;
      opacity: 0.6;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .token-icon svg {
      width: 100%;
      height: 100%;
      display: block;
    }

    /* Token Edit Button */
    .token-edit-btn {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      width: 18px;
      height: 18px;
      opacity: 0;
      cursor: pointer;
      color: var(--color-text-muted);
      transition: opacity 0.15s, color 0.15s;
      flex-shrink: 0;
      pointer-events: none;
    }

    .token-item:hover .token-edit-btn {
      opacity: 1;
      pointer-events: auto;
    }

    .token-edit-btn:hover {
      color: var(--color-primary);
    }

    /* Token Name */
    .token-name {
      flex: 1;
      font-size: 13px;
      color: var(--color-text);
      min-width: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    /* Token Value */
    .token-value {
      font-size: 12px;
      color: var(--color-text-secondary);
      font-family: 'Monaco', 'Courier New', monospace;
      white-space: nowrap;
      padding-right: 30px;
      /* Space for edit icon */
    }

    .token-value.editable-input {
      background-color: var(--color-bg);
      border: 1px solid var(--color-primary);
      border-radius: var(--radius-sm);
      padding: 2px 6px;
      outline: none;
      min-width: 80px;
    }

    /* Token Tooltip - Figma Style */
    .token-tooltip {
      position: fixed;
      background-color: var(--tooltip-bg);
      color: var(--tooltip-text);
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 12px;
      z-index: 10000;
      pointer-events: none;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4);
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.2s ease, visibility 0.2s ease;
    }

    .token-tooltip.visible {
      opacity: 1;
      visibility: visible;
    }

    .token-tooltip-name {
      font-weight: 600;
      font-size: 13px;
      margin-bottom: 4px;
      color: var(--tooltip-text);
    }

    .token-tooltip-info {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 4px;
      font-size: 11px;
    }

    .token-tooltip-path {
      color: rgba(255, 255, 255, 0.5);
      font-family: 'Monaco', 'Courier New', monospace;
    }

    .token-tooltip-value {
      font-family: 'Monaco', 'Courier New', monospace;
      font-weight: 500;
      padding: 2px 6px;
      border-radius: 3px;
      color: var(--color-text);
      background-color: var(--color-bg-secondary);
    }

    .token-tooltip-value.color-value {
      color: var(--tooltip-text);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    /* Alias Autocomplete Dropdown */
    .alias-autocomplete {
      position: absolute;
      background: white;
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
      max-height: 200px;
      overflow-y: auto;
      z-index: 10002;
      min-width: 250px;
      display: none;
    }

    .alias-autocomplete.visible {
      display: block;
    }

    .alias-option {
      padding: 8px 12px;
      cursor: pointer;
      font-family: 'Monaco', 'Courier New', monospace;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: background-color 0.1s ease;
    }

    .alias-option:hover,
    .alias-option.selected {
      background-color: var(--color-primary-alpha-10);
    }

    .alias-option-path {
      color: var(--color-text);
      font-weight: 500;
      flex: 1;
    }

    .alias-option-value {
      color: var(--color-text-secondary);
      font-size: 11px;
      max-width: 100px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .alias-option-type {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 3px;
      background-color: var(--color-bg-secondary);
      color: var(--color-text-secondary);
      text-transform: uppercase;
      font-weight: 600;
    }

    /* Empty State */
    .token-tree-empty {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 200px;
    }

    /* ===== BUTTONS ===== */
    button {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-2);
      padding: var(--space-3) var(--space-4);
      font-size: var(--font-size-sm);
      font-weight: var(--font-weight-medium);
      border: 1px solid transparent;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all var(--transition-fast);
      text-decoration: none;
      white-space: nowrap;
      height: 48px;
    }

    .primary {
      background-color: var(--color-primary);
      color: var(--color-text-on-primary);
      border-color: var(--color-primary);
    }

    .primary:hover {
      background-color: var(--color-primary-hover);
      border-color: var(--color-primary-hover);
    }

    .primary:focus {
      outline: none;
      box-shadow: var(--focus-ring);
    }

    .secondary {
      background-color: var(--color-bg-secondary);
      color: var(--color-text);
      border-color: var(--color-border);
    }

    .secondary:hover {
      background-color: var(--color-gray-50);
      border-color: var(--color-gray-300);
    }

    .secondary:focus {
      outline: none;
      box-shadow: var(--focus-ring);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* ===== FOOTER BUTTON CONSISTENCY ===== */
    .footer .button-group button {
      min-height: 48px;
      height: 48px;
      align-items: center;
      line-height: 1;
      transition: all 0.2s ease;
      position: relative;
    }

    /* ===== RESPONSIVE ICON BUTTONS ===== */
    .footer-btn {
      transition: all 0.2s ease;
    }

    /* Disabled state for footer buttons */
    .footer-btn:disabled,
    .footer-btn.disabled {
      opacity: 0.4;
      cursor: not-allowed;
      pointer-events: none;
    }

    .footer-btn .btn-text {
      transition: opacity 0.2s ease, width 0.2s ease, margin 0.2s ease;
      white-space: nowrap;
      overflow: hidden;
    }

    .footer-btn.icon-only {
      width: 48px !important;
      height: 48px !important;
      min-width: 48px !important;
      max-width: 48px !important;
      padding: 12px !important;
      justify-content: center;
      align-items: center;
      gap: 0 !important;
    }

    .footer-btn.icon-only .btn-text {
      display: none !important;
    }

    .footer-btn.icon-only svg {
      margin: 0 !important;
    }

    .footer-btn.icon-only svg[style*="margin-right"] {
      margin-right: 0 !important;
    }

    /* Tooltip styles */
    .tooltip {
      position: absolute;
      bottom: calc(100% + 8px);
      left: 50%;
      transform: translateX(-50%);
      background: var(--color-gray-800);
      color: white;
      padding: 6px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 500;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease, transform 0.2s ease;
      z-index: 9999;
      display: none;
      /* Hidden by default */
    }

    .tooltip::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 4px solid transparent;
      border-top-color: var(--color-gray-800);
    }

    /* Show tooltip only on icon-only buttons */
    .footer-btn.icon-only .tooltip {
      display: block;
    }

    .footer-btn.icon-only:hover .tooltip {
      opacity: 1;
      transform: translateX(-50%) translateY(-2px);
    }

    /* Media query tooltip visibility */
    @media (max-width: 600px) {
      .footer .button-group .footer-btn.secondary .tooltip {
        display: block;
      }

      .footer .button-group .footer-btn.secondary:hover .tooltip {
        opacity: 1;
        transform: translateX(-50%) translateY(-2px);
      }
    }

    /* Dev mode tooltip visibility */
    body.figma-dev-mode .footer .button-group .footer-btn.secondary .tooltip {
      display: block;
    }

    body.figma-dev-mode .footer .button-group .footer-btn.secondary:hover .tooltip {
      opacity: 1;
      transform: translateX(-50%) translateY(-2px);
    }

    /* Media queries for responsive behavior */
    @media (max-width: 600px) {
      .footer .button-group .footer-btn.secondary {
        width: 48px !important;
        height: 48px !important;
        min-width: 48px !important;
        max-width: 48px !important;
        padding: 12px !important;
        justify-content: center;
        align-items: center;
        gap: 0 !important;
      }

      .footer .button-group .footer-btn.secondary .btn-text {
        display: none !important;
      }

      .footer .button-group .footer-btn.secondary svg {
        margin: 0 !important;
      }
    }

    /* Dev mode detection (based on body class) */
    body.figma-dev-mode .footer .button-group .footer-btn.secondary {
      width: 48px !important;
      height: 48px !important;
      min-width: 48px !important;
      max-width: 48px !important;
      padding: 12px !important;
      justify-content: center;
      align-items: center;
      gap: 0 !important;
    }

    body.figma-dev-mode .footer .button-group .footer-btn.secondary .btn-text {
      display: none !important;
    }

    body.figma-dev-mode .footer .button-group .footer-btn.secondary svg {
      margin: 0 !important;
    }

    .select-all {
      font-size: var(--font-size-xs);
      padding: var(--space-2) var(--space-3);
      color: var(--color-primary);
      background: white;
      border: 1px solid var(--color-primary-alpha-20);
    }

    .select-all:hover {
      background-color: var(--color-primary-alpha-10);
    }

    /* Compact Select All Button */
    .select-all-compact {
      display: inline-flex;
      align-items: center;
      gap: var(--space-2);
      font-size: var(--font-size-xs);
      font-weight: var(--font-weight-medium);
      padding: var(--space-2) var(--space-3);
      height: 32px;
      min-height: 32px;
      color: var(--color-text);
      background-color: var(--color-bg-secondary);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all var(--transition-fast);
      white-space: nowrap;
    }

    .select-all-compact:hover {
      background-color: var(--color-gray-50);
      border-color: var(--color-gray-300);
    }

    .select-all-compact:focus {
      outline: none;
      box-shadow: var(--focus-ring);
    }

    .select-all-compact:active {
      transform: translateY(0.5px);
    }

    .select-all-compact svg {
      width: 16px;
      height: 16px;
      flex-shrink: 0;
    }

    /* ===== DROPDOWN ===== */
    .dropdown {
      position: relative;
      display: inline-block;
    }

    .dropdown-trigger {
      display: flex;
      gap: var(--space-2);
      position: relative;
    }

    .dropdown-trigger .dropdown-arrow {
      transition: transform 0.2s ease;
      margin-left: var(--space-1);
    }

    .dropdown.active .dropdown-arrow {
      transform: rotate(180deg);
    }

    .dropdown-content {
      position: absolute;
      top: calc(100% + 4px);
      left: 0;
      right: 0;
      background-color: var(--color-bg-secondary);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      padding: var(--space-2);
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-8px);
      transition: opacity var(--transition-normal), transform var(--transition-normal), visibility var(--transition-normal);
      overflow: hidden;
      align-items: start;
      min-width: 280px;
      justify-content: start;
    }

    .dropdown.active .dropdown-content {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .dropdown-item {
      width: 100%;
      display: flex;
      align-items: start;
      gap: var(--space-3);
      padding: var(--space-3);
      background: none;
      border: none;
      text-align: left;
      color: var(--color-text);
      cursor: pointer;
      transition: background-color 0.15s ease;
    }

    .dropdown-item:hover {
      background-color: var(--menu-item-hover-bg);
      text-emphasis-color: var(--color-primary);
    }

    .dropdown-item:focus {
      outline: none;
      background-color: var(--menu-item-hover-bg);
    }

    .dropdown-item svg {
      flex-shrink: 0;
      color: var(--color-text-primary);
    }

    .dropdown-item:hover svg {
      color: var(--color-primary);
    }

    .dropdown-item-title {
      font-weight: 500;
      color: var(--color-text);
      margin-bottom: 2px;
    }

    .dropdown-item-desc {
      font-size: var(--font-size-xs);
      color: var(--color-text-secondary);
      line-height: 1.3;
    }

    /* ===== ACTIONS DROPDOWN ===== */
    .actions-dropdown {
      position: absolute;
      top: 16px;
      right: 16px;
      z-index: 100;
    }

    .actions-dropdown .dropdown-trigger {
      background: var(--color-bg-secondary);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      padding: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      min-width: 40px;
      min-height: 40px;
    }

    .actions-dropdown .dropdown-trigger:hover {
      background: var(--color-bg-primary);
      border-color: var(--color-primary);
    }

    .actions-dropdown .dropdown-trigger svg {
      color: var(--color-text);
      transition: color 0.2s ease;
    }

    .actions-dropdown .dropdown-trigger:hover svg {
      color: var(--color-primary);
    }

    .actions-dropdown .dropdown-content {
      position: absolute;
      top: 48px;
      right: -16px;
      background: var(--color-bg-secondary);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-lg);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      min-width: 200px;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-8px);
      transition: all 0.2s ease;
      z-index: 1000;
    }

    .actions-dropdown.active .dropdown-content {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .actions-dropdown .dropdown-item {
      width: 100%;
      display: flex;
      align-items: start;
      gap: var(--space-3);
      padding: var(--space-3);
      border: none;
      background: transparent;
      text-align: left;
      cursor: pointer;
      transition: background-color 0.15s ease;
    }

    .actions-dropdown .dropdown-item:hover {
      background-color: var(--menu-item-hover-bg);
    }

    .actions-dropdown .dropdown-item:focus {
      outline: none;
      background-color: var(--menu-item-hover-bg);
    }

    .actions-dropdown .dropdown-item svg {
      flex-shrink: 0;
      color: var(--color-text-primary);
    }

    .actions-dropdown .dropdown-item:hover svg {
      color: var(--color-primary);
    }

    .actions-dropdown .dropdown-item-title {
      font-weight: 500;
      color: var(--color-text);
      margin-bottom: 2px;
    }

    .actions-dropdown .dropdown-item-desc {
      font-size: var(--font-size-xs);
      color: var(--color-text-secondary);
      line-height: 1.3;
    }

    /* ===== GET CODE DROPDOWN (NEW) ===== */
    .get-code-container {
      position: absolute;
      top: var(--space-3);
      right: var(--space-3);
      z-index: 10;
      display: none;
      /* Hidden by default - shown after generation */
    }

    /* Rimosso: .get-code-trigger ora usa .button.secondary.size-M */

    .button .get-code-chevron {
      transition: transform var(--transition-normal);
      color: var(--color-text-muted);
    }

    .get-code-container.active .button .get-code-chevron {
      transform: rotate(180deg);
    }

    .get-code-menu {
      position: absolute;
      top: calc(100% + 4px);
      /* Below the button */
      right: 0;
      width: 280px;
      background-color: var(--color-bg-secondary);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      padding: var(--space-2);
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-8px);
      transition: opacity var(--transition-normal), transform var(--transition-normal), visibility var(--transition-normal);
    }

    .get-code-container.active .get-code-menu {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .get-code-item {
      width: 100%;
      display: flex;
      align-items: flex-start;
      gap: var(--space-3);
      padding: var(--space-3);
      background: none;
      border: none;
      text-align: left;
      border-radius: var(--radius-md);
      cursor: pointer;
      height: auto;
      /* Override fixed height */
    }

    .get-code-item:hover {
      background-color: var(--color-gray-100);
    }

    .get-code-item svg {
      margin-top: 2px;
      flex-shrink: 0;
      width: 16px;
      height: 16px;
      color: var(--color-text-secondary);
    }

    .get-code-item-text {
      display: flex;
      flex-direction: column;
    }

    .get-code-item-title {
      font-weight: var(--font-weight-medium);
      color: var(--color-text);
      line-height: 1.3;
    }

    .get-code-item-desc {
      font-size: var(--font-size-xs);
      color: var(--color-text-muted);
      line-height: 1.4;
    }

    /* ===== CUSTOM COMPONENTS ===== */
    /* Custom Select Dropdown */
    .custom-select {
      position: relative;
      width: 100%;
    }

    .custom-select-trigger {
      width: 100%;
      display: flex;
      align-items: start;
      justify-content: space-between;
      padding: var(--space-3) var(--space-4);
      font-size: var(--font-size-sm);
      border: 1px solid var(--menu-trigger-border);
      border-radius: var(--menu-border-radius);
      background-color: var(--menu-trigger-bg);
      color: var(--color-text);
      cursor: pointer;
      transition: all var(--transition-fast);
    }

    .custom-select-trigger:hover {
      border-color: var(--color-primary-hover);
    }

    .custom-select-trigger:focus,
    .custom-select.active .custom-select-trigger {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: var(--focus-ring);
    }

    .custom-select-arrow {
      transition: transform 0.2s ease;
      color: var(--color-text-muted);
    }

    .custom-select.active .custom-select-arrow {
      transform: rotate(180deg);
      transform-style: var(--color-bg-primary);
    }

    .custom-select-dropdown {
      position: absolute;
      top: calc(100% + 4px);
      left: 0;
      right: 0;
      background-color: var(--color-bg-secondary);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      padding: var(--space-2);
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-8px);
      transition: opacity var(--transition-normal), transform var(--transition-normal), visibility var(--transition-normal);
      overflow: hidden;
      max-height: 200px;
      overflow-y: auto;
    }

    .custom-select.active .custom-select-dropdown {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .custom-select-option {
      width: 100%;
      display: flex;
      align-items: center;
      padding: var(--space-3);
      background: none;
      border: none;
      text-align: left;
      color: var(--color-text);
      cursor: pointer;
      transition: background-color 0.15s ease;
      font-size: var(--font-size-sm);
      justify-content: start;
      border-radius: var(--radius-md);
    }

    .custom-select-option:hover {
      background-color: var(--color-gray-100);
    }

    .custom-select-option:focus {
      outline: none;
      background-color: var(--color-gray-100);
    }

    .custom-select-option.selected {
      background-color: var(--menu-item-selected-bg);
      color: var(--color-text);
    }

    /* Custom Input Field */
    .custom-input-wrapper {
      position: relative;
      width: 100%;
    }

    .custom-input {
      width: 100%;
      padding: var(--space-3) var(--space-4);
      font-size: var(--font-size-sm);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      background-color: var(--color-bg-secondary);
      color: var(--color-text);
      transition: all var(--transition-fast);
    }

    .custom-input:focus {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: var(--focus-ring);
    }

    .custom-input::placeholder {
      color: var(--color-text-muted);
    }

    .custom-input-number {
      padding-right: calc(var(--space-4) + 24px);
    }

    .custom-input-number-controls {
      position: absolute;
      right: var(--space-1);
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      flex-direction: column;
      gap: 1px;
    }

    .custom-input-number-btn {
      width: 20px;
      height: 12px;
      border: none;
      background: var(--color-bg-tertiary);
      color: var(--color-text-muted);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      transition: all 0.15s ease;
    }

    .custom-input-number-btn:first-child {
      border-radius: var(--radius-sm) var(--radius-sm) 0 0;
    }

    .custom-input-number-btn:last-child {
      border-radius: 0 0 var(--radius-sm) var(--radius-sm);
    }

    .custom-input-number-btn:hover {
      background: var(--color-primary);
      color: white;
    }

    /* ===== CHECKBOXES ===== */
    input[type="checkbox"] {
      width: 16px;
      height: 16px;
      border: 1px solid var(--color-border);
      border-radius: var(--radius-sm);
      background-color: var(--color-bg-secondary);
      cursor: pointer;
      appearance: none;
      position: relative;
      transition: all var(--transition-fast);
    }

    input[type="checkbox"]:checked {
      background-color: var(--color-primary);
      border-color: var(--color-primary);
    }

    input[type="checkbox"]:checked::after {
      content: '';
      position: absolute;
      top: 1px;
      left: 5px;
      width: 4px;
      height: 8px;
      border: solid white;
      border-width: 0 2px 2px 0;
      transform: rotate(45deg);
    }

    input[type="checkbox"]:focus {
      outline: none;
      box-shadow: var(--focus-ring);
    }

    /* ===== RADIO BUTTONS ===== */
    .radio-group {
      display: flex;
      flex-direction: column;
      gap: var(--space-3);
    }

    .radio-item {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      padding: var(--space-3) var(--space-4);
      background-color: var(--color-bg-secondary);
      border: 1px solid var(--color-border-light);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all var(--transition-fast);
    }

    .radio-item:hover {
      border-color: var(--color-border);
      box-shadow: var(--shadow-xs);
      background-color: var(--color-gray-50);
    }

    .radio-item input[type="radio"] {
      display: none;
    }

    .radio-indicator {
      width: 18px;
      height: 18px;
      border: 2px solid var(--color-border);
      border-radius: 50%;
      background-color: var(--color-bg-primary);
      position: relative;
      transition: all var(--transition-fast);
      flex-shrink: 0;
    }

    .radio-item input[type="radio"]:checked+.radio-indicator {
      border-color: var(--color-primary);
      background-color: var(--color-primary);
    }

    .radio-item input[type="radio"]:checked+.radio-indicator::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 6px;
      height: 6px;
      background-color: white;
      border-radius: 50%;
      transform: translate(-50%, -50%);
    }

    .radio-item:focus-within .radio-indicator {
      box-shadow: var(--focus-ring);
    }

    .radio-item span:last-child {
      flex: 1;
      font-size: var(--font-size-sm);
      color: var(--color-text);
      line-height: 1.4;
    }

    /* ===== LISTS ===== */
    .collection-list,
    .mode-list {
      display: flex;
      flex-direction: column;
      gap: var(--space-2);
    }

    .collection-item,
    .mode-item {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      padding: var(--space-3) var(--space-4);
      background-color: var(--color-bg-secondary);
      border: 1px solid var(--color-border-light);
      border-radius: var(--radius-md);
      transition: all var(--transition-fast);
      margin-bottom: var(--space-3);
    }

    .collection-item.existing {
      justify-content: space-between;
    }

    .collection-info {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: var(--space-1);
    }

    .collection-actions {
      display: flex;
      gap: var(--space-2);
      align-items: center;
    }

    .btn-icon {
      padding: var(--space-2);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-sm);
      background-color: var(--color-bg);
      color: var(--color-text-secondary);
      cursor: pointer;
      transition: all var(--transition-fast);
      display: flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
    }

    .btn-icon:hover {
      background-color: var(--color-bg-secondary);
      border-color: var(--color-border-primary);
      color: var(--color-primary);
    }

    .btn-icon.danger:hover {
      background-color: var(--color-error-bg);
      border-color: var(--color-error-border);
      color: var(--color-error);

    }

    .clear-all-btn {
      margin-top: var(--space-4);
      width: 100%;
      padding: var(--space-3);
      background-color: white;
      color: var(--color-error);
      border: 1px solid var(--color-error-border);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all var(--transition-fast);
      font-size: var(--font-size-sm);
      font-weight: var(--font-weight-medium);
      height: 40px;
    }

    .clear-all-btn:hover {
      border: 2px solid var(--color-error-border);
      color: var(--color-error);
      background-color: #fceff1
    }

    /* Modal dialogs */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal-content {
      background-color: var(--color-bg);
      border-radius: 8px;
      padding: 24px;
      width: 60%;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    }

    .modal-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--color-text);
      margin-bottom: 12px;
    }

    .modal-message {
      color: var(--color-text-secondary);
      margin-bottom: 20px;
      line-height: 1.5;
      white-space: pre-line;
    }

    .modal-input {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--color-border);
      border-radius: 6px;
      background-color: var(--color-bg);
      color: var(--color-text);
      font-size: 14px;
      margin-bottom: 20px;
    }

    .modal-input:focus {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .modal-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    .modal-button {
      padding: 10px 20px;
      border-radius: 6px;
      border: 1px solid var(--color-border);
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
    }

    .modal-button.primary {
      background-color: var(--color-primary);
      color: white;
      border-color: var(--color-primary);
    }

    .modal-button.primary:hover {
      background-color: var(--color-primary-hover);
    }

    .modal-button.danger {
      background-color: var(--color-error);
      color: white;
      border-color: var(--color-error);
    }

    .modal-button.danger:hover {
      background-color: var(--color-error);
    }

    .modal-button.secondary {
      background-color: var(--color-bg);
      color: var(--color-text-secondary);
    }

    .modal-button.secondary:hover {
      background-color: var(--color-bg-secondary);
      color: var(--color-text);
    }

    .collection-item:hover,
    .mode-item:hover {
      border-color: var(--color-border);
      box-shadow: var(--shadow-xs);
    }

    .collection-item label,
    .mode-item label {
      flex: 1;
      font-size: var(--font-size-sm);
      color: var(--color-text);
      cursor: pointer;
    }

    /* ===== TABLES ===== */
    .table-container {
      overflow-x: auto;
      border: 1px solid var(--color-border);
      background-color: var(--color-bg-secondary);
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    table th {
      background-color: var(--color-gray-50);
      padding: var(--space-3) var(--space-4);
      text-align: left;
      font-size: var(--font-size-xs);
      font-weight: var(--font-weight-semibold);
      color: var(--color-text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 1px solid var(--color-border);
    }

    table td {
      padding: var(--space-3) var(--space-4);
      font-size: var(--font-size-sm);
      color: var(--color-text);
      border-bottom: 1px solid var(--color-border-light);
    }

    table tr:last-child td {
      border-bottom: none;
    }

    table tr:hover {
      background-color: var(--color-gray-50);
    }

    table td:first-child {
      font-weight: var(--font-weight-medium);
      color: var(--color-text);
    }

    table td:nth-child(3) {
      font-family: ui-monospace, SFMono-Regular, "SF Mono", Monaco, Consolas, monospace;
      font-size: var(--font-size-sm);
    }

    /* ===== EXPORT MODE TOGGLE STYLES ===== */
    .css-mode-toggle-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: var(--space-md);
    }

    .css-mode-info {
      flex: 1;
    }

    .css-mode-info h3 {
      margin: 0 0 var(--space-xs) 0;
      font-size: var(--font-size-lg);
      font-weight: 600;
      color: var(--color-text);
    }

    .css-mode-description {
      margin: 0;
      font-size: var(--font-size-sm);
      color: var(--color-text-secondary);
      line-height: 1.4;
    }

    .css-mode-toggle-control {
      flex-shrink: 0;
    }

    /* Modern Segmented Control */
    .toggle-switch {
      display: inline-flex;
      background: var(--color-bg-secondary);
      border-radius: var(--radius-md);
      padding: 2px;
      border: 1px solid var(--color-border);
      cursor: pointer;
      user-select: none;
      position: relative;
    }

    .toggle-switch:hover {
      border-color: var(--color-border-hover);
    }

    .toggle-switch input {
      position: absolute;
      opacity: 0;
      pointer-events: none;
    }

    .toggle-option {
      position: relative;
      padding: 6px 16px;
      font-size: var(--font-size-sm);
      font-weight: 500;
      color: var(--color-text-secondary);
      border-radius: calc(var(--radius-md) - 2px);
      transition: all 0.2s ease;
      z-index: 2;
      min-width: 80px;
      text-align: center;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .toggle-switch input:not(:checked)+.toggle-slider .toggle-option:first-child,
    .toggle-switch input:checked+.toggle-slider .toggle-option:last-child {
      color: var(--color-text);
      font-weight: 600;
    }

    .toggle-slider {
      display: flex;
      align-items: center;
      position: relative;
    }

    .toggle-slider::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      width: 50%;
      background: var(--color-bg);
      border-radius: calc(var(--radius-md) - 2px);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1), 0 0 0 1px rgba(0, 0, 0, 0.05);
      transition: transform 0.2s ease;
      z-index: 1;
    }

    .toggle-switch input:checked+.toggle-slider::before {
      transform: translateX(100%);
    }

    /* CSS Export Controls */
    .css-export-controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: var(--space-3);
      margin-bottom: var(--space-lg);
      margin-top: var(--space-8);
      padding-top: var(--space-4);
    }

    .css-advanced {
      display: none;
    }

    .css-advanced.active {
      display: block;
    }

    /* ===== ANALYSIS GRID ===== */
    .analysis-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: var(--space-4);
      margin-bottom: var(--space-6);
    }

    .analysis-item {
      text-align: center;
      padding: var(--space-4);
      background-color: var(--color-bg-secondary);
      border: 1px solid var(--color-border-light);
      border-radius: var(--radius-md);
      transition: all var(--transition-fast);
    }

    .analysis-item:hover {
      border-color: var(--color-border);
      box-shadow: var(--shadow-xs);
    }

    .analysis-number {
      display: block;
      font-size: var(--font-size-2xl);
      font-weight: var(--font-weight-bold);
      color: var(--color-primary);
      line-height: 1.2;
    }

    .analysis-label {
      display: block;
      font-size: var(--font-size-xs);
      font-weight: var(--font-weight-medium);
      color: var(--color-text-secondary);
      margin-top: var(--space-2);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* ===== BUTTON GROUPS ===== */
    .button-group {
      display: flex;
      justify-content: flex-end;
      gap: var(--space-3);
    }

    /* Footer button group responsive layout */
    body.figma-dev-mode .footer .button-group {
      justify-content: flex-end;
      align-items: center;
      flex-wrap: nowrap;
    }

    body.figma-dev-mode .footer .button-group .primary.footer-btn {
      flex: 1;
      /* Fill available space */
      min-width: 120px;
      /* Minimum width for Generate button */
    }

    @media (max-width: 600px) {
      .footer .button-group {
        justify-content: flex-end;
        align-items: center;
        flex-wrap: nowrap;
      }

      .footer .button-group .primary.footer-btn {
        flex: 1;
        /* Fill available space */
        margin-right: var(--space-3);
        min-width: 120px;
        /* Minimum width for Generate button */
      }
    }

    /* ===== STATUS MESSAGES ===== */
    .status-message {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      padding: var(--space-4);
      border-radius: var(--radius-md);
      font-size: var(--font-size-sm);
      margin-bottom: var(--space-4);
    }

    .status-message.success {
      background-color: var(--color-success-bg);
      border: 1px solid var(--color-success-border);
      color: var(--color-success);
    }

    .status-message.warning {
      background-color: var(--color-warning-bg);
      border: 1px solid var(--color-warning-border);
      color: var(--color-warning);
    }

    .status-message.error {
      background-color: var(--color-error-bg);
      border: 1px solid var(--color-error-border);
      color: var(--color-error);
    }

    /* ===== EMPTY STATES ===== */
    .empty-state {
      text-align: center;
      padding: var(--space-10) var(--space-6);
      color: var(--color-text-muted);
    }

    .empty-state h3 {
      font-size: var(--font-size-lg);
      font-weight: var(--font-weight-semibold);
      color: var(--color-text);
      margin-bottom: var(--space-3);
    }

    .empty-state p {
      font-size: var(--font-size-sm);
      line-height: 1.6;
      margin-bottom: var(--space-6);
    }

    /* ===== FOOTER ===== */
    .footer {
      position: fixed;
      bottom: 0;
      left: 40px;
      right: 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--space-2) var(--space-3);
      background-color: var(--color-bg-secondary);
      border-top: 1px solid var(--color-border);
      flex-wrap: wrap;
      gap: var(--space-4);
      z-index: 100;
    }

    .credits {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      font-size: var(--font-size-xs);
      color: var(--color-text-muted);
    }

    .version {
      font-weight: var(--font-weight-medium);
      color: var(--color-text-secondary);
    }

    .author {
      color: var(--color-primary);
      font-weight: var(--font-weight-medium);
    }

    /* ===== TYPE PILLS ===== */
    .type-pill {
      display: inline-block;
      padding: 2px 8px;
      border-radius: var(--radius-full);
      font-size: var(--font-size-xs);
      font-weight: var(--font-weight-medium);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .type-pill.color {
      background-color: var(--type-color-bg);
      color: var(--type-color);
    }

    .type-pill.number,
    .type-pill.float {
      background-color: var(--type-number-bg);
      color: var(--type-number);
    }

    .type-pill.string {
      background-color: var(--type-string-bg);
      color: var(--type-string);
    }

    .type-pill.boolean {
      background-color: var(--type-boolean-bg);
      color: var(--type-boolean);
    }

    .type-pill.alias {
      background-color: var(--type-alias-bg);
      color: var(--type-alias);
    }

    /* ===== COLOR PREVIEW ===== */
    .color-preview {
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }

    .color-dot {
      width: 18px;
      height: 18px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--color-border);
      flex-shrink: 0;
    }

    /* ===== ALIAS REFERENCE ===== */
    .alias-reference {
      color: var(--color-primary);
      font-style: italic;
      font-family: ui-monospace, SFMono-Regular, "SF Mono", Monaco, Consolas, monospace;
    }

    /* ===== BOOLEAN PREVIEW ===== */
    .boolean-preview {
      display: flex;
      align-items: center;
    }

    .boolean-preview input[type="checkbox"] {
      pointer-events: none;
    }

    /* ===== RESIZE HANDLE ===== */
    .resize-handle {
      position: fixed;
      bottom: 0;
      right: 0;
      width: 16px;
      height: 16px;
      cursor: nw-resize;
      z-index: 1000;
      background: var(--color-primary);
      opacity: 0;
      transition: opacity var(--transition-fast);
    }

    .resize-handle:hover,
    .resize-handle.active {
      opacity: 0.7;
    }

    .resize-handle::before {
      content: '';
      position: absolute;
      bottom: 2px;
      right: 2px;
      width: 0;
      height: 0;
      border-left: 12px solid transparent;
      border-bottom: 12px solid currentColor;
    }

    .resize-handle::after {
      content: '';
      position: absolute;
      bottom: 6px;
      right: 6px;
      width: 0;
      height: 0;
      border-left: 4px solid transparent;
      border-bottom: 4px solid var(--color-bg-secondary);
    }

    /* ===== RESPONSIVE ===== */
    @media (max-width: 640px) {
      .main-content-container {
        flex-direction: column;
        height: 100%;
        overflow-y: auto;
      }

      .left-panel {
        width: 100%;
        max-width: 100%;
        min-width: 30px;
        margin-bottom: var(--space-3);
      }

      .right-panel {
        width: 100%;
        min-width: 100%;
        margin-left: 0;
        margin-top: var(--space-3);
      }

      .scrollable-content {
        padding: var(--space-4);
        gap: var(--space-4);
      }

      .section {
        padding: var(--space-3);
        margin-bottom: var(--space-4);
      }

      .css-mode-toggle-container {
        flex-direction: column;
        gap: var(--space-3);
        align-items: flex-start;
      }

      .css-mode-info {
        width: 100%;
      }

      .css-mode-toggle-control {
        align-self: flex-start;
      }

      .toggle-option {
        min-width: 55px;
        padding: 5px 10px;
        font-size: var(--font-size-xs);
      }

      .tabs {
        padding: 0 var(--space-4);
      }

      .tab {
        padding: var(--space-3);
        font-size: var(--font-size-xs);
      }

      .button-group:not(.footer .button-group) {
        flex-direction: column;
      }

      .button-group:not(.footer .button-group) button {
        width: 100%;
      }

      .analysis-grid {
        grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
        gap: var(--space-3);
      }

      .footer {
        flex-direction: column;
        gap: var(--space-3);
        padding: var(--space-3) var(--space-4);
      }

      .footer .button-group {
        width: 100%;
        justify-content: center;
      }

      .resize-handle {
        display: none;
      }
    }

    @media (max-width: 768px) {
      .section-header {
        flex-direction: column;
        align-items: flex-start;
        gap: var(--space-3);
      }

      .select-all {
        align-self: flex-end;
      }

      .select-all-compact {
        align-self: flex-end;
      }
    }


    /* ===== CSS CUSTOMIZATION STYLES ===== */
    .css-customization-section {
      border-top: 1px solid var(--color-border);
      margin-top: var(--space-5);
      padding-top: var(--space-5);
    }

    .form-subsection {
      background: var(--color-bg-secondary);
      border-radius: var(--radius-md);
      margin-top: var(--space-3);
    }

    .text-input {
      width: 100%;
      padding: var(--space-3);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      background: var(--color-bg);
      color: var(--color-text);
      font-size: var(--font-size-sm);
      transition: all var(--transition-fast);
    }

    .text-input:focus {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: 0 0 0 3px var(--color-primary-alpha-10);
    }

    .text-input[type="number"] {
      -moz-appearance: textfield;
      appearance: textfield;
    }

    .text-input[type="number"]::-webkit-outer-spin-button,
    .text-input[type="number"]::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    /* ===== DARK MODE ===== */
    @media (prefers-color-scheme: dark) {
      :root {
        /* Backgrounds - improved depth and contrast */
        --color-bg: #0F0F11;
        --color-bg-secondary: #1A1A1E;
        --color-bg-tertiary: #25252A;

        /* Borders - enhanced visibility */
        --color-border: #35353A;
        --color-border-light: #28282D;

        /* Text - optimized for readability (WCAG AAA compliant) */
        --color-text: #EBEBF0;
        --color-text-secondary: #B8B8C2;
        --color-text-muted: #8E8E98;

        /* Unified Menu Dark Mode Variables */
        --menu-bg: var(--color-bg);
        --menu-bg-secondary: var(--color-bg-secondary);
        --menu-border: var(--color-border);
        --menu-shadow: 0 10px 25px rgba(0, 0, 0, 0.6);
        --menu-item-hover-bg: #28282E;
        --menu-item-selected-bg: var(--color-primary-alpha-10);
        --menu-item-selected-border: var(--color-primary);
        --menu-trigger-bg: var(--color-bg-secondary);
        --menu-trigger-border: var(--color-border);

        /* JSON Editor & Search (Dark Mode) */
        --json-editor-bg: #1a1a2e;
        --json-action-btn-bg: rgba(255, 255, 255, 0.08);
        --json-action-btn-border: rgba(255, 255, 255, 0.12);
        --json-action-btn-text: rgba(255, 255, 255, 0.7);
        --search-toolbar-bg: rgba(45, 45, 48, 0.98);
        --search-toolbar-border: #3e3e42;
        --search-field-bg: #3c3c3c;
        --search-field-border: #5a5a5a;
        --search-field-focus-bg: #2d2d30;
        --search-field-text: #ffffff;
        --search-placeholder: #858585;

        /* Syntax Highlighting (Dark Mode) */
        --syntax-property: #d4d4d4;
        --syntax-value: #9cdcfe;
        --syntax-string: #ce9178;
        --syntax-number: #b5cea8;
        --syntax-boolean: #569cd6;
        --syntax-punctuation: #d4d4d4;

        /* Tooltips (Dark Mode) */
        --tooltip-bg: #1e1e1e;
        --tooltip-text: #ffffff;

        /* Chips (Dark Mode) */
        --chip-bg: #2d2d30;
        --chip-text: #b8b8c2;
        --chip-bg-hover: #3c3c3c;
        --chip-border-active: rgba(59, 136, 219, 0.4);
        --chip-text-active: var(--color-primary-hover);
      }

      /* Dropdown specific dark mode fixes */
      .dropdown-content {
        background: var(--color-bg-secondary);
        border: 1px solid var(--color-border);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
      }

      .dropdown-item {
        color: var(--color-text);
      }

      .dropdown-item:hover {
        background-color: var(--color-gray-800);
      }

      .dropdown-item:focus {
        background-color: var(--color-gray-800);
      }

      .dropdown-item-title {
        color: var(--color-text);
      }

      .dropdown-item-desc {
        color: var(--color-text-secondary);
      }

      .dropdown-item svg {
        color: var(--color-text-secondary);
      }

      .dropdown-item:hover svg {
        color: var(--color-primary);
      }

      /* Custom components dark mode fixes */
      .custom-select-dropdown {
        background: var(--color-bg-secondary);
        border: 1px solid var(--color-border);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
      }

      .custom-select-option {
        color: var(--color-text);
        background: transparent;
      }

      .custom-select-option:hover {
        background-color: var(--color-gray-900);
        color: var(--color-text);
      }

      .custom-select-option:focus {
        background-color: var(--color-gray-900);
        color: var(--color-text);
      }

      .custom-select-option.selected {
        background-color: var(--color-primary-alpha-10);
        color: var(--color-text);
      }

      /* Ensure dropdown content has dark theme */
      .custom-select-trigger {
        background: var(--color-bg-secondary);
        color: var(--color-text);
        border-color: var(--color-border);
      }

      .custom-select-trigger:hover {
        border-color: var(--color-primary-hover);
      }

      .custom-select.active .custom-select-trigger {
        border-color: var(--color-primary);
      }

      .custom-input-number-btn {
        background: var(--color-bg-tertiary);
        color: var(--color-text-muted);
      }

      /* Radio buttons dark mode fixes */
      .radio-item {
        background-color: var(--color-bg-secondary);
        border-color: var(--color-border);
        color: var(--color-text);
      }

      .radio-item:hover {
        background-color: var(--color-gray-800);
        border-color: var(--color-border);
      }

      .radio-item span:last-child {
        color: var(--color-text);
      }

      .radio-indicator {
        background-color: var(--color-bg-secondary);
        border-color: var(--color-border);
      }

      .radio-item input[type="radio"]:checked+.radio-indicator {
        border-color: var(--color-primary);
        background-color: var(--color-primary);
      }

      .radio-item input[type="radio"]:checked+.radio-indicator::after {
        background-color: var(--color-bg);
      }

      /* Footer dark mode fixes */
      .footer {
        background-color: var(--color-bg-secondary);
        border-top: 1px solid var(--color-border);
      }

      .credits {
        color: var(--color-text-muted);
      }

      .version {
        color: var(--color-text-secondary);
      }

      .author a {
        color: var(--color-primary);
      }

      table th {
        background-color: var(--color-gray-800);
      }

      table tr:hover {
        background-color: var(--color-gray-700);
      }

      .tab:hover {
        background-color: var(--color-gray-800);
      }

      /* Select All compact buttons dark mode */
      .select-all-compact:hover {
        background-color: var(--color-gray-800);
        border-color: var(--color-gray-600);
      }

      .secondary:hover {
        background-color: var(--color-gray-700);
      }
    }

    /* ===== SNACKBAR NOTIFICATIONS ===== */
    #snackbar-container {
      position: fixed;
      bottom: 20px;
      left: 20px;
      z-index: 2000;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .snackbar {
      padding: 12px 16px;
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-lg);
      color: white;
      font-size: var(--font-size-sm);
      font-weight: var(--font-weight-medium);
      transform: translateX(-120%);
      opacity: 0;
      transition: all 0.4s cubic-bezier(0.21, 1.02, 0.73, 1);
      display: flex;
      align-items: center;
      gap: 8px;
      /* Default background color for fallback */
      background-color: var(--color-gray-600);
    }

    .snackbar.show {
      transform: translateX(0);
      opacity: 1;
    }

    .snackbar.success {
      background-color: var(--color-success);
    }

    .snackbar.error {
      background-color: var(--color-error);
    }

    .snackbar.warning {
      background-color: var(--color-warning);
    }

    .snackbar.info {
      background-color: var(--color-primary);
    }

    /* ===== UPLOAD STATUS ===== */
    .upload-status-container {
      background-color: var(--color-primary);
      color: white;
      padding: 12px 16px;
      margin-bottom: 16px;
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-sm);
      animation: slideDown 0.3s ease-out;
    }

    .upload-status {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .upload-status-content {
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1;
    }

    .upload-spinner {
      animation: spin 1s linear infinite;
    }

    .upload-status-text {
      font-size: var(--font-size-sm);
      font-weight: 500;
    }

    .upload-status-close {
      background: none;
      border: none;
      color: white;
      opacity: 0.8;
      cursor: pointer;
      padding: 4px;
      border-radius: var(--radius-sm);
      transition: opacity 0.2s ease;
    }

    .upload-status-close:hover {
      opacity: 1;
      background-color: rgba(255, 255, 255, 0.1);
    }

    .upload-status-container.success {
      background-color: var(--color-success);
    }

    .upload-status-container.error {
      background-color: var(--color-error);
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes spin {
      from {
        transform: rotate(0deg);
      }

      to {
        transform: rotate(360deg);
      }
    }

    @keyframes opacityPulse1 {

      0%,
      100% {
        opacity: 0.3;
      }

      25% {
        opacity: 1;
      }

      50%,
      75% {
        opacity: 0.3;
      }
    }

    @keyframes opacityPulse2 {

      0%,
      25% {
        opacity: 0.3;
      }

      50% {
        opacity: 1;
      }

      75%,
      100% {
        opacity: 0.3;
      }
    }

    @keyframes opacityPulse3 {

      0%,
      50% {
        opacity: 0.3;
      }

      75% {
        opacity: 1;
      }

      100% {
        opacity: 0.3;
      }
    }

    @keyframes opacityPulse4 {
      0% {
        opacity: 1;
      }

      25%,
      75% {
        opacity: 0.3;
      }

      100% {
        opacity: 1;
      }
    }

    /* Cube opacity pulse animation for Generate buttons */
    #export-json-button svg path:nth-child(1),
    #export-css-button svg path:nth-child(1),
    #export-text-styles-button svg path:nth-child(1) {
      animation: opacityPulse1 3s ease-in-out infinite;
    }

    #export-json-button svg path:nth-child(2),
    #export-css-button svg path:nth-child(2),
    #export-text-styles-button svg path:nth-child(2) {
      animation: opacityPulse2 3s ease-in-out infinite;
    }

    #export-json-button svg path:nth-child(3),
    #export-css-button svg path:nth-child(3),
    #export-text-styles-button svg path:nth-child(3) {
      animation: opacityPulse3 3s ease-in-out infinite;
    }

    #export-json-button svg path:nth-child(4),
    #export-css-button svg path:nth-child(4),
    #export-text-styles-button svg path:nth-child(4) {
      animation: opacityPulse4 3s ease-in-out infinite;
    }

    /* Pause animation on hover */
    #export-json-button:hover svg path,
    #export-css-button:hover svg path,
    #export-text-styles-button:hover svg path {
      animation-play-state: paused;
      opacity: 1;
    }

    /* Pause animation when button is in static states (generate, generated, update) */
    #export-json-button.paused svg path,
    #export-css-button.paused svg path,
    #export-text-styles-button.paused svg path {
      animation: none !important;
      opacity: 1;
    }

    /* === BUTTON STANDARDIZATION CSS (Aggiunto per coerenza) === */

    /* Unificazione del Focus Ring per l'Accessibilit√† */
    .button:focus,
    .primary:focus,
    .secondary:focus,
    .variant-ghost:focus,
    .json-toolbar button:focus {
      outline: none;
      box-shadow: var(--focus-ring, 0 0 0 3px rgba(37, 99, 235, 0.5));
    }

    /* 1. Varianti di Dimensione (Size) */

    /* Size M (40px) - Per dropdown e azioni secondarie di media dimensione (sostituisce .get-code-trigger) */
    .button.size-M {
      min-height: 40px;
      padding: 8px 16px;
      font-size: var(--font-size-sm);
      line-height: 24px;
    }

    /* Size S (32px) - Per toolbar compatte */
    .button.size-S {
      min-height: 32px;
      padding: 4px 12px;
      font-size: var(--font-size-sm);
      line-height: 24px;
    }

    /* Size XS (24px) - Per icone/controlli inline (sostituisce i bottoni interni al .json-toolbar) */
    .button.size-XS {
      min-height: 24px;
      width: 24px;
      padding: 0;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: var(--font-size-sm);
    }

    /* 2. Variante di Stile (Variant) Ghost */

    /* Per elementi interattivi trasparenti nei menu e toolbar */
    .button.variant-ghost {
      background: transparent;
      border-color: transparent;
      color: var(--color-text);
    }

    .button.variant-ghost:hover {
      background: var(--color-gray-100, #f3f4f6);
    }


    /* 3. Overrides per il Contesto Scurio (JSON Toolbar) */

    /* Applica stile Primary (Filled) + Size XS al bottone di Replace */
    .json-toolbar .replace-btn {
      /* Sovrascrivi il min-height/padding se erano stati definiti diversamente */
      min-height: 24px;
      width: auto;
      padding: 0 8px;
      font-size: var(--font-size-sm);

      background-color: var(--color-primary);
      color: white;
      border: none;
      border-radius: var(--radius-sm);
    }

    .json-toolbar .replace-btn:hover {
      background-color: var(--color-primary-hover);
    }

    /* Applica stile Icona + Size XS ai bottoni di navigazione (Search/Close/Nav) */
    .json-toolbar .search-nav-btn {
      min-height: 24px;
      width: 24px;
      padding: 0;

      background-color: var(--color-bg-dark, #3c3c3c);
      /* Mantiene lo sfondo scuro della toolbar */
      color: white;
      border: 1px solid var(--color-border-dark, #5a5a5a);
      border-radius: var(--radius-sm);
    }

    .json-toolbar .search-nav-btn:hover {
      background-color: var(--color-bg-dark-hover, #464646);
    }

    /* ===== THEME BUILDER STYLES ===== */
    .theme-builder-layout {
      display: flex;
      width: 100%;
      height: 100%;
      gap: 0;
    }

    .theme-sidebar {
      width: 320px;
      border-right: 1px solid var(--color-border);
      padding: var(--space-4);
      overflow-y: auto;
      flex-shrink: 0;
      background: var(--color-bg-primary);
    }

    .theme-list {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .theme-list-item {
      display: flex;
      align-items: center;
      gap: 0;
      padding: 0 8px;
      border-radius: 4px;
      background: transparent;
      cursor: pointer;
      transition: all 0.15s ease;
      position: relative;
      height: 40px;
    }

    .theme-list-item:hover {
      background: rgba(0, 0, 0, 0.03);
    }

    .theme-list-item.active {
      background: #f3f4f6;
    }

    .theme-list-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex: 1;
      gap: 0;
    }

    .theme-color-swatches {
      display: flex;
      gap: 0;
      position: relative;
      height: 20px;
      width: 40px;
      flex-shrink: 0;
      margin-right: 0;
    }

    .theme-color-swatch {
      position: absolute;
      top: 3px;
    }

    .theme-color-swatch:nth-child(1) {
      left: 4px;
      z-index: 3;
    }

    .theme-color-swatch:nth-child(2) {
      left: 11px;
      z-index: 2;
    }

    .theme-color-swatch:nth-child(3) {
      left: 18px;
      z-index: 1;
    }

    .theme-color-dot {
      width: 15px;
      height: 15px;
      border-radius: 2px;
      border: 1px solid white;
      transition: transform 0.15s ease;
    }

    .theme-color-dot:hover {
      transform: scale(1.05);
    }

    .theme-color-label {
      font-family: 'JetBrains Mono', monospace;
      font-size: 14px;
      font-weight: 400;
      color: #b3b3b3;
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      line-height: 1.4;
    }

    .theme-list-item.active .theme-color-label {
      color: var(--color-text);
      font-weight: 400;
    }

    .theme-draft-badge {
      display: inline-block;
      margin-left: 8px;
      padding: 2px 6px;
      font-size: 9px;
      font-weight: 600;
      color: var(--draft-text);
      background: var(--draft-bg);
      border: 1px solid var(--draft-border);
      border-radius: 3px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      vertical-align: middle;
      line-height: 1.2;
    }

    .theme-list-item.active .theme-draft-badge {
      color: var(--draft-text-active);
      background: var(--draft-bg-active);
      border-color: var(--draft-border-active);
    }

    .theme-delete-btn {
      opacity: 0;
      transition: opacity 0.15s ease;
      flex-shrink: 0;
    }

    .theme-list-item:hover .theme-delete-btn {
      opacity: 1;
    }

    #add-theme-btn:hover {
      background: rgba(0, 0, 0, 0.03) !important;
    }

    .theme-editor-area {
      flex: 1;
      padding: var(--space-6);
      overflow-y: auto;
    }

    .theme-editor-empty {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 300px;
      color: var(--color-text-secondary);
      text-align: center;
    }

    /* ===== THEME TOKENS TABLE STYLES ===== */
    .theme-tokens-table-wrapper {
      width: 100%;
      overflow: auto;
    }

    .theme-tokens-table {
      width: 100%;
      font-family: 'Inter', -apple-system, sans-serif;
    }

    .tokens-table-body {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .token-row {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 12px;
      border-radius: 6px;
      transition: background 0.12s;
      cursor: default;
    }

    .token-row:hover {
      background: rgba(0, 0, 0, 0.03);
    }

    .theme-token-swatch {
      width: 32px;
      height: 32px;
      border-radius: 6px;
      border: 1px solid rgba(0, 0, 0, 0.06);
      flex-shrink: 0;
      box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.1);
    }

    .theme-token-icon {
      width: 16px;
      height: 16px;
      flex-shrink: 0;
      opacity: 0.5;
    }

    .theme-token-name {
      font-size: 13px;
      font-weight: 500;
      color: var(--color-text);
      flex-shrink: 0;
      min-width: 150px;
    }

    .token-value-chip {
      background: var(--chip-bg);
      border: 1px solid transparent;
      border-radius: 4px;
      padding: 4px 10px;
      font-size: 12px;
      font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
      color: var(--chip-text);
      cursor: pointer;
      transition: all 0.15s;
      margin-left: auto;
      user-select: none;
    }

    .token-value-chip:hover {
      background: var(--chip-bg-hover);
      border-color: var(--chip-border-active);
      color: var(--chip-text-active);
    }

    .token-value-chip:active {
      transform: scale(0.98);
    }

    /* ===== LIBRARIES MODAL STYLES ===== */
    .libraries-modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.25);
      z-index: 99999;
      display: flex;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.15s;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    .libraries-modal {
      background: white;
      border-radius: 12px;
      width: 440px;
      max-height: 640px;
      box-shadow: 0 16px 48px rgba(0, 0, 0, 0.2);
      display: flex;
      flex-direction: column;
      animation: slideUp 0.2s cubic-bezier(0.16, 1, 0.3, 1);
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(8px) scale(0.98);
      }

      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .libraries-header {
      padding: 16px;
      border-bottom: 1px solid #e5e5e5;
      position: relative;
    }

    .libraries-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--color-text);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .libraries-title-swatch {
      width: 20px;
      height: 20px;
      border-radius: 4px;
      border: 1px solid rgba(0, 0, 0, 0.1);
      flex-shrink: 0;
    }

    .libraries-search-wrapper {
      position: relative;
    }

    .libraries-search {
      width: 100%;
      padding: 8px 12px 8px 32px;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      font-size: 13px;
      outline: none;
      transition: border-color 0.15s;
    }

    .libraries-search:focus {
      border-color: #0066ff;
    }

    .search-icon {
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      width: 14px;
      height: 14px;
      opacity: 0.4;
      pointer-events: none;
    }

    .libraries-content {
      overflow-y: auto;
      flex: 1;
      padding: 8px;
    }

    .color-family {
      margin-bottom: 16px;
    }

    .color-family-title {
      font-size: 11px;
      font-weight: 600;
      color: #999;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 8px 8px 4px 8px;
    }

    .color-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.12s;
    }

    .color-item:hover {
      background: rgba(0, 0, 0, 0.04);
    }

    .color-item-swatch {
      width: 28px;
      height: 28px;
      border-radius: 5px;
      border: 1px solid rgba(0, 0, 0, 0.08);
      flex-shrink: 0;
    }

    .color-item-label {
      font-size: 13px;
      color: var(--color-text);
      font-weight: 500;
    }

    .modal-close {
      position: absolute;
      top: 16px;
      right: 16px;
      background: none;
      border: none;
      width: 24px;
      height: 24px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      color: #666;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.15s;
    }

    .modal-close:hover {
      background: rgba(0, 0, 0, 0.06);
    }

    /* ===== THEME PREVIEW STYLES ===== */
    .theme-preview-container {
      max-width: 900px;
      margin: 0 auto;
    }

    .theme-preview-header {
      margin-bottom: 32px;
    }

    .theme-preview-title {
      font-family: 'Inter', -apple-system, sans-serif;
      font-size: 24px;
      font-weight: 600;
      color: var(--color-text);
      margin: 0 0 8px 0;
    }

    .theme-preview-description {
      font-family: 'Inter', -apple-system, sans-serif;
      font-size: 14px;
      color: #737373;
      margin: 0;
    }

    .theme-preview-component {
      position: relative;
      margin-bottom: 24px;
      display: flex;
      align-items: center;
      gap: 24px;
    }

    .theme-preview-component>*:first-child {
      flex: 1;
    }

    .theme-preview-token-label {
      font-family: 'JetBrains Mono', 'Courier New', monospace;
      font-size: 11px;
      color: #999;
      text-align: right;
      white-space: nowrap;
      min-width: 140px;
      line-height: 1.5;
    }

    .theme-preview-card {
      padding: 20px;
      display: flex;
      align-items: center;
      gap: 16px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      transition: transform 0.2s ease;
    }

    .theme-preview-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .theme-preview-card-icon {
      flex-shrink: 0;
    }

    .theme-preview-card-content {
      flex: 1;
    }

    .theme-preview-card-title {
      font-family: 'Inter', -apple-system, sans-serif;
      font-size: 16px;
      font-weight: 700;
      color: white;
      margin: 0 0 4px 0;
      letter-spacing: 0.5px;
    }

    .theme-preview-card-subtitle {
      font-family: 'Inter', -apple-system, sans-serif;
      font-size: 13px;
      color: rgba(255, 255, 255, 0.9);
      margin: 0;
    }

    .theme-preview-card-arrow {
      flex-shrink: 0;
      opacity: 0.9;
    }

    .theme-preview-label {
      font-family: 'Inter', -apple-system, sans-serif;
      font-size: 13px;
      font-weight: 500;
      color: var(--color-text);
      margin: 0 0 8px 0;
    }

    .theme-preview-input-wrapper {
      display: flex;
      align-items: center;
      background: white;
      overflow: hidden;
      transition: border-color 0.2s ease;
    }

    .theme-preview-input-wrapper:focus-within {
      filter: brightness(0.95);
    }

    .theme-preview-input {
      flex: 1;
      border: none;
      outline: none;
      padding: 12px 16px;
      font-family: 'Inter', -apple-system, sans-serif;
      font-size: 14px;
      color: var(--color-text);
      background: transparent;
    }

    .theme-preview-input-button {
      padding: 12px 20px;
      background: transparent;
      border: none;
      border-left: 2px solid;
      font-family: 'Inter', -apple-system, sans-serif;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .theme-preview-input-button:hover {
      background: rgba(0, 0, 0, 0.03);
    }

    .theme-preview-card-metro {
      padding: 32px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 120px;
    }

    .theme-preview-metro-logo {
      margin-bottom: 12px;
    }

    .theme-preview-metro-icon {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Inter', -apple-system, sans-serif;
      font-size: 24px;
      font-weight: 700;
      color: white;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }

    .theme-preview-metro-label {
      font-family: inherit;
      font-size: 16px;
      font-weight: 600;
      margin: 0;
    }

    .theme-preview-button {
      width: 100%;
      padding: 16px;
      border: none;
      font-size: 16px;
      font-weight: 700;
      color: white;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      letter-spacing: 0.3px;
    }


    .theme-preview-button:active {
      transform: translateY(0);
    }

    /* ===== COLOR GROUP CARDS ===== */
    .color-group-card {
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      padding: var(--space-4);
      background: var(--color-bg-secondary);
      margin-bottom: var(--space-3);
    }

    .color-group-title {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      font-size: 13px;
      font-weight: 600;
      margin-bottom: var(--space-3);
      text-transform: uppercase;
    }

    .color-group-badge {
      width: 12px;
      height: 12px;
      border-radius: 50%;
    }

    .color-group-badge.core {
      background: #2473BD;
    }

    .color-group-badge.accent {
      background: #EA4444;
    }

    .color-group-badge.alt {
      background: #2A2A2A;
    }

    /* ===== VARIANT PREVIEW ===== */
    .variant-preview-container {
      margin-top: var(--space-3);
      padding: var(--space-3);
      background: var(--color-bg-tertiary);
      border-radius: var(--radius-md);
      border: 1px solid var(--color-border);
    }

    .variant-preview-row {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-2) 0;
      font-size: 12px;
    }

    .variant-preview-row:not(:last-child) {
      border-bottom: 1px solid var(--color-border);
    }

    .variant-preview-label {
      min-width: 60px;
      font-weight: 500;
      color: var(--color-text-secondary);
    }

    .variant-preview-dot {
      width: 20px;
      height: 20px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--color-border);
      flex-shrink: 0;
    }

    .variant-preview-value {
      font-family: 'Monaco', 'Menlo', monospace;
      color: var(--color-text);
      font-size: 11px;
      flex: 1;
    }

    .variant-preview-status {
      font-size: 14px;
      min-width: 20px;
      text-align: center;
    }

    .variant-preview-status.success {
      color: var(--color-success);
    }

    .variant-preview-status.fallback {
      color: var(--color-warning);
    }

    .fallback-warning {
      margin-top: var(--space-2);
      padding: var(--space-2) var(--space-3);
      background: var(--color-warning-alpha-10);
      border: 1px solid var(--color-warning);
      border-radius: var(--radius-sm);
      font-size: 12px;
      color: var(--color-warning);
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }

    /* ===== COLOR FAMILY GRID ===== */
    .color-family-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: var(--space-3);
      margin-top: var(--space-3);
    }

    .color-family-card {
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      padding: var(--space-3);
      background: var(--color-bg-secondary);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .color-family-card:hover {
      border-color: var(--color-primary);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .color-family-card.selected {
      border-color: var(--color-primary);
      background: var(--color-primary-alpha-5);
      box-shadow: 0 0 0 3px var(--color-primary-alpha-10);
    }

    .color-family-name {
      font-size: 12px;
      font-weight: 600;
      margin-bottom: var(--space-2);
      color: var(--color-text);
      text-transform: capitalize;
    }

    .color-level-dots {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-1);
    }

    .color-level-dot {
      width: 24px;
      height: 24px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--color-border);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .color-level-dot:hover {
      transform: scale(1.2);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      z-index: 1;
    }

    .color-level-dot.selected {
      border: 2px solid var(--color-primary);
      box-shadow: 0 0 0 2px var(--color-primary-alpha-20);
    }

    /* ===== AUTOCOMPLETE STYLES ===== */
    .autocomplete-container {
      position: relative;
      width: 100%;
    }

    .input-with-swatch {
      position: relative;
      display: flex;
      align-items: center;
    }

    .input-color-swatch {
      position: absolute;
      left: 12px;
      bottom: 32px;
      width: 20px;
      height: 20px;
      border-radius: 4px;
      border: 1px solid var(--color-border);
      pointer-events: none;
      z-index: 1;
    }

    .input-with-swatch input {
      padding-left: 40px !important;
    }

    .autocomplete-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      margin-top: -18px;
      max-height: 320px;
      overflow-y: auto;
      background: white;
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 10000;
    }

    .autocomplete-item {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      padding: var(--space-3);
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .autocomplete-item:hover {
      background: var(--color-bg-tertiary);
    }

    .autocomplete-item.active {
      background: var(--color-primary-alpha-10);
    }

    .autocomplete-color-preview {
      width: 16px;
      height: 16px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--color-border);
      flex-shrink: 0;
    }

    .autocomplete-text {
      font-size: 13px;
      color: var(--color-text-primary);
      flex: 1;
    }

    .autocomplete-empty {
      padding: var(--space-4);
      text-align: center;
      color: var(--color-text-tertiary);
      font-size: 13px;
    }

    /* Hierarchical autocomplete styles */
    .autocomplete-group-header {
      padding: var(--space-2) var(--space-3);
      font-size: 11px;
      font-weight: 600;
      color: var(--color-text-tertiary);
      background: var(--color-bg-secondary);
      border-bottom: 1px solid var(--color-border);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .autocomplete-family-header {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-2) var(--space-3);
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
      color: var(--color-text-secondary);
      background: var(--color-bg-primary);
      border-bottom: 1px solid var(--color-border);
      transition: background 0.2s ease;
      user-select: none;
    }

    .autocomplete-family-header:hover {
      background: var(--color-bg-tertiary);
    }

    .autocomplete-family-icon {
      width: 12px;
      height: 12px;
      transition: transform 0.2s ease;
      flex-shrink: 0;
    }

    .autocomplete-family-icon.collapsed {
      transform: rotate(-90deg);
    }

    .autocomplete-family-count {
      margin-left: auto;
      font-size: 11px;
      color: var(--color-text-tertiary);
    }

    .autocomplete-family-colors {
      display: block;
    }

    .autocomplete-family-colors.hidden {
      display: none;
    }
  </style>
</head>

<body>

  <!-- Simple Linear Progress Bar - MUST be first for top:0 to work -->
  <div class="simple-progress-bar" id="simple-progress-bar">
    <div class="simple-progress-fill" id="simple-progress-fill"></div>
  </div>

  <div class="app-container">
    <div class="resize-handle" id="resize-handle"></div>



    <!-- Sidebar Navigation -->
    <div class="sidebar-nav">
      <button class="nav-icon-button active" data-tab="json-to-variables" title="Import Variables">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path
            d="M11.25 10.0001C11.25 10.6905 10.6904 11.2501 10 11.2501C9.30964 11.2501 8.75 10.6905 8.75 10.0001C8.75 9.30976 9.30964 8.75011 10 8.75011C10.6904 8.75011 11.25 9.30976 11.25 10.0001Z"
            fill="currentColor" />
          <path fill-rule="evenodd" clip-rule="evenodd"
            d="M8.75 2.79064C9.52341 2.3442 10.4766 2.3442 11.25 2.79064L15.625 5.31628C16.3984 5.76279 16.8748 6.5888 16.875 7.4818V12.5331C16.875 13.4262 16.3984 14.252 15.625 14.6986L11.25 17.2242C10.4765 17.6708 9.52348 17.6708 8.75 17.2242L4.375 14.6986C3.60161 14.252 3.125 13.4262 3.125 12.5331V7.4818C3.12515 6.5888 3.60162 5.76279 4.375 5.31628L8.75 2.79064ZM10.625 3.8734C10.2383 3.65025 9.76166 3.65025 9.375 3.8734L5 6.39904L4.86206 6.49059C4.55733 6.72518 4.37513 7.0911 4.375 7.4818V12.5331C4.375 12.9796 4.61336 13.3925 5 13.6158L9.375 16.1415C9.71342 16.3369 10.1205 16.3613 10.4761 16.2147L10.625 16.1415L15 13.6158C15.3866 13.3925 15.625 12.9796 15.625 12.5331V7.4818C15.6249 7.0911 15.4427 6.72518 15.1379 6.49059L15 6.39904L10.625 3.8734Z"
            fill="currentColor" />
        </svg>



        <span class="nav-label">Import</span>
      </button>

      <button class="nav-icon-button" data-tab="json-export" title="Export JSON">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path
            d="M18.4697 16.4697C18.7359 16.2034 19.1526 16.1792 19.4462 16.3971L19.5303 16.4697L21.5303 18.4697C21.7966 18.7359 21.8208 19.1526 21.603 19.4462L21.5303 19.5303L19.5303 21.5303C19.2374 21.8232 18.7626 21.8232 18.4697 21.5303C18.2034 21.2641 18.1792 20.8474 18.3971 20.5538L18.4697 20.4697L19.939 19L18.4697 17.5303C18.2034 17.2641 18.1792 16.8474 18.3971 16.5538L18.4697 16.4697Z"
            fill="currentColor" />
          <path
            d="M8.83301 2.25C9.2127 2.25 9.5265 2.53215 9.57616 2.89823L9.58301 3V7C9.58301 7.91817 8.8759 8.67119 7.97653 8.7442L7.83301 8.75H3.83301C3.41879 8.75 3.08301 8.41421 3.08301 8C3.08301 7.6203 3.36516 7.30651 3.73124 7.25685L3.83301 7.25H7.83301C7.95135 7.25 8.05049 7.16777 8.07641 7.05732L8.08301 7V3C8.08301 2.58579 8.41879 2.25 8.83301 2.25Z"
            fill="currentColor" />
          <path
            d="M16.833 2.25C18.2955 2.25 19.4914 3.3917 19.578 4.83248L19.583 5V13C19.583 13.4142 19.2472 13.75 18.833 13.75C18.4533 13.75 18.1395 13.4678 18.0899 13.1018L18.083 13V5C18.083 4.35279 17.5911 3.82047 16.9608 3.75645L16.833 3.75H8.66101C8.37704 3.75 8.10294 3.8468 7.88274 4.02218L7.77734 4.11633L4.94926 6.94441C4.74826 7.14535 4.62275 7.40759 4.59099 7.68704L4.58301 7.828V19C4.58301 19.6472 5.07488 20.1795 5.7052 20.2435L5.83301 20.25H11C11.4142 20.25 11.75 20.5858 11.75 21C11.75 21.3797 11.4679 21.6935 11.1018 21.7432L11 21.75H5.83301C4.37048 21.75 3.1746 20.6083 3.08803 19.1675L3.08301 19V7.828C3.08301 7.16502 3.3226 6.52669 3.75366 6.02873L3.88868 5.88367L6.7166 3.05575C7.1854 2.5868 7.80607 2.30458 8.46297 2.25714L8.66101 2.25H16.833Z"
            fill="currentColor" />
          <path
            d="M15.4697 16.4697C15.7626 16.1768 16.2374 16.1768 16.5303 16.4697C16.7966 16.7359 16.8208 17.1526 16.603 17.4462L16.5303 17.5303L15.061 19L16.5303 20.4697C16.7966 20.7359 16.8208 21.1526 16.603 21.4462L16.5303 21.5303C16.2641 21.7966 15.8474 21.8208 15.5538 21.6029L15.4697 21.5303L13.4697 19.5303C13.2034 19.2641 13.1792 18.8474 13.3971 18.5538L13.4697 18.4697L15.4697 16.4697Z"
            fill="currentColor" />
        </svg>


        <span class="nav-label">Export</span>
      </button>

      <button class="nav-icon-button" data-tab="text-styles-export" title="Text Styles">

        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
          <g clip-path="url(#clip0_754_6879)">
            <path fill-rule="evenodd" clip-rule="evenodd"
              d="M4.54545 3.18181H15.4545C16.2077 3.18181 16.8182 3.79233 16.8182 4.54545V15.4545C16.8182 16.2077 16.2077 16.8182 15.4545 16.8182H4.54545C3.79233 16.8182 3.18181 16.2077 3.18181 15.4545V4.54545C3.18181 3.79233 3.79233 3.18181 4.54545 3.18181ZM1.81818 4.54545C1.81818 3.03922 3.03922 1.81818 4.54545 1.81818H15.4545C16.9608 1.81818 18.1818 3.03922 18.1818 4.54545V15.4545C18.1818 16.9608 16.9608 18.1818 15.4545 18.1818H4.54545C3.03922 18.1818 1.81818 16.9608 1.81818 15.4545V4.54545ZM6.5909 5.90909C6.21435 5.90909 5.90909 6.21435 5.90909 6.5909V7.95454C5.90909 8.33104 6.21435 8.63636 6.5909 8.63636C6.96746 8.63636 7.27272 8.33104 7.27272 7.95454V7.27272H9.31818V12.7273H8.63636C8.25986 12.7273 7.95454 13.0326 7.95454 13.4091C7.95454 13.7856 8.25986 14.0909 8.63636 14.0909H9.99999H11.3636C11.7401 14.0909 12.0454 13.7856 12.0454 13.4091C12.0454 13.0326 11.7401 12.7273 11.3636 12.7273H10.6818V7.27272H12.7273V7.95454C12.7273 8.33104 13.0326 8.63636 13.4091 8.63636C13.7856 8.63636 14.0909 8.33104 14.0909 7.95454V6.5909C14.0909 6.21435 13.7856 5.90909 13.4091 5.90909H9.99999H6.5909Z"
              fill="currentColor" />
          </g>
          <defs>
            <clipPath id="clip0_754_6879">
              <rect width="18" height="18" fill="white" transform="translate(1 1)" />
            </clipPath>
          </defs>
        </svg>




        <span class="nav-label">Styles</span>
      </button>

      <!-- GitHub Tab Button -->
      <button class="nav-icon-button" data-tab="settings" title="GitHub configuration">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 2.25C14.6086 2.25 17.2662 3.36564 19.1387 5.3877C20.7938 7.17683 21.7499 9.51211 21.75 12.1846C21.75 14.2999 21.0424 16.3881 19.8281 18.0137C18.6589 19.5789 17.0173 20.6669 15.2832 21.374C14.7899 21.5752 14.25 21.2124 14.25 20.6797V19.9561L14.249 19.8838L14.2373 19.6885L14.21 19.4355L14.1885 19.29C14.1117 18.7961 13.9732 18.3046 13.7598 17.8535C13.6814 17.6879 13.5937 17.5304 13.4971 17.3818C13.1856 16.9027 13.5032 16.2648 14.0732 16.2246C15.7143 16.1099 17.0184 14.6204 17.0186 12.7822C17.0186 12.1992 16.7995 11.6284 16.377 11.1064C16.2734 10.9784 16.2144 10.8199 16.21 10.6553L16.1592 8.76172L14.1221 9.49902C14.0168 9.53707 13.9044 9.55081 13.7939 9.54004L13.6846 9.52148C13.1406 9.38502 12.5748 9.31445 12 9.31445C11.426 9.31445 10.86 9.38459 10.3145 9.52051C10.17 9.55649 10.0179 9.54864 9.87793 9.49805L7.83984 8.76074L7.79004 10.6553C7.78647 10.7873 7.74812 10.9157 7.67969 11.0273L7.62207 11.1074C7.19977 11.6281 6.98145 12.1983 6.98145 12.7822C6.98155 14.6204 8.28569 16.1099 9.92676 16.2246C10.4968 16.2648 10.8144 16.9027 10.5029 17.3818C9.9486 18.2342 9.75073 19.2373 9.75 19.9561V20.6797C9.75002 21.2124 9.21011 21.5752 8.7168 21.374C6.98267 20.6669 5.34105 19.5788 4.17188 18.0137C2.95782 16.3884 2.25 14.2993 2.25 12.1846C2.2501 9.51224 3.20608 7.17705 4.86133 5.3877C6.73352 3.36589 9.39141 2.25 12 2.25ZM12 3.75C9.80174 3.75 7.54544 4.69736 5.96289 6.40625C4.5588 7.92396 3.7501 9.89826 3.75 12.1846C3.75 13.9726 4.35164 15.7476 5.37402 17.1162C6.09174 18.077 7.05025 18.8414 8.10352 19.4229L8.2666 19.5098L8.28711 19.2891C8.34636 18.747 8.4808 18.1564 8.72168 17.5664L8.74609 17.5088L8.58496 17.4531C6.82957 16.7975 5.57381 15.0586 5.48633 13.0107L5.48145 12.7822C5.48145 11.9965 5.72095 11.2415 6.16602 10.5615L6.29688 10.3711L6.3418 8.68262C6.36718 7.72395 7.28458 7.05687 8.18945 7.29883L8.3125 7.33789L10.1816 8.0127L10.3525 7.97559C10.7559 7.89564 11.1673 7.8447 11.583 7.82422L12 7.81445C12.6182 7.81445 13.2283 7.88109 13.8193 8.01172L15.6875 7.33887C16.5893 7.01313 17.5437 7.62337 17.6484 8.55371L17.6582 8.68262L17.7021 10.3721L17.834 10.5625C18.2342 11.1748 18.4688 11.8473 18.5117 12.5479L18.5186 12.7822C18.5185 14.9285 17.2354 16.7733 15.415 17.4531L15.2471 17.5107L15.3301 17.7197C15.5505 18.3071 15.6702 18.8757 15.7207 19.3721L15.7314 19.5107L15.8965 19.4229C16.854 18.8943 17.7336 18.2142 18.4248 17.373L18.626 17.1162C19.6486 15.7473 20.25 13.9732 20.25 12.1846C20.2499 9.89827 19.4419 7.9237 18.0381 6.40625C16.4553 4.69697 14.1983 3.75 12 3.75ZM13.8174 8.01367L14.0498 8.06641C13.9734 8.04724 13.8964 8.02875 13.8193 8.01172L13.8174 8.01367Z" fill="currentColor"/>
        </svg>
        <span class="nav-label">GitHub</span>
      </button>
    </div>

    <!-- Main Content Area -->
    <div class="main-view">
      <!-- JSON to Variables Tab -->
      <div class="tab-content active" id="json-to-variables-tab">
        <div class="scrollable-content">
          <div class="main-content-container">
            <div class="left-panel">

              <!-- TOKEN TREE VIEW SECTION -->
              <div class="section">
                <div class="section-title" style="display: flex; justify-content: space-between; align-items: center;">
                  <div style="display: flex; align-items: center; gap: var(--space-2);">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path
                        d="M11.25 10.0001C11.25 10.6905 10.6904 11.2501 10 11.2501C9.30964 11.2501 8.75 10.6905 8.75 10.0001C8.75 9.30976 9.30964 8.75011 10 8.75011C10.6904 8.75011 11.25 9.30976 11.25 10.0001Z"
                        fill="currentColor" />
                      <path fill-rule="evenodd" clip-rule="evenodd"
                        d="M8.75 2.79064C9.52341 2.3442 10.4766 2.3442 11.25 2.79064L15.625 5.31628C16.3984 5.76279 16.8748 6.5888 16.875 7.4818V12.5331C16.875 13.4262 16.3984 14.252 15.625 14.6986L11.25 17.2242C10.4765 17.6708 9.52348 17.6708 8.75 17.2242L4.375 14.6986C3.60161 14.252 3.125 13.4262 3.125 12.5331V7.4818C3.12515 6.5888 3.60162 5.76279 4.375 5.31628L8.75 2.79064ZM10.625 3.8734C10.2383 3.65025 9.76166 3.65025 9.375 3.8734L5 6.39904L4.86206 6.49059C4.55733 6.72518 4.37513 7.0911 4.375 7.4818V12.5331C4.375 12.9796 4.61336 13.3925 5 13.6158L9.375 16.1415C9.71342 16.3369 10.1205 16.3613 10.4761 16.2147L10.625 16.1415L15 13.6158C15.3866 13.3925 15.625 12.9796 15.625 12.5331V7.4818C15.6249 7.0911 15.4427 6.72518 15.1379 6.49059L15 6.39904L10.625 3.8734Z"
                        fill="currentColor" />
                    </svg>
                    Variables
                  </div>
                </div>

                <!-- Token Tree Container -->
                <div id="token-tree-container" class="token-tree-container">
                  <div id="token-tree-root" class="token-tree-root">
                    <!-- Token tree will be rendered here dynamically -->
                    <div class="token-tree-empty"
                      style="padding: var(--space-4); text-align: center; color: var(--color-text-secondary); font-size: 13px;">
                      <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"
                        style="margin: 0 auto var(--space-2); opacity: 0.3;">
                        <path
                          d="M12 2C10.9391 2 9.92172 2.42143 9.17157 3.17157C8.42143 3.92172 8 4.93913 8 6C8 7.06087 8.42143 8.07828 9.17157 8.82843C9.92172 9.57857 10.9391 10 12 10C13.0609 10 14.0783 9.57857 14.8284 8.82843C15.5786 8.07828 16 7.06087 16 6C16 4.93913 15.5786 3.92172 14.8284 3.17157C14.0783 2.42143 13.0609 2 12 2Z"
                          fill="currentColor" />
                        <path
                          d="M6 14C4.93913 14 3.92172 14.4214 3.17157 15.1716C2.42143 15.9217 2 16.9391 2 18C2 19.0609 2.42143 20.0783 3.17157 20.8284C3.92172 21.5786 4.93913 22 6 22C7.06087 22 8.07828 21.5786 8.82843 20.8284C9.57857 20.0783 10 19.0609 10 18C10 16.9391 9.57857 15.9217 8.82843 15.1716C8.07828 14.4214 7.06087 14 6 14Z"
                          fill="currentColor" />
                        <path
                          d="M18 14C16.9391 14 15.9217 14.4214 15.1716 15.1716C14.4214 15.9217 14 16.9391 14 18C14 19.0609 14.4214 20.0783 15.1716 20.8284C15.9217 21.5786 16.9391 22 18 22C19.0609 22 20.0783 21.5786 20.8284 20.8284C21.5786 20.0783 22 19.0609 22 18C22 16.9391 21.5786 15.9217 20.8284 15.1716C20.0783 14.4214 19.0609 14 18 14Z"
                          fill="currentColor" />
                      </svg>
                      <p>No variables found</p>
                      <p style="font-size: 12px; margin-top: var(--space-1);">Load an example or import JSON to see
                        tokens</p>
                    </div>
                  </div>
                </div>
              </div>
              <!-- END TOKEN TREE VIEW -->

              <div class="section">
                <div class="section-title">
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path
                      d="M10 5.25C10.3797 5.25 10.6935 5.53215 10.7432 5.89823L10.75 6V7C10.75 7.41421 10.4142 7.75 10 7.75C9.6203 7.75 9.30651 7.46785 9.25685 7.10177L9.25 7V6C9.25 5.58579 9.58579 5.25 10 5.25Z"
                      fill="currentColor" />
                    <path
                      d="M10 9.25C10.3797 9.25 10.6935 9.53215 10.7432 9.89823L10.75 10V11C10.75 11.4142 10.4142 11.75 10 11.75C9.6203 11.75 9.30651 11.4678 9.25685 11.1018L9.25 11V10C9.25 9.58579 9.58579 9.25 10 9.25Z"
                      fill="currentColor" />
                    <path
                      d="M10 13.25C11.2426 13.25 12.25 14.2574 12.25 15.5V16.5C12.25 17.7426 11.2426 18.75 10 18.75C8.75736 18.75 7.75 17.7426 7.75 16.5V15.5C7.75 14.2574 8.75736 13.25 10 13.25ZM10 14.75C9.58579 14.75 9.25 15.0858 9.25 15.5V16.5C9.25 16.9142 9.58579 17.25 10 17.25C10.4142 17.25 10.75 16.9142 10.75 16.5V15.5C10.75 15.0858 10.4142 14.75 10 14.75Z"
                      fill="currentColor" />
                    <path
                      d="M14.6279 2.25C15.6225 2.25 16.577 2.64537 17.2803 3.34863L19.6514 5.71973C20.3546 6.42299 20.75 7.37751 20.75 8.37207V18.5C20.75 20.2949 19.2949 21.75 17.5 21.75H7C5.48122 21.75 4.25 20.5188 4.25 19V5.5C4.25 3.70507 5.70507 2.25 7.5 2.25H14.6279ZM7.5 3.75C6.5335 3.75 5.75 4.5335 5.75 5.5V19C5.75 19.6904 6.30964 20.25 7 20.25H17.5C18.4665 20.25 19.25 19.4665 19.25 18.5V8.37207C19.25 7.77533 19.0128 7.20223 18.5908 6.78027L16.2197 4.40918C15.7978 3.98722 15.2247 3.75 14.6279 3.75H7.5Z"
                      fill="currentColor" />
                  </svg>
                  Import Variables
                </div>


                <div class="button-group" style="justify-content: flex-start; margin-top: var(--space-4);">
                  <!-- Upload File Button -->
                  <button class="secondary" id="upload-file-button">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path
                        d="M11.1875 5.02433L6.88698 9.32449C6.5697 9.64177 6.05538 9.64177 5.7381 9.32449C5.42082 9.00721 5.42082 8.49289 5.7381 8.17561L11.4256 2.48811C11.7429 2.17083 12.2572 2.17083 12.5745 2.48811L18.262 8.17561C18.5793 8.49289 18.5793 9.00721 18.262 9.32449C18.1031 9.48333 17.8955 9.56255 17.6875 9.56255C17.4795 9.56255 17.2715 9.48333 17.1131 9.32449L12.8125 5.02433V16.0626C12.8125 16.5111 12.4485 16.8751 12 16.8751C11.5511 16.8751 11.1875 16.5111 11.1875 16.0626V5.02433Z"
                        fill="currentColor" />
                      <path
                        d="M20.125 16.875C20.125 16.4265 20.489 16.0625 20.9375 16.0625C21.386 16.0625 21.75 16.4265 21.75 16.875V18.5C21.75 20.292 20.292 21.75 18.5 21.75H5.5C3.70803 21.75 2.25 20.292 2.25 18.5V16.875C2.25 16.4265 2.614 16.0625 3.0625 16.0625C3.511 16.0625 3.875 16.4265 3.875 16.875V18.5C3.875 19.3958 4.60381 20.125 5.5 20.125H18.5C19.3962 20.125 20.125 19.3958 20.125 18.5V16.875Z"
                        fill="currentColor" />
                    </svg>

                    <span>Upload File</span>
                  </button>

                  <!-- Hidden File Input -->
                  <input type="file" id="json-file-input" accept=".json,.css" style="display: none;">
                </div>
                <!-- Import Progress Bar -->
                <div id="import-progress-container"
                  style="display: none; margin: var(--space-3) 0; padding: var(--space-3); background-color: var(--color-bg-secondary); border-radius: var(--radius-md); border: 1px solid var(--color-border);">
                  <div
                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-2);">
                    <span id="import-progress-text"
                      style="font-size: 13px; font-weight: 500; color: var(--color-text);">Importing variables...</span>
                    <span id="import-progress-percentage"
                      style="font-size: 13px; color: var(--color-text-secondary); font-weight: 600;">0%</span>
                  </div>
                  <div
                    style="width: 100%; height: 6px; background-color: var(--color-bg); border-radius: 3px; overflow: hidden;">
                    <div id="import-progress-bar"
                      style="width: 0%; height: 100%; background: linear-gradient(90deg, var(--color-primary), var(--color-primary-hover)); transition: width 0.3s ease;">
                    </div>
                  </div>
                  <div id="import-progress-details"
                    style="margin-top: var(--space-2); font-size: 12px; color: var(--color-text-secondary);"></div>
                </div>
              </div>
            </div>

            <div class="panel-separator"></div>

            <div class="right-panel">
              <!-- JSON Editor Container -->
              <div class="json-editor-container">

                <!-- JSON Editor Action Buttons (Top Right) -->
                <div class="json-editor-actions">
                  <button class="json-action-btn" id="json-refresh-btn" title="Refresh JSON from Figma">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path
                        d="M13.6536 2.34644C12.2086 0.90144 10.2162 0 8 0C3.58172 0 0 3.58172 0 8C0 12.4183 3.58172 16 8 16C11.7 16 14.8496 13.3948 15.7468 9.92972C15.8808 9.44284 15.596 8.94056 15.1092 8.80656C14.6223 8.67256 14.12 8.95732 13.986 9.44424C13.2832 12.1856 10.86 14.2222 8 14.2222C4.56384 14.2222 1.77778 11.4362 1.77778 8C1.77778 4.56384 4.56384 1.77778 8 1.77778C9.66384 1.77778 11.1678 2.47024 12.2489 3.55112L10.6667 5.13336H14.2222V1.57784L13.6536 2.34644Z"
                        fill="currentColor" />
                    </svg>
                  </button>
                  <button class="json-action-btn" id="json-copy-btn" title="Copy to Clipboard (‚åòC)">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path fill-rule="evenodd" clip-rule="evenodd"
                        d="M5.5 2C5.22386 2 5 2.22386 5 2.5V3H4.5C3.67157 3 3 3.67157 3 4.5V13.5C3 14.3284 3.67157 15 4.5 15H11.5C12.3284 15 13 14.3284 13 13.5V4.5C13 3.67157 12.3284 3 11.5 3H11V2.5C11 2.22386 10.7761 2 10.5 2H5.5ZM10 3V2.75C10 2.61193 9.88807 2.5 9.75 2.5H6.25C6.11193 2.5 6 2.61193 6 2.75V3.5C6 3.77614 6.22386 4 6.5 4H9.5C9.77614 4 10 3.77614 10 3.5V3ZM4 4.5C4 4.22386 4.22386 4 4.5 4H5V4.5C5 5.32843 5.67157 6 6.5 6H9.5C10.3284 6 11 5.32843 11 4.5V4H11.5C11.7761 4 12 4.22386 12 4.5V13.5C12 13.7761 11.7761 14 11.5 14H4.5C4.22386 14 4 13.7761 4 13.5V4.5Z"
                        fill="currentColor" />
                    </svg>
                  </button>
                </div>

                <!-- Find & Replace Toolbar (Hidden by default, shown with CMD+F) -->
                <div class="json-search-toolbar" id="json-search-toolbar" style="display: none;">
                  <div class="search-toolbar-inner">
                    <div class="search-row">
                      <input type="text" id="json-search-input" class="search-field" placeholder="Find"
                        autocomplete="off" spellcheck="false">
                      <div class="search-controls">
                        <span class="search-counter" id="json-search-counter">0 of 0</span>
                        <button class="search-nav-btn size-XS" id="json-search-prev" title="Previous (Shift+Enter)">
                          <svg width="10" height="10" viewBox="0 0 12 12">
                            <path d="M6 3L2 7h8L6 3z" fill="currentColor" />
                          </svg>
                        </button>
                        <button class="search-nav-btn size-XS" id="json-search-next" title="Next (Enter)">
                          <svg width="10" height="10" viewBox="0 0 12 12">
                            <path d="M6 9l4-4H2l4 4z" fill="currentColor" />
                          </svg>
                        </button>
                        <button class="search-toggle-btn size-XS" id="json-match-case" title="Match Case (‚å•C)">
                          <span style="font-size: 10px; font-weight: 600;">Aa</span>
                        </button>
                        <button class="search-toggle-btn size-XS" id="json-match-whole" title="Match Whole Word (‚å•W)">
                          <span style="font-size: 10px; font-weight: 600;">ab</span>
                        </button>
                        <button class="search-toggle-btn size-XS" id="json-use-regex"
                          title="Use Regular Expression (‚å•R)">
                          <span style="font-size: 10px; font-weight: 600;">.*</span>
                        </button>
                        <button class="search-close-btn size-XS" id="json-search-close" title="Close (Esc)">√ó</button>
                      </div>
                    </div>

                    <div class="replace-row" id="json-replace-row" style="display: none;">
                      <input type="text" id="json-replace-input" class="search-field" placeholder="Replace"
                        autocomplete="off" spellcheck="false">
                      <div class="replace-controls">
                        <button class="replace-btn primary size-XS" id="json-replace-one">Replace</button>
                        <button class="replace-btn primary size-XS" id="json-replace-all">Replace All</button>
                      </div>
                    </div>

                    <button class="toggle-replace-btn" id="json-toggle-replace" title="Toggle Replace">
                      <svg width="10" height="10" viewBox="0 0 12 12" class="replace-chevron">
                        <path d="M3 5l3 3 3-3H3z" fill="currentColor" />
                      </svg>
                    </button>
                  </div>
                </div>

                <!-- JSON Editor Main -->
                <div class="json-editor-main">
                  <div class="line-numbers" id="json-line-numbers">1</div>

                  <!-- Syntax highlighting overlay -->
                  <div class="json-syntax-highlight" id="json-syntax-highlight"></div>

                  <textarea id="json-editor-textarea" class="json-editor-textarea" placeholder='Paste or type your JSON here...
Example:
{
  "colors": {
    "primary": {
      "$value": "#4F46E5",
      "$type": "color"
    },
    "secondary": {
      "$value": "#059669",
      "$type": "color"
    }
  }
}' spellcheck="false" autocomplete="off"></textarea>
                </div>

                <!-- Status Bar -->
                <div class="json-editor-status">
                  <div class="status-left">
                    <span id="json-syntax-status" class="syntax-status valid">‚úì Valid JSON</span>
                  </div>
                  <div class="status-right">
                    <span id="json-cursor-pos" class="cursor-pos">Ln 1, Col 1</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- JSON Export Tab -->
      <div class="tab-content" id="json-export-tab">
        <div class="scrollable-content">
          <div class="main-content-container">
            <div class="left-panel">
              <div class="section">
                <div class="section-header">
                  <h3>Select Collections</h3>
                  <button class="select-all-compact" id="select-all-collections">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path
                        d="M7.24767 15.5805C7.54056 15.2876 8.01544 15.2876 8.30833 15.5805C8.5746 15.8468 8.5988 16.2634 8.38095 16.5571L8.30833 16.6412L6.08633 18.8632C5.82013 19.1294 5.4036 19.1536 5.10999 18.9359L5.02587 18.8634L3.69187 17.5304C3.39887 17.2376 3.39869 16.7627 3.69147 16.4697C3.95764 16.2033 4.37429 16.179 4.66799 16.3967L4.75213 16.4693L5.555 17.2718L7.24767 15.5805Z"
                        fill="currentColor" />
                      <path fill-rule="evenodd" clip-rule="evenodd"
                        d="M5.78198 12.2551L6 12.25C8.53503 12.25 10.6202 14.2409 10.7449 16.782L10.75 17C10.75 19.535 8.75909 21.6202 6.21802 21.7449L6 21.75C3.46497 21.75 1.37981 19.7591 1.25512 17.218L1.25 17C1.25 14.465 3.24091 12.3798 5.78198 12.2551ZM6 13.75L5.8372 13.754C4.11244 13.8388 2.75 15.2657 2.74977 16.9816L2.75399 17.1628C2.83878 18.8876 4.26572 20.25 5.98161 20.2502L6.1628 20.246C7.88756 20.1612 9.25 18.7343 9.25023 17.0184L9.24601 16.8372C9.16122 15.1124 7.73428 13.75 6 13.75Z"
                        fill="currentColor" />
                      <path
                        d="M3.68769 5.47166C3.95296 5.2044 4.36953 5.17863 4.66395 5.39538L4.74834 5.46769L6.08834 6.79769C6.38233 7.08948 6.38411 7.56435 6.09231 7.85834C5.82705 8.1256 5.41048 8.15137 5.11605 7.93462L5.03166 7.86231L3.69166 6.53231C3.39767 6.24052 3.39589 5.76565 3.68769 5.47166Z"
                        fill="currentColor" />
                      <path
                        d="M7.24967 4.57953C7.54256 4.28664 8.01743 4.28664 8.31033 4.57953C8.57659 4.8458 8.6008 5.26246 8.38295 5.55607L8.31033 5.64019L6.09033 7.86019C5.79743 8.15309 5.32256 8.15309 5.02967 7.86019C4.7634 7.59393 4.73919 7.17726 4.95705 6.88365L5.02967 6.79953L7.24967 4.57953Z"
                        fill="currentColor" />
                      <path
                        d="M7.24767 4.58051C7.54056 4.28762 8.01544 4.28762 8.30833 4.58051C8.5746 4.84678 8.5988 5.26344 8.38095 5.55705L8.30833 5.64117L6.08633 7.86317C5.82013 8.12937 5.4036 8.15364 5.10999 7.93594L5.02587 7.86337L3.69187 6.53037C3.39887 6.23759 3.39869 5.76271 3.69147 5.46971C3.95764 5.20334 4.37429 5.17898 4.66799 5.39672L4.75213 5.46931L5.555 6.27184L7.24767 4.58051Z"
                        fill="currentColor" />
                      <path
                        d="M18.2477 4.58051C18.5406 4.28762 19.0154 4.28762 19.3083 4.58051C19.5746 4.84678 19.5988 5.26344 19.3809 5.55705L19.3083 5.64117L17.0863 7.86317C16.8201 8.12937 16.4036 8.15364 16.11 7.93594L16.0259 7.86337L14.6919 6.53037C14.3989 6.23759 14.3987 5.76271 14.6915 5.46971C14.9576 5.20334 15.3743 5.17898 15.668 5.39672L15.7521 5.46931L16.555 6.27184L18.2477 4.58051Z"
                        fill="currentColor" />
                      <path fill-rule="evenodd" clip-rule="evenodd"
                        d="M16.782 1.25512L17 1.25C19.535 1.25 21.6202 3.24091 21.7449 5.78198L21.75 6C21.75 8.53503 19.7591 10.6202 17.218 10.7449L17 10.75C14.465 10.75 12.3798 8.75909 12.2551 6.21802L12.25 6C12.25 3.46497 14.2409 1.37981 16.782 1.25512ZM17 2.75L16.8372 2.75399C15.1124 2.83878 13.75 4.26572 13.7498 5.98161L13.754 6.1628C13.8388 7.88756 15.2657 9.25 16.9816 9.25023L17.1628 9.24601C18.8876 9.16122 20.25 7.73428 20.2502 6.01839L20.246 5.8372C20.1612 4.11244 18.7343 2.75 17 2.75Z"
                        fill="currentColor" />
                      <path fill-rule="evenodd" clip-rule="evenodd"
                        d="M15.3499 21.3035L15.2982 21.1612L13.3224 14.8496C12.9181 13.5612 14.2372 12.4081 15.4608 12.9783L21.3544 15.7285C22.7046 16.3591 22.4778 18.3453 21.0192 18.6549L19.003 19.0801L18.2445 21.2168C17.7614 22.573 15.8811 22.5855 15.3499 21.3035ZM20.7198 17.0877L14.8272 14.3379C14.7846 14.3181 14.74 14.3571 14.7537 14.401L16.7296 20.7125C16.745 20.7615 16.8139 20.7628 16.8313 20.7138L17.7313 18.1828C17.8187 17.937 18.0276 17.7543 18.2828 17.7003L20.7083 17.1874C20.7579 17.1769 20.7657 17.1091 20.7198 17.0877Z"
                        fill="currentColor" />
                      <path fill-rule="evenodd" clip-rule="evenodd"
                        d="M5.78198 1.25512L6 1.25C8.53503 1.25 10.6202 3.24091 10.7449 5.78198L10.75 6C10.75 8.53503 8.75909 10.6202 6.21802 10.7449L6 10.75C3.46497 10.75 1.37981 8.75909 1.25512 6.21802L1.25 6C1.25 3.46497 3.24091 1.37981 5.78198 1.25512ZM6 2.75L5.8372 2.75399C4.11244 2.83878 2.75 4.26572 2.74977 5.98161L2.75399 6.1628C2.83878 7.88756 4.26572 9.25 5.98161 9.25023L6.1628 9.24601C7.88756 9.16122 9.25 7.73428 9.25023 6.01839L9.24601 5.8372C9.16122 4.11244 7.73428 2.75 6 2.75Z"
                        fill="currentColor" />
                    </svg>
                    Select All
                  </button>
                </div>
                <div class="collection-list" id="export-collections">
                  <!-- Collections will be populated here -->
                </div>
              </div>

              <div class="section">
                <div class="section-header">
                  <h3>Select Modes</h3>
                  <button class="select-all-compact" id="select-all-modes">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path
                        d="M7.24767 15.5805C7.54056 15.2876 8.01544 15.2876 8.30833 15.5805C8.5746 15.8468 8.5988 16.2634 8.38095 16.5571L8.30833 16.6412L6.08633 18.8632C5.82013 19.1294 5.4036 19.1536 5.10999 18.9359L5.02587 18.8634L3.69187 17.5304C3.39887 17.2376 3.39869 16.7627 3.69147 16.4697C3.95764 16.2033 4.37429 16.179 4.66799 16.3967L4.75213 16.4693L5.555 17.2718L7.24767 15.5805Z"
                        fill="currentColor" />
                      <path fill-rule="evenodd" clip-rule="evenodd"
                        d="M5.78198 12.2551L6 12.25C8.53503 12.25 10.6202 14.2409 10.7449 16.782L10.75 17C10.75 19.535 8.75909 21.6202 6.21802 21.7449L6 21.75C3.46497 21.75 1.37981 19.7591 1.25512 17.218L1.25 17C1.25 14.465 3.24091 12.3798 5.78198 12.2551ZM6 13.75L5.8372 13.754C4.11244 13.8388 2.75 15.2657 2.74977 16.9816L2.75399 17.1628C2.83878 18.8876 4.26572 20.25 5.98161 20.2502L6.1628 20.246C7.88756 20.1612 9.25 18.7343 9.25023 17.0184L9.24601 16.8372C9.16122 15.1124 7.73428 13.75 6 13.75Z"
                        fill="currentColor" />
                      <path
                        d="M3.68769 5.47166C3.95296 5.2044 4.36953 5.17863 4.66395 5.39538L4.74834 5.46769L6.08834 6.79769C6.38233 7.08948 6.38411 7.56435 6.09231 7.85834C5.82705 8.1256 5.41048 8.15137 5.11605 7.93462L5.03166 7.86231L3.69166 6.53231C3.39767 6.24052 3.39589 5.76565 3.68769 5.47166Z"
                        fill="currentColor" />
                      <path
                        d="M7.24967 4.57953C7.54256 4.28664 8.01743 4.28664 8.31033 4.57953C8.57659 4.8458 8.6008 5.26246 8.38295 5.55607L8.31033 5.64019L6.09033 7.86019C5.79743 8.15309 5.32256 8.15309 5.02967 7.86019C4.7634 7.59393 4.73919 7.17726 4.95705 6.88365L5.02967 6.79953L7.24967 4.57953Z"
                        fill="currentColor" />
                      <path
                        d="M7.24767 4.58051C7.54056 4.28762 8.01544 4.28762 8.30833 4.58051C8.5746 4.84678 8.5988 5.26344 8.38095 5.55705L8.30833 5.64117L6.08633 7.86317C5.82013 8.12937 5.4036 8.15364 5.10999 7.93594L5.02587 7.86337L3.69187 6.53037C3.39887 6.23759 3.39869 5.76271 3.69147 5.46971C3.95764 5.20334 4.37429 5.17898 4.66799 5.39672L4.75213 5.46931L5.555 6.27184L7.24767 4.58051Z"
                        fill="currentColor" />
                      <path
                        d="M18.2477 4.58051C18.5406 4.28762 19.0154 4.28762 19.3083 4.58051C19.5746 4.84678 19.5988 5.26344 19.3809 5.55705L19.3083 5.64117L17.0863 7.86317C16.8201 8.12937 16.4036 8.15364 16.11 7.93594L16.0259 7.86337L14.6919 6.53037C14.3989 6.23759 14.3987 5.76271 14.6915 5.46971C14.9576 5.20334 15.3743 5.17898 15.668 5.39672L15.7521 5.46931L16.555 6.27184L18.2477 4.58051Z"
                        fill="currentColor" />
                      <path fill-rule="evenodd" clip-rule="evenodd"
                        d="M16.782 1.25512L17 1.25C19.535 1.25 21.6202 3.24091 21.7449 5.78198L21.75 6C21.75 8.53503 19.7591 10.6202 17.218 10.7449L17 10.75C14.465 10.75 12.3798 8.75909 12.2551 6.21802L12.25 6C12.25 3.46497 14.2409 1.37981 16.782 1.25512ZM17 2.75L16.8372 2.75399C15.1124 2.83878 13.75 4.26572 13.7498 5.98161L13.754 6.1628C13.8388 7.88756 15.2657 9.25 16.9816 9.25023L17.1628 9.24601C18.8876 9.16122 20.25 7.73428 20.2502 6.01839L20.246 5.8372C20.1612 4.11244 18.7343 2.75 17 2.75Z"
                        fill="currentColor" />
                      <path fill-rule="evenodd" clip-rule="evenodd"
                        d="M15.3499 21.3035L15.2982 21.1612L13.3224 14.8496C12.9181 13.5612 14.2372 12.4081 15.4608 12.9783L21.3544 15.7285C22.7046 16.3591 22.4778 18.3453 21.0192 18.6549L19.003 19.0801L18.2445 21.2168C17.7614 22.573 15.8811 22.5855 15.3499 21.3035ZM20.7198 17.0877L14.8272 14.3379C14.7846 14.3181 14.74 14.3571 14.7537 14.401L16.7296 20.7125C16.745 20.7615 16.8139 20.7628 16.8313 20.7138L17.7313 18.1828C17.8187 17.937 18.0276 17.7543 18.2828 17.7003L20.7083 17.1874C20.7579 17.1769 20.7657 17.1091 20.7198 17.0877Z"
                        fill="currentColor" />
                      <path fill-rule="evenodd" clip-rule="evenodd"
                        d="M5.78198 1.25512L6 1.25C8.53503 1.25 10.6202 3.24091 10.7449 5.78198L10.75 6C10.75 8.53503 8.75909 10.6202 6.21802 10.7449L6 10.75C3.46497 10.75 1.37981 8.75909 1.25512 6.21802L1.25 6C1.25 3.46497 3.24091 1.37981 5.78198 1.25512ZM6 2.75L5.8372 2.75399C4.11244 2.83878 2.75 4.26572 2.74977 5.98161L2.75399 6.1628C2.83878 7.88756 4.26572 9.25 5.98161 9.25023L6.1628 9.24601C7.88756 9.16122 9.25 7.73428 9.25023 6.01839L9.24601 5.8372C9.16122 4.11244 7.73428 2.75 6 2.75Z"
                        fill="currentColor" />
                    </svg>

                    Select All
                  </button>
                </div>
                <div class="mode-list" id="modes-list">
                  <!-- Modes will be populated here -->
                </div>
              </div>

              <div class="section">
                <div class="section-header">
                  <h3>Variable Types</h3>
                </div>
                <div class="collection-list" id="types-list">
                  <!-- Variable types will be populated here -->
                </div>
              </div>

              <div class="section">
                <div class="section-header">
                  <h3>Export Options</h3>
                </div>

                <div class="form-group">
                  <label class="form-label">JSON Format</label>
                  <div class="custom-select" id="export-format-select">
                    <button class="custom-select-trigger" type="button">
                      <span class="custom-select-value">W3C Design Tokens</span>
                      <svg class="custom-select-arrow" width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                        <path
                          d="M4.427 6.427a.6.6 0 0 1 .849 0L8 9.151l2.724-2.724a.6.6 0 1 1 .849.849l-3.148 3.148a.6.6 0 0 1-.849 0L4.427 7.276a.6.6 0 0 1 0-.849Z" />
                      </svg>
                    </button>
                    <div class="custom-select-dropdown">
                      <button class="custom-select-option selected" data-value="w3c">W3C Design Tokens</button>
                    </div>
                  </div>
                  <input type="hidden" id="export-format" value="w3c">
                  <div class="form-help">Choose JSON output format</div>
                </div>


                <div class="form-group">
                  <label class="form-label">File Organization</label>
                  <div class="radio-group">
                    <label class="radio-item">
                      <input type="radio" name="json-export-type" value="combined" checked>
                      <span class="radio-indicator"></span>
                      <span>Single JSON file (all collections/modes combined)</span>
                    </label>
                    <label class="radio-item">
                      <input type="radio" name="json-export-type" value="separate">
                      <span class="radio-indicator"></span>
                      <span>Separate files per collection-mode</span>
                    </label>
                    <label class="radio-item">
                      <input type="radio" name="json-export-type" value="by-collection">
                      <span class="radio-indicator"></span>
                      <span>Separate files per collection (all modes within)</span>
                    </label>
                  </div>
                </div>

                <div class="form-group">
                  <label class="form-label">Additional Metadata (Optional)</label>
                  <label class="collection-item">
                    <input type="checkbox" id="include-description">
                    <span class="checkbox-indicator"></span>
                    <span>Variable Description</span>
                  </label>


                  <label class="collection-item">
                    <input type="checkbox" id="include-code-syntax">
                    <span class="checkbox-indicator"></span>
                    <span>Code Syntax</span>


                  </label>
                </div>
              </div>

            </div>

            <div class="panel-separator"></div>

            <div class="right-panel">
              <!-- Get Code Dropdown -->
              <div class="get-code-container" id="get-code-container-json">
                <button class="button secondary size-M get-code-trigger" id="get-code-trigger-json">
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path
                      d="M13.0479 3.83727C13.1379 3.43294 13.5386 3.1781 13.9429 3.26806C14.3135 3.35053 14.5586 3.6941 14.5275 4.06222L14.5121 4.16305L10.9521 20.1631C10.8621 20.5674 10.4614 20.8222 10.0571 20.7323C9.68649 20.6498 9.44146 20.3062 9.47249 19.9381L9.48791 19.8373L13.0479 3.83727Z"
                      fill="currentColor" />
                    <path
                      d="M17.4697 7.46967C17.7359 7.2034 18.1526 7.1792 18.4462 7.39705L18.5303 7.46967L22.5303 11.4697C22.7966 11.7359 22.8208 12.1526 22.6029 12.4462L22.5303 12.5303L18.5303 16.5303C18.2374 16.8232 17.7626 16.8232 17.4697 16.5303C17.2034 16.2641 17.1792 15.8474 17.3971 15.5538L17.4697 15.4697L20.939 12L17.4697 8.53033C17.2034 8.26406 17.1792 7.8474 17.3971 7.55379L17.4697 7.46967Z"
                      fill="currentColor" />
                    <path
                      d="M5.46967 7.46967C5.76256 7.17678 6.23744 7.17678 6.53033 7.46967C6.7966 7.73594 6.8208 8.1526 6.60295 8.44621L6.53033 8.53033L3.061 12L6.53033 15.4697C6.7966 15.7359 6.8208 16.1526 6.60295 16.4462L6.53033 16.5303C6.26406 16.7966 5.8474 16.8208 5.55379 16.6029L5.46967 16.5303L1.46967 12.5303C1.2034 12.2641 1.1792 11.8474 1.39705 11.5538L1.46967 11.4697L5.46967 7.46967Z"
                      fill="currentColor" />
                  </svg>
                  <span>Get Code</span>
                  <svg class="get-code-chevron" width="16" height="16" viewBox="0 0 16 16" fill="currentColor"
                    xmlns="http://www.w3.org/2000/svg">
                    <path
                      d="M4.427 6.427a.6.6 0 0 1 .849 0L8 9.151l2.724-2.724a.6.6 0 1 1 .849.849l-3.148 3.148a.6.6 0 0 1-.849 0L4.427 7.276a.6.6 0 0 1 0-.849Z" />
                  </svg>
                </button>
                <div class="get-code-menu" id="get-code-menu-json">
                  <button class="get-code-item" id="copy-json-button">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path
                        d="M18.9998 2.25C19.7293 2.2498 20.4289 2.53949 20.9447 3.0553C21.4605 3.5711 21.7502 4.27075 21.75 5.00021C21.7499 5.41442 21.414 5.75011 20.9998 5.75C20.6201 5.7499 20.3064 5.46766 20.2568 5.10157L20.25 4.99979C20.2501 4.6683 20.1184 4.35036 19.884 4.11596C19.6831 3.91504 19.4208 3.78962 19.1412 3.75794L19.0002 3.75C18.586 3.75011 18.2501 3.41442 18.25 3.00021C18.2499 2.58599 18.5856 2.25011 18.9998 2.25Z"
                        fill="currentColor" />
                      <path
                        d="M21 11.25C21.3797 11.25 21.6935 11.5322 21.7432 11.8982L21.75 12V13C21.75 13.4142 21.4142 13.75 21 13.75C20.6203 13.75 20.3065 13.4678 20.2568 13.1018L20.25 13V12C20.25 11.5858 20.5858 11.25 21 11.25Z"
                        fill="currentColor" />
                      <path
                        d="M21 7.25C21.3797 7.25 21.6935 7.53215 21.7432 7.89823L21.75 8V9C21.75 9.41421 21.4142 9.75 21 9.75C20.6203 9.75 20.3065 9.46785 20.2568 9.10177L20.25 9V8C20.25 7.58579 20.5858 7.25 21 7.25Z"
                        fill="currentColor" />
                      <path
                        d="M20.9998 15.25C21.414 15.2499 21.7499 15.5856 21.75 15.9998C21.7502 16.7293 21.4605 17.4289 20.9447 17.9447C20.4289 18.4605 19.7293 18.7502 18.9998 18.75C18.5856 18.7499 18.2499 18.414 18.25 17.9998C18.2501 17.6201 18.5323 17.3064 18.8984 17.2568L19.0002 17.25C19.3317 17.2501 19.6496 17.1184 19.884 16.884C20.085 16.6831 20.2104 16.4208 20.2421 16.1412L20.25 16.0002C20.2499 15.586 20.5856 15.2501 20.9998 15.25Z"
                        fill="currentColor" />
                      <path
                        d="M8.00021 2.25C8.41442 2.25011 8.75011 2.58599 8.75 3.00021C8.7499 3.3799 8.46766 3.69362 8.10157 3.74318L7.99979 3.75C7.6683 3.74991 7.35036 3.88155 7.11596 4.11596C6.91504 4.31687 6.78962 4.57916 6.75794 4.85876L6.75 4.99979C6.75011 5.41401 6.41442 5.74989 6.00021 5.75C5.58599 5.75011 5.25011 5.41442 5.25 5.00021C5.2498 4.27074 5.53949 3.5711 6.0553 3.0553C6.5711 2.53949 7.27074 2.2498 8.00021 2.25Z"
                        fill="currentColor" />
                      <path
                        d="M16 2.25C16.4142 2.25 16.75 2.58579 16.75 3C16.75 3.3797 16.4678 3.69349 16.1018 3.74315L16 3.75H15C14.5858 3.75 14.25 3.41421 14.25 3C14.25 2.6203 14.5322 2.30651 14.8982 2.25685L15 2.25H16Z"
                        fill="currentColor" />
                      <path
                        d="M12 2.25C12.4142 2.25 12.75 2.58579 12.75 3C12.75 3.3797 12.4678 3.69349 12.1018 3.74315L12 3.75H11C10.5858 3.75 10.25 3.41421 10.25 3C10.25 2.6203 10.5322 2.30651 10.8982 2.25685L11 2.25H12Z"
                        fill="currentColor" />
                      <path fill-rule="evenodd" clip-rule="evenodd"
                        d="M5 7.25H13.9998C14.7293 7.2498 15.4289 7.53949 15.9447 8.0553C16.4605 8.5711 16.7502 9.27075 16.75 10V18.9998C16.7502 19.7293 16.4605 20.4289 15.9447 20.9447C15.4289 21.4605 14.7293 21.7502 14 21.75H5.00021C4.27074 21.7502 3.5711 21.4605 3.0553 20.9447C2.53949 20.4289 2.2498 19.7293 2.25 19V10.0002C2.2498 9.27075 2.53949 8.5711 3.0553 8.0553C3.5711 7.53949 4.27074 7.2498 5 7.25ZM14.0002 8.75H4.99979C4.6683 8.74991 4.35036 8.88155 4.11596 9.11596C3.88155 9.35036 3.74991 9.6683 3.75 10L3.75 19.0002C3.74991 19.3317 3.88155 19.6496 4.11596 19.884C4.35036 20.1184 4.6683 20.2501 5 20.25H14.0002C14.3317 20.2501 14.6496 20.1184 14.884 19.884C15.1184 19.6496 15.2501 19.3317 15.25 19V9.99979C15.2501 9.6683 15.1184 9.35036 14.884 9.11596C14.6496 8.88155 14.3317 8.74991 14.0002 8.75Z"
                        fill="currentColor" />
                      <path
                        d="M13 10.75C13.4142 10.75 13.75 11.0858 13.75 11.5C13.75 11.8797 13.4678 12.1935 13.1018 12.2432L13 12.25H6C5.58579 12.25 5.25 11.9142 5.25 11.5C5.25 11.1203 5.53215 10.8065 5.89823 10.7568L6 10.75H13Z"
                        fill="currentColor" />
                      <path
                        d="M9 16.75C9.41421 16.75 9.75 17.0858 9.75 17.5C9.75 17.8797 9.46785 18.1935 9.10177 18.2432L9 18.25H6C5.58579 18.25 5.25 17.9142 5.25 17.5C5.25 17.1203 5.53215 16.8065 5.89823 16.7568L6 16.75H9Z"
                        fill="currentColor" />
                      <path
                        d="M13 13.75C13.4142 13.75 13.75 14.0858 13.75 14.5C13.75 14.8797 13.4678 15.1935 13.1018 15.2432L13 15.25H6C5.58579 15.25 5.25 14.9142 5.25 14.5C5.25 14.1203 5.53215 13.8065 5.89823 13.7568L6 13.75H13Z"
                        fill="currentColor" />
                    </svg>
                    <div class="get-code-item-text">
                      <div class="get-code-item-title">Copy to Clipboard</div>
                      <div class="get-code-item-desc">Copy the generated code to clipboard.</div>
                    </div>
                  </button>
                  <button class="get-code-item" id="download-json-button">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path
                        d="M12 2.25C17.3848 2.25 21.75 6.61523 21.75 12C21.75 17.3848 17.3848 21.75 12 21.75C11.5858 21.75 11.25 21.4142 11.25 21C11.25 20.5858 11.5858 20.25 12 20.25C16.5564 20.25 20.25 16.5563 20.25 12C20.25 7.44365 16.5564 3.75 12 3.75C11.5858 3.75 11.25 3.41421 11.25 3C11.25 2.58579 11.5858 2.25 12 2.25Z"
                        fill="currentColor" />
                      <path
                        d="M5.64168 18.4109C5.9074 18.0931 6.3804 18.0509 6.69815 18.3167C7.43586 18.9336 8.27588 19.4166 9.18018 19.7437C9.56968 19.8847 9.7712 20.3147 9.63028 20.7042C9.48935 21.0937 9.05936 21.2952 8.66985 21.1543C7.6009 20.7675 6.60792 20.1966 5.73588 19.4673C5.41813 19.2016 5.37596 18.7286 5.64168 18.4109Z"
                        fill="currentColor" />
                      <path
                        d="M8.67043 2.84553C9.06006 2.70493 9.48988 2.9068 9.63049 3.29642C9.77109 3.68604 9.56921 4.11587 9.17959 4.25647C8.27535 4.58278 7.43555 5.06563 6.69862 5.68294C6.38109 5.94892 5.90806 5.90714 5.64208 5.58961C5.37609 5.27208 5.41788 4.79905 5.73541 4.53306C6.60721 3.80278 7.6007 3.23156 8.67043 2.84553Z"
                        fill="currentColor" />
                      <path
                        d="M3.56148 7.12503C3.76857 6.7663 4.22725 6.64337 4.58598 6.85046C4.94471 7.05755 5.06764 7.51624 4.86055 7.87497C4.37953 8.70822 4.04858 9.61949 3.8828 10.5672C3.81142 10.9753 3.4228 11.2482 3.01478 11.1768C2.60676 11.1054 2.33386 10.7168 2.40523 10.3088C2.60128 9.18801 2.99264 8.1104 3.56148 7.12503Z"
                        fill="currentColor" />
                      <path
                        d="M3.01483 12.8222C3.42285 12.7509 3.81146 13.0238 3.8828 13.4318C4.04859 14.3799 4.37955 15.2915 4.86061 16.1251C5.06764 16.4839 4.94464 16.9426 4.58588 17.1496C4.22712 17.3566 3.76845 17.2336 3.56142 16.8749C2.99259 15.8892 2.60125 14.8112 2.40522 13.6902C2.33388 13.2822 2.60681 12.8936 3.01483 12.8222Z"
                        fill="currentColor" />
                      <path
                        d="M12 7.25C12.3797 7.25 12.6935 7.53215 12.7432 7.89823L12.75 8V16C12.75 16.4142 12.4142 16.75 12 16.75C11.6203 16.75 11.3065 16.4678 11.2569 16.1018L11.25 16V8C11.25 7.58579 11.5858 7.25 12 7.25Z"
                        fill="currentColor" />
                      <path
                        d="M8.46968 12.4697C8.73595 12.2034 9.15262 12.1792 9.44623 12.3971L9.53034 12.4697L12 14.939L14.4697 12.4697C14.736 12.2034 15.1526 12.1792 15.4462 12.3971L15.5303 12.4697C15.7966 12.7359 15.8208 13.1526 15.603 13.4462L15.5303 13.5303L12.5303 16.5303C12.2641 16.7966 11.8474 16.8208 11.5538 16.6029L11.4697 16.5303L8.46968 13.5303C8.17679 13.2374 8.17679 12.7626 8.46968 12.4697Z"
                        fill="currentColor" />
                    </svg>
                    <div class="get-code-item-text">
                      <div class="get-code-item-title">Download File (or ZIP)</div>
                      <div class="get-code-item-desc">Save generated files to your computer.</div>
                    </div>
                  </button>
                  <button class="get-code-item" id="push-github-json-button">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path fill-rule="evenodd" clip-rule="evenodd" d="M12 2C6.477 2 2 6.477 2 12c0 4.42 2.87 8.17 6.84 9.5.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34-.46-1.16-1.11-1.47-1.11-1.47-.91-.62.07-.6.07-.6 1 .07 1.53 1.03 1.53 1.03.87 1.52 2.34 1.07 2.91.83.09-.65.35-1.09.63-1.34-2.22-.25-4.55-1.11-4.55-4.92 0-1.11.38-2 1.03-2.71-.1-.25-.45-1.29.1-2.64 0 0 .84-.27 2.75 1.02.79-.22 1.65-.33 2.5-.33.85 0 1.71.11 2.5.33 1.91-1.29 2.75-1.02 2.75-1.02.55 1.35.2 2.39.1 2.64.65.71 1.03 1.6 1.03 2.71 0 3.82-2.34 4.66-4.57 4.91.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0012 2z" fill="currentColor"/>
                    </svg>
                    <div class="get-code-item-text">
                      <div class="get-code-item-title">Push to GitHub</div>
                      <div class="get-code-item-desc">Upload to configured repository.</div>
                    </div>
                  </button>
                </div>
              </div>
              <textarea id="json-export-textarea" placeholder='Export results will appear here...'></textarea>
            </div>
          </div>
        </div>
      </div>


      <!-- Export Text Styles Tab -->
      <div class="tab-content" id="text-styles-export-tab">
        <div class="scrollable-content">
          <div class="main-content-container">
            <div class="left-panel">


              <!-- Brand Filter Section -->
              <div class="section">
                <div class="section-header">
                  <h3>Brand Filter</h3>
                </div>
                <div class="collection-list" id="brand-filter-list">
                  <!-- Brand filter options will be populated here -->
                </div>
              </div>

              <!-- Properties Selection Section -->
              <div class="section">
                <div class="section-title">
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path
                      d="M11.2 13.07C11.6142 13.07 11.95 13.4058 11.95 13.82C11.95 14.1997 11.6679 14.5135 11.3018 14.5632L11.2 14.57H6.51001C6.0958 14.57 5.76001 14.2342 5.76001 13.82C5.76001 13.4403 6.04216 13.1265 6.40824 13.0769L6.51001 13.07H11.2Z"
                      fill="currentColor" />
                    <path
                      d="M8.17135 8.08294C8.33542 7.70261 8.77674 7.52729 9.15708 7.69135C9.50572 7.84175 9.68209 8.22512 9.58269 8.58092L9.54867 8.67708L6.68867 15.3071C6.5246 15.6874 6.08328 15.8627 5.70294 15.6987C5.3543 15.5483 5.17793 15.1649 5.27733 14.8091L5.31135 14.7129L8.17135 8.08294Z"
                      fill="currentColor" />
                    <path
                      d="M8.5638 7.69098C8.91263 7.54103 9.31235 7.67632 9.50255 7.99303L9.54903 8.08382L12.399 14.7138C12.5626 15.0944 12.3867 15.5355 12.0062 15.699C11.6574 15.849 11.2576 15.7137 11.0674 15.397L11.021 15.3062L8.17096 8.67621C8.00738 8.29566 8.18326 7.85456 8.5638 7.69098Z"
                      fill="currentColor" />
                    <path
                      d="M17.75 10.25C18.1297 10.25 18.4435 10.5322 18.4932 10.8982L18.5 11V15C18.5 15.4142 18.1642 15.75 17.75 15.75C17.3703 15.75 17.0565 15.4678 17.0068 15.1018L17 15V11C17 10.5858 17.3358 10.25 17.75 10.25Z"
                      fill="currentColor" />
                    <path
                      d="M13.7866 11.0486C14.8648 9.97043 16.6127 9.9706 17.6909 11.0486C18.7692 12.1268 18.7692 13.8746 17.6909 14.9529C16.6127 16.0311 14.8649 16.0311 13.7866 14.9529C12.7086 13.8746 12.7085 12.1267 13.7866 11.0486ZM16.5278 12.0173C16.0327 11.6193 15.3067 11.6496 14.8472 12.1091C14.3548 12.6015 14.355 13.3999 14.8472 13.8923C15.3396 14.3848 16.1379 14.3848 16.6304 13.8923C17.09 13.4327 17.1205 12.7068 16.7222 12.2117L16.6304 12.1091L16.5278 12.0173Z"
                      fill="currentColor" />
                  </svg>
                  Export Properties
                </div>

                <!-- Select All / Deselect All -->
                <div style="margin-bottom: 16px; display: flex; gap: 6px;">
                  <button id="select-all-properties" class="button secondary size-S"
                    style="flex: 1; font-size: 11px; padding: 5px 10px; min-height: 24px;">All</button>
                  <button id="deselect-all-properties" class="button secondary size-S"
                    style="flex: 1; font-size: 11px; padding: 5px 10px; min-height: 24px;">None</button>
                </div>

                <!-- Property Categories Container -->
                <div style="display: flex; flex-direction: column; gap: 16px;">

                  <!-- Basic Info -->
                  <div style="display: flex; flex-direction: column; gap: 6px;">
                    <div
                      style="font-weight: 600; font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--figma-color-text-tertiary); margin-bottom: 2px;">
                      Basic Info</div>
                    <label class="checkbox-item">
                      <input type="checkbox" name="text-style-prop" value="id" checked>
                      <span class="checkbox-indicator"></span>
                      <span style="font-size: 11px;">ID</span>
                    </label>
                    <label class="checkbox-item">
                      <input type="checkbox" name="text-style-prop" value="name" checked>
                      <span class="checkbox-indicator"></span>
                      <span style="font-size: 11px;">Name</span>
                    </label>
                    <label class="checkbox-item">
                      <input type="checkbox" name="text-style-prop" value="description" checked>
                      <span class="checkbox-indicator"></span>
                      <span style="font-size: 11px;">Description</span>
                    </label>
                  </div>

                  <!-- Font Properties -->
                  <div style="display: flex; flex-direction: column; gap: 6px;">
                    <div
                      style="font-weight: 600; font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--figma-color-text-tertiary); margin-bottom: 2px;">
                      Font</div>
                    <label class="checkbox-item">
                      <input type="checkbox" name="text-style-prop" value="fontFamily" checked>
                      <span class="checkbox-indicator"></span>
                      <span style="font-size: 11px;">Font Family</span>
                    </label>
                    <label class="checkbox-item">
                      <input type="checkbox" name="text-style-prop" value="fontStyle" checked>
                      <span class="checkbox-indicator"></span>
                      <span style="font-size: 11px;">Font Style</span>
                    </label>
                    <label class="checkbox-item">
                      <input type="checkbox" name="text-style-prop" value="fontSize" checked>
                      <span class="checkbox-indicator"></span>
                      <span style="font-size: 11px;">Font Size</span>
                    </label>
                  </div>

                  <!-- Spacing Properties -->
                  <div style="display: flex; flex-direction: column; gap: 6px;">
                    <div
                      style="font-weight: 600; font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--figma-color-text-tertiary); margin-bottom: 2px;">
                      Spacing</div>
                    <label class="checkbox-item">
                      <input type="checkbox" name="text-style-prop" value="letterSpacing" checked>
                      <span class="checkbox-indicator"></span>
                      <span style="font-size: 11px;">Letter Spacing</span>
                    </label>
                    <label class="checkbox-item">
                      <input type="checkbox" name="text-style-prop" value="lineHeight" checked>
                      <span class="checkbox-indicator"></span>
                      <span style="font-size: 11px;">Line Height</span>
                    </label>
                    <label class="checkbox-item">
                      <input type="checkbox" name="text-style-prop" value="paragraphSpacing">
                      <span class="checkbox-indicator"></span>
                      <span style="font-size: 11px;">Paragraph Spacing</span>
                    </label>
                    <label class="checkbox-item">
                      <input type="checkbox" name="text-style-prop" value="paragraphIndent">
                      <span class="checkbox-indicator"></span>
                      <span style="font-size: 11px;">Paragraph Indent</span>
                    </label>
                    <label class="checkbox-item">
                      <input type="checkbox" name="text-style-prop" value="listSpacing">
                      <span class="checkbox-indicator"></span>
                      <span style="font-size: 11px;">List Spacing</span>
                    </label>
                  </div>

                  <!-- Formatting -->
                  <div style="display: flex; flex-direction: column; gap: 6px;">
                    <div
                      style="font-weight: 600; font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--figma-color-text-tertiary); margin-bottom: 2px;">
                      Formatting</div>
                    <label class="checkbox-item">
                      <input type="checkbox" name="text-style-prop" value="textCase">
                      <span class="checkbox-indicator"></span>
                      <span style="font-size: 11px;">Text Case</span>
                    </label>
                    <label class="checkbox-item">
                      <input type="checkbox" name="text-style-prop" value="textDecoration">
                      <span class="checkbox-indicator"></span>
                      <span style="font-size: 11px;">Text Decoration</span>
                    </label>
                  </div>

                  <!-- Alignment -->
                  <div style="display: flex; flex-direction: column; gap: 6px;">
                    <div
                      style="font-weight: 600; font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--figma-color-text-tertiary); margin-bottom: 2px;">
                      Alignment</div>
                    <label class="checkbox-item">
                      <input type="checkbox" name="text-style-prop" value="textAlignHorizontal" checked>
                      <span class="checkbox-indicator"></span>
                      <span style="font-size: 11px;">Horizontal</span>
                    </label>
                    <label class="checkbox-item">
                      <input type="checkbox" name="text-style-prop" value="textAlignVertical" checked>
                      <span class="checkbox-indicator"></span>
                      <span style="font-size: 11px;">Vertical</span>
                    </label>
                  </div>

                  <!-- Auto-Resize & Truncation -->
                  <div style="display: flex; flex-direction: column; gap: 6px;">
                    <div
                      style="font-weight: 600; font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--figma-color-text-tertiary); margin-bottom: 2px;">
                      Behavior</div>
                    <label class="checkbox-item">
                      <input type="checkbox" name="text-style-prop" value="textAutoResize" checked>
                      <span class="checkbox-indicator"></span>
                      <span style="font-size: 11px;">Auto Resize</span>
                    </label>
                    <label class="checkbox-item">
                      <input type="checkbox" name="text-style-prop" value="textTruncation" checked>
                      <span class="checkbox-indicator"></span>
                      <span style="font-size: 11px;">Truncation</span>
                    </label>
                    <label class="checkbox-item">
                      <input type="checkbox" name="text-style-prop" value="maxLines">
                      <span class="checkbox-indicator"></span>
                      <span style="font-size: 11px;">Max Lines</span>
                    </label>
                  </div>

                  <!-- Advanced -->
                  <div style="display: flex; flex-direction: column; gap: 6px;">
                    <div
                      style="font-weight: 600; font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--figma-color-text-tertiary); margin-bottom: 2px;">
                      Advanced</div>
                    <label class="checkbox-item">
                      <input type="checkbox" name="text-style-prop" value="hangingPunctuation">
                      <span class="checkbox-indicator"></span>
                      <span style="font-size: 11px;">Hanging Punctuation</span>
                    </label>
                    <label class="checkbox-item">
                      <input type="checkbox" name="text-style-prop" value="hangingList">
                      <span class="checkbox-indicator"></span>
                      <span style="font-size: 11px;">Hanging List</span>
                    </label>
                    <label class="checkbox-item">
                      <input type="checkbox" name="text-style-prop" value="leadingTrim" checked>
                      <span class="checkbox-indicator"></span>
                      <span style="font-size: 11px;">Leading Trim</span>
                    </label>
                    <label class="checkbox-item">
                      <input type="checkbox" name="text-style-prop" value="hyperlink">
                      <span class="checkbox-indicator"></span>
                      <span style="font-size: 11px;">Hyperlink</span>
                    </label>
                  </div>

                </div>
              </div>

            </div>

            <div class="panel-separator"></div>

            <div class="right-panel">
              <!-- Get Code Dropdown -->
              <div class="get-code-container" id="get-code-container-text-styles">
                <button class="button secondary size-M" id="get-code-trigger-text-styles">
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path
                      d="M13.0479 3.83727C13.1379 3.43294 13.5386 3.1781 13.9429 3.26806C14.3135 3.35053 14.5586 3.6941 14.5275 4.06222L14.5121 4.16305L10.9521 20.1631C10.8621 20.5674 10.4614 20.8222 10.0571 20.7323C9.68649 20.6498 9.44146 20.3062 9.47249 19.9381L9.48791 19.8373L13.0479 3.83727Z"
                      fill="currentColor" />
                    <path
                      d="M17.4697 7.46967C17.7359 7.2034 18.1526 7.1792 18.4462 7.39705L18.5303 7.46967L22.5303 11.4697C22.7966 11.7359 22.8208 12.1526 22.6029 12.4462L22.5303 12.5303L18.5303 16.5303C18.2374 16.8232 17.7626 16.8232 17.4697 16.5303C17.2034 16.2641 17.1792 15.8474 17.3971 15.5538L17.4697 15.4697L20.939 12L17.4697 8.53033C17.2034 8.26406 17.1792 7.8474 17.3971 7.55379L17.4697 7.46967Z"
                      fill="currentColor" />
                    <path
                      d="M5.46967 7.46967C5.76256 7.17678 6.23744 7.17678 6.53033 7.46967C6.7966 7.73594 6.8208 8.1526 6.60295 8.44621L6.53033 8.53033L3.061 12L6.53033 15.4697C6.7966 15.7359 6.8208 16.1526 6.60295 16.4462L6.53033 16.5303C6.26406 16.7966 5.8474 16.8208 5.55379 16.6029L5.46967 16.5303L1.46967 12.5303C1.2034 12.2641 1.1792 11.8474 1.39705 11.5538L1.46967 11.4697L5.46967 7.46967Z"
                      fill="currentColor" />
                  </svg>
                  <span>Get Code</span>
                  <svg class="get-code-chevron" width="16" height="16" viewBox="0 0 16 16" fill="currentColor"
                    xmlns="http://www.w3.org/2000/svg">
                    <path
                      d="M4.427 6.427a.6.6 0 0 1 .849 0L8 9.151l2.724-2.724a.6.6 0 1 1 .849.849l-3.148 3.148a.6.6 0 0 1-.849 0L4.427 7.276a.6.6 0 0 1 0-.849Z" />
                  </svg>
                </button>
                <div class="get-code-menu" id="get-code-menu-text-styles">
                  <button class="get-code-item" id="copy-text-styles-button">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path
                        d="M18.9998 2.25C19.7293 2.2498 20.4289 2.53949 20.9447 3.0553C21.4605 3.5711 21.7502 4.27075 21.75 5.00021C21.7499 5.41442 21.414 5.75011 20.9998 5.75C20.6201 5.7499 20.3064 5.46766 20.2568 5.10157L20.25 4.99979C20.2501 4.6683 20.1184 4.35036 19.884 4.11596C19.6831 3.91504 19.4208 3.78962 19.1412 3.75794L19.0002 3.75C18.586 3.75011 18.2501 3.41442 18.25 3.00021C18.2499 2.58599 18.5856 2.25011 18.9998 2.25Z"
                        fill="currentColor" />
                      <path
                        d="M21 11.25C21.3797 11.25 21.6935 11.5322 21.7432 11.8982L21.75 12V13C21.75 13.4142 21.4142 13.75 21 13.75C20.6203 13.75 20.3065 13.4678 20.2568 13.1018L20.25 13V12C20.25 11.5858 20.5858 11.25 21 11.25Z"
                        fill="currentColor" />
                      <path
                        d="M21 7.25C21.3797 7.25 21.6935 7.53215 21.7432 7.89823L21.75 8V9C21.75 9.41421 21.4142 9.75 21 9.75C20.6203 9.75 20.3065 9.46785 20.2568 9.10177L20.25 9V8C20.25 7.58579 20.5858 7.25 21 7.25Z"
                        fill="currentColor" />
                      <path
                        d="M20.9998 15.25C21.414 15.2499 21.7499 15.5856 21.75 15.9998C21.7502 16.7293 21.4605 17.4289 20.9447 17.9447C20.4289 18.4605 19.7293 18.7502 18.9998 18.75C18.5856 18.7499 18.2499 18.414 18.25 17.9998C18.2501 17.6201 18.5323 17.3064 18.8984 17.2568L19.0002 17.25C19.3317 17.2501 19.6496 17.1184 19.884 16.884C20.085 16.6831 20.2104 16.4208 20.2421 16.1412L20.25 16.0002C20.2499 15.586 20.5856 15.2501 20.9998 15.25Z"
                        fill="currentColor" />
                      <path
                        d="M8.00021 2.25C8.41442 2.25011 8.75011 2.58599 8.75 3.00021C8.7499 3.3799 8.46766 3.69362 8.10157 3.74318L7.99979 3.75C7.6683 3.74991 7.35036 3.88155 7.11596 4.11596C6.91504 4.31687 6.78962 4.57916 6.75794 4.85876L6.75 4.99979C6.75011 5.41401 6.41442 5.74989 6.00021 5.75C5.58599 5.75011 5.25011 5.41442 5.25 5.00021C5.2498 4.27074 5.53949 3.5711 6.0553 3.0553C6.5711 2.53949 7.27074 2.2498 8.00021 2.25Z"
                        fill="currentColor" />
                      <path
                        d="M16 2.25C16.4142 2.25 16.75 2.58579 16.75 3C16.75 3.3797 16.4678 3.69349 16.1018 3.74315L16 3.75H15C14.5858 3.75 14.25 3.41421 14.25 3C14.25 2.6203 14.5322 2.30651 14.8982 2.25685L15 2.25H16Z"
                        fill="currentColor" />
                      <path
                        d="M12 2.25C12.4142 2.25 12.75 2.58579 12.75 3C12.75 3.3797 12.4678 3.69349 12.1018 3.74315L12 3.75H11C10.5858 3.75 10.25 3.41421 10.25 3C10.25 2.6203 10.5322 2.30651 10.8982 2.25685L11 2.25H12Z"
                        fill="currentColor" />
                      <path fill-rule="evenodd" clip-rule="evenodd"
                        d="M5 7.25H13.9998C14.7293 7.2498 15.4289 7.53949 15.9447 8.0553C16.4605 8.5711 16.7502 9.27075 16.75 10V18.9998C16.7502 19.7293 16.4605 20.4289 15.9447 20.9447C15.4289 21.4605 14.7293 21.7502 14 21.75H5.00021C4.27074 21.7502 3.5711 21.4605 3.0553 20.9447C2.53949 20.4289 2.2498 19.7293 2.25 19V10.0002C2.2498 9.27075 2.53949 8.5711 3.0553 8.0553C3.5711 7.53949 4.27074 7.2498 5 7.25ZM14.0002 8.75H4.99979C4.6683 8.74991 4.35036 8.88155 4.11596 9.11596C3.88155 9.35036 3.74991 9.6683 3.75 10L3.75 19.0002C3.74991 19.3317 3.88155 19.6496 4.11596 19.884C4.35036 20.1184 4.6683 20.2501 5 20.25H14.0002C14.3317 20.2501 14.6496 20.1184 14.884 19.884C15.1184 19.6496 15.2501 19.3317 15.25 19V9.99979C15.2501 9.6683 15.1184 9.35036 14.884 9.11596C14.6496 8.88155 14.3317 8.74991 14.0002 8.75Z"
                        fill="currentColor" />
                      <path
                        d="M13 10.75C13.4142 10.75 13.75 11.0858 13.75 11.5C13.75 11.8797 13.4678 12.1935 13.1018 12.2432L13 12.25H6C5.58579 12.25 5.25 11.9142 5.25 11.5C5.25 11.1203 5.53215 10.8065 5.89823 10.7568L6 10.75H13Z"
                        fill="currentColor" />
                      <path
                        d="M9 16.75C9.41421 16.75 9.75 17.0858 9.75 17.5C9.75 17.8797 9.46785 18.1935 9.10177 18.2432L9 18.25H6C5.58579 18.25 5.25 17.9142 5.25 17.5C5.25 17.1203 5.53215 16.8065 5.89823 16.7568L6 16.75H9Z"
                        fill="currentColor" />
                      <path
                        d="M13 13.75C13.4142 13.75 13.75 14.0858 13.75 14.5C13.75 14.8797 13.4678 15.1935 13.1018 15.2432L13 15.25H6C5.58579 15.25 5.25 14.9142 5.25 14.5C5.25 14.1203 5.53215 13.8065 5.89823 13.7568L6 13.75H13Z"
                        fill="currentColor" />
                    </svg>
                    <div class="get-code-item-text">
                      <div class="get-code-item-title">Copy to Clipboard</div>
                      <div class="get-code-item-desc">Copy the generated code to clipboard.</div>
                    </div>
                  </button>
                  <button class="get-code-item" id="download-text-styles-button">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path
                        d="M12 2.25C17.3848 2.25 21.75 6.61523 21.75 12C21.75 17.3848 17.3848 21.75 12 21.75C11.5858 21.75 11.25 21.4142 11.25 21C11.25 20.5858 11.5858 20.25 12 20.25C16.5564 20.25 20.25 16.5563 20.25 12C20.25 7.44365 16.5564 3.75 12 3.75C11.5858 3.75 11.25 3.41421 11.25 3C11.25 2.58579 11.5858 2.25 12 2.25Z"
                        fill="currentColor" />
                      <path
                        d="M5.64168 18.4109C5.9074 18.0931 6.3804 18.0509 6.69815 18.3167C7.43586 18.9336 8.27588 19.4166 9.18018 19.7437C9.56968 19.8847 9.7712 20.3147 9.63028 20.7042C9.48935 21.0937 9.05936 21.2952 8.66985 21.1543C7.6009 20.7675 6.60792 20.1966 5.73588 19.4673C5.41813 19.2016 5.37596 18.7286 5.64168 18.4109Z"
                        fill="currentColor" />
                      <path
                        d="M8.67043 2.84553C9.06006 2.70493 9.48988 2.9068 9.63049 3.29642C9.77109 3.68604 9.56921 4.11587 9.17959 4.25647C8.27535 4.58278 7.43555 5.06563 6.69862 5.68294C6.38109 5.94892 5.90806 5.90714 5.64208 5.58961C5.37609 5.27208 5.41788 4.79905 5.73541 4.53306C6.60721 3.80278 7.6007 3.23156 8.67043 2.84553Z"
                        fill="currentColor" />
                      <path
                        d="M3.56148 7.12503C3.76857 6.7663 4.22725 6.64337 4.58598 6.85046C4.94471 7.05755 5.06764 7.51624 4.86055 7.87497C4.37953 8.70822 4.04858 9.61949 3.8828 10.5672C3.81142 10.9753 3.4228 11.2482 3.01478 11.1768C2.60676 11.1054 2.33386 10.7168 2.40523 10.3088C2.60128 9.18801 2.99264 8.1104 3.56148 7.12503Z"
                        fill="currentColor" />
                      <path
                        d="M3.01483 12.8222C3.42285 12.7509 3.81146 13.0238 3.8828 13.4318C4.04859 14.3799 4.37955 15.2915 4.86061 16.1251C5.06764 16.4839 4.94464 16.9426 4.58588 17.1496C4.22712 17.3566 3.76845 17.2336 3.56142 16.8749C2.99259 15.8892 2.60125 14.8112 2.40522 13.6902C2.33388 13.2822 2.60681 12.8936 3.01483 12.8222Z"
                        fill="currentColor" />
                      <path
                        d="M12 7.25C12.3797 7.25 12.6935 7.53215 12.7432 7.89823L12.75 8V16C12.75 16.4142 12.4142 16.75 12 16.75C11.6203 16.75 11.3065 16.4678 11.2569 16.1018L11.25 16V8C11.25 7.58579 11.5858 7.25 12 7.25Z"
                        fill="currentColor" />
                      <path
                        d="M8.46968 12.4697C8.73595 12.2034 9.15262 12.1792 9.44623 12.3971L9.53034 12.4697L12 14.939L14.4697 12.4697C14.736 12.2034 15.1526 12.1792 15.4462 12.3971L15.5303 12.4697C15.7966 12.7359 15.8208 13.1526 15.603 13.4462L15.5303 13.5303L12.5303 16.5303C12.2641 16.7966 11.8474 16.8208 11.5538 16.6029L11.4697 16.5303L8.46968 13.5303C8.17679 13.2374 8.17679 12.7626 8.46968 12.4697Z"
                        fill="currentColor" />
                    </svg>
                    <div class="get-code-item-text">
                      <div class="get-code-item-title">Download File (or ZIP)</div>
                      <div class="get-code-item-desc">Save generated files to your computer.</div>
                    </div>
                  </button>
                  <button class="get-code-item" id="push-github-text-styles-button">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path fill-rule="evenodd" clip-rule="evenodd" d="M12 2C6.477 2 2 6.477 2 12c0 4.42 2.87 8.17 6.84 9.5.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34-.46-1.16-1.11-1.47-1.11-1.47-.91-.62.07-.6.07-.6 1 .07 1.53 1.03 1.53 1.03.87 1.52 2.34 1.07 2.91.83.09-.65.35-1.09.63-1.34-2.22-.25-4.55-1.11-4.55-4.92 0-1.11.38-2 1.03-2.71-.1-.25-.45-1.29.1-2.64 0 0 .84-.27 2.75 1.02.79-.22 1.65-.33 2.5-.33.85 0 1.71.11 2.5.33 1.91-1.29 2.75-1.02 2.75-1.02.55 1.35.2 2.39.1 2.64.65.71 1.03 1.6 1.03 2.71 0 3.82-2.34 4.66-4.57 4.91.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0012 2z" fill="currentColor"/>
                    </svg>
                    <div class="get-code-item-text">
                      <div class="get-code-item-title">Push to GitHub</div>
                      <div class="get-code-item-desc">Upload to configured repository.</div>
                    </div>
                  </button>
                </div>
              </div>
              <textarea id="text-styles-export-textarea"
                placeholder='Text styles output will appear here...'></textarea>
            </div>
          </div>
        </div>
      </div>

      <!-- Settings Tab -->
      <div class="tab-content" id="settings-tab">
        <div class="scrollable-content">
          <div class="main-content-container">
            <!-- GitHub Configuration Section -->
            <div class="section" style="max-width: 600px;">
              <div class="section-title">GitHub Configuration</div>
              <div style="margin-top: var(--space-4); display: flex; flex-direction: column; gap: var(--space-3);">

                <div>
                  <label class="input-label">Personal Access Token</label>
                  <input type="password" id="github-token" class="input-field" placeholder="ghp_..." style="width: 100%; margin-top: var(--space-1);">
                  <p style="font-size: 12px; color: var(--color-text-muted); margin-top: var(--space-1);">
                    <a href="https://github.com/settings/tokens/new" target="_blank" style="color: var(--color-primary);">Get token from GitHub ‚Üí</a>
                  </p>
                </div>

                <div>
                  <label class="input-label">Repository</label>
                  <input type="text" id="github-repo" class="input-field" placeholder="owner/repo" style="width: 100%; margin-top: var(--space-1);">
                  <p style="font-size: 12px; color: var(--color-text-muted); margin-top: var(--space-1);">Format: owner/repository</p>
                </div>

                <div>
                  <label class="input-label">Branch</label>
                  <input type="text" id="github-branch" class="input-field" value="main" style="width: 100%; margin-top: var(--space-1);">
                </div>

                <div>
                  <label class="input-label">Target Directory</label>
                  <input type="text" id="github-path" class="input-field" value="tokens/" style="width: 100%; margin-top: var(--space-1);">
                  <p style="font-size: 12px; color: var(--color-text-muted); margin-top: var(--space-1);">Path where tokens will be uploaded in repository</p>
                </div>

                <div style="margin-top: var(--space-2);">
                  <button id="test-github-connection-btn" class="button secondary" style="margin-right: var(--space-2);">
                    Test Connection
                  </button>
                  <span id="github-connection-status" style="font-size: 12px; color: var(--color-text-muted);"></span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div> <!-- Close main-view -->

    <!-- Unified Footer -->
    <div class="footer" id="app-footer">
      <div class="credits">
        <span class="version">v.1</span>
      </div>
      <div class="button-group">
        <!-- Preserve Scopes Checkbox (Import Variables Tab) -->
        <label class="footer-checkbox-container" data-tab="json-to-variables"
          style="display: none; align-items: center; gap: 8px; margin-right: 12px; cursor: pointer; user-select: none;">
          <input type="checkbox" id="preserve-scopes-checkbox" style="cursor: pointer; width: 16px; height: 16px;">
          <span style="font-size: 13px; color: var(--color-text); white-space: nowrap;"
            title="When enabled, existing variable scopes will be modified during import">Write scopes</span>
        </label>

        <!-- Import Variables Tab Button -->
        <button id="import-variables-button" class="primary footer-btn" data-tab="json-to-variables">
          Update Figma
          <svg width="22" height="22" viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path fill-rule="evenodd" clip-rule="evenodd"
              d="M16.2931 7.81818C17.3219 7.13414 18 5.96443 18 4.63636C18 2.52763 16.2905 0.818176 14.1818 0.818176H7.81818C5.70946 0.818176 4 2.52763 4 4.63636C4 5.96443 4.67805 7.13414 5.70686 7.81818C4.67805 8.50222 4 9.67192 4 11C4 12.3281 4.67805 13.4978 5.70686 14.1818C4.67805 14.8659 4 16.0356 4 17.3636C4 19.4724 5.70946 21.1818 7.81818 21.1818C9.92691 21.1818 11.6364 19.4724 11.6364 17.3636V13.8459C12.3119 14.4505 13.2039 14.8182 14.1818 14.8182C16.2905 14.8182 18 13.1087 18 11C18 9.67192 17.3219 8.50222 16.2931 7.81818ZM7.81818 8.45454C6.41237 8.45454 5.27273 9.59418 5.27273 11C5.27273 12.4058 6.41237 13.5454 7.81818 13.5454H10.3636L10.3636 8.45454H7.81818ZM14.1818 7.18181C15.5876 7.18181 16.7273 6.04217 16.7273 4.63636C16.7273 3.23054 15.5876 2.0909 14.1818 2.0909H11.6364V7.18181H14.1818ZM14.1818 8.45454H14.1802C12.7755 8.45539 11.637 9.5941 11.6364 10.9989L11.6364 11.0011C11.637 12.4064 12.7764 13.5454 14.1818 13.5454C15.5876 13.5454 16.7273 12.4058 16.7273 11C16.7273 9.59418 15.5876 8.45454 14.1818 8.45454ZM5.27273 17.3636C5.27273 15.9578 6.41237 14.8182 7.81818 14.8182L10.3636 14.8182V17.3636C10.3636 18.7694 9.224 19.9091 7.81818 19.9091C6.41237 19.9091 5.27273 18.7694 5.27273 17.3636ZM10.3636 7.18181H7.81818C6.41237 7.18181 5.27273 6.04217 5.27273 4.63636C5.27273 3.23054 6.41237 2.0909 7.81818 2.0909H10.3636V7.18181Z"
              fill="currentColor" fill-opacity="0.9" />
          </svg>
        </button>

        <!-- Export JSON Tab Button -->
        <button id="export-json-button" class="primary footer-btn" data-tab="json-export" style="display: none;">
          Export JSON
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M21 7L12 12V22L21 16.5V7Z" stroke="currentColor" stroke-width="1.4" stroke-linejoin="round" />
            <path d="M12 12L3 7V17L12 22V12Z" stroke="currentColor" stroke-width="1.4" stroke-linejoin="round" />
            <path d="M12 12L3 7L12 2L21 7L12 12Z" stroke="currentColor" stroke-width="1.4" stroke-linejoin="round" />
            <path d="M3 17V7L12 2V12L3 17Z" stroke="currentColor" stroke-width="1.4" stroke-linejoin="round" />
          </svg>
        </button>

        <!-- Text Styles Export Tab Button -->
        <button id="export-text-styles-button" class="primary footer-btn" data-tab="text-styles-export"
          style="display: none;">
          Generate
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M21 7L12 12V22L21 16.5V7Z" stroke="currentColor" stroke-width="1.4" stroke-linejoin="round" />
            <path d="M12 12L3 7V17L12 22V12Z" stroke="currentColor" stroke-width="1.4" stroke-linejoin="round" />
            <path d="M12 12L3 7L12 2L21 7L12 12Z" stroke="currentColor" stroke-width="1.4" stroke-linejoin="round" />
            <path d="M3 17V7L12 2V12L3 17Z" stroke="currentColor" stroke-width="1.4" stroke-linejoin="round" />
          </svg>
        </button>

      </div>
    </div>

    <!-- Empty State Templates -->
    <template id="empty-collections-template">
      <div class="empty-state">
        <h3>No Collections Found</h3>
        <p>Create some variable collections in Figma first, then refresh this plugin.</p>
      </div>
    </template>

    <template id="empty-modes-template">
      <div class="empty-state">
        <h3>No Modes Found</h3>
        <p>Select at least one collection to see available modes.</p>
      </div>
    </template>

    <!-- JAVASCRIPT - Full Plugin Functionality -->
    <script>
      // Global state
      let collections = [];
      let selectedCollections = new Set();
      let selectedModes = new Set();
      let selectedTypes = new Set(['COLOR', 'FLOAT', 'STRING', 'BOOLEAN']);
      let availableModes = new Set();
      let isAdvancedCssMode = false;
      let lastJsonExportResult = null;
      let lastCssExportResult = null;
      let lastTextStylesExportResult = null;
      let lastExportOptions = null; // Store last export options for refresh functionality
      let jsonEditorModified = false; // Track if JSON editor has unsaved changes

      // Button state management
      let exportJsonButtonState = 'generate'; // 'generate' | 'generating' | 'generated' | 'update'
      let exportCssButtonState = 'generate'; // 'generate' | 'generating' | 'generated' | 'update'
      let exportTextStylesButtonState = 'generate'; // 'generate' | 'generating' | 'generated' | 'update'

      // üÜï TOKEN TREE VIEW STATE
      let tokenTreeData = null; // Full W3C JSON data
      let activeTokenMode = null; // Currently selected mode (global fallback)
      let tokenTreeDebounceTimer = null; // Debounce timer for JSON sync
      let isUpdatingProgrammatically = false; // Flag to suppress input event during programmatic updates
      let suppressNextSync = false; // Flag to suppress next syncJSONToTokenTree call
      let hasUnsavedChanges = false; // Flag to track if JSON has been modified (enables Update Figma button)
      let currentTooltip = null; // Active tooltip element
      const collectionActiveModes = new Map(); // Collection-specific active modes: collectionPath -> modeName

      // üÜï DRAWER STATE
      let drawerMode = null; // 'edit-name' | 'edit-value' | null
      let drawerData = null; // Data for the drawer

      // ===== THEME BUILDER STATE =====
      const themeBuilderState = {
        themes: [],
        activeTheme: null,
        groupVariants: {
          core: null,
          accent: null,
          alt: null
        }
      };

      // Track import status of themes: 'draft' | 'imported'
      let themeImportStatus = {};

      // ===== THEME BUILDER CONSTANTS =====
      const VARIANT_PERCENTILES = {
        core: { soft: 5, light: 25, faded: 45, dark: 90 },
        accent: { soft: 5, light: 25, dark: 90 },
        alt: { soft: 5, light: 25, dark: 70 }
      };

      const CLARA_FALLBACK = {
        core: { main: 70, soft: 5, light: 30, faded: 40, dark: 400 },
        accent: { main: 50, soft: 10, light: 20, dark: 500 },
        alt: { main: 700, soft: 10, light: 40, dark: 700 }
      };

      // ===== THEME BUILDER FUNCTIONS =====

      function parseColorRef(ref) {
        if (!ref || !ref.startsWith('{colors.')) return null;
        const match = ref.match(/\{colors\.([^.]+)\.(\d+)\}/);
        if (!match) return null;
        return { family: match[1], level: parseInt(match[2], 10) };
      }

      function buildColorRef(family, level) {
        return `{colors.${family}.${level}}`;
      }

      function resolveColorRefToHex(ref) {
        const parsed = parseColorRef(ref);
        if (!parsed) return null;

        const color = tokenTreeData?.global?.colors?.[parsed.family]?.[parsed.level];
        if (!color || !color.$value) return null;

        if (typeof color.$value === 'object' && color.$value.r !== undefined) {
          return rgbToHex(color.$value);
        }
        return color.$value;
      }

      // Resolve generic token references (font, radius, etc.)
      function resolveTokenRef(ref) {
        // Handle numeric values (like radius: 10) - add 'px' suffix
        if (typeof ref === 'number') {
          return `${ref}px`;
        }

        if (!ref || typeof ref !== 'string') return ref;

        // Already a plain value (not a reference)
        if (!ref.startsWith('{')) return ref;

        // Parse reference like {typography.fontFamily.sans} or {radius.md}
        const match = ref.match(/\{([^}]+)\}/);
        if (!match) return ref;

        const path = match[1].split('.');
        let value = tokenTreeData?.global;

        for (const key of path) {
          if (!value || !value[key]) {
            console.warn(`[Theme Preview] Token reference not found: ${ref}`);
            return ref; // Return original if not found
          }
          value = value[key];
        }

        // Get the $value and recursively resolve if it's also a reference
        const resolvedValue = value?.$value || ref;

        // If the resolved value is a number, add 'px'
        if (typeof resolvedValue === 'number') {
          return `${resolvedValue}px`;
        }

        return resolvedValue;
      }

      // Universal color token resolver - handles global, semantic, and alias references
      function resolveTokenToHex(ref, visited = new Set()) {
        if (!ref || typeof ref !== 'string') return null;

        // Direct hex color
        if (ref.startsWith('#')) return ref;

        // RGB object
        if (typeof ref === 'object' && ref.r !== undefined) {
          return rgbToHex(ref);
        }

        // Prevent circular references
        if (visited.has(ref)) {
          console.warn(`Circular reference detected: ${ref}`);
          return null;
        }
        visited.add(ref);

        // Parse token reference {path.to.token}
        if (!ref.startsWith('{') || !ref.endsWith('}')) return null;
        const path = ref.slice(1, -1).split('.');

        // Try global colors first: {colors.family.level}
        if (path[0] === 'colors' && path.length === 3) {
          const [, family, level] = path;
          const token = tokenTreeData?.global?.colors?.[family]?.[level];
          if (token && token.$value) {
            if (typeof token.$value === 'object' && token.$value.r !== undefined) {
              return rgbToHex(token.$value);
            }
            if (typeof token.$value === 'string') {
              // Could be an alias, resolve recursively
              return token.$value.startsWith('{')
                ? resolveTokenToHex(token.$value, visited)
                : token.$value;
            }
            return token.$value;
          }
        }

        // Try semantic tokens: {brand.primary.main}, {text.primary}, etc.
        let current = tokenTreeData?.semantic;
        for (const segment of path) {
          if (!current || typeof current !== 'object') return null;
          current = current[segment];
        }

        if (current && typeof current === 'object' && current.$type === 'color') {
          const value = current.$value;
          if (typeof value === 'object' && value.r !== undefined) {
            return rgbToHex(value);
          }
          if (typeof value === 'string') {
            // Could be an alias, resolve recursively
            return value.startsWith('{')
              ? resolveTokenToHex(value, visited)
              : value;
          }
          return value;
        }

        return null;
      }

      function mapColorVariants(colorRef, groupType) {
        const parsed = parseColorRef(colorRef);
        if (!parsed) return null;

        const family = tokenTreeData?.global?.colors?.[parsed.family];
        if (!family) return null;

        const levels = Object.keys(family)
          .map(k => parseInt(k, 10))
          .filter(n => !isNaN(n) && family[n].$type === 'color')
          .sort((a, b) => a - b);

        if (levels.length === 0) return null;

        const targets = VARIANT_PERCENTILES[groupType];
        if (!targets) return null;

        const results = { main: parsed.level };
        const maxIndex = levels.length - 1;

        for (const [variant, targetPercent] of Object.entries(targets)) {
          const targetIndex = Math.round((targetPercent / 100) * maxIndex);
          const clampedIndex = Math.max(0, Math.min(targetIndex, maxIndex));
          results[variant] = levels[clampedIndex];
        }

        return { family: parsed.family, variants: results };
      }

      function getClaraFallback(groupType) {
        const fallback = CLARA_FALLBACK[groupType];
        if (!fallback) return null;
        return { family: 'ocean', variants: fallback };
      }

      function extractThemesFromTokens() {
        if (!tokenTreeData || !tokenTreeData.semantic) return [];

        const brandTheme = tokenTreeData.semantic.brand?.theme?.$value;
        if (!brandTheme || typeof brandTheme !== 'object') return [];

        return Object.keys(brandTheme).map(id => {
          // Initialize import status for existing themes if not set
          if (themeImportStatus[id] === undefined) {
            themeImportStatus[id] = 'imported';
          }

          return {
            id,
            label: id.charAt(0).toUpperCase() + id.slice(1)
          };
        });
      }

      function renderThemeList() {
        const container = document.getElementById('theme-list');
        if (!container) return;

        themeBuilderState.themes = extractThemesFromTokens();
        container.innerHTML = '';

        themeBuilderState.themes.forEach(theme => {
          const primaryRef = tokenTreeData.semantic.brand.primary.main.$value[theme.id];
          const accentRef = tokenTreeData.semantic.brand.accent.main.$value[theme.id];
          const secondaryRef = tokenTreeData.semantic.brand.secondary.main.$value[theme.id];

          const primaryHex = resolveColorRefToHex(primaryRef);
          const accentHex = resolveColorRefToHex(accentRef);
          const secondaryHex = resolveColorRefToHex(secondaryRef);

          const item = document.createElement('div');
          item.className = `theme-list-item${theme.id === themeBuilderState.activeTheme ? ' active' : ''}`;
          item.innerHTML = `
          <div class="theme-color-swatches">
            <div class="theme-color-swatch">
              <div class="theme-color-dot" style="background: ${primaryHex || '#ccc'}" title="Primary: ${primaryRef}"></div>
            </div>
            <div class="theme-color-swatch">
              <div class="theme-color-dot" style="background: ${accentHex || '#ccc'}" title="Accent: ${accentRef}"></div>
            </div>
            <div class="theme-color-swatch">
              <div class="theme-color-dot" style="background: ${secondaryHex || '#ccc'}" title="Secondary: ${secondaryRef}"></div>
            </div>
          </div>
          <div class="theme-color-label">
            ${theme.label}.json
            ${themeImportStatus[theme.id] === 'draft' ? '<span class="theme-draft-badge">DRAFT</span>' : ''}
          </div>
          ${theme.id !== 'clara' ? `
            <button class="icon-only secondary theme-delete-btn" onclick="deleteTheme('${theme.id}')" title="Delete" style="padding: 2px; width: 16px; height: 16px; margin-left: auto;">
              <svg width="12" height="12" viewBox="0 0 16 16" fill="none">
                <path d="M2 4H14M6 7V11M10 7V11M3 4L4 13H12L13 4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
              </svg>
            </button>
          ` : ''}
        `;

          item.addEventListener('click', (e) => {
            if (!e.target.closest('button')) {
              selectTheme(theme.id);
            }
          });
          container.appendChild(item);
        });

        document.getElementById('theme-count').textContent = themeBuilderState.themes.length;
      }

      function selectTheme(themeId) {
        themeBuilderState.activeTheme = themeId;
        renderThemeList();
        renderThemeEditor(themeId);
      }

      // Traverse semantic tokens and call callback for each token
      function traverseSemanticTokens(themeId, callback) {
        const semantic = tokenTreeData?.semantic;
        if (!semantic) return;

        function traverse(obj, path = []) {
          if (!obj || typeof obj !== 'object') return;

          // Check if this is a token leaf node
          if (obj.$type && obj.$value && typeof obj.$value === 'object' && obj.$value[themeId]) {
            callback({
              path: path.join('.'),
              type: obj.$type,
              value: obj.$value[themeId],
              allValues: obj.$value
            });
          }

          // Recursively traverse children
          for (const [key, value] of Object.entries(obj)) {
            if (!key.startsWith('$') && typeof value === 'object') {
              traverse(value, path.concat(key));
            }
          }
        }

        traverse(semantic);
      }

      // Update token value for a specific theme
      function updateTokenValueForTheme(tokenPath, themeId, newValue) {
        const parts = tokenPath.split('.');
        const semantic = tokenTreeData?.semantic;
        if (!semantic) return false;

        // Navigate to the token
        let current = semantic;
        for (const part of parts) {
          if (!current[part]) return false;
          current = current[part];
        }

        // Update the value for this theme
        if (current.$value && typeof current.$value === 'object') {
          current.$value[themeId] = newValue;

          // Mark as changed
          hasUnsavedChanges = true;
          updateImportButtonState();

          // Sync to Variables tab
          const editor = document.getElementById('json-editor-textarea');
          if (editor && tokenTreeData) {
            editor.value = JSON.stringify(tokenTreeData, null, 2);
            const inputEvent = new Event('input', { bubbles: true });
            editor.dispatchEvent(inputEvent);
          }

          return true;
        }

        return false;
      }

      // Build semantic tokens table for theme editor
      // Format token path for display
      function formatTokenPath(path) {
        const parts = path.split('.');
        return parts[parts.length - 1]; // Return last segment only
      }

      // Build color families list for modal
      // Show libraries modal
      function showLibrariesModal(tokenPath, themeId, currentValue) {
        const overlay = document.createElement('div');
        overlay.className = 'libraries-modal-overlay';

        const hexColor = resolveTokenToHex(currentValue);

        overlay.innerHTML = `
        <div class="libraries-modal">
          <div class="libraries-header">
            <button class="modal-close">‚úï</button>
            <div class="libraries-title">
              ${hexColor ? `<div class="libraries-title-swatch" style="background: ${hexColor};"></div>` : ''}
              ${currentValue}
            </div>
            <div class="autocomplete-container">
              <input type="text" class="libraries-search" placeholder="Search colors or enter HEX (e.g. #FF5733)" />
            </div>
          </div>
          <div class="libraries-content"></div>
        </div>
      `;

        document.body.appendChild(overlay);

        const modal = overlay.querySelector('.libraries-modal');

        // Close on overlay click (but not on modal click)
        overlay.addEventListener('click', (e) => {
          if (e.target === overlay) {
            hideAutocomplete();
            overlay.remove();
          }
        });

        // Close button
        overlay.querySelector('.modal-close').addEventListener('click', () => {
          hideAutocomplete();
          overlay.remove();
        });

        // Initialize autocomplete on the search input
        const searchInput = overlay.querySelector('.libraries-search');

        // Selection callback (receives the ref string directly)
        const onSelect = (refString) => {
          updateTokenValueForTheme(tokenPath, themeId, refString);
          hideAutocomplete();
          overlay.remove();
          renderThemeEditor(themeId);
          showSnackbar('Token updated', 'success');
        };

        // Show autocomplete
        showAutocomplete(searchInput, onSelect);

        // Handle input changes (debounced for autocomplete update)
        let debounceTimer = null;
        searchInput.addEventListener('input', (e) => {
          const value = e.target.value.trim();

          // Check if it's a valid HEX color
          const hexRegex = /^#[0-9A-Fa-f]{6}$/;
          if (hexRegex.test(value)) {
            // Valid HEX - allow direct selection via Enter key
            searchInput.dataset.hexValue = value;
          } else {
            delete searchInput.dataset.hexValue;
          }

          // Debounce autocomplete update
          clearTimeout(debounceTimer);
          debounceTimer = setTimeout(() => {
            updateAutocompleteDropdown();
          }, 150);
        });

        // Handle Enter key for HEX input
        searchInput.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' && searchInput.dataset.hexValue) {
            e.preventDefault();
            const hexValue = searchInput.dataset.hexValue;
            updateTokenValueForTheme(tokenPath, themeId, hexValue);
            hideAutocomplete();
            overlay.remove();
            renderThemeEditor(themeId);
            showSnackbar(`Token updated to ${hexValue}`, 'success');
          }
        });

        searchInput.focus();
      }

      // Recursive function to render semantic tokens as tree view
      function renderSemanticTokenGroup(obj, path, themeId, depth) {
        let html = '';

        for (const [key, value] of Object.entries(obj)) {
          if (key.startsWith('$')) continue; // Skip metadata like $value, $type

          const fullPath = path ? `${path}.${key}` : key;

          // Check if it's a token (has $value with theme data)
          if (value?.$value && typeof value.$value === 'object' && value.$value[themeId] !== undefined) {
            // This is a token leaf node - render token item
            const tokenValue = value.$value[themeId];
            const tokenType = value.$type || 'string';

            // Generate swatch/icon
            let iconHTML = '';
            if (tokenType === 'color') {
              const hexColor = resolveTokenToHex(tokenValue);
              if (hexColor) {
                iconHTML = `
                  <div class="token-swatch">
                    <div class="token-swatch-color" style="background-color: ${hexColor};"></div>
                  </div>
                `;
              } else {
                iconHTML = `<div class="token-icon">${getTokenIcon(tokenType)}</div>`;
              }
            } else {
              iconHTML = `<div class="token-icon">${getTokenIcon(tokenType)}</div>`;
            }

            html += `
              <div class="token-item" data-path="${fullPath}" data-type="${tokenType}">
                ${iconHTML}
                <span class="token-name">${key}</span>
                <span class="token-value token-value-chip"
                      data-token-path="${fullPath}"
                      data-theme-id="${themeId}"
                      data-current-value="${tokenValue}">
                  ${tokenValue}
                </span>
              </div>
            `;
          }
          else if (value && typeof value === 'object') {
            // It's a group - render collapsible section
            const isCollection = depth === 0;
            const isOpen = depth <= 1; // Auto-open first 2 levels

            const headerClass = isCollection ? 'token-collection-header' : 'token-group-header';
            const containerClass = isCollection ? 'token-collection' : 'token-group';
            const chevronClass = isOpen ? 'token-chevron' : 'token-chevron collapsed';
            const listClass = isOpen ? 'token-list' : 'token-list hidden';
            const openClass = isOpen ? ' open' : '';

            html += `
              <div class="${containerClass}${openClass}">
                <div class="${headerClass}" data-path="${fullPath}">
                  <svg class="${chevronClass}" viewBox="0 0 12 12" fill="currentColor">
                    <path d="M3 5l3 3 3-3H3z"/>
                  </svg>
                  <span>${key}</span>
                </div>
                <div class="${listClass}" data-parent="${fullPath}">
                  ${renderSemanticTokenGroup(value, fullPath, themeId, depth + 1)}
                </div>
              </div>
            `;
          }
        }

        return html;
      }

      // Main function to render theme tokens as tree view
      function renderThemeTreeView(themeId) {
        const semantic = tokenTreeData?.semantic;
        if (!semantic) {
          return '<p style="color: var(--color-text-muted); text-align: center; padding: 40px 0;">No semantic tokens available</p>';
        }

        // Render tree recursively
        const treeHTML = renderSemanticTokenGroup(semantic, '', themeId, 0);

        return `
          <div class="token-tree-container" style="max-height: 600px; margin-top: 16px;">
            <div class="token-tree-root">
              ${treeHTML}
            </div>
          </div>
        `;
      }

      function buildSemanticTokensTable(themeId) {
        const tokens = [];

        // Collect all semantic tokens for this theme
        traverseSemanticTokens(themeId, (token) => {
          tokens.push(token);
        });

        if (tokens.length === 0) {
          return '<p style="color: var(--color-text-muted); text-align: center; padding: 40px 0;">No semantic tokens found for this theme</p>';
        }

        // Build table HTML
        let html = `
        <div class="theme-tokens-table-wrapper">
          <div class="theme-tokens-table">
            <div class="tokens-table-body">
      `;

        tokens.forEach(token => {
          const displayValue = token.value || '';
          const tokenName = formatTokenPath(token.path);
          let swatchHTML = '';

          // Generate swatch based on token type
          if (token.type === 'color') {
            const hexColor = resolveTokenToHex(token.value);
            if (hexColor) {
              swatchHTML = `<div class="theme-token-swatch" style="background: ${hexColor};" title="${hexColor}"></div>`;
            } else {
              swatchHTML = `<div class="theme-token-swatch" style="background: var(--color-gray-200);"></div>`;
            }
          } else {
            swatchHTML = `<div class="theme-token-swatch" style="background: var(--color-gray-200);"></div>`;
          }

          const iconSVG = `<svg class="theme-token-icon" viewBox="0 0 16 16"><circle cx="8" cy="8" r="6" fill="currentColor"/></svg>`;

          html += `
          <div class="token-row" data-path="${token.path}" data-type="${token.type}">
            ${swatchHTML}
            ${iconSVG}
            <span class="theme-token-name">${tokenName}</span>
            <div class="token-value-chip"
                 data-token-path="${token.path}"
                 data-theme-id="${themeId}"
                 data-current-value="${displayValue}">
              ${displayValue}
            </div>
          </div>
        `;
        });

        html += `
            </div>
          </div>
        </div>
      `;

        return html;
      }

      function renderThemeEditor(themeId) {
        const empty = document.getElementById('theme-editor-empty');
        const content = document.getElementById('theme-editor-content');
        const container = document.getElementById('theme-details-container');

        if (!themeId) {
          empty.style.display = 'flex';
          content.style.display = 'none';
          return;
        }

        empty.style.display = 'none';
        content.style.display = 'block';

        const theme = themeBuilderState.themes.find(t => t.id === themeId);
        if (!theme) return;

        // Get semantic tokens for this theme
        const semantic = tokenTreeData?.semantic;
        if (!semantic) {
          container.innerHTML = '<p>No semantic tokens available</p>';
          return;
        }

        // Render tokens tree view
        container.innerHTML = `
        <div style="max-width: 100%; margin: 0;">
          <div style="margin-bottom: 24px;">
            <h2 style="font-family: 'Inter', -apple-system, sans-serif; font-size: 16px; font-weight: 600; color: var(--color-text); margin: 0 0 4px 0;">${theme.label} Theme</h2>
            <p style="font-family: 'Inter', -apple-system, sans-serif; font-size: 13px; color: var(--color-text-secondary); margin: 0;">Edit semantic token values for this theme</p>
          </div>
          ${renderThemeTreeView(themeId)}
        </div>
      `;

        // Attach collapse/expand listeners to tree groups
        container.querySelectorAll('.token-collection-header, .token-group-header').forEach(header => {
          header.addEventListener('click', (e) => {
            e.stopPropagation();
            const chevron = header.querySelector('.token-chevron');
            const path = header.dataset.path;
            const list = container.querySelector(`.token-list[data-parent="${path}"]`);
            const containerEl = header.parentElement;

            if (list && containerEl) {
              list.classList.toggle('hidden');
              chevron.classList.toggle('collapsed');
              containerEl.classList.toggle('open');
            }
          });
        });

        // Attach click listeners to chips
        container.querySelectorAll('.token-value-chip').forEach(chip => {
          chip.addEventListener('click', function () {
            const tokenPath = this.dataset.tokenPath;
            const themeId = this.dataset.themeId;
            const currentValue = this.dataset.currentValue;

            showLibrariesModal(tokenPath, themeId, currentValue);
          });
        });
      }


      async function deleteTheme(themeId) {
        if (themeId === 'clara') {
          showSnackbar('Cannot delete CLARA theme', 'warning');
          return;
        }

        const confirmed = await createModal(
          'Delete Theme',
          `Are you sure you want to delete theme "${themeId}"? This action cannot be undone.`,
          null,
          'delete'
        );

        if (!confirmed) return;

        const semantic = tokenTreeData.semantic;

        function removeThemeFromTokens(obj) {
          if (!obj || typeof obj !== 'object') return;
          if (obj.$value && typeof obj.$value === 'object') {
            delete obj.$value[themeId];
          }
          for (const key in obj) {
            if (!key.startsWith('$')) {
              removeThemeFromTokens(obj[key]);
            }
          }
        }

        removeThemeFromTokens(semantic);

        hasUnsavedChanges = true;
        updateImportButtonState();
        renderTokenTree(tokenTreeData, activeTokenMode);

        themeBuilderState.activeTheme = null;
        renderThemeList();
        renderThemeEditor(null);

        showSnackbar(`Theme "${themeId}" deleted`, 'success');
      }

      // Export semantic JSON for selected theme
      function exportThemeJSON() {
        const themeId = themeBuilderState.activeTheme;
        if (!themeId) {
          showSnackbar('Please select a theme first', 'warning');
          return;
        }

        const semantic = tokenTreeData?.semantic;
        if (!semantic) {
          showSnackbar('No semantic tokens available', 'error');
          return;
        }

        // Build minimal semantic JSON for this theme only
        const themeJSON = { semantic: {} };

        function extractThemeTokens(source, target, path = []) {
          for (const [key, value] of Object.entries(source)) {
            if (key.startsWith('$')) {
              // Copy metadata ($type, $description, etc.)
              target[key] = value;
            } else if (value && typeof value === 'object') {
              if (value.$type && value.$value && value.$value[themeId]) {
                // This is a token leaf - extract only this theme's value
                target[key] = {
                  $value: {
                    [themeId]: value.$value[themeId]
                  },
                  $type: value.$type
                };
              } else {
                // This is a group - recurse
                target[key] = {};
                extractThemeTokens(value, target[key], path.concat(key));
              }
            }
          }
        }

        extractThemeTokens(semantic, themeJSON.semantic);

        // Download as JSON file
        const jsonString = JSON.stringify(themeJSON, null, 2);
        const blob = new Blob([jsonString], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `semantic-${themeId}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        showSnackbar(`Exported semantic-${themeId}.json`, 'success');
      }

      // Create/Update theme mode in Figma
      async function createThemeInFigma() {
        const themeId = themeBuilderState.activeTheme;
        if (!themeId) {
          showSnackbar('Please select a theme first', 'warning');
          return;
        }

        // Double confirmation
        const confirmed = await createModal(
          'Create Theme in Figma',
          `This will create or update the "${themeId}" mode in Figma.\n\nThis may take a few seconds. Continue?`,
          null,
          'confirm'
        );

        if (!confirmed) return;

        // Second confirmation
        const doubleConfirmed = await createModal(
          'Confirm',
          'Are you sure? This will import ALL tokens to Figma.',
          null,
          'confirm'
        );

        if (!doubleConfirmed) return;

        try {
          // Use existing importToFigma() function (option A)
          showSnackbar('Creating theme in Figma...', 'info');

          // Call the existing import function
          await importToFigma();

          showSnackbar(`Theme "${themeId}" created successfully!`, 'success');
        } catch (error) {
          console.error('[Create Theme] Error:', error);
          showSnackbar(`Failed to create theme: ${error.message}`, 'error');
        }
      }

      async function addNewTheme() {
        const themeName = await createModal(
          'New Theme',
          'Enter a name for the new theme:',
          'adidas'
        );

        if (!themeName) return;

        const existing = themeBuilderState.themes.find(t => t.id === themeName.toLowerCase());
        if (existing) {
          showSnackbar('Theme name already exists', 'error');
          return;
        }

        if (!/^[a-z0-9\-_]+$/i.test(themeName)) {
          showSnackbar('Use only letters, numbers, hyphens, and underscores', 'error');
          return;
        }

        await openThemeColorPicker(themeName);
      }

      function buildFontFamilyOptions() {
        const options = [];
        const fontFamilies = tokenTreeData?.global?.typography?.fontFamily;

        if (!fontFamilies) return options;

        for (const [name, token] of Object.entries(fontFamilies)) {
          if (token && token.$type === 'fontFamily' && token.$value) {
            options.push({
              ref: `{typography.fontFamily.${name}}`,
              value: token.$value,
              name: name
            });
          }
        }

        return options;
      }

      function buildRadiusOptions() {
        const options = [];
        const radii = tokenTreeData?.global?.radius;

        if (!radii) return options;

        for (const [name, token] of Object.entries(radii)) {
          if (token && token.$type === 'borderRadius' && token.$value !== undefined) {
            options.push({
              ref: `{radius.${name}}`,
              value: token.$value,
              name: name,
              display: `${name} (${token.$value}px)`
            });
          }
        }

        return options;
      }

      async function selectBrandSettingsStep(themeName) {
        return new Promise((resolve) => {
          const overlay = document.createElement('div');
          overlay.className = 'modal-overlay';

          const content = document.createElement('div');
          content.className = 'modal-content';
          content.style.maxWidth = '500px';

          const fontOptions = buildFontFamilyOptions();
          const radiusOptions = buildRadiusOptions();

          const defaultFont = fontOptions.length > 0 ? fontOptions[0].ref : '{typography.fontFamily.sans}';
          const defaultRadius = '{radius.md}';

          const fontOptionsHTML = fontOptions.length > 0
            ? fontOptions.map(opt =>
              `<option value="${opt.ref}" ${opt.ref === defaultFont ? 'selected' : ''}>${opt.name} - ${opt.value}</option>`
            ).join('')
            : '<option value="" disabled selected>No fonts available</option>';

          const radiusOptionsHTML = radiusOptions.map(opt =>
            `<option value="${opt.ref}" ${opt.ref === defaultRadius ? 'selected' : ''}>${opt.display}</option>`
          ).join('');

          content.innerHTML = `
          <div class="modal-title">Step 2: Brand Settings</div>
          <div class="modal-message" style="margin-bottom: 20px;">Configure typography and border radius for ${themeName} theme</div>

          <div style="display: flex; flex-direction: column; gap: 16px;">
            <div style="display: flex; flex-direction: column; gap: 8px;">
              <label style="font-weight: 600; font-size: 13px; color: var(--color-text-secondary);">Brand Font Family</label>
              <select class="modal-input" id="font-select" style="padding: 8px;">
                ${fontOptionsHTML}
              </select>
            </div>

            <div style="display: flex; flex-direction: column; gap: 8px;">
              <label style="font-weight: 600; font-size: 13px; color: var(--color-text-secondary);">Brand Border Radius</label>
              <select class="modal-input" id="radius-select" style="padding: 8px;">
                ${radiusOptionsHTML}
              </select>
            </div>
          </div>

          <div class="modal-actions" style="margin-top: 24px;">
            <button class="modal-button secondary" id="modal-back">‚Üê Back</button>
            <button class="modal-button primary" id="modal-create">Create Theme</button>
          </div>
        `;

          overlay.appendChild(content);
          document.body.appendChild(overlay);

          const fontSelect = content.querySelector('#font-select');
          const radiusSelect = content.querySelector('#radius-select');
          const backBtn = content.querySelector('#modal-back');
          const createBtn = content.querySelector('#modal-create');

          const cleanup = () => {
            document.body.removeChild(overlay);
          };

          backBtn.addEventListener('click', () => {
            cleanup();
            resolve(null); // This will trigger going back to step 1
          });

          createBtn.addEventListener('click', () => {
            const fontFamily = fontSelect.value;
            const radius = radiusSelect.value;

            // Validate font selection
            if (!fontFamily || fontFamily === '') {
              alert('Please select a font family before creating the theme.');
              return;
            }

            cleanup();
            resolve({ fontFamily, radius });
          });

          overlay.addEventListener('click', (e) => {
            if (e.target === overlay) {
              cleanup();
              resolve(null);
            }
          });

          // Focus create button
          setTimeout(() => {
            createBtn.focus();
          }, 100);
        });
      }

      async function selectAllColorsStep(themeName) {
        return new Promise((resolve) => {
          const overlay = document.createElement('div');
          overlay.className = 'modal-overlay';

          const content = document.createElement('div');
          content.className = 'modal-content';
          content.style.maxWidth = '600px';

          const defaultRefs = {
            core: '{colors.ocean.70}',
            accent: '{colors.coral.50}',
            alt: '{colors.gray.700}'
          };

          content.innerHTML = `
          <div class="modal-title">Step 1: Select Brand Colors</div>
          <div class="modal-message" style="margin-bottom: 20px;">Choose the three main colors for ${themeName} theme</div>

          <div style="display: flex; flex-direction: column; gap: 16px;">
            <div style="display: flex; flex-direction: column; gap: 8px;">
              <label style="font-weight: 600; font-size: 13px; color: var(--color-text-secondary);">Core Color</label>
              <div class="autocomplete-container input-with-swatch">
                <span class="input-color-swatch" id="core-swatch"></span>
                <input type="text" class="modal-input" id="core-color-input" value="${defaultRefs.core}" placeholder="${defaultRefs.core}">
              </div>
            </div>

            <div style="display: flex; flex-direction: column; gap: 8px;">
              <label style="font-weight: 600; font-size: 13px; color: var(--color-text-secondary);">Accent Color</label>
              <div class="autocomplete-container input-with-swatch">
                <span class="input-color-swatch" id="accent-swatch"></span>
                <input type="text" class="modal-input" id="accent-color-input" value="${defaultRefs.accent}" placeholder="${defaultRefs.accent}">
              </div>
            </div>

            <div style="display: flex; flex-direction: column; gap: 8px;">
              <label style="font-weight: 600; font-size: 13px; color: var(--color-text-secondary);">Alt Color</label>
              <div class="autocomplete-container input-with-swatch">
                <span class="input-color-swatch" id="alt-swatch"></span>
                <input type="text" class="modal-input" id="alt-color-input" value="${defaultRefs.alt}" placeholder="${defaultRefs.alt}">
              </div>
            </div>
          </div>

          <div class="modal-actions" style="margin-top: 24px;">
            <button class="modal-button secondary" id="modal-cancel">Cancel</button>
            <button class="modal-button primary" id="modal-next">Next ‚Üí</button>
          </div>
        `;

          overlay.appendChild(content);
          document.body.appendChild(overlay);

          const coreInput = content.querySelector('#core-color-input');
          const accentInput = content.querySelector('#accent-color-input');
          const altInput = content.querySelector('#alt-color-input');
          const coreSwatch = content.querySelector('#core-swatch');
          const accentSwatch = content.querySelector('#accent-swatch');
          const altSwatch = content.querySelector('#alt-swatch');
          const cancelBtn = content.querySelector('#modal-cancel');
          const nextBtn = content.querySelector('#modal-next');

          // Update swatch color with visual error feedback
          const updateSwatch = (input, swatch) => {
            const value = input.value.trim();
            const hex = resolveTokenToHex(value);

            if (hex) {
              // Valid token - show color
              swatch.style.backgroundColor = hex;
              swatch.style.borderColor = 'var(--color-border)';
              swatch.style.borderWidth = '1px';
              swatch.title = value;
            } else if (value) {
              // Invalid token - show error state
              swatch.style.backgroundColor = 'var(--color-gray-100)';
              swatch.style.borderColor = 'var(--color-error)';
              swatch.style.borderWidth = '2px';
              swatch.title = `Invalid token: ${value}`;
            } else {
              // Empty input - neutral state
              swatch.style.backgroundColor = 'var(--color-gray-200)';
              swatch.style.borderColor = 'var(--color-border)';
              swatch.style.borderWidth = '1px';
              swatch.title = 'No color selected';
            }
          };

          // Setup autocomplete for all inputs
          const inputs = [
            { input: coreInput, swatch: coreSwatch },
            { input: accentInput, swatch: accentSwatch },
            { input: altInput, swatch: altSwatch }
          ];

          inputs.forEach(({ input, swatch }) => {
            // Initialize swatch color
            updateSwatch(input, swatch);

            input.addEventListener('focus', () => {
              showAutocomplete(input, (selectedRef) => {
                input.value = selectedRef;
                updateSwatch(input, swatch);
              });
              updateAutocompleteDropdown();
            });

            input.addEventListener('input', () => {
              updateSwatch(input, swatch);
              if (autocompleteState.debounceTimer) {
                clearTimeout(autocompleteState.debounceTimer);
              }
              autocompleteState.debounceTimer = setTimeout(() => {
                updateAutocompleteDropdown();
              }, 150);
            });

            input.addEventListener('blur', (e) => {
              setTimeout(() => {
                if (!e.relatedTarget || !e.relatedTarget.closest('.autocomplete-dropdown')) {
                  hideAutocomplete();
                }
              }, 150);
            });

            input.addEventListener('keydown', (e) => {
              handleAutocompleteKeydown(e);
            });
          });

          const cleanup = () => {
            if (autocompleteState.debounceTimer) {
              clearTimeout(autocompleteState.debounceTimer);
              autocompleteState.debounceTimer = null;
            }
            hideAutocomplete();
            document.body.removeChild(overlay);
          };

          cancelBtn.addEventListener('click', () => {
            cleanup();
            resolve(null);
          });

          nextBtn.addEventListener('click', () => {
            const core = coreInput.value.trim();
            const accent = accentInput.value.trim();
            const alt = altInput.value.trim();

            if (!core || !accent || !alt) {
              showSnackbar('Please fill all color fields', 'error');
              return;
            }

            cleanup();
            resolve({ core, accent, alt });
          });

          overlay.addEventListener('click', (e) => {
            if (e.target === overlay) {
              cleanup();
              resolve(null);
            }
          });

          // Focus first input
          setTimeout(() => {
            coreInput.focus();
            coreInput.select();
          }, 100);
        });
      }

      async function openThemeColorPicker(themeName) {
        // Step 1: Select all 3 colors at once
        const colorSelections = await selectAllColorsStep(themeName);
        if (!colorSelections) {
          showSnackbar('Theme creation cancelled', 'info');
          return;
        }

        // Step 2: Select fontFamily and radius
        const brandSettings = await selectBrandSettingsStep(themeName);
        if (!brandSettings) {
          showSnackbar('Theme creation cancelled', 'info');
          return;
        }

        // Map colors to variants
        const selectedColors = {};
        for (const [group, colorRef] of Object.entries(colorSelections)) {
          const mapped = mapColorVariants(colorRef, group);
          console.log(`[Theme Builder] Mapped ${group}:`, colorRef, '->', mapped);
          selectedColors[group] = mapped || getClaraFallback(group);
        }

        console.log('[Theme Builder] All colors selected:', selectedColors);
        console.log('[Theme Builder] Brand settings:', brandSettings);

        // Map UI names (core, accent, alt) to semantic names (primary, accent, secondary)
        const mappedColors = {
          primary: selectedColors.core,
          accent: selectedColors.accent,
          secondary: selectedColors.alt
        };

        addThemeToSemanticTokens(themeName, mappedColors, brandSettings);

        showSnackbar(`Theme "${themeName}" created`, 'success');
      }

      async function selectColorFromGlobal(groupType) {
        const defaultRefs = {
          core: '{colors.ocean.70}',
          accent: '{colors.coral.50}',
          alt: '{colors.gray.700}'
        };

        return new Promise((resolve) => {
          const overlay = document.createElement('div');
          overlay.className = 'modal-overlay';

          const content = document.createElement('div');
          content.className = 'modal-content';

          content.innerHTML = `
          <div class="modal-title">Select ${groupType.toUpperCase()} color</div>
          <div class="modal-message">Enter color reference, like {colors.blue.100}</div>
          <div class="autocomplete-container">
            <input type="text" class="modal-input" placeholder="${defaultRefs[groupType]}" value="${defaultRefs[groupType]}" id="color-autocomplete-input">
          </div>
          <div class="modal-actions">
            <button class="modal-button secondary" id="modal-cancel">Cancel</button>
            <button class="modal-button primary" id="modal-ok">OK</button>
          </div>
        `;

          overlay.appendChild(content);
          document.body.appendChild(overlay);

          const input = content.querySelector('#color-autocomplete-input');
          const cancelBtn = content.querySelector('#modal-cancel');
          const okBtn = content.querySelector('#modal-ok');

          // Initialize autocomplete
          showAutocomplete(input, (selectedRef) => {
            // Callback when item is selected from autocomplete
          });

          // Update autocomplete on input with debounce
          const inputListener = () => {
            // Clear previous debounce timer
            if (autocompleteState.debounceTimer) {
              clearTimeout(autocompleteState.debounceTimer);
            }
            // Set new timer (150ms debounce)
            autocompleteState.debounceTimer = setTimeout(() => {
              updateAutocompleteDropdown();
            }, 150);
          };
          input.addEventListener('input', inputListener);

          // Show dropdown on focus
          const focusListener = () => {
            updateAutocompleteDropdown();
          };
          input.addEventListener('focus', focusListener);

          // Hide dropdown on blur (with delay to allow click on dropdown items)
          const blurListener = (e) => {
            setTimeout(() => {
              // Only hide if focus didn't move to dropdown
              if (!e.relatedTarget || !e.relatedTarget.closest('.autocomplete-dropdown')) {
                hideAutocomplete();
              }
            }, 150);
          };
          input.addEventListener('blur', blurListener);

          // Keyboard navigation
          const keydownListener = (e) => {
            handleAutocompleteKeydown(e);
          };
          input.addEventListener('keydown', keydownListener);

          // Focus and select input after setting up listeners
          setTimeout(() => {
            input.focus();
            input.select();
          }, 100);

          const cleanup = () => {
            // Clear debounce timer
            if (autocompleteState.debounceTimer) {
              clearTimeout(autocompleteState.debounceTimer);
              autocompleteState.debounceTimer = null;
            }
            hideAutocomplete();
            input.removeEventListener('input', inputListener);
            input.removeEventListener('focus', focusListener);
            input.removeEventListener('blur', blurListener);
            input.removeEventListener('keydown', keydownListener);
            document.body.removeChild(overlay);
          };

          cancelBtn.addEventListener('click', () => {
            cleanup();
            resolve(null);
          });

          okBtn.addEventListener('click', () => {
            const value = input.value.trim();
            cleanup();
            resolve(value || null);
          });

          // Handle Enter key on input (if not handled by autocomplete)
          input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && autocompleteState.activeIndex < 0) {
              e.preventDefault();
              const value = input.value.trim();
              cleanup();
              resolve(value || null);
            }
          });

          // Close on overlay click
          overlay.addEventListener('click', (e) => {
            if (e.target === overlay) {
              cleanup();
              resolve(null);
            }
          });
        });
      }

      function addThemeToSemanticTokens(themeName, colorGroups, brandSettings = null) {
        try {
          const semantic = tokenTreeData.semantic;

          if (!semantic || !semantic.brand) {
            throw new Error('Invalid token structure: semantic.brand not found');
          }

          console.log('[Theme Builder] Creating theme:', themeName, 'with colors:', colorGroups);
          if (brandSettings) {
            console.log('[Theme Builder] Brand settings:', brandSettings);
          }

          // Copy template from Clara first (will be overridden by custom values)
          copySemanticTokensFromCLARA(themeName);

          ['main', 'soft', 'light', 'faded', 'dark'].forEach(variant => {
            // Crea il nodo se non esiste
            if (!semantic.brand.primary[variant]) {
              semantic.brand.primary[variant] = { $type: 'color', $value: {} };
            }
            // Ora possiamo accedere al path in sicurezza
            const path = semantic.brand.primary[variant];
            if (!path.$value) path.$value = {};

            const family = colorGroups.primary.family;
            const level = colorGroups.primary.variants[variant] || colorGroups.primary.variants.main;
            if (level !== undefined) {
              path.$value[themeName] = buildColorRef(family, level);
              console.log(`[Theme Builder] Set primary.${variant}[${themeName}] = ${buildColorRef(family, level)}`);
            }
          });

          ['main', 'soft', 'light', 'dark'].forEach(variant => {
            // Crea il nodo se non esiste
            if (!semantic.brand.accent[variant]) {
              semantic.brand.accent[variant] = { $type: 'color', $value: {} };
            }
            // Ora possiamo accedere al path in sicurezza
            const path = semantic.brand.accent[variant];
            if (!path.$value) path.$value = {};

            const family = colorGroups.accent.family;
            const level = colorGroups.accent.variants[variant] || colorGroups.accent.variants.main;
            if (level !== undefined) {
              path.$value[themeName] = buildColorRef(family, level);
              console.log(`[Theme Builder] Set accent.${variant}[${themeName}] = ${buildColorRef(family, level)}`);
            }
          });

          ['main', 'soft', 'light', 'dark'].forEach(variant => {
            // Crea il nodo se non esiste
            if (!semantic.brand.secondary[variant]) {
              semantic.brand.secondary[variant] = { $type: 'color', $value: {} };
            }
            // Ora possiamo accedere al path in sicurezza
            const path = semantic.brand.secondary[variant];
            if (!path.$value) path.$value = {};

            const family = colorGroups.secondary.family;
            const level = colorGroups.secondary.variants[variant] || colorGroups.secondary.variants.main;
            if (level !== undefined) {
              path.$value[themeName] = buildColorRef(family, level);
              console.log(`[Theme Builder] Set secondary.${variant}[${themeName}] = ${buildColorRef(family, level)}`);
            }
          });

          // Add fontFamily if provided
          if (brandSettings && brandSettings.fontFamily) {
            if (!semantic.brand.fontFamily) {
              semantic.brand.fontFamily = {};
            }
            if (!semantic.brand.fontFamily.main) {
              semantic.brand.fontFamily.main = { $type: 'fontFamily', $value: {} };
            }
            if (!semantic.brand.fontFamily.main.$value) {
              semantic.brand.fontFamily.main.$value = {};
            }
            semantic.brand.fontFamily.main.$value[themeName] = brandSettings.fontFamily;
            console.log(`[Theme Builder] Set fontFamily.main[${themeName}] = ${brandSettings.fontFamily}`);
          }

          // Add radius if provided
          if (brandSettings && brandSettings.radius) {
            if (!semantic.radius) {
              semantic.radius = {};
            }
            if (!semantic.radius.brand) {
              semantic.radius.brand = { $type: 'borderRadius', $value: {} };
            }
            if (!semantic.radius.brand.$value) {
              semantic.radius.brand.$value = {};
            }
            semantic.radius.brand.$value[themeName] = brandSettings.radius;
            console.log(`[Theme Builder] Set radius.brand[${themeName}] = ${brandSettings.radius}`);
          }

          // Mark as draft until imported into Figma
          themeImportStatus[themeName] = 'draft';

          hasUnsavedChanges = true;
          updateImportButtonState();
          renderTokenTree(tokenTreeData, activeTokenMode);

          // Update JSON editor textarea
          const editor = document.getElementById('json-editor-textarea');
          if (editor) {
            isUpdatingProgrammatically = true;
            editor.value = JSON.stringify(tokenTreeData, null, 2);
            isUpdatingProgrammatically = false;

            suppressNextSync = true;
            const inputEvent = new Event('input', { bubbles: true });
            editor.dispatchEvent(inputEvent);
          }

          renderThemeList();
          selectTheme(themeName);

          console.log('[Theme Builder] Theme created successfully:', themeName);
        } catch (error) {
          console.error('[Theme Builder] Error adding theme:', error);
          showSnackbar(`Failed to create theme: ${error.message}`, 'error');
          throw error;
        }
      }

      function copySemanticTokensFromCLARA(newThemeName) {
        const semantic = tokenTreeData.semantic;

        function traverseAndCopy(obj, path = []) {
          if (!obj || typeof obj !== 'object') return;

          if (obj.$value && typeof obj.$value === 'object' && obj.$value.clara) {
            const tokenPath = path.join('.');

            // brand.theme deve usare il nome del tema, non copiare da clara
            if (tokenPath === 'brand.theme') {
              obj.$value[newThemeName] = newThemeName;
            } else {
              obj.$value[newThemeName] = obj.$value.clara;
            }
          }

          for (const key in obj) {
            if (!key.startsWith('$')) {
              traverseAndCopy(obj[key], [...path, key]);
            }
          }
        }

        traverseAndCopy(semantic, []);
      }

      function initializeThemeBuilder() {
        if (!tokenTreeData) return;

        renderThemeList();
        renderThemeEditor(null);
      }

      function setupThemeBuilderEventListeners() {
        const addBtn = document.getElementById('add-theme-btn');
        if (addBtn) {
          addBtn.addEventListener('click', addNewTheme);
        }
      }

      // ===== AUTOCOMPLETE FUNCTIONS =====

      let autocompleteState = {
        dropdown: null,
        activeIndex: -1,
        options: [],
        cachedOptions: null, // Cache for global colors
        inputEl: null,
        onSelect: null,
        debounceTimer: null,
        expandedFamilies: new Set(), // Track expanded families
        hierarchicalData: null // Cache for hierarchical structure
      };

      function buildColorAutocompleteOptions() {
        // Return cached options if available
        if (autocompleteState.cachedOptions) {
          return autocompleteState.cachedOptions;
        }

        const options = [];
        const globalColors = tokenTreeData?.global?.colors;

        if (!globalColors) return options;

        for (const [family, levels] of Object.entries(globalColors)) {
          if (typeof levels !== 'object' || !levels) continue;

          for (const [level, token] of Object.entries(levels)) {
            // Robustness: skip malformed data
            if (!token || typeof token !== 'object') continue;
            if (token.$type !== 'color' || !token.$value) continue;

            const levelNum = parseInt(level, 10);
            if (!isNaN(levelNum)) {
              options.push({
                ref: `{colors.${family}.${level}}`,
                hex: token.$value || '#000000', // Fallback
                family: family,
                level: levelNum,
                display: `colors.${family}.${level}`
              });
            }
          }
        }

        // Sort by family then level
        options.sort((a, b) => {
          if (a.family !== b.family) return a.family.localeCompare(b.family);
          return a.level - b.level;
        });

        // Cache the result
        autocompleteState.cachedOptions = options;

        return options;
      }

      // New hierarchical color options builder
      function buildHierarchicalColorOptions() {
        // Return cached if available
        if (autocompleteState.hierarchicalData) {
          return autocompleteState.hierarchicalData;
        }

        const result = [];
        const globalFamilies = new Map();
        const semanticFamilies = new Map();

        // Process GLOBAL colors
        const globalColors = tokenTreeData?.global?.colors;
        if (globalColors) {
          for (const [family, levels] of Object.entries(globalColors)) {
            if (typeof levels !== 'object' || !levels) continue;

            const familyColors = [];
            for (const [level, token] of Object.entries(levels)) {
              if (!token || typeof token !== 'object') continue;
              if (token.$type !== 'color' || !token.$value) continue;

              // REMOVE numeric-only filter - accept all levels
              familyColors.push({
                ref: `{colors.${family}.${level}}`,
                hex: token.$value || '#000000',
                level: level,
                display: `colors.${family}.${level}`
              });
            }

            if (familyColors.length > 0) {
              // Sort by level (try numeric first, then alphabetic)
              familyColors.sort((a, b) => {
                const aNum = parseInt(a.level, 10);
                const bNum = parseInt(b.level, 10);
                if (!isNaN(aNum) && !isNaN(bNum)) return aNum - bNum;
                return a.level.localeCompare(b.level);
              });

              globalFamilies.set(family, familyColors);
            }
          }
        }

        // Process SEMANTIC colors (recursive traversal)
        const semanticData = tokenTreeData?.semantic;
        if (semanticData) {
          const extractSemanticColors = (obj, path = []) => {
            for (const [key, value] of Object.entries(obj)) {
              if (!value || typeof value !== 'object') continue;

              if (value.$type === 'color') {
                // This is a color token
                const familyName = path.join('/');
                if (!semanticFamilies.has(familyName)) {
                  semanticFamilies.set(familyName, []);
                }

                const fullPath = [...path, key].join('.');
                semanticFamilies.get(familyName).push({
                  ref: `{${fullPath}}`,
                  hex: resolveTokenToHex(value.$value) || '#000000',
                  level: key,
                  display: fullPath
                });
              } else {
                // Recurse deeper
                extractSemanticColors(value, [...path, key]);
              }
            }
          };

          extractSemanticColors(semanticData);
        }

        // Build hierarchical structure
        if (globalFamilies.size > 0) {
          result.push({ type: 'header', label: 'GLOBAL COLORS' });

          // Sort families alphabetically
          const sortedGlobal = Array.from(globalFamilies.entries()).sort((a, b) =>
            a[0].localeCompare(b[0])
          );

          for (const [family, colors] of sortedGlobal) {
            result.push({
              type: 'family',
              name: family,
              count: colors.length,
              colors: colors,
              expanded: true // Default expanded
            });
          }
        }

        if (semanticFamilies.size > 0) {
          result.push({ type: 'header', label: 'SEMANTIC COLORS' });

          // Sort families alphabetically
          const sortedSemantic = Array.from(semanticFamilies.entries()).sort((a, b) =>
            a[0].localeCompare(b[0])
          );

          for (const [family, colors] of sortedSemantic) {
            result.push({
              type: 'family',
              name: family,
              count: colors.length,
              colors: colors,
              expanded: true // Default expanded
            });
          }
        }

        // Cache the result
        autocompleteState.hierarchicalData = result;

        return result;
      }

      function filterColorOptions(query, options) {
        if (!query || query.trim() === '') return options;

        const q = query.toLowerCase().replace(/[{}]/g, '');

        return options.filter(opt => {
          const display = opt.display.toLowerCase();
          const family = opt.family.toLowerCase();
          const level = String(opt.level);

          return display.includes(q) ||
            family.includes(q) ||
            level.includes(q);
        });
      }

      function showAutocomplete(inputEl, onSelectCallback) {
        autocompleteState.inputEl = inputEl;
        autocompleteState.onSelect = onSelectCallback;

        // Initialize all families as expanded if not already set
        if (autocompleteState.expandedFamilies.size === 0) {
          const hierarchicalData = buildHierarchicalColorOptions();
          for (const item of hierarchicalData) {
            if (item.type === 'family') {
              autocompleteState.expandedFamilies.add(item.name);
            }
          }
        }

        updateAutocompleteDropdown();
      }

      function updateAutocompleteDropdown() {
        const inputEl = autocompleteState.inputEl;
        if (!inputEl) return;

        const query = inputEl.value;
        const hierarchicalData = buildHierarchicalColorOptions();

        // Remove existing dropdown
        hideAutocomplete();

        if (!hierarchicalData || hierarchicalData.length === 0) {
          const dropdown = document.createElement('div');
          dropdown.className = 'autocomplete-dropdown';
          dropdown.innerHTML = '<div class="autocomplete-empty">No colors found</div>';

          const container = inputEl.parentElement;
          if (container && container.classList.contains('autocomplete-container')) {
            container.appendChild(dropdown);
            autocompleteState.dropdown = dropdown;
          }
          return;
        }

        // Filter hierarchical data based on query
        const filteredData = filterHierarchicalData(hierarchicalData, query);

        if (filteredData.length === 0) {
          const dropdown = document.createElement('div');
          dropdown.className = 'autocomplete-dropdown';
          dropdown.innerHTML = '<div class="autocomplete-empty">No colors found</div>';

          const container = inputEl.parentElement;
          if (container && container.classList.contains('autocomplete-container')) {
            container.appendChild(dropdown);
            autocompleteState.dropdown = dropdown;
          }
          return;
        }

        // Create dropdown with hierarchical structure
        const dropdown = document.createElement('div');
        dropdown.className = 'autocomplete-dropdown';

        let colorIndex = 0;
        for (const item of filteredData) {
          if (item.type === 'header') {
            // Render group header (GLOBAL COLORS / SEMANTIC COLORS)
            const header = document.createElement('div');
            header.className = 'autocomplete-group-header';
            header.textContent = item.label;
            dropdown.appendChild(header);
          } else if (item.type === 'family') {
            // Render family header
            const familyHeader = document.createElement('div');
            familyHeader.className = 'autocomplete-family-header';

            const isExpanded = autocompleteState.expandedFamilies.has(item.name);

            // Arrow icon
            const icon = document.createElement('div');
            icon.className = `autocomplete-family-icon ${isExpanded ? '' : 'collapsed'}`;
            icon.innerHTML = `<svg width="12" height="12" viewBox="0 0 12 12" fill="none"><path d="M3 4.5L6 7.5L9 4.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
            familyHeader.appendChild(icon);

            // Family name
            const nameSpan = document.createElement('span');
            nameSpan.textContent = item.name;
            familyHeader.appendChild(nameSpan);

            // Count badge
            const countSpan = document.createElement('span');
            countSpan.className = 'autocomplete-family-count';
            countSpan.textContent = `(${item.count})`;
            familyHeader.appendChild(countSpan);

            // Prevent input from losing focus when clicking header
            familyHeader.addEventListener('mousedown', (e) => {
              e.preventDefault();
            });

            // Toggle expansion on click
            familyHeader.addEventListener('click', (e) => {
              e.stopPropagation();
              toggleFamilyExpansion(item.name);
            });

            dropdown.appendChild(familyHeader);

            // Render colors if expanded
            if (isExpanded) {
              const colorsContainer = document.createElement('div');
              colorsContainer.className = 'autocomplete-family-colors';

              // REMOVE .slice(0, 50) - show ALL colors
              item.colors.forEach((color) => {
                const colorItem = document.createElement('div');
                colorItem.className = 'autocomplete-item';
                colorItem.dataset.index = colorIndex++;

                const preview = document.createElement('div');
                preview.className = 'autocomplete-color-preview';
                preview.style.backgroundColor = color.hex;

                const text = document.createElement('div');
                text.className = 'autocomplete-text';
                text.textContent = color.display;

                colorItem.appendChild(preview);
                colorItem.appendChild(text);

                colorItem.addEventListener('click', (e) => {
                  e.stopPropagation();
                  selectAutocompleteItem(color);
                });

                colorsContainer.appendChild(colorItem);
              });

              dropdown.appendChild(colorsContainer);
            }
          }
        }

        const container = inputEl.parentElement;
        if (container && container.classList.contains('autocomplete-container')) {
          container.appendChild(dropdown);
          autocompleteState.dropdown = dropdown;
          autocompleteState.activeIndex = -1;
        }
      }

      // Filter hierarchical data based on query
      function filterHierarchicalData(data, query) {
        if (!query || query.trim() === '') return data;

        const q = query.toLowerCase().replace(/[{}]/g, '');
        const result = [];

        for (const item of data) {
          if (item.type === 'header') {
            result.push(item);
          } else if (item.type === 'family') {
            // Filter colors in this family
            const filteredColors = item.colors.filter(color => {
              const display = color.display.toLowerCase();
              const level = color.level.toLowerCase();
              return display.includes(q) || level.includes(q);
            });

            if (filteredColors.length > 0) {
              result.push({
                ...item,
                colors: filteredColors,
                count: filteredColors.length
              });
            }
          }
        }

        return result;
      }

      // Toggle family expansion state
      function toggleFamilyExpansion(familyName) {
        if (autocompleteState.expandedFamilies.has(familyName)) {
          autocompleteState.expandedFamilies.delete(familyName);
        } else {
          autocompleteState.expandedFamilies.add(familyName);
        }
        updateAutocompleteDropdown();
      }

      function selectAutocompleteItem(option) {
        if (autocompleteState.inputEl && autocompleteState.onSelect) {
          autocompleteState.inputEl.value = option.ref;
          autocompleteState.onSelect(option.ref);
        }
        hideAutocomplete();
      }

      function hideAutocomplete() {
        if (autocompleteState.dropdown) {
          autocompleteState.dropdown.remove();
          autocompleteState.dropdown = null;
        }
        autocompleteState.activeIndex = -1;
      }

      function handleAutocompleteKeydown(e) {
        if (!autocompleteState.dropdown) return;

        const items = autocompleteState.dropdown.querySelectorAll('.autocomplete-item');
        if (items.length === 0) return;

        switch (e.key) {
          case 'ArrowDown':
            e.preventDefault();
            autocompleteState.activeIndex = Math.min(
              autocompleteState.activeIndex + 1,
              items.length - 1
            );
            updateActiveItem(items);
            break;

          case 'ArrowUp':
            e.preventDefault();
            autocompleteState.activeIndex = Math.max(
              autocompleteState.activeIndex - 1,
              -1
            );
            updateActiveItem(items);
            break;

          case 'Enter':
            e.preventDefault();
            if (autocompleteState.activeIndex >= 0) {
              const query = autocompleteState.inputEl.value;
              const filtered = filterColorOptions(query, autocompleteState.options);
              const option = filtered[autocompleteState.activeIndex];
              if (option) {
                selectAutocompleteItem(option);
              }
            }
            break;

          case 'Escape':
            e.preventDefault();
            hideAutocomplete();
            break;
        }
      }

      function updateActiveItem(items) {
        items.forEach((item, idx) => {
          if (idx === autocompleteState.activeIndex) {
            item.classList.add('active');
            item.scrollIntoView({ block: 'nearest' });
          } else {
            item.classList.remove('active');
          }
        });
      }

      // Update Import/Update Figma button state based on unsaved changes
      function updateImportButtonState() {
        const button = document.getElementById('import-variables-button');
        if (!button) return;

        if (hasUnsavedChanges) {
          button.disabled = false;
          button.classList.remove('disabled');
        } else {
          button.disabled = true;
          button.classList.add('disabled');
        }
      }

      // Update Export JSON button state
      function updateExportJsonButtonState(newState) {
        exportJsonButtonState = newState;
        const button = document.getElementById('export-json-button');
        if (!button) return;

        const svg = button.querySelector('svg');
        const textNode = Array.from(button.childNodes).find(node => node.nodeType === Node.TEXT_NODE);

        switch (newState) {
          case 'generate':
            if (textNode) textNode.textContent = '\n        Generate\n      ';
            button.classList.add('paused');
            svg.innerHTML = `
          <path d="M21 7L12 12V22L21 16.5V7Z" stroke="currentColor" stroke-width="1.4" stroke-linejoin="round"/>
          <path d="M12 12L3 7V17L12 22V12Z" stroke="currentColor" stroke-width="1.4" stroke-linejoin="round"/>
          <path d="M12 12L3 7L12 2L21 7L12 12Z" stroke="currentColor" stroke-width="1.4" stroke-linejoin="round"/>
          <path d="M3 17V7L12 2V12L3 17Z" stroke="currentColor" stroke-width="1.4" stroke-linejoin="round"/>
          `;
            break;
          case 'generating':
            if (textNode) textNode.textContent = '\n        Generating..\n      ';
            button.classList.remove('paused');
            break;
          case 'generated':
            if (textNode) textNode.textContent = '\n        Generated!\n      ';
            button.classList.add('paused');
            svg.innerHTML = `
          <path d="M20 6L9 17L4 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          `;
            break;
          case 'update':
            if (textNode) textNode.textContent = '\n        Update Json\n      ';
            button.classList.add('paused');
            svg.innerHTML = `
          <path d="M21 7L12 12V22L21 16.5V7Z" stroke="currentColor" stroke-width="1.4" stroke-linejoin="round"/>
          <path d="M12 12L3 7V17L12 22V12Z" stroke="currentColor" stroke-width="1.4" stroke-linejoin="round"/>
          <path d="M12 12L3 7L12 2L21 7L12 12Z" stroke="currentColor" stroke-width="1.4" stroke-linejoin="round"/>
          <path d="M3 17V7L12 2V12L3 17Z" stroke="currentColor" stroke-width="1.4" stroke-linejoin="round"/>
          `;
            break;
        }
      }

      // Update Export CSS button state
      function updateExportCssButtonState(newState) {
        exportCssButtonState = newState;
        const button = document.getElementById('export-css-button');
        if (!button) return;

        const svg = button.querySelector('svg');
        const textNode = Array.from(button.childNodes).find(node => node.nodeType === Node.TEXT_NODE);

        switch (newState) {
          case 'generate':
            if (textNode) textNode.textContent = '\n        Generate\n      ';
            button.classList.add('paused');
            svg.innerHTML = `
          <path d="M21 7L12 12V22L21 16.5V7Z" stroke="currentColor" stroke-width="1.4" stroke-linejoin="round"/>
          <path d="M12 12L3 7V17L12 22V12Z" stroke="currentColor" stroke-width="1.4" stroke-linejoin="round"/>
          <path d="M12 12L3 7L12 2L21 7L12 12Z" stroke="currentColor" stroke-width="1.4" stroke-linejoin="round"/>
          <path d="M3 17V7L12 2V12L3 17Z" stroke="currentColor" stroke-width="1.4" stroke-linejoin="round"/>
          `;
            break;
          case 'generating':
            if (textNode) textNode.textContent = '\n        Generating..\n      ';
            button.classList.remove('paused');
            break;
          case 'generated':
            if (textNode) textNode.textContent = '\n        Generated!\n      ';
            button.classList.add('paused');
            svg.innerHTML = `
          <path d="M20 6L9 17L4 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          `;
            break;
          case 'update':
            if (textNode) textNode.textContent = '\n        Update CSS\n      ';
            button.classList.add('paused');
            svg.innerHTML = `
          <path d="M21 7L12 12V22L21 16.5V7Z" stroke="currentColor" stroke-width="1.4" stroke-linejoin="round"/>
          <path d="M12 12L3 7V17L12 22V12Z" stroke="currentColor" stroke-width="1.4" stroke-linejoin="round"/>
          <path d="M12 12L3 7L12 2L21 7L12 12Z" stroke="currentColor" stroke-width="1.4" stroke-linejoin="round"/>
          <path d="M3 17V7L12 2V12L3 17Z" stroke="currentColor" stroke-width="1.4" stroke-linejoin="round"/>
          `;
            break;
        }
      }

      // Update Export Text Styles button state
      function updateExportTextStylesButtonState(newState) {
        exportTextStylesButtonState = newState;
        const button = document.getElementById('export-text-styles-button');
        if (!button) return;

        const svg = button.querySelector('svg');
        const textNode = Array.from(button.childNodes).find(node => node.nodeType === Node.TEXT_NODE);

        switch (newState) {
          case 'generate':
            if (textNode) textNode.textContent = '\n        Generate\n      ';
            button.classList.add('paused');
            svg.innerHTML = `
          <path d="M21 7L12 12V22L21 16.5V7Z" stroke="currentColor" stroke-width="1.4" stroke-linejoin="round"/>
          <path d="M12 12L3 7V17L12 22V12Z" stroke="currentColor" stroke-width="1.4" stroke-linejoin="round"/>
          <path d="M12 12L3 7L12 2L21 7L12 12Z" stroke="currentColor" stroke-width="1.4" stroke-linejoin="round"/>
          <path d="M3 17V7L12 2V12L3 17Z" stroke="currentColor" stroke-width="1.4" stroke-linejoin="round"/>
          `;
            break;
          case 'generating':
            if (textNode) textNode.textContent = '\n        Generating..\n      ';
            button.classList.remove('paused');
            break;
          case 'generated':
            if (textNode) textNode.textContent = '\n        Generated!\n      ';
            button.classList.add('paused');
            svg.innerHTML = `
          <path d="M20 6L9 17L4 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          `;
            break;
          case 'update':
            if (textNode) textNode.textContent = '\n        Update Text Styles\n      ';
            button.classList.add('paused');
            svg.innerHTML = `
          <path d="M21 7L12 12V22L21 16.5V7Z" stroke="currentColor" stroke-width="1.4" stroke-linejoin="round"/>
          <path d="M12 12L3 7V17L12 22V12Z" stroke="currentColor" stroke-width="1.4" stroke-linejoin="round"/>
          <path d="M12 12L3 7L12 2L21 7L12 12Z" stroke="currentColor" stroke-width="1.4" stroke-linejoin="round"/>
          <path d="M3 17V7L12 2V12L3 17Z" stroke="currentColor" stroke-width="1.4" stroke-linejoin="round"/>
          `;
            break;
        }
      }

      // Old progress functions removed - using SimpleProgressLoader instead

      // ==================== TOKEN TREE VIEW FUNCTIONS ====================

      /**
       * Get paths of all currently open panels in the tree
       * @returns {Set<String>} Set of paths for open panels
       */
      function getOpenTreePaths() {
        const openPaths = new Set();
        const treeRoot = document.getElementById('token-tree-root');
        if (!treeRoot) return openPaths;

        // Find all open containers
        const openContainers = treeRoot.querySelectorAll('.token-collection.open, .token-group.open');
        openContainers.forEach(container => {
          const header = container.querySelector('.token-collection-header, .token-group-header');
          if (header && header.dataset.path) {
            openPaths.add(header.dataset.path);
          }
        });

        return openPaths;
      }

      /**
       * Render Token Tree from W3C JSON
       * @param {Object} json - W3C Design Tokens JSON
       * @param {String} selectedMode - Active mode name (e.g., "Default", "Dark")
       * @param {Set<String>} openPaths - Optional set of paths that should be open
       */
      function renderTokenTree(json, selectedMode, openPaths = null) {

        const treeRoot = document.getElementById('token-tree-root');
        if (!treeRoot) {
          console.error('[renderTokenTree] token-tree-root not found!');
          return;
        }

        // üíæ IMPORTANT: Save open/closed state BEFORE clearing DOM
        if (!openPaths) {
          openPaths = getOpenTreePaths();
        }

        // Clear existing content (this destroys all elements)
        treeRoot.innerHTML = '';

        // Store data globally
        tokenTreeData = json;
        activeTokenMode = selectedMode;

        if (!json || Object.keys(json).length === 0) {

          treeRoot.innerHTML = `
          <div class="token-tree-empty" style="padding: var(--space-4); text-align: center; color: var(--color-text-secondary); font-size: 13px;">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin: 0 auto var(--space-2); opacity: 0.3;">
              <path d="M12 2C10.9391 2 9.92172 2.42143 9.17157 3.17157C8.42143 3.92172 8 4.93913 8 6C8 7.06087 8.42143 8.07828 9.17157 8.82843C9.92172 9.57857 10.9391 10 12 10C13.0609 10 14.0783 9.57857 14.8284 8.82843C15.5786 8.07828 16 7.06087 16 6C16 4.93913 15.5786 3.92172 14.8284 3.17157C14.0783 2.42143 13.0609 2 12 2Z" fill="currentColor"/>
              <path d="M6 14C4.93913 14 3.92172 14.4214 3.17157 15.1716C2.42143 15.9217 2 16.9391 2 18C2 19.0609 2.42143 20.0783 3.17157 20.8284C3.92172 21.5786 4.93913 22 6 22C7.06087 22 8.07828 21.5786 8.82843 20.8284C9.57857 20.0783 10 19.0609 10 18C10 16.9391 9.57857 15.9217 8.82843 15.1716C8.07828 14.4214 7.06087 14 6 14Z" fill="currentColor"/>
              <path d="M18 14C16.9391 14 15.9217 14.4214 15.1716 15.1716C14.4214 15.9217 14 16.9391 14 18C14 19.0609 14.4214 20.0783 15.1716 20.8284C15.9217 21.5786 16.9391 22 18 22C19.0609 22 20.0783 21.5786 20.8284 20.8284C21.5786 20.0783 22 19.0609 22 18C22 16.9391 21.5786 15.9217 20.8284 15.1716C20.0783 14.4214 19.0609 14 18 14Z" fill="currentColor"/>
            </svg>
            <p>No variables found</p>
            <p style="font-size: 12px; margin-top: var(--space-1);">Load an example or import JSON to see tokens</p>
          </div>
        `;
          return;
        }

        // Render collections recursively with open state
        const collectionsHTML = renderTokenGroup(json, '', selectedMode, 0, openPaths);
        treeRoot.innerHTML = collectionsHTML;

        // Attach event listeners
        attachTokenTreeListeners();
      }

      /**
       * Recursively render token groups
       * @param {Object} obj - Current JSON object level
       * @param {String} path - Current path (e.g., "colors.primary")
       * @param {String} selectedMode - Active mode (fallback)
       * @param {Number} depth - Nesting level
       * @param {Set<String>} openPaths - Set of paths that should be rendered as open
       * @param {String} collectionPath - Path of parent collection (to track collection-specific mode)
       */
      function renderTokenGroup(obj, path, selectedMode, depth, openPaths = new Set(), collectionPath = null) {
        let html = '';

        for (const [key, value] of Object.entries(obj)) {
          const fullPath = path ? `${path}.${key}` : key;

          // Check if it's a token (has $value or $type)
          if (value && typeof value === 'object' && (value.$value !== undefined || value.$type !== undefined)) {
            // It's a token - render token item using collection-specific mode
            const effectiveMode = collectionPath ?
              (collectionActiveModes.get(collectionPath) || selectedMode) :
              selectedMode;

            html += renderTokenItem(key, value, fullPath, effectiveMode);
          } else if (value && typeof value === 'object') {
            // It's a group - render group header + nested tokens
            const isCollection = depth === 0;
            const headerClass = isCollection ? 'token-collection-header' : 'token-group-header';
            const containerClass = isCollection ? 'token-collection' : 'token-group';


            // Check if this panel should be open
            const isOpen = openPaths.has(fullPath);
            const chevronClass = isOpen ? 'token-chevron' : 'token-chevron collapsed';
            const listClass = isOpen ? 'token-list' : 'token-list hidden';
            const containerOpenClass = isOpen ? ' open' : '';

            // Track active mode for this collection
            let activeCollectionMode = selectedMode;
            let modeChipHTML = '';

            // Determine which collection path to use for child tokens
            const currentCollectionPath = isCollection ? fullPath : collectionPath;

            if (isCollection) {
              const collectionModes = extractModesFromCollection(value);

              if (collectionModes.length > 1) {
                // Get active mode for this collection
                // Priority: saved mode > selectedMode (if valid) > first available mode
                let activeCollectionMode = collectionActiveModes.get(fullPath);

                if (!activeCollectionMode) {
                  // Check if selectedMode is valid for this collection
                  if (selectedMode && collectionModes.includes(selectedMode)) {
                    activeCollectionMode = selectedMode;
                  } else {
                    // Use first available mode from this collection
                    activeCollectionMode = collectionModes[0];
                  }

                  // üÜï AUTO-INITIALIZE: Save the determined mode
                  collectionActiveModes.set(fullPath, activeCollectionMode);
                } else {
                }

                // Build dropdown options
                const optionsHTML = collectionModes.map(mode => `
                <button class="mode-option ${mode === activeCollectionMode ? 'selected' : ''}" data-mode="${mode}">
                  <span>${mode}</span>
                  <svg class="mode-option-check" viewBox="0 0 12 12" fill="currentColor">
                    <path d="M10 3L4.5 8.5L2 6" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </button>
              `).join('');

                modeChipHTML = `
                <div class="mode-chip" data-collection="${fullPath}" onclick="event.stopPropagation();">
                  <span class="mode-chip-label">
                    <svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M6.36066 2.448C6.83003 2.17372 7.41171 2.17445 7.88019 2.45093L9.77863 3.57202C10.2355 3.84179 10.5158 4.33346 10.5159 4.86401V7.1355C10.5159 7.66608 10.2355 8.15765 9.77863 8.42749L7.88019 9.54858C7.41173 9.82507 6.83004 9.82672 6.36066 9.55249L7.34406 8.97241C7.36582 8.96553 7.3873 8.95692 7.40851 8.948L7.49933 8.9021L9.39777 7.78101C9.62599 7.64605 9.76593 7.40066 9.76593 7.1355V4.86401C9.76585 4.63197 9.65862 4.41513 9.47882 4.27417L9.39777 4.21851L7.49933 3.09741C7.45012 3.06836 7.39818 3.04595 7.34503 3.02905L6.36066 2.448ZM4.1048 2.45093C4.57518 2.17321 5.15976 2.17331 5.63019 2.45093L7.52863 3.57202C7.98552 3.84181 8.26588 4.33342 8.26593 4.86401V7.1355C8.26593 7.66613 7.98553 8.15767 7.52863 8.42749L5.63019 9.54858C5.15973 9.82626 4.57522 9.82636 4.1048 9.54858L2.20636 8.42749C1.74946 8.15767 1.46906 7.66613 1.46906 7.1355V4.86401C1.46911 4.33342 1.74946 3.84181 2.20636 3.57202L4.1048 2.45093ZM5.24933 3.09741C5.01412 2.95856 4.72185 2.95857 4.48663 3.09741L2.5882 4.21851L2.50616 4.27417C2.32649 4.41516 2.2191 4.63204 2.21906 4.86401V7.1355C2.21906 7.4008 2.35976 7.64609 2.5882 7.78101L4.48663 8.9021C4.69252 9.02367 4.94174 9.03923 5.15851 8.948L5.24933 8.9021L7.14777 7.78101C7.37606 7.64606 7.51593 7.40071 7.51593 7.1355V4.86401C7.51588 4.63192 7.40865 4.41515 7.22882 4.27417L7.14777 4.21851L5.24933 3.09741ZM4.87531 5.24976C5.28931 5.24992 5.62519 5.58574 5.62531 5.99976C5.62531 6.41387 5.28938 6.74959 4.87531 6.74976C4.46109 6.74976 4.12531 6.41397 4.12531 5.99976C4.12542 5.58564 4.46116 5.24976 4.87531 5.24976Z" fill="currentColor"/>
                    </svg>

                    ${activeCollectionMode}
                  </span>
                  <svg class="mode-chip-arrow" viewBox="0 0 8 8" fill="currentColor">
                    <path d="M1 2l3 3 3-3H1z"/>
                  </svg>
                  <div class="mode-chip-dropdown">
                    ${optionsHTML}
                  </div>
                </div>
              `;
              }
            }

            html += `
            <div class="${containerClass}${containerOpenClass}">
              <div class="${headerClass}" data-path="${fullPath}">
                <svg class="${chevronClass}" viewBox="0 0 12 12" fill="currentColor">
                  <path d="M3 5l3 3 3-3H3z"/>
                </svg>
                <span>${key}</span>
                ${modeChipHTML}
              </div>
              <div class="${listClass}" data-parent="${fullPath}">
                ${renderTokenGroup(value, fullPath, selectedMode, depth + 1, openPaths, currentCollectionPath)}
              </div>
            </div>
          `;
          }
        }

        return html;
      }

      /**
       * Render individual token item
       * @param {String} name - Token name
       * @param {Object} token - Token data ($value, $type, etc.)
       * @param {String} path - Full token path
       * @param {String} selectedMode - Active mode
       */
      function renderTokenItem(name, token, path, selectedMode) {
        const type = token.$type || 'string';
        let displayValue = token.$value;

        // Handle multi-mode values
        if (typeof displayValue === 'object' && !Array.isArray(displayValue) && displayValue !== null) {
          // Check if it's RGB color object
          if (displayValue.r !== undefined) {
            displayValue = rgbToHex(displayValue);
          } else if (selectedMode && displayValue[selectedMode] !== undefined) {
            // It's a mode object
            displayValue = displayValue[selectedMode];
          } else {
            // Use first available mode
            const modes = Object.keys(displayValue);
            displayValue = modes.length > 0 ? displayValue[modes[0]] : JSON.stringify(displayValue);
          }
        }

        // Convert display value to string
        const displayStr = formatTokenValue(displayValue, type);
        const fullValue = JSON.stringify(token.$value);

        // Render icon/swatch based on type
        let iconHTML = '';
        if (type === 'color') {
          // Resolve alias if displayValue is an alias reference
          let resolvedColorValue = resolveAliasValue(displayValue, selectedMode);

          // Convert to hex if it's an RGB object
          const colorValue = typeof resolvedColorValue === 'object' && resolvedColorValue.r !== undefined ? rgbToHex(resolvedColorValue) : resolvedColorValue;

          iconHTML = `
          <div class="token-swatch">
            <div class="token-swatch-color" style="background-color: ${colorValue};"></div>
          </div>
        `;
        } else {
          const iconSVG = getTokenIcon(type);
          iconHTML = `<div class="token-icon">${iconSVG}</div>`;
        }

        return `
        <div class="token-item"
             data-path="${path}"
             data-type="${type}"
             data-value='${fullValue.replace(/'/g, "&apos;")}'>
          ${iconHTML}
          <span class="token-name">${name}</span>
          <span class="token-value" data-editable="true">${displayStr}</span>
          <svg class="token-edit-btn" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M11.5 2.5L13.5 4.5M2 14L3.5 10L11 2.5L13.5 5L6 12.5L2 14Z" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
      `;
      }

      /**
       * Format token value for display
       */
      function formatTokenValue(value, type) {
        if (value === null || value === undefined) return 'null';

        if (typeof value === 'object') {
          if (value.r !== undefined) return rgbToHex(value); // RGB color
          return JSON.stringify(value);
        }

        if (type === 'dimension' || type === 'number') {
          return typeof value === 'number' ? `${value}px` : value;
        }

        return String(value);
      }

      /**
       * RGB to HEX converter
       */
      function rgbToHex(rgb) {
        const toHex = (n) => {
          const hex = Math.round(n * 255).toString(16);
          return hex.length === 1 ? '0' + hex : hex;
        };
        return `#${toHex(rgb.r)}${toHex(rgb.g)}${toHex(rgb.b)}`;
      }

      /**
       * Resolve alias value to actual value
       * @param {*} value - Value that might be an alias (e.g., "{primitives.colors.blue.600}")
       * @param {String} selectedMode - Current active mode
       * @param {Number} depth - Recursion depth to prevent infinite loops
       * @returns {*} Resolved value or original value if not an alias
       */
      function resolveAliasValue(value, selectedMode, depth = 0) {
        // Prevent infinite recursion
        if (depth > 10) {
          return value;
        }

        // Check if value is an alias (string starting with { and ending with })
        if (typeof value !== 'string' || !value.startsWith('{') || !value.endsWith('}')) {
          return value;
        }

        // Check if tokenTreeData is available
        if (!tokenTreeData) {
          return value;
        }

        // Extract path from alias (remove { and })
        const aliasPath = value.slice(1, -1);

        // Split path into segments (e.g., "colors.blue.600" -> ["colors", "blue", "600"])
        const pathSegments = aliasPath.split('.');

        // Try to find the token by searching in all root collections
        let current = null;

        // First, try direct path from root
        current = tokenTreeData;
        for (const segment of pathSegments) {
          if (!current || typeof current !== 'object') {
            current = null;
            break;
          }
          current = current[segment];
        }

        // If not found, try searching in each collection (primitives, semantic, components, etc.)
        if (!current || typeof current !== 'object' || current.$value === undefined) {
          for (const collectionKey in tokenTreeData) {
            if (collectionKey.startsWith('$')) continue; // Skip metadata keys

            let temp = tokenTreeData[collectionKey];
            let found = true;

            for (const segment of pathSegments) {
              if (!temp || typeof temp !== 'object') {
                found = false;
                break;
              }
              temp = temp[segment];
            }

            if (found && temp && typeof temp === 'object' && temp.$value !== undefined) {
              current = temp;
              break;
            }
          }
        }

        // Check if we found a valid token
        if (!current || typeof current !== 'object') {
          return value;
        }

        // Get the $value from the resolved token
        let resolvedValue = current.$value;

        if (resolvedValue === undefined) {
          return value;
        }

        // Handle multi-mode values in the resolved token
        if (typeof resolvedValue === 'object' && !Array.isArray(resolvedValue) && resolvedValue !== null) {
          // Check if it's RGB color object
          if (resolvedValue.r !== undefined) {
            return resolvedValue; // Return RGB object as-is
          }

          // It's a mode object - extract value for selected mode
          if (selectedMode && resolvedValue[selectedMode] !== undefined) {
            resolvedValue = resolvedValue[selectedMode];
          } else {
            // Use first available mode as fallback
            const modes = Object.keys(resolvedValue);
            resolvedValue = modes.length > 0 ? resolvedValue[modes[0]] : resolvedValue;
          }
        }

        // Recursively resolve if the resolved value is also an alias
        if (typeof resolvedValue === 'string' && resolvedValue.startsWith('{') && resolvedValue.endsWith('}')) {
          return resolveAliasValue(resolvedValue, selectedMode, depth + 1);
        }

        return resolvedValue;
      }

      /**
       * Get icon SVG for token type
       */
      function getTokenIcon(type) {
        // SVG icon definitions from /icon svg/icon/variables/
        const numberIcon = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M8.33333 6.5C7.32081 6.5 6.5 7.32081 6.5 8.33333V15.6667C6.5 16.6792 7.32081 17.5 8.33333 17.5H15.6667C16.6792 17.5 17.5 16.6792 17.5 15.6667V8.33333C17.5 7.32081 16.6792 6.5 15.6667 6.5H8.33333ZM7.41667 8.33333C7.41667 7.82708 7.82707 7.41667 8.33333 7.41667H15.6667C16.1729 7.41667 16.5833 7.82708 16.5833 8.33333V15.6667C16.5833 16.1729 16.1729 16.5833 15.6667 16.5833H8.33333C7.82707 16.5833 7.41667 16.1729 7.41667 15.6667V8.33333ZM11.5394 9.75394C11.5646 9.50207 11.3808 9.27746 11.129 9.25227C10.8771 9.22709 10.6525 9.41086 10.6273 9.66273L10.5769 10.1667H9.70833C9.45521 10.1667 9.25 10.3719 9.25 10.625C9.25 10.8781 9.45521 11.0833 9.70833 11.0833H10.4852L10.3019 12.9167H9.70833C9.45521 12.9167 9.25 13.1219 9.25 13.375C9.25 13.6281 9.45521 13.8333 9.70833 13.8333H10.2102L10.169 14.246C10.1438 14.4979 10.3275 14.7225 10.5794 14.7477C10.8313 14.7729 11.0558 14.5891 11.081 14.3373L11.1315 13.8333H12.5019L12.4606 14.246C12.4354 14.4979 12.6192 14.7225 12.871 14.7477C13.1229 14.7729 13.3475 14.5891 13.3727 14.3373L13.4231 13.8333H14.2917C14.5448 13.8333 14.75 13.6281 14.75 13.375C14.75 13.1219 14.5448 12.9167 14.2917 12.9167H13.5148L13.6981 11.0833H14.2917C14.5448 11.0833 14.75 10.8781 14.75 10.625C14.75 10.3719 14.5448 10.1667 14.2917 10.1667H13.7898L13.831 9.75394C13.8563 9.50207 13.6725 9.27746 13.4207 9.25227C13.1688 9.22709 12.9442 9.41086 12.919 9.66273L12.8685 10.1667H11.4981L11.5394 9.75394ZM11.2231 12.9167L11.4065 11.0833H12.7769L12.5935 12.9167H11.2231Z" fill="black" fill-opacity="0.9"/></svg>';
        const stringIcon = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M8.33333 7.41667H15.6667C16.1729 7.41667 16.5833 7.82707 16.5833 8.33333V15.6667C16.5833 16.1729 16.1729 16.5833 15.6667 16.5833H8.33333C7.82707 16.5833 7.41667 16.1729 7.41667 15.6667V8.33333C7.41667 7.82707 7.82707 7.41667 8.33333 7.41667ZM6.5 8.33333C6.5 7.32081 7.32081 6.5 8.33333 6.5H15.6667C16.6792 6.5 17.5 7.32081 17.5 8.33333V15.6667C17.5 16.6792 16.6792 17.5 15.6667 17.5H8.33333C7.32081 17.5 6.5 16.6792 6.5 15.6667V8.33333ZM9.70833 9.25C9.45521 9.25 9.25 9.45521 9.25 9.70833V10.625C9.25 10.8781 9.45521 11.0833 9.70833 11.0833C9.96146 11.0833 10.1667 10.8781 10.1667 10.625V10.1667H11.5417V13.8333H11.0833C10.8302 13.8333 10.625 14.0386 10.625 14.2917C10.625 14.5448 10.8302 14.75 11.0833 14.75H12H12.9167C13.1698 14.75 13.375 14.5448 13.375 14.2917C13.375 14.0386 13.1698 13.8333 12.9167 13.8333H12.4583V10.1667H13.8333V10.625C13.8333 10.8781 14.0386 11.0833 14.2917 11.0833C14.5448 11.0833 14.75 10.8781 14.75 10.625V9.70833C14.75 9.45521 14.5448 9.25 14.2917 9.25H12H9.70833Z" fill="black" fill-opacity="0.9"/></svg>';
        const booleanIcon = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.1666 8.33335H13.8333C15.8583 8.33335 17.5 9.97498 17.5 12C17.5 14.025 15.8583 15.6667 13.8333 15.6667H10.1666C8.1416 15.6667 6.49998 14.025 6.49998 12C6.49998 9.97498 8.1416 8.33335 10.1666 8.33335ZM5.58331 12C5.58331 9.46871 7.63534 7.41669 10.1666 7.41669H13.8333C16.3646 7.41669 18.4166 9.46871 18.4166 12C18.4166 14.5313 16.3646 16.5834 13.8333 16.5834H10.1666C7.63534 16.5834 5.58331 14.5313 5.58331 12ZM10.1666 13.8334C9.15412 13.8334 8.33331 13.0126 8.33331 12C8.33331 10.9875 9.15412 10.1667 10.1666 10.1667C11.1792 10.1667 12 10.9875 12 12C12 13.0126 11.1792 13.8334 10.1666 13.8334ZM7.41665 12C7.41665 10.4812 8.64786 9.25002 10.1666 9.25002C11.6855 9.25002 12.9166 10.4812 12.9166 12C12.9166 13.5188 11.6855 14.75 10.1666 14.75C8.64786 14.75 7.41665 13.5188 7.41665 12Z" fill="black" fill-opacity="0.9"/></svg>';

        // Type to icon mapping
        const iconMap = {
          // Numbers, dimensions, spacing
          'number': numberIcon,
          'dimension': numberIcon,
          'spacing': numberIcon,
          'borderRadius': numberIcon,

          // Text and typography
          'string': stringIcon,
          'text': stringIcon,
          'fontFamily': stringIcon,
          'fontWeight': stringIcon,
          'typography': stringIcon,

          // Boolean
          'boolean': booleanIcon
        };

        // Return mapped icon or fallback to number icon (most generic)
        return iconMap[type] || numberIcon;
      }

      /**
       * Attach event listeners to token tree
       */
      function attachTokenTreeListeners() {
        // Collapse/Expand groups
        document.querySelectorAll('.token-collection-header, .token-group-header').forEach(header => {
          header.addEventListener('click', (e) => {
            e.stopPropagation();
            const chevron = header.querySelector('.token-chevron');
            const path = header.dataset.path;
            const list = document.querySelector(`.token-list[data-parent="${path}"]`);
            const container = header.parentElement; // Get the parent container

            if (list && container) {
              list.classList.toggle('hidden');
              chevron.classList.toggle('collapsed');
              container.classList.toggle('open'); // ‚Üê ADD THIS LINE!
            }
          });
        });

        // Token hover - tooltip is handled by the unified grid-tooltip system below
        // Removed duplicate event listeners to prevent double tooltips

        // Token click - inline edit
        document.querySelectorAll('.token-value[data-editable="true"]').forEach(valueEl => {
          valueEl.addEventListener('click', (e) => {
            e.stopPropagation();
            startInlineEdit(valueEl);
          });
        });

        // Mode chip - toggle dropdown
        document.querySelectorAll('.mode-chip').forEach(chip => {
          chip.addEventListener('click', (e) => {
            e.stopPropagation();

            // Close all other dropdowns
            document.querySelectorAll('.mode-chip.active').forEach(otherChip => {
              if (otherChip !== chip) {
                otherChip.classList.remove('active');
              }
            });

            // Toggle this dropdown
            const isActive = chip.classList.toggle('active');

            // Position dropdown with fixed positioning
            if (isActive) {
              const dropdown = chip.querySelector('.mode-chip-dropdown');
              if (dropdown) {
                const chipRect = chip.getBoundingClientRect();
                dropdown.style.top = `${chipRect.bottom + 4}px`;
                dropdown.style.right = `${window.innerWidth - chipRect.right}px`;
              }
            }
          });
        });

        // Mode option - switch mode
        document.querySelectorAll('.mode-option').forEach(option => {
          option.addEventListener('click', (e) => {
            e.stopPropagation();
            const modeName = option.dataset.mode;
            const chip = option.closest('.mode-chip');
            const collectionPath = chip.dataset.collection;

            // Update active mode for this collection
            collectionActiveModes.set(collectionPath, modeName);

            // Close dropdown
            chip.classList.remove('active');

            // Re-render tree with new mode
            renderTokenTree(tokenTreeData, modeName);
          });
        });

        // Edit button - start inline edit
        document.querySelectorAll('.token-edit-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const tokenItem = btn.closest('.token-item');
            const valueEl = tokenItem.querySelector('.token-value[data-editable="true"]');
            if (valueEl) {
              startInlineEdit(valueEl);
            }
          });
        });

        // Close dropdowns when clicking outside
        document.addEventListener('click', (e) => {
          if (!e.target.closest('.mode-chip')) {
            document.querySelectorAll('.mode-chip.active').forEach(chip => {
              chip.classList.remove('active');
            });
          }
        });
      }

      /**
       * DEPRECATED: Tooltip system unified - now handled by grid-tooltip below
       * These functions are kept for reference but are no longer used
       */
      // function showTokenTooltip(e) { ... }
      // function hideTokenTooltip() { ... }

      /**
       * Start inline editing
       */
      function startInlineEdit(valueEl) {
        const item = valueEl.closest('.token-item');
        const path = item.dataset.path;
        const type = item.dataset.type;
        const currentValue = valueEl.textContent;

        // Create input
        const input = document.createElement('input');
        input.type = 'text';
        input.className = 'token-value editable-input';
        input.value = currentValue;

        // Replace span with input
        valueEl.replaceWith(input);
        input.focus();
        input.select();

        item.classList.add('editing');

        // Blur handler function (so we can remove it)
        const blurHandler = () => {
          saveInlineEdit(input, valueEl, path, type);
        };

        // Save on Enter
        input.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            // Remove blur listener to prevent double-save when input is removed
            input.removeEventListener('blur', blurHandler);
            saveInlineEdit(input, valueEl, path, type);
          } else if (e.key === 'Escape') {
            input.removeEventListener('blur', blurHandler);
            cancelInlineEdit(input, valueEl);
          }
        });

        // Save on blur
        input.addEventListener('blur', blurHandler);
      }

      /**
       * Save inline edit
       */
      function saveInlineEdit(input, originalSpan, path, type) {
        const newValue = input.value.trim();
        const item = input.closest('.token-item');

        if (!item) return;

        try {
          // Update JSON in editor
          updateJSONFromTreeEdit(path, newValue, type);

          // Restore span
          originalSpan.textContent = newValue;
          input.replaceWith(originalSpan);
          item.classList.remove('editing');
        } catch (error) {
          console.error('‚ùå Error saving inline edit:', error);
          // On error, restore original state
          input.replaceWith(originalSpan);
          item.classList.remove('editing');
        }
      }

      /**
       * Cancel inline edit
       */
      function cancelInlineEdit(input, originalSpan) {
        const item = input.closest('.token-item');
        input.replaceWith(originalSpan);
        if (item) item.classList.remove('editing');
      }

      /**
       * Update JSON data when token is edited in tree
       * Updates tokenTreeData in memory and re-renders tree view
       * JSON editor will be synced when user switches tabs or manually edits
       * @param {String} path - Token path (e.g., "colors.primary")
       * @param {String} newValue - New value
       * @param {String} type - Token type
       */
      function updateJSONFromTreeEdit(path, newValue, type) {

        try {
          // Work with tokenTreeData in memory (source of truth for tree view)
          let json = tokenTreeData;

          // If tokenTreeData is not initialized, read from editor
          if (!json) {
            const editor = document.getElementById('json-editor-textarea');
            if (editor && editor.value.trim()) {
              json = JSON.parse(editor.value);
            } else {
              console.error('‚ùå [updateJSONFromTreeEdit] No JSON data available');
              return;
            }
          }

          // Navigate to path and update $value
          const pathParts = path.split('.');
          let current = json;

          for (let i = 0; i < pathParts.length - 1; i++) {
            if (!current[pathParts[i]]) {
              console.error(`[updateJSONFromTreeEdit] Path not found at ${pathParts[i]}`);
              return;
            }
            current = current[pathParts[i]];
          }

          const lastKey = pathParts[pathParts.length - 1];

          if (current[lastKey] && current[lastKey].$value !== undefined) {
            // Parse value based on type
            let parsedValue = newValue;
            if (type === 'color') {
              parsedValue = newValue; // Keep as hex string
            } else if (type === 'number' || type === 'dimension') {
              parsedValue = parseFloat(newValue.replace('px', '')) || 0;
            } else if (type === 'boolean') {
              parsedValue = newValue === 'true';
            }

            // Update the value
            current[lastKey].$value = parsedValue;

            // Update global tokenTreeData
            tokenTreeData = json;

            // Re-render tree view (will preserve open panels automatically)
            renderTokenTree(json, activeTokenMode);

            // Update JSON editor
            const editor = document.getElementById('json-editor-textarea');
            if (editor) {
              isUpdatingProgrammatically = true;

              const newJsonString = JSON.stringify(json, null, 2);
              editor.value = newJsonString;

              isUpdatingProgrammatically = false;

              // Manually trigger input event to update line numbers, syntax highlight, etc.
              // Set suppressNextSync flag to prevent redundant tree re-render
              suppressNextSync = true;
              const inputEvent = new Event('input', { bubbles: true });
              editor.dispatchEvent(inputEvent);

              // Mark as having unsaved changes after inline edit
              if (!hasUnsavedChanges) {
                hasUnsavedChanges = true;
                updateImportButtonState();
              }

            } else {
              console.error('‚ùå [updateJSONFromTreeEdit] JSON editor not found!');
            }
          } else {
          }

        } catch (error) {
          console.error('‚ùå [updateJSONFromTreeEdit] Error:', error);
          isUpdatingProgrammatically = false;
        }
      }

      /**
       * Update Mode Selector dropdown (DEPRECATED - kept for backwards compatibility)
       * Mode selection now happens via collection-specific chips
       * @param {Array} modes - Array of mode objects [{id, name}]
       */
      function updateModeSelector(modes) {
        // Set first mode as active token mode (fallback)
        if (modes && modes.length > 0) {
          activeTokenMode = modes[0].name || modes[0].id;
        }
        // Note: No UI update needed - mode chips handle this now
      }

      /**
       * Debounced sync from JSON Editor to Token Tree
       */
      function syncJSONToTokenTree() {

        // Check if we should suppress this sync (e.g., after inline edit)
        if (suppressNextSync) {
          suppressNextSync = false;
          return;
        }

        clearTimeout(tokenTreeDebounceTimer);

        tokenTreeDebounceTimer = setTimeout(() => {
          try {
            const editor = document.getElementById('json-editor-textarea');
            if (!editor) {
              return;
            }

            const json = JSON.parse(editor.value);
            // renderTokenTree will automatically preserve open state
            renderTokenTree(json, activeTokenMode);
          } catch (error) {
            // Invalid JSON - keep current tree
          }
        }, 150); // 150ms debounce - faster response for better UX
      }

      // ==================== END TOKEN TREE VIEW FUNCTIONS ====================

      // Message handlers
      function sendMessage(type, data = {}) {
        parent.postMessage({ pluginMessage: Object.assign({ type: type }, data) }, '*');
      }

      // Listen for messages from main thread
      window.addEventListener('message', (event) => {
        const pluginMessage = event.data.pluginMessage || {};
        const type = pluginMessage.type;
        const data = Object.assign({}, pluginMessage);
        delete data.type;

        switch (type) {
          case 'init-data':
            handleInitData(data);
            break;
          case 'collections-data':
            handleCollectionsData(data);
            break;
          case 'analysis-result':
            handleAnalysisResult(data);
            break;
          case 'import-progress':
            handleImportProgress(data);
            break;
          case 'import-result':
            handleImportResult(data);
            break;
          case 'json-result':
            handleJsonResult(data);
            break;
          case 'json-advanced-result':
            handleJsonAdvancedResult(data);
            break;
          case 'css-result':
            handleCssResult(data);
            break;
          case 'css-advanced-result':
            handleCssAdvancedResult(data);
            break;
          case 'text-styles-export-result':
            handleTextStylesResult(data);
            break;
          case 'sophisticated-loader-show':
            showSophisticatedLoader();
            break;
          case 'sophisticated-loader-update':
            updateSophisticatedLoader(data.percentage);
            break;
          case 'sophisticated-loader-hide':
            hideSophisticatedLoader();
            break;
          case 'error':
            showSnackbar(data.message, 'error');
            hideSophisticatedLoader(); // Hide simple progress bar on error
            break;
          case 'collection-management-result':
            handleCollectionManagementResult(data);
            break;
          // GitHub integration handlers
          case 'github-config-loaded':
            handleGitHubConfigLoaded(data);
            break;
          case 'github-config-saved':
            handleGitHubConfigSaved(data);
            break;
          case 'github-test-connection-request':
            executeGitHubTestConnection(data);
            break;
          case 'github-test-result':
            handleGitHubTestResult(data);
            break;
          case 'github-push-request':
            executeGitHubPush(data);
            break;
          case 'github-push-result':
            handleGitHubPushResult(data);
            break;
        }
      });

      // ================== SIMPLE PROGRESS BAR FUNCTIONS ==================

      function showSophisticatedLoader() {
        const progressBar = document.getElementById('simple-progress-bar');
        const progressFill = document.getElementById('simple-progress-fill');

        if (progressBar && progressFill) {
          // Reset progress
          progressFill.style.width = '0%';

          // Show progress bar with animation
          progressBar.classList.add('show');
        }
      }

      function updateSophisticatedLoader(percentage) {
        const progressFill = document.getElementById('simple-progress-fill');

        if (progressFill && percentage !== undefined) {
          progressFill.style.width = `${percentage}%`;
        }
      }

      function hideSophisticatedLoader() {
        const progressBar = document.getElementById('simple-progress-bar');
        if (progressBar) {
          progressBar.classList.remove('show');

          // Reset progress after animation completes
          setTimeout(() => {
            if (!progressBar.classList.contains('show')) {
              const progressFill = document.getElementById('simple-progress-fill');
              if (progressFill) progressFill.style.width = '0%';
            }
          }, 200); // Match CSS transition duration
        }
      }


      // Initialize plugin
      function initPlugin() {
        setupTabNavigation();
        setupEventListeners();
        setupResizeHandle();
        setupGetCodeDropdowns();

        // Delay custom components initialization to ensure DOM is ready
        setTimeout(() => {
          initializeCustomComponents();
        }, 100);

        // Signal backend that UI is ready (prevents race conditions)
        sendMessage('ui-ready');

        requestCollections();
      }

      // Update CSS customization options visibility
      function updateCssCustomizationVisibility() {
        const customizationOptions = document.getElementById('css-customization-options');

        // Show customization options only if:
        // 1. Pro mode is enabled (isAdvancedCssMode)
        // 2. Standard CSS format is selected (not Tailwind)

        let showCustomization = false;

        if (isAdvancedCssMode) {
          const formatSelect = document.getElementById('css-expert-format-select');
          if (formatSelect && formatSelect.value === 'standard') {
            showCustomization = true;
          }
        }

        if (customizationOptions) {
          customizationOptions.style.display = showCustomization ? 'block' : 'none';
        }
      }

      // Collect CSS customization options
      function getCssCustomizationOptions() {
        return {
          // CSS Selectors
          baseSelector: (document.getElementById('css-base-selector') && document.getElementById('css-base-selector').value) || ':root',
          themeSelector: (document.getElementById('css-theme-selector') && document.getElementById('css-theme-selector').value) || '.theme-{theme}',

          // Token Names
          tokenNameStyle: (document.getElementById('css-token-name-style') && document.getElementById('css-token-name-style').value) || 'kebab',
          tokenNameStructure: (document.getElementById('css-token-name-structure') && document.getElementById('css-token-name-structure').value) || 'path-name',
          globalPrefix: (document.getElementById('css-global-prefix') && document.getElementById('css-global-prefix').value) || '',
          customizeTypePrefixes: (document.getElementById('css-customize-type-prefixes') && document.getElementById('css-customize-type-prefixes').checked) || false,
          typePrefixes: {
            color: (document.getElementById('css-prefix-color') && document.getElementById('css-prefix-color').value) || 'color',
            typography: (document.getElementById('css-prefix-typography') && document.getElementById('css-prefix-typography').value) || 'typography',
            dimension: (document.getElementById('css-prefix-dimension') && document.getElementById('css-prefix-dimension').value) || 'dimension',
            size: (document.getElementById('css-prefix-size') && document.getElementById('css-prefix-size').value) || 'size',
            space: (document.getElementById('css-prefix-space') && document.getElementById('css-prefix-space').value) || 'space',
            opacity: (document.getElementById('css-prefix-opacity') && document.getElementById('css-prefix-opacity').value) || 'opacity',
            fontSize: (document.getElementById('css-prefix-fontsize') && document.getElementById('css-prefix-fontsize').value) || 'fontSize',
            lineHeight: (document.getElementById('css-prefix-lineheight') && document.getElementById('css-prefix-lineheight').value) || 'lineHeight',
            letterSpacing: (document.getElementById('css-prefix-letterspacing') && document.getElementById('css-prefix-letterspacing').value) || 'letterSpacing',
            paragraphSpacing: (document.getElementById('css-prefix-paragraphspacing') && document.getElementById('css-prefix-paragraphspacing').value) || 'paragraphSpacing',
            borderWidth: (document.getElementById('css-prefix-borderwidth') && document.getElementById('css-prefix-borderwidth').value) || 'borderWidth',
            borderRadius: (document.getElementById('css-prefix-borderradius') && document.getElementById('css-prefix-borderradius').value) || 'borderRadius',
            duration: (document.getElementById('css-prefix-duration') && document.getElementById('css-prefix-duration').value) || 'duration',
            zIndex: (document.getElementById('css-prefix-zindex') && document.getElementById('css-prefix-zindex').value) || 'zIndex',
            shadow: (document.getElementById('css-prefix-shadow') && document.getElementById('css-prefix-shadow').value) || 'shadow'
          },

          // Token Values
          colorFormat: (document.getElementById('css-color-format') && document.getElementById('css-color-format').value) || 'hex',
          forceRemUnits: (document.getElementById('css-force-rem-units') && document.getElementById('css-force-rem-units').checked) || false,
          useTokenReferences: !(document.getElementById('css-use-token-references') && document.getElementById('css-use-token-references').checked === false),
          colorPrecision: parseInt((document.getElementById('css-color-precision') && document.getElementById('css-color-precision').value)) || 3,
          useFallbackValues: (document.getElementById('css-use-fallback-values') && document.getElementById('css-use-fallback-values').checked) || false,

          // Themes - simplified (no longer configurable by user)
          themeExportFormat: 'separate', // Default behavior based on File Organization
          exportOnlyThemedTokens: false,
          exportBaseValues: true,

          // Index File
          generateIndexFile: !(document.getElementById('css-generate-index-file') && document.getElementById('css-generate-index-file').checked === false),
          indexFilename: (document.getElementById('css-index-filename') && document.getElementById('css-index-filename').value) || 'index.css',
          indexPath: (document.getElementById('css-index-path') && document.getElementById('css-index-path').value) || './',

          // Other
          showTokenDescriptions: !(document.getElementById('css-show-token-descriptions') && document.getElementById('css-show-token-descriptions').checked === false),
          showFileDisclaimer: !(document.getElementById('css-show-file-disclaimer') && document.getElementById('css-show-file-disclaimer').checked === false),
          disclaimerMessage: (document.getElementById('css-disclaimer-message') && document.getElementById('css-disclaimer-message').value) || 'This file was generated automatically',
          indentation: parseInt((document.getElementById('css-indentation') && document.getElementById('css-indentation').value)) || 2
        };
      }

      // Function to update footer button visibility
      function updateFooterButtons(activeTab) {
        // Handle footer buttons
        document.querySelectorAll('.footer-btn').forEach(btn => {
          if (btn.dataset.tab === activeTab) {
            // Show buttons for the active tab
            btn.style.display = 'inline-flex';

            // Hide secondary buttons (copy/download) initially
            if (btn.classList.contains('secondary')) {
              btn.style.display = 'none';
            }
          } else {
            // Hide buttons for inactive tabs
            btn.style.display = 'none';
          }
        });

        // Handle footer checkbox (preserve scopes)
        document.querySelectorAll('.footer-checkbox-container').forEach(container => {
          if (container.dataset.tab === activeTab) {
            container.style.display = 'flex';
          } else {
            container.style.display = 'none';
          }
        });
      }

      // Get Code container functions
      function showGetCodeContainer(containerId) {
        const container = document.getElementById(containerId);
        if (container) {
          container.style.display = 'flex';
        }
      }

      function hideGetCodeContainer(containerId) {
        const container = document.getElementById(containerId);
        if (container) {
          container.style.display = 'none';
        }
      }

      // Setup Get Code dropdown event listeners
      function setupGetCodeDropdowns() {
        // Handle Get Code dropdown triggers
        document.querySelectorAll('.get-code-trigger').forEach(trigger => {
          trigger.addEventListener('click', (e) => {
            e.stopPropagation();
            const container = trigger.closest('.get-code-container');
            if (container) {
              // Close other open menus
              document.querySelectorAll('.get-code-container.active').forEach(openContainer => {
                if (openContainer !== container) {
                  openContainer.classList.remove('active');
                }
              });
              // Toggle current menu
              container.classList.toggle('active');
            }
          });
        });

        // Close menus when clicking outside
        document.addEventListener('click', () => {
          document.querySelectorAll('.get-code-container.active').forEach(container => {
            container.classList.remove('active');
          });
        });
      }

      // Tab navigation
      function setupTabNavigation() {
        document.querySelectorAll('.nav-icon-button').forEach(button => {
          button.addEventListener('click', () => {
            // Remove active from all buttons
            document.querySelectorAll('.nav-icon-button').forEach(b =>
              b.classList.remove('active')
            );

            // Remove active from all content
            document.querySelectorAll('.tab-content').forEach(tc =>
              tc.classList.remove('active')
            );

            // Activate clicked button
            button.classList.add('active');

            // Show corresponding content
            const targetId = button.getAttribute('data-tab') + '-tab';
            document.getElementById(targetId).classList.add('active');

            // Update footer buttons for the active tab
            const activeTabId = button.getAttribute('data-tab');
            updateFooterButtons(activeTabId);

            // Update collections when switching to export tabs
            if (targetId === 'json-export-tab') {
              requestCollections();
            }

            // Initialize text styles export when switching to text styles tab
            if (targetId === 'text-styles-export-tab') {
              setTimeout(() => {
                initializeTextStylesExport();
              }, 100);
            }
          });
        });

        // Initialize footer buttons for the default active tab
        updateFooterButtons('json-to-variables');
      }

      // Custom Components JavaScript
      function initializeCustomComponents() {

        // Remove any existing event listeners to prevent duplicates
        const existingListener = window.customSelectGlobalListener;
        if (existingListener) {
          document.removeEventListener('click', existingListener);
        }

        // Initialize all custom select dropdowns
        document.querySelectorAll('.custom-select').forEach(select => {
          const trigger = select.querySelector('.custom-select-trigger');
          const dropdown = select.querySelector('.custom-select-dropdown');
          const hiddenInput = select.parentElement.querySelector('input[type="hidden"]');
          const valueSpan = select.querySelector('.custom-select-value');

          if (!trigger || !dropdown) {
            return;
          }


          // Remove existing listeners if any
          const newTrigger = trigger.cloneNode(true);
          trigger.parentNode.replaceChild(newTrigger, trigger);
          const newDropdown = dropdown.cloneNode(true);
          dropdown.parentNode.replaceChild(newDropdown, dropdown);

          // Re-get references after cloning
          const finalTrigger = select.querySelector('.custom-select-trigger');
          const finalDropdown = select.querySelector('.custom-select-dropdown');
          const finalValueSpan = select.querySelector('.custom-select-value');

          // Toggle dropdown
          finalTrigger.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();

            // Close other dropdowns
            document.querySelectorAll('.custom-select.active').forEach(other => {
              if (other !== select) other.classList.remove('active');
            });

            select.classList.toggle('active');
          });

          // Handle option selection
          finalDropdown.addEventListener('click', (e) => {
            if (e.target.classList.contains('custom-select-option')) {
              const value = e.target.dataset.value;
              const text = e.target.textContent;


              // Update UI
              finalDropdown.querySelectorAll('.custom-select-option').forEach(opt => {
                opt.classList.remove('selected');
              });
              e.target.classList.add('selected');
              finalValueSpan.textContent = text;

              // Update hidden input
              if (hiddenInput) {
                hiddenInput.value = value;
                // Trigger change event for compatibility
                hiddenInput.dispatchEvent(new Event('change'));
              }

              select.classList.remove('active');
            }
          });
        });

        // Close dropdowns when clicking outside (only one global listener)
        const globalClickListener = (e) => {
          if (!e.target.closest('.custom-select')) {
            document.querySelectorAll('.custom-select.active').forEach(select => {
              select.classList.remove('active');
            });
          }
        };

        window.customSelectGlobalListener = globalClickListener;
        document.addEventListener('click', globalClickListener);

        // Initialize custom number input controls
        document.querySelectorAll('.custom-input-number-controls').forEach(controls => {
          const input = controls.parentElement.querySelector('.custom-input-number');
          if (!input) return;

          controls.addEventListener('click', (e) => {
            if (e.target.classList.contains('custom-input-number-btn')) {
              const action = e.target.dataset.action;
              const min = parseFloat(input.getAttribute('min')) || -Infinity;
              const max = parseFloat(input.getAttribute('max')) || Infinity;
              const step = parseFloat(input.getAttribute('step')) || 1;
              let value = parseFloat(input.value) || 0;

              if (action === 'increment' && value < max) {
                value = Math.min(max, value + step);
              } else if (action === 'decrement' && value > min) {
                value = Math.max(min, value - step);
              }

              input.value = value;
              input.dispatchEvent(new Event('input'));
              input.dispatchEvent(new Event('change'));
            }
          });
        });

        // Populate dynamic dropdowns (collections/modes)
        populateCustomSelects();
      }

      function populateCustomSelects() {
        // Populate CSS collection select when collections are loaded
        const cssCollectionSelect = document.getElementById('css-collection-custom-select');
        if (cssCollectionSelect && collections && collections.length > 0) {
          const dropdown = cssCollectionSelect.querySelector('.custom-select-dropdown');
          if (dropdown) {
            dropdown.innerHTML = collections.map(collection =>
              `<button class="custom-select-option" data-value="${collection.id}">${collection.name}</button>`
            ).join('');
          }
        }
      }

      // Event listeners
      function setupEventListeners() {
        // Import tab
        document.getElementById('import-variables-button') && document.getElementById('import-variables-button').addEventListener('click', importVariables);

        // Upload file button - triggers file input
        const uploadFileButton = document.getElementById('upload-file-button');
        const jsonFileInput = document.getElementById('json-file-input');

        if (uploadFileButton && jsonFileInput) {
          uploadFileButton.addEventListener('click', () => {
            jsonFileInput.click();
          });

          jsonFileInput.addEventListener('change', handleFileUpload);
        }

        // Upload status close button
        const uploadStatusClose = document.getElementById('upload-status-close');
        if (uploadStatusClose) {
          uploadStatusClose.addEventListener('click', hideUploadStatus);
        }

        // JSON Export tab
        document.getElementById('select-all-collections') && document.getElementById('select-all-collections').addEventListener('click', () => toggleAllCollections('json'));
        document.getElementById('select-all-modes') && document.getElementById('select-all-modes').addEventListener('click', () => toggleAllModes('json'));
        document.getElementById('export-json-button') && document.getElementById('export-json-button').addEventListener('click', exportJson);
        document.getElementById('copy-json-button') && document.getElementById('copy-json-button').addEventListener('click', () => {
          const textarea = document.getElementById('json-export-textarea');
          if (textarea) {
            copyToClipboard(textarea.value);
          }
        });
        document.getElementById('download-json-button') && document.getElementById('download-json-button').addEventListener('click', () => {

          if (lastJsonExportResult) {

            if (lastJsonExportResult.files && lastJsonExportResult.files.length > 1) {
              // Multiple files - create ZIP
              const zipName = `pelican-${new Date().toISOString().split('T')[0]}.zip`;
              downloadZipFiles(lastJsonExportResult.files, zipName);
            } else if (lastJsonExportResult.files && lastJsonExportResult.files.length === 1) {
              // Single file from advanced export
              const file = lastJsonExportResult.files[0];
              downloadJson(file.content, file.filename);
            } else if (lastJsonExportResult.json) {
              // Single JSON string export (most common case)
              downloadJson(lastJsonExportResult.json, 'pelican.json');
            } else if (lastJsonExportResult.data) {
              // Legacy data format - convert to JSON
              const jsonString = typeof lastJsonExportResult.data === 'string'
                ? lastJsonExportResult.data
                : JSON.stringify(lastJsonExportResult.data, null, 2);
              downloadJson(jsonString, 'pelican.json');
            } else {
              console.error('lastJsonExportResult structure not recognized:', lastJsonExportResult);
              console.error('Available properties:', Object.keys(lastJsonExportResult));
              showSnackbar('Error: Export data structure not recognized. Check console for details.', 'error');
            }
          } else {
            console.error('No lastJsonExportResult available');
            showSnackbar('Error: No export data available. Please export first.', 'error');
          }
        });

        // CSS Export tab
        // CSS Mode Toggle
        document.getElementById('css-advanced-mode-toggle') && document.getElementById('css-advanced-mode-toggle').addEventListener('change', function () {
          isAdvancedCssMode = this.checked;
          const simpleMode = document.getElementById('css-simple');
          const advancedMode = document.getElementById('css-advanced');
          const description = document.getElementById('css-mode-description');

          if (isAdvancedCssMode) {
            simpleMode.style.display = 'none';
            advancedMode.classList.add('active');
            description.textContent = 'Pro export';
          } else {
            simpleMode.style.display = 'grid';
            advancedMode.classList.remove('active');
            description.textContent = 'Quick export';
          }

          // Update customization options visibility
          updateCssCustomizationVisibility();

          // Reinitialize custom components after mode change
          setTimeout(() => {
            initializeCustomComponents();
          }, 50);
        });

        // CSS Format Change (for both simple and advanced)
        document.getElementById('css-format-select') && document.getElementById('css-format-select').addEventListener('change', updateCssCustomizationVisibility);
        document.getElementById('css-expert-format-select') && document.getElementById('css-expert-format-select').addEventListener('change', updateCssCustomizationVisibility);

        // Type Prefixes Toggle
        document.getElementById('css-customize-type-prefixes') && document.getElementById('css-customize-type-prefixes').addEventListener('change', function () {
          const typePrefixes = document.getElementById('css-type-prefixes');
          if (this.checked) {
            typePrefixes.style.display = 'block';
          } else {
            typePrefixes.style.display = 'none';
          }
        });

        document.getElementById('css-select-all-collections') && document.getElementById('css-select-all-collections').addEventListener('click', () => toggleAllCollections('css'));

        document.getElementById('css-select-all-modes') && document.getElementById('css-select-all-modes').addEventListener('click', () => toggleAllModes('css'));
        document.getElementById('export-css-button') && document.getElementById('export-css-button').addEventListener('click', exportCss);
        document.getElementById('copy-css-button') && document.getElementById('copy-css-button').addEventListener('click', () => {
          if (lastCssExportResult && lastCssExportResult.css) {
            copyToClipboard(lastCssExportResult.css);
          }
        });
        document.getElementById('download-css-button') && document.getElementById('download-css-button').addEventListener('click', () => {
          if (lastCssExportResult && lastCssExportResult.files && lastCssExportResult.files.length > 1) {
            // Multiple files - create ZIP
            const zipName = `css-variables-${new Date().toISOString().split('T')[0]}.zip`;
            downloadZipFiles(lastCssExportResult.files, zipName);
          } else if (lastCssExportResult && lastCssExportResult.css) {
            // Single file
            downloadCss(lastCssExportResult.css, 'variables.css');
          }
        });

        // Simple mode collection change handler
        document.getElementById('css-collection-select') && document.getElementById('css-collection-select').addEventListener('change', function () {
          const collectionId = this.value;
          populateCssModeSelect(collectionId);
        });

        // Text Styles Export Event Listeners
        document.getElementById('export-text-styles-button') && document.getElementById('export-text-styles-button').addEventListener('click', exportTextStyles);
        document.getElementById('copy-text-styles-button') && document.getElementById('copy-text-styles-button').addEventListener('click', () => {
          const textarea = document.getElementById('text-styles-export-textarea');
          if (textarea && textarea.value) {
            copyToClipboard(textarea.value);
          }
        });
        document.getElementById('download-text-styles-button') && document.getElementById('download-text-styles-button').addEventListener('click', () => {
          if (lastTextStylesExportResult && lastTextStylesExportResult.data) {
            downloadTextStyles(lastTextStylesExportResult.data, lastTextStylesExportResult.filename);
          }
        });
      }

      // Request collections from main thread
      function requestCollections() {
        sendMessage('get-collections');
      }

      // Handle initial data
      function handleInitData(data) {
        // üîß FIX: Il backend invia { success: true, data: { collections, w3cJson, modes } }
        // Ma il message handler ha gi√† rimosso il 'type', quindi riceviamo tutto sotto 'data'
        const actualData = data.data || data; // Unwrap se necessario

        if (actualData.collections) {
          handleCollectionsData({ collections: actualData.collections });
        }

        if (actualData.w3cJson && actualData.modes) {
          try {
            const json = typeof actualData.w3cJson === 'string' ? JSON.parse(actualData.w3cJson) : actualData.w3cJson;

            // Update mode selector
            updateModeSelector(actualData.modes);

            // Render Brand Filter List
            if (actualData.modes) {
              renderBrandFilterList(actualData.modes);
            }

            // Render token tree with first mode
            const firstMode = actualData.modes.length > 0 ? actualData.modes[0].name : null;
            renderTokenTree(json, firstMode);

            // ‚úÖ SEMPRE popola JSON editor (rimossa condizione !editor.value.trim())
            const editor = document.getElementById('json-editor-textarea');
            if (editor) {
              editor.value = typeof actualData.w3cJson === 'string' ? actualData.w3cJson : JSON.stringify(json, null, 2);

              // ‚úÖ Trigger manuale di tutti gli aggiornamenti UI
              // Trigger input event per aggiornare line numbers, syntax highlighting, ecc.
              const inputEvent = new Event('input', { bubbles: true });
              editor.dispatchEvent(inputEvent);

              // Reset modification flag after loading fresh data from Figma
              jsonEditorModified = false;
            }

          } catch (error) {
            console.error('[Token Tree] ‚ùå Failed to initialize:', error);
          }
        } else {
        }

        // Update footer button based on collection state
        updateVariablesFooterButton();

        // Initialize button state (disabled until first edit)
        updateImportButtonState();
      }

      // Handle collections data
      function handleCollectionsData(data) {
        collections = data.collections || [];
        updateCollectionsUI();
        updateModesUI();
        // Also populate CSS simple mode dropdowns
        populateCssCollectionSelect();
        // Update footer button based on collection state
        updateVariablesFooterButton();
      }

      // Update Variables footer button based on collection state
      function updateVariablesFooterButton() {
        const button = document.getElementById('import-variables-button');
        if (!button) return;

        const hasCollections = collections && collections.length > 0 &&
          collections.some(c => c.variableIds && c.variableIds.length > 0);

        // Preserve the SVG icon
        const svg = button.querySelector('svg');

        // Always use "Apply to Figma" behavior (import JSON ‚Üí Figma)
        // Never sync FROM Figma after initial load (would overwrite user edits)
        if (hasCollections) {
          button.innerHTML = 'Update Figma';
          if (svg) button.appendChild(svg);
          button.onclick = importVariables; // ‚Üê Changed from syncVariablesFromFigma
        } else {
          button.innerHTML = 'Import Variables';
          if (svg) button.appendChild(svg);
          button.onclick = importVariables;
        }

      }

      // Populate Simple mode collection dropdown
      function populateCssCollectionSelect() {
        const select = document.getElementById('css-collection-select');
        if (!select) return;

        select.innerHTML = '<option value="">Choose a collection...</option>';

        collections.forEach(collection => {
          const option = document.createElement('option');
          option.value = collection.id;
          option.textContent = collection.name;
          select.appendChild(option);
        });
      }

      // Populate Simple mode mode dropdown based on selected collection
      function populateCssModeSelect(collectionId) {
        const select = document.getElementById('css-mode-select');
        if (!select) return;

        select.innerHTML = '<option value="">Choose a mode...</option>';

        if (!collectionId) return;

        const collection = collections.find(c => c.id === collectionId);
        if (!collection) return;

        collection.modes.forEach(mode => {
          const option = document.createElement('option');
          option.value = mode;
          option.textContent = mode;
          select.appendChild(option);
        });
      }

      // Update collections UI
      function updateCollectionsUI() {
        const containers = [
          document.getElementById('existing-collections'),
          document.getElementById('export-collections'),
          document.getElementById('css-expert-collections')
        ];

        containers.forEach((container, index) => {
          if (!container) return;

          if (collections.length === 0) {
            container.innerHTML = `
            <div class="empty-state">
              <h3>No Collections Found</h3>
              <p>Create some variable collections in Figma first, then refresh this plugin.</p>
            </div>
          `;
            return;
          }

          const isExport = index > 0;
          const prefix = index === 2 ? 'css-' : '';

          let collectionsHTML = collections.map(collection => {
            if (isExport) {
              return `
              <div class="collection-item">
                <input type="checkbox" id="${prefix}collection-${collection.id}" value="${collection.id}">
                <label for="${prefix}collection-${collection.id}">
                  ${collection.name} (${collection.modes.length} modes)
                </label>
              </div>
            `;
            } else {
              return `
              <div class="collection-item existing" data-collection-id="${collection.id}">
                <div class="collection-info">
                  <label class="collection-name" data-original-name="${collection.name}">${collection.name}</label>
                  <span class="collection-modes">${collection.modes.length} modes: ${collection.modes.join(', ')}</span>
                </div>
                <div class="collection-actions">
                  <button class="btn-icon rename-btn" title="Rename collection" data-collection-id="${collection.id}">
<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M5.99995 13.25C6.41416 13.25 6.74995 13.5858 6.74995 14C6.74995 14.3797 6.46779 14.6935 6.10172 14.7432L5.99995 14.75H3.10773C2.69351 14.75 2.35773 14.4142 2.35773 14C2.35773 13.6203 2.63988 13.3065 3.00596 13.2568L3.10773 13.25H5.99995Z" fill="currentColor"/>
<path d="M11 8.25C11.4142 8.25 11.75 8.58579 11.75 9C11.75 9.3797 11.4678 9.69349 11.1018 9.74315L11 9.75H3C2.58579 9.75 2.25 9.41421 2.25 9C2.25 8.6203 2.53215 8.30651 2.89823 8.25685L3 8.25H11Z" fill="currentColor"/>
<path d="M16 3.25C16.4142 3.25 16.75 3.58579 16.75 4C16.75 4.3797 16.4679 4.69349 16.1018 4.74315L16 4.75H3.10773C2.69351 4.75 2.35773 4.41421 2.35773 4C2.35773 3.6203 2.63988 3.30651 3.00596 3.25685L3.10773 3.25H16Z" fill="currentColor"/>
<path fill-rule="evenodd" clip-rule="evenodd" d="M15.8835 10.0562C16.3992 9.54005 17.0989 9.25 17.8284 9.25C18.5579 9.25 19.2575 9.53968 19.7733 10.0555L20.9443 11.2266C22.0183 12.3005 22.0186 14.0416 20.945 15.116L16.1164 19.9446C15.6007 20.4604 14.9012 20.7501 14.1719 20.7501H12C11.0335 20.7501 10.25 19.9666 10.25 19.0001V16.8288C10.25 16.0995 10.5397 15.4 11.0554 14.8843L15.8835 10.0562ZM18.7126 11.1161C18.4782 10.8817 18.1602 10.75 17.8284 10.75C17.497 10.75 17.179 10.8818 16.9446 11.1164L12.1161 15.9449C11.8817 16.1794 11.75 16.4973 11.75 16.8288V19.0001C11.75 19.1382 11.8619 19.2501 12 19.2501H14.1719C14.5034 19.2501 14.8214 19.1184 15.0558 18.884L19.884 14.0557C20.3721 13.5672 20.372 12.7755 19.8837 12.2872L18.7126 11.1161Z" fill="currentColor"/>
</svg>


                  </button>
                  <button class="btn-icon danger delete-btn" title="Delete collection" data-collection-id="${collection.id}">
<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
<path fill-rule="evenodd" clip-rule="evenodd" d="M11.0843 2.26481C11.3852 2.25497 11.6907 2.25 12 2.25L12.308 2.25165C12.5125 2.25385 12.7151 2.25825 12.9157 2.26481L13.511 2.29093C13.7073 2.30178 13.9013 2.31476 14.0927 2.32983L14.6594 2.38133C14.7525 2.39095 14.845 2.40109 14.9367 2.41174L15.4783 2.48177L16.0014 2.56391C18.8253 3.04869 20.75 4.07471 20.75 5.5C20.75 6.92529 18.8253 7.95131 16.0014 8.43609L15.4783 8.51823L14.9367 8.58826C14.845 8.59891 14.7525 8.60905 14.6594 8.61867L14.0927 8.67017C13.9013 8.68524 13.7073 8.69822 13.511 8.70907L12.9157 8.73519C12.6148 8.74503 12.3093 8.75 12 8.75C11.6907 8.75 11.3852 8.74503 11.0843 8.73519L10.489 8.70907C10.2927 8.69822 10.0987 8.68524 9.90727 8.67017L9.34059 8.61867C9.24747 8.60905 9.15504 8.59891 9.06331 8.58826L8.52174 8.51823L7.99861 8.43609C5.17466 7.95131 3.25 6.92529 3.25 5.5C3.25 4.07471 5.17466 3.04869 7.99861 2.56391L8.52174 2.48177L9.06331 2.41174C9.15504 2.40109 9.24747 2.39095 9.34059 2.38133L9.90727 2.32983C10.0987 2.31476 10.2927 2.30178 10.489 2.29093L11.0843 2.26481ZM14.5538 3.88982C13.7588 3.80156 12.8979 3.75 12 3.75L11.7021 3.75189C10.9116 3.76191 10.1529 3.81137 9.44617 3.88982L8.9262 3.95393L8.42762 4.02793L7.95234 4.11085L7.50225 4.2017C7.42944 4.21744 7.35776 4.23348 7.28725 4.24979L6.8785 4.3507C5.56483 4.69677 4.75 5.13427 4.75 5.5C4.75 5.86573 5.56483 6.30323 6.8785 6.6493L7.28725 6.75021C7.35776 6.76652 7.42944 6.78256 7.50225 6.7983L7.95234 6.88915L8.42762 6.97207L8.9262 7.04607L9.44617 7.11018C10.2412 7.19844 11.1021 7.25 12 7.25C12.8979 7.25 13.7588 7.19844 14.5538 7.11018L15.0738 7.04607L15.5724 6.97207L16.0477 6.88915L16.4977 6.7983C16.5706 6.78256 16.6422 6.76652 16.7128 6.75021L17.1215 6.6493C18.4352 6.30323 19.25 5.86573 19.25 5.5C19.25 5.13427 18.4352 4.69677 17.1215 4.3507L16.7128 4.24979C16.6422 4.23348 16.5706 4.21744 16.4977 4.2017L16.0477 4.11085L15.5724 4.02793L15.0738 3.95393L14.5538 3.88982Z" fill="currentColor"/>
<path d="M20.0924 4.88499C20.5027 4.9418 20.7892 5.32046 20.7324 5.73076L19.0078 18.1887C18.7997 19.7485 17.636 21.0103 16.0861 21.3463C13.3885 21.8846 10.6112 21.8846 7.90152 21.3437C6.36373 21.0103 5.20009 19.7484 4.99248 18.1923L3.2674 5.73076C3.21059 5.32046 3.49716 4.9418 3.90746 4.88499C4.31776 4.82819 4.69642 5.11475 4.75323 5.52505L6.47881 17.9903C6.60331 18.9234 7.29945 19.6783 8.20724 19.8753C10.711 20.3749 13.2888 20.3749 15.7804 19.8778C16.7004 19.6783 17.3965 18.9234 17.5215 17.9867L19.2466 5.52505C19.2987 5.14895 19.6212 4.87681 19.9906 4.87782L20.0924 4.88499Z" fill="currentColor"/>
<path d="M14 11.25C14.3797 11.25 14.6935 11.5322 14.7432 11.8982L14.75 12V16C14.75 16.4142 14.4142 16.75 14 16.75C13.6203 16.75 13.3065 16.4678 13.2568 16.1018L13.25 16V12C13.25 11.5858 13.5858 11.25 14 11.25Z" fill="currentColor"/>
<path d="M10 11.25C10.3797 11.25 10.6935 11.5322 10.7432 11.8982L10.75 12V16C10.75 16.4142 10.4142 16.75 10 16.75C9.6203 16.75 9.30651 16.4678 9.25685 16.1018L9.25 16V12C9.25 11.5858 9.58579 11.25 10 11.25Z" fill="currentColor"/>
</svg>

                  </button>
                </div>
              </div>
            `;
            }
          }).join('');

          // Add clear all button for existing collections
          if (index === 0 && collections.length > 0) {
            collectionsHTML += `
            <button class="clear-all-btn" id="clear-all-collections">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
<path fill-rule="evenodd" clip-rule="evenodd" d="M11.0843 2.26481C11.3852 2.25497 11.6907 2.25 12 2.25L12.308 2.25165C12.5125 2.25385 12.7151 2.25825 12.9157 2.26481L13.511 2.29093C13.7073 2.30178 13.9013 2.31476 14.0927 2.32983L14.6594 2.38133C14.7525 2.39095 14.845 2.40109 14.9367 2.41174L15.4783 2.48177L16.0014 2.56391C18.8253 3.04869 20.75 4.07471 20.75 5.5C20.75 6.92529 18.8253 7.95131 16.0014 8.43609L15.4783 8.51823L14.9367 8.58826C14.845 8.59891 14.7525 8.60905 14.6594 8.61867L14.0927 8.67017C13.9013 8.68524 13.7073 8.69822 13.511 8.70907L12.9157 8.73519C12.6148 8.74503 12.3093 8.75 12 8.75C11.6907 8.75 11.3852 8.74503 11.0843 8.73519L10.489 8.70907C10.2927 8.69822 10.0987 8.68524 9.90727 8.67017L9.34059 8.61867C9.24747 8.60905 9.15504 8.59891 9.06331 8.58826L8.52174 8.51823L7.99861 8.43609C5.17466 7.95131 3.25 6.92529 3.25 5.5C3.25 4.07471 5.17466 3.04869 7.99861 2.56391L8.52174 2.48177L9.06331 2.41174C9.15504 2.40109 9.24747 2.39095 9.34059 2.38133L9.90727 2.32983C10.0987 2.31476 10.2927 2.30178 10.489 2.29093L11.0843 2.26481ZM14.5538 3.88982C13.7588 3.80156 12.8979 3.75 12 3.75L11.7021 3.75189C10.9116 3.76191 10.1529 3.81137 9.44617 3.88982L8.9262 3.95393L8.42762 4.02793L7.95234 4.11085L7.50225 4.2017C7.42944 4.21744 7.35776 4.23348 7.28725 4.24979L6.8785 4.3507C5.56483 4.69677 4.75 5.13427 4.75 5.5C4.75 5.86573 5.56483 6.30323 6.8785 6.6493L7.28725 6.75021C7.35776 6.76652 7.42944 6.78256 7.50225 6.7983L7.95234 6.88915L8.42762 6.97207L8.9262 7.04607L9.44617 7.11018C10.2412 7.19844 11.1021 7.25 12 7.25C12.8979 7.25 13.7588 7.19844 14.5538 7.11018L15.0738 7.04607L15.5724 6.97207L16.0477 6.88915L16.4977 6.7983C16.5706 6.78256 16.6422 6.76652 16.7128 6.75021L17.1215 6.6493C18.4352 6.30323 19.25 5.86573 19.25 5.5C19.25 5.13427 18.4352 4.69677 17.1215 4.3507L16.7128 4.24979C16.6422 4.23348 16.5706 4.21744 16.4977 4.2017L16.0477 4.11085L15.5724 4.02793L15.0738 3.95393L14.5538 3.88982Z" fill="currentColor"/>
<path d="M20.0924 4.88499C20.5027 4.9418 20.7892 5.32046 20.7324 5.73076L19.0078 18.1887C18.7997 19.7485 17.636 21.0103 16.0861 21.3463C13.3885 21.8846 10.6112 21.8846 7.90153 21.3437C6.36374 21.0103 5.20009 19.7484 4.99249 18.1923L3.2674 5.73076C3.2106 5.32046 3.49716 4.9418 3.90746 4.88499C4.31776 4.82819 4.69642 5.11475 4.75323 5.52505L6.47882 17.9903C6.60331 18.9234 7.29945 19.6783 8.20725 19.8753C10.711 20.3749 13.2888 20.3749 15.7804 19.8778C16.7004 19.6783 17.3965 18.9234 17.5215 17.9867L19.2466 5.52505C19.2987 5.14895 19.6212 4.87681 19.9906 4.87782L20.0924 4.88499Z" fill="currentColor"/>
<path d="M12.9697 12.0303C13.2626 11.7374 13.7374 11.7374 14.0303 12.0303C14.2966 12.2966 14.3208 12.7133 14.1029 13.0069L14.0303 13.091L11.0303 16.091C10.7374 16.3839 10.2626 16.3839 9.96967 16.091C9.7034 15.8247 9.6792 15.4081 9.89705 15.1145L9.96967 15.0303L12.9697 12.0303Z" fill="currentColor"/>
<path d="M9.96967 12.0303C10.2359 11.7641 10.6526 11.7399 10.9462 11.9577L11.0303 12.0303L14.0303 15.0303C14.3232 15.3232 14.3232 15.7981 14.0303 16.091C13.7641 16.3573 13.3474 16.3815 13.0538 16.1636L12.9697 16.091L9.96967 13.091C9.67678 12.7981 9.67678 12.3232 9.96967 12.0303Z" fill="currentColor"/>
</svg>
 Clear All Collections (${collections.length} total)
            </button>
          `;
          }

          container.innerHTML = collectionsHTML;

          if (isExport) {
            // Add event listeners for checkboxes
            container.querySelectorAll('input[type="checkbox"]').forEach(cb => {
              cb.addEventListener('change', (e) => {
                const collectionId = e.target.value;
                if (e.target.checked) {
                  selectedCollections.add(collectionId);
                } else {
                  selectedCollections.delete(collectionId);
                }
                updateModesUI();
              });
            });
          } else if (index === 0) {
            // Add event listeners for collection management buttons
            container.querySelectorAll('.rename-btn').forEach(btn => {
              btn.addEventListener('click', (e) => {
                e.stopPropagation();
                // Get collection ID from button or closest button element
                const target = e.target.closest('.rename-btn');
                const collectionId = target.getAttribute('data-collection-id');
                if (collectionId) {
                  renameCollection(collectionId);
                }
              });
            });

            container.querySelectorAll('.delete-btn').forEach(btn => {
              btn.addEventListener('click', (e) => {
                e.stopPropagation();
                // Get collection ID from button or closest button element
                const target = e.target.closest('.delete-btn');
                const collectionId = target.getAttribute('data-collection-id');
                if (collectionId) {
                  deleteCollection(collectionId);
                }
              });
            });

            // Clear all collections button
            const clearAllBtn = container.querySelector('#clear-all-collections');
            if (clearAllBtn) {
              clearAllBtn.addEventListener('click', () => {
                clearAllCollections();
              });
            }
          }
        });
      }

      // Collection Management Functions
      async function renameCollection(collectionId) {

        const collection = collections.find(c => c.id === collectionId);
        if (!collection) {
          console.error('[renameCollection] Collection not found for ID:', collectionId);
          return;
        }

        const currentName = collection.name;

        const newName = await createModal(
          'Rename Collection',
          `Rename collection "${currentName}":`,
          currentName
        );


        if (newName && newName !== currentName && newName.trim()) {
          // Send rename request to backend
          parent.postMessage({
            pluginMessage: {
              type: 'rename-collection',
              collectionId: collectionId,
              newName: newName.trim()
            }
          }, '*');

          showSnackbar('Renaming collection...', 'info');
        }
      }

      async function deleteCollection(collectionId) {

        const collection = collections.find(c => c.id === collectionId);
        if (!collection) {
          console.error('[deleteCollection] Collection not found for ID:', collectionId);
          return;
        }

        const variableCount = collection.variableIds ? collection.variableIds.length : 0;

        const confirmMessage = `Are you sure you want to delete the collection "${collection.name}"?\n\nThis will permanently delete ${variableCount} variables and cannot be undone.`;

        const confirmation = await createModal(
          'Delete Collection',
          confirmMessage,
          null,
          'UN GORBU'
        );


        if (confirmation) {
          // Send delete request to backend
          parent.postMessage({
            pluginMessage: {
              type: 'delete-collection',
              collectionId: collectionId
            }
          }, '*');

          showSnackbar('Deleting collection...', 'warning');
        }
      }

      async function clearAllCollections() {
        const totalCollections = collections.length;
        const totalVariables = collections.reduce((sum, c) => sum + (c.variableIds ? c.variableIds.length : 0), 0);

        const confirmMessage = `‚ö†Ô∏è DANGER: This will delete ALL collections and variables!\n\nCollections: ${totalCollections}\nVariables: ${totalVariables}\n\nThis action cannot be undone.`;

        const confirmation = await createModal(
          'Clear All Collections',
          confirmMessage,
          null,
          'UN GORBU'
        );

        if (confirmation) {
          // Send clear all request to backend
          parent.postMessage({
            pluginMessage: {
              type: 'clear-all-collections'
            }
          }, '*');

          showSnackbar('Clearing all collections...', 'error');
        }
      }

      // Handle collection management results
      function handleCollectionManagementResult(data) {
        hideSophisticatedLoader();

        if (data.success) {
          switch (data.action) {
            case 'rename':
              showSnackbar(`‚úÖ Collection renamed successfully!`, 'success');
              break;
            case 'delete':
              showSnackbar(`‚úÖ Collection deleted successfully!`, 'success');
              break;
            case 'clear-all':
              showSnackbar(`‚úÖ All collections cleared successfully!`, 'success');
              break;
          }

          // Refresh the collections data
          parent.postMessage({
            pluginMessage: { type: 'get-collections' }
          }, '*');

        } else {
          const actionText = data.action === 'rename' ? 'rename' :
            data.action === 'delete' ? 'delete' : 'clear';
          showSnackbar(`‚ùå Failed to ${actionText} collection: ${data.message}`, 'error');
        }
      }

      // Modal dialog helper functions
      function createModal(title, message, inputPlaceholder = null, dangerConfirm = null) {
        return new Promise((resolve) => {
          const overlay = document.createElement('div');
          overlay.className = 'modal-overlay';

          const content = document.createElement('div');
          content.className = 'modal-content';

          let modalHTML = `
          <div class="modal-title">${title}</div>
          <div class="modal-message">${message}</div>
        `;

          if (inputPlaceholder) {
            modalHTML += `<input type="text" class="modal-input" placeholder="${inputPlaceholder}" value="${inputPlaceholder}" id="modal-input">`;
          }

          if (dangerConfirm) {
            modalHTML += `<input type="text" class="modal-input" placeholder='Type "${dangerConfirm}" to confirm' id="modal-confirm">`;
          }

          modalHTML += `
          <div class="modal-actions">
            <button class="modal-button secondary" id="modal-cancel">Cancel</button>
            <button class="modal-button ${dangerConfirm ? 'danger' : 'primary'}" id="modal-ok">${dangerConfirm ? 'Delete' : 'OK'}</button>
          </div>
        `;

          content.innerHTML = modalHTML;
          overlay.appendChild(content);
          document.body.appendChild(overlay);

          // Focus input if exists
          const input = content.querySelector('#modal-input') || content.querySelector('#modal-confirm');
          if (input) {
            setTimeout(() => {
              input.focus();
              if (input.id === 'modal-input' && inputPlaceholder) {
                input.select(); // Select all text for rename
              }
            }, 100);
          }

          // Event listeners
          const cancelBtn = content.querySelector('#modal-cancel');
          const okBtn = content.querySelector('#modal-ok');

          const cleanup = () => {
            document.body.removeChild(overlay);
          };

          cancelBtn.addEventListener('click', () => {
            cleanup();
            resolve(null);
          });

          okBtn.addEventListener('click', () => {
            if (dangerConfirm) {
              const confirmInput = content.querySelector('#modal-confirm');
              if (confirmInput.value !== dangerConfirm) {
                confirmInput.style.borderColor = 'var(--color-error)';
                confirmInput.focus();
                return;
              }
              cleanup();
              resolve(true);
            } else if (inputPlaceholder) {
              const inputValue = content.querySelector('#modal-input').value.trim();
              cleanup();
              resolve(inputValue || null);
            } else {
              cleanup();
              resolve(true);
            }
          });

          // Handle escape key
          const handleEscape = (e) => {
            if (e.key === 'Escape') {
              cleanup();
              resolve(null);
              document.removeEventListener('keydown', handleEscape);
            }
          };
          document.addEventListener('keydown', handleEscape);

          // Handle enter key
          const handleEnter = (e) => {
            if (e.key === 'Enter') {
              okBtn.click();
            }
          };
          if (input) {
            input.addEventListener('keydown', handleEnter);
          }
        });
      }

      // Update modes UI
      function updateModesUI() {
        availableModes.clear();

        // Collect all modes from selected collections
        collections.forEach(collection => {
          if (selectedCollections.has(collection.id)) {
            collection.modes.forEach(mode => availableModes.add(mode));
          }
        });

        const containers = [
          document.getElementById('modes-list'),
          document.getElementById('css-expert-modes')
        ];

        containers.forEach((container, index) => {
          if (!container) return;

          const prefix = index === 1 ? 'css-' : '';

          if (availableModes.size === 0) {
            container.innerHTML = `
            <div class="empty-state">
              <h3>No Modes Available</h3>
              <p>Select at least one collection to see available modes.</p>
            </div>
          `;
            return;
          }

          container.innerHTML = Array.from(availableModes).map(mode => `
          <div class="mode-item">
            <input type="checkbox" id="${prefix}mode-${mode}" value="${mode}">
            <label for="${prefix}mode-${mode}">${mode}</label>
          </div>
        `).join('');

          // Add event listeners
          container.querySelectorAll('input[type="checkbox"]').forEach(cb => {
            cb.addEventListener('change', (e) => {
              const mode = e.target.value;
              if (e.target.checked) {
                selectedModes.add(mode);
              } else {
                selectedModes.delete(mode);
              }
            });
          });
        });

        // Update types UI
        updateTypesUI();
      }

      // Update types UI
      function updateTypesUI() {
        const container = document.getElementById('types-list');
        if (!container) return;

        const types = ['COLOR', 'FLOAT', 'STRING', 'BOOLEAN'];

        container.innerHTML = types.map(type => `
        <div class="collection-item">
          <input type="checkbox" id="type-${type}" value="${type}" ${selectedTypes.has(type) ? 'checked' : ''}>
          <label for="type-${type}">${type}</label>
        </div>
      `).join('');

        container.querySelectorAll('input[type="checkbox"]').forEach(cb => {
          cb.addEventListener('change', (e) => {
            const type = e.target.value;
            if (e.target.checked) {
              selectedTypes.add(type);
            } else {
              selectedTypes.delete(type);
            }
          });
        });
      }

      // Toggle all collections
      function toggleAllCollections(context) {
        const containerId = context === 'css' ? 'css-expert-collections' : 'export-collections';
        const checkboxes = document.querySelectorAll(`#${containerId} input[type="checkbox"]`);
        const allChecked = Array.from(checkboxes).every(cb => cb.checked);

        checkboxes.forEach(cb => {
          cb.checked = !allChecked;
          const event = new Event('change');
          cb.dispatchEvent(event);
        });
      }

      // Toggle all modes
      function toggleAllModes(context) {
        const containerId = context === 'css' ? 'css-expert-modes' : 'modes-list';
        const checkboxes = document.querySelectorAll(`#${containerId} input[type="checkbox"]`);
        const allChecked = Array.from(checkboxes).every(cb => cb.checked);

        checkboxes.forEach(cb => {
          cb.checked = !allChecked;
          const event = new Event('change');
          cb.dispatchEvent(event);
        });
      }

      // Parse CSS custom properties and convert to W3C Design Tokens format
      function parseCSSToW3C(cssContent) {
        const tokens = {};

        // Regex to match CSS custom properties: --name: value;
        const cssVarRegex = /--([a-zA-Z0-9-_]+)\s*:\s*([^;]+);/g;
        let match;

        while ((match = cssVarRegex.exec(cssContent)) !== null) {
          const name = match[1];
          const value = match[2].trim();

          // Infer token type based on value
          const tokenType = inferTokenType(value);
          const processedValue = processTokenValue(value, tokenType);

          // Create nested structure from kebab-case names
          const parts = name.split('-');
          let current = tokens;

          for (let i = 0; i < parts.length - 1; i++) {
            if (!current[parts[i]]) {
              current[parts[i]] = {};
            }
            current = current[parts[i]];
          }

          // Add the token with W3C format
          const tokenName = parts[parts.length - 1];
          current[tokenName] = {
            "$value": processedValue,
            "$type": tokenType
          };
        }

        return tokens;
      }

      // Infer token type from CSS value
      function inferTokenType(value) {
        // Color detection (hex, rgb, rgba, hsl, hsla, named colors)
        if (/^#([0-9A-F]{3}|[0-9A-F]{6}|[0-9A-F]{8})$/i.test(value) ||
          /^rgb/i.test(value) ||
          /^hsl/i.test(value) ||
          /^(black|white|red|green|blue|yellow|purple|orange|pink|gray|grey)$/i.test(value)) {
          return 'color';
        }

        // Dimension (px, rem, em, %, vh, vw, etc.)
        if (/^-?\d+(\.\d+)?(px|rem|em|%|vh|vw|vmin|vmax|pt|pc|in|cm|mm)$/i.test(value)) {
          return 'dimension';
        }

        // Number (unitless)
        if (/^-?\d+(\.\d+)?$/.test(value)) {
          return 'number';
        }

        // Font family
        if (/[,\s]/.test(value) && !value.includes('(')) {
          return 'fontFamily';
        }

        // Font weight
        if (/^(100|200|300|400|500|600|700|800|900|normal|bold|bolder|lighter)$/i.test(value)) {
          return 'fontWeight';
        }

        // Boolean
        if (value === 'true' || value === 'false') {
          return 'boolean';
        }

        // Default to string
        return 'string';
      }

      // Process token value based on type
      function processTokenValue(value, type) {
        switch (type) {
          case 'number':
            return parseFloat(value);
          case 'boolean':
            return value === 'true';
          case 'dimension':
            // Keep dimension as string with unit
            return value;
          default:
            // Remove quotes if present
            return value.replace(/^["']|["']$/g, '');
        }
      }

      // Handle file upload
      function handleFileUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();

        reader.onload = function (e) {
          const content = e.target.result;
          const fileExtension = file.name.split('.').pop().toLowerCase();

          let jsonContent;

          try {
            if (fileExtension === 'css') {
              // Parse CSS and convert to W3C tokens
              const tokens = parseCSSToW3C(content);
              jsonContent = JSON.stringify(tokens, null, 2);
              showSnackbar('CSS file converted to W3C Design Tokens format', 'success');
            } else if (fileExtension === 'json') {
              // Validate JSON
              JSON.parse(content);
              jsonContent = content;
              showSnackbar('JSON file loaded successfully', 'success');
            } else {
              showSnackbar('Unsupported file format. Please upload .json or .css files', 'error');
              return;
            }

            // Load into editor
            const newEditor = document.getElementById('json-editor-textarea');
            const oldTextarea = document.getElementById('json-input');
            const target = newEditor || oldTextarea;

            if (target) {
              target.value = jsonContent;
              // Trigger events for line numbers and validation
              const inputEvent = new Event('input', { bubbles: true });
              target.dispatchEvent(inputEvent);

              // Parse JSON and update tree view + modes
              try {
                const json = JSON.parse(jsonContent);

                // Extract modes from JSON
                const modes = extractModesFromJSON(json);

                // Update mode selector
                updateModeSelector(modes);

                // Render token tree with first mode
                const firstMode = modes.length > 0 ? modes[0].name : 'Default';
                renderTokenTree(json, firstMode);

              } catch (parseError) {
                console.error('[File Upload] Error parsing JSON for tree view:', parseError);
                // Still show the file content in editor even if tree fails
              }

              // Reset modification flag after successful file load
              jsonEditorModified = false;
            }

          } catch (error) {
            showSnackbar('Error processing file: ' + error.message, 'error');
          }

          // Reset file input
          event.target.value = '';
        };

        reader.onerror = function () {
          showSnackbar('Error reading file', 'error');
        };

        reader.readAsText(file);
      }

      /**
       * Extract modes from W3C JSON
       * Scans for multi-mode variables and returns array of mode objects
       * @param {Object} json - W3C Design Tokens JSON
       * @returns {Array} Array of mode objects [{id, name}]
       */
      function extractModesFromJSON(json) {
        const modesSet = new Set(['Default']); // Always include Default

        function scanForModes(node) {
          if (!node || typeof node !== 'object') return;

          // Check if this is a variable with multi-mode values
          if (node.$value !== undefined) {
            // Check for multi-mode object (not a color RGB object)
            if (typeof node.$value === 'object' &&
              !node.$value.r && !node.$value.g && !node.$value.b && !node.$value.a) {
              // Extract mode keys (skip $ prefixed keys)
              const modeKeys = Object.keys(node.$value).filter(key => !key.startsWith('$'));
              modeKeys.forEach(key => modesSet.add(key));
            }
            return; // Don't recurse into variables
          }

          // Recurse into nested objects
          for (const key in node) {
            if (!key.startsWith('$')) {
              scanForModes(node[key]);
            }
          }
        }

        // Scan all top-level groups
        for (const key in json) {
          if (!key.startsWith('$')) {
            scanForModes(json[key]);
          }
        }

        // Convert to array of mode objects
        const modesArray = Array.from(modesSet).map(modeName => ({
          id: modeName,
          name: modeName
        }));

        return modesArray;
      }

      /**
       * Extract modes from a specific collection
       * @param {Object} collectionData - Collection object
       * @returns {Array} Array of mode names found in this collection
       */
      function extractModesFromCollection(collectionData) {
        const modesSet = new Set();

        function scanForModes(node) {
          if (!node || typeof node !== 'object') return;

          // Check if this is a variable with multi-mode values
          if (node.$value !== undefined) {
            // Check for multi-mode object (not a color RGB object)
            if (typeof node.$value === 'object' &&
              !node.$value.r && !node.$value.g && !node.$value.b && !node.$value.a) {
              // Extract mode keys (skip $ prefixed keys)
              const modeKeys = Object.keys(node.$value).filter(key => !key.startsWith('$'));
              modeKeys.forEach(key => modesSet.add(key));
            }
            return; // Don't recurse into variables
          }

          // Recurse into nested objects
          for (const key in node) {
            if (!key.startsWith('$')) {
              scanForModes(node[key]);
            }
          }
        }

        scanForModes(collectionData);
        return Array.from(modesSet);
      }

      // Pre-analyze JSON for quick display (without waiting for backend)
      function preAnalyzeJson(data) {
        const analysis = {
          types: {},
          collections: new Set(),
          variables: 0,
          modes: new Set(["Default"]),
          flattenedVars: []
        };

        function processNode(node, path = [], collection = null) {
          if (!node || typeof node !== 'object') return;

          // Check if this is a variable
          if (node.$value !== undefined) {
            analysis.variables++;

            // Determine type
            const type = node.$type ? node.$type.toUpperCase() :
              (typeof node.$value === 'object' && node.$value.r !== undefined ? 'COLOR' :
                (typeof node.$value === 'number' ? 'NUMBER' :
                  (typeof node.$value === 'boolean' ? 'BOOLEAN' :
                    (typeof node.$value === 'string' && node.$value.startsWith('{') ? 'ALIAS' : 'STRING'))));

            // Count by type
            analysis.types[type] = (analysis.types[type] || 0) + 1;

            // Add to flattened list
            analysis.flattenedVars.push({
              path: path.join('/'),
              type: type,
              value: node.$value,
              isAlias: typeof node.$value === 'string' && node.$value.startsWith('{') && node.$value.endsWith('}')
            });

            // Check for multi-mode values
            if (typeof node.$value === 'object' && !node.$value.r && !node.$value.g && !node.$value.b && !node.$value.a) {
              // This is likely a multi-mode object
              const modeKeys = Object.keys(node.$value).filter(key => !key.startsWith('$'));
              if (modeKeys.length > 0) {
                modeKeys.forEach(key => analysis.modes.add(key));
              }
            }
          }

          // Add collection (top-level groups)
          if (path.length === 1) {
            analysis.collections.add(path[0]);
          }

          // Process nested nodes
          for (const key in node) {
            if (key.startsWith('$')) continue;
            if (typeof node[key] === 'object') {
              processNode(node[key], path.concat([key]), collection || path[0]);
            }
          }
        }

        // Process each top-level node
        for (const key in data) {
          processNode(data[key], [key]);
        }

        return {
          types: analysis.types,
          collections: Array.from(analysis.collections),
          variables: analysis.variables,
          modes: Array.from(analysis.modes),
          flattenedVars: analysis.flattenedVars
        };
      }

      // Display preliminary analysis before getting full results from backend
      function displayPreliminaryAnalysis(analysis) {
        // Display statistics in analysis grid
        const container = document.getElementById('analysis-grid');
        container.innerHTML = '';

        const items = [
          { value: analysis.variables, label: 'Variables' },
          { value: analysis.collections.length, label: 'Collections' },
          { value: analysis.modes.length, label: 'Modes' }
        ];

        // Add type counts
        Object.keys(analysis.types).forEach(type => {
          items.push({ value: analysis.types[type], label: type });
        });

        items.forEach(item => {
          const element = document.createElement('div');
          element.classList.add('analysis-item');
          element.innerHTML = `
          <span class="analysis-number">${item.value}</span>
          <span class="analysis-label">${item.label}</span>
        `;
          container.appendChild(element);
        });

        // Display first 20 variables
        displayVariablePreview(analysis.flattenedVars);
      }

      // Improved display for variable preview
      function displayVariablePreview(variables) {
        const tableBody = document.getElementById('variables-table-body');
        tableBody.innerHTML = '';

        if (!variables || variables.length === 0) {
          const row = document.createElement('tr');
          row.innerHTML = `<td colspan="4" style="text-align: center; color: var(--color-text-secondary);">No variables found</td>`;
          tableBody.appendChild(row);
          return;
        }

        // Display first 20 variables
        variables.slice(0, 20).forEach(variable => {
          const row = document.createElement('tr');

          // Create type pill
          let typePill = '';
          let typeLower = variable.type ? variable.type.toLowerCase() : 'unknown';

          // Fall back to better type detection for display
          if (typeLower === 'unknown') {
            if (typeof variable.value === 'string' && variable.value.startsWith('#')) {
              typeLower = 'color';
            } else if (typeof variable.value === 'number') {
              typeLower = 'number';
            } else if (typeof variable.value === 'boolean') {
              typeLower = 'boolean';
            } else if (typeof variable.value === 'string') {
              if (variable.isAlias) {
                typeLower = 'alias';
              } else {
                typeLower = 'string';
              }
            }
          }

          typePill = `<span class="type-pill ${typeLower}">${typeLower}</span>`;

          // Format value display
          let valueDisplay = '';
          let previewDisplay = '';

          if (typeLower === 'color') {
            if (variable.isAlias) {
              valueDisplay = `<span class="alias-reference">${variable.value}</span>`;
              previewDisplay = `<div class="color-preview">
              <div class="color-dot" style="background-color: var(--color-gray-300); opacity: 0.5;"></div>
              <span style="font-style: italic; color: var(--color-text-secondary);">Reference</span>
            </div>`;
            } else if (typeof variable.value === 'object' && !variable.value.r) {
              // Multi-mode color value
              const modes = Object.keys(variable.value);
              const firstMode = modes[0];
              const firstColor = variable.value[firstMode];

              valueDisplay = modes.map(mode =>
                `<span style="font-size: var(--font-size-xs); color: var(--color-text-secondary);">${mode}:</span> ${variable.value[mode]}`
              ).join('<br>');

              previewDisplay = `<div class="color-preview">
              <div class="color-dot" style="background-color: ${firstColor};"></div>
              <span>${modes.length} modes</span>
            </div>`;
            } else {
              valueDisplay = variable.value;
              previewDisplay = `<div class="color-preview">
              <div class="color-dot" style="background-color: ${variable.value};"></div>
              <span>${variable.value}</span>
            </div>`;
            }
          } else if (typeLower === 'boolean') {
            const boolValue = typeof variable.value === 'boolean' ? variable.value :
              (variable.value === 'true' || variable.value === true);
            valueDisplay = `<strong style="color: ${boolValue ? 'var(--color-success)' : 'var(--color-error)'};">${boolValue.toString()}</strong>`;
            previewDisplay = `<div class="boolean-preview">
            <input type="checkbox" ${boolValue ? 'checked' : ''} disabled style="transform: scale(1.1);">
            <span style="margin-left: var(--space-2); font-size: var(--font-size-xs); color: var(--color-text-secondary);">${boolValue ? 'True' : 'False'}</span>
          </div>`;
          } else if (typeLower === 'number' || typeLower === 'float') {
            if (variable.isAlias) {
              valueDisplay = `<span class="alias-reference">${variable.value}</span>`;
              previewDisplay = `<span style="font-style: italic; color: var(--color-text-secondary);">Reference</span>`;
            } else if (typeof variable.value === 'object') {
              // Multi-mode number value
              const modes = Object.keys(variable.value);
              valueDisplay = modes.map(mode =>
                `<span style="font-size: var(--font-size-xs); color: var(--color-text-secondary);">${mode}:</span> <strong>${variable.value[mode]}</strong>`
              ).join('<br>');
              previewDisplay = `<span style="font-weight: 600;">${modes.length} modes</span>`;
            } else {
              valueDisplay = `<strong>${variable.value}</strong>${typeof variable.value === 'string' && variable.value.includes('px') ? '' : 'px'}`;
              previewDisplay = `<div style="background: var(--color-primary-alpha-10); padding: 2px 8px; border-radius: var(--radius-sm); font-size: var(--font-size-xs); color: var(--color-primary); font-weight: 600;">${variable.value}${typeof variable.value === 'string' && variable.value.includes('px') ? '' : 'px'}</div>`;
            }
          } else if (variable.isAlias) {
            valueDisplay = `<span class="alias-reference">${variable.value}</span>`;
            previewDisplay = `<div style="display: flex; align-items: center; gap: var(--space-2);">
            <svg width="12" height="12" viewBox="0 0 16 16" fill="currentColor" style="color: var(--color-primary);">
              <path d="M4.715 6.542L3.343 7.914a3 3 0 1 0 4.243 4.243l1.828-1.828A3 3 0 0 0 8.586 5.5L8 6.086a1.002 1.002 0 0 0-.154.199 2 2 0 0 1 .861 3.337L6.88 11.45a2 2 0 1 1-2.83-2.83l.793-.792a4.018 4.018 0 0 1-.128-1.287z"/>
              <path d="M6.586 4.672A3 3 0 0 0 7.414 9.5l.775-.776a2 2 0 0 1-.896-3.346L9.12 3.55a2 2 0 0 1 2.83 2.83l-.793.792c.112.42.155.855.128 1.287l1.372-1.372a3 3 0 0 0-4.243-4.243L6.586 4.672z"/>
            </svg>
            <span style="font-size: var(--font-size-xs);">Link</span>
          </div>`;
          } else {
            // String type
            const truncatedValue = String(variable.value).length > 30 ?
              String(variable.value).substring(0, 30) + '...' :
              String(variable.value);
            valueDisplay = `<code style="background: var(--color-bg); padding: 2px 6px; border-radius: var(--radius-sm); font-size: var(--font-size-xs);">${truncatedValue}</code>`;
            previewDisplay = `<span style="font-size: var(--font-size-xs); color: var(--color-text-secondary);">${String(variable.value).length} chars</span>`;
          }

          // Extract collection name from path (first segment)
          const collectionName = variable.path.split('/')[0];

          // Combine value and preview for rich display
          let richValueDisplay = '';

          if (typeLower === 'color') {
            if (variable.isAlias) {
              richValueDisplay = `<div style="display: flex; align-items: center; gap: var(--space-2);">
              <div class="color-dot" style="background-color: var(--color-gray-300); opacity: 0.5;"></div>
              <span class="alias-reference">${variable.value}</span>
            </div>`;
            } else if (typeof variable.value === 'object' && !variable.value.r) {
              // Multi-mode color value
              const modes = Object.keys(variable.value);
              const firstMode = modes[0];
              const firstColor = variable.value[firstMode];

              richValueDisplay = `<div style="display: flex; align-items: center; gap: var(--space-2);">
              <div class="color-dot" style="background-color: ${firstColor};"></div>
              <div>
                ${modes.map(mode =>
                `<div style="font-size: var(--font-size-xs);"><span style="color: var(--color-text-secondary);">${mode}:</span> <strong>${variable.value[mode]}</strong></div>`
              ).join('')}
              </div>
            </div>`;
            } else {
              richValueDisplay = `<div style="display: flex; align-items: center; gap: var(--space-2);">
              <div class="color-dot" style="background-color: ${variable.value};"></div>
              <strong>${variable.value}</strong>
            </div>`;
            }
          } else if (typeLower === 'boolean') {
            const boolValue = typeof variable.value === 'boolean' ? variable.value :
              (variable.value === 'true' || variable.value === true);
            richValueDisplay = `<div style="display: flex; align-items: center; gap: var(--space-2);">
            <input type="checkbox" ${boolValue ? 'checked' : ''} disabled style="transform: scale(1.1);">
            <strong style="color: ${boolValue ? 'var(--color-success)' : 'var(--color-error)'};">${boolValue.toString()}</strong>
          </div>`;
          } else if (typeLower === 'number' || typeLower === 'float') {
            if (variable.isAlias) {
              richValueDisplay = `<span class="alias-reference">${variable.value}</span>`;
            } else if (typeof variable.value === 'object') {
              // Multi-mode number value
              const modes = Object.keys(variable.value);
              richValueDisplay = modes.map(mode =>
                `<div style="font-size: var(--font-size-xs);"><span style="color: var(--color-text-secondary);">${mode}:</span> <strong>${variable.value[mode]}px</strong></div>`
              ).join('');
            } else {
              richValueDisplay = `<div style="background: var(--color-primary-alpha-10); padding: 2px 8px; border-radius: var(--radius-sm); font-size: var(--font-size-sm); color: var(--color-primary); font-weight: 600; display: inline-block;">${variable.value}${typeof variable.value === 'string' && variable.value.includes('px') ? '' : 'px'}</div>`;
            }
          } else if (variable.isAlias) {
            richValueDisplay = `<div style="display: flex; align-items: center; gap: var(--space-2);">
            <svg width="12" height="12" viewBox="0 0 16 16" fill="currentColor" style="color: var(--color-primary);">
              <path d="M4.715 6.542L3.343 7.914a3 3 0 1 0 4.243 4.243l1.828-1.828A3 3 0 0 0 8.586 5.5L8 6.086a1.002 1.002 0 0 0-.154.199 2 2 0 0 1 .861 3.337L6.88 11.45a2 2 0 1 1-2.83-2.83l.793-.792a4.018 4.018 0 0 1-.128-1.287z"/>
              <path d="M6.586 4.672A3 3 0 0 0 7.414 9.5l.775-.776a2 2 0 0 1-.896-3.346L9.12 3.55a2 2 0 0 1 2.83 2.83l-.793.792c.112.42.155.855.128 1.287l1.372-1.372a3 3 0 0 0-4.243-4.243L6.586 4.672z"/>
            </svg>
            <span class="alias-reference">${variable.value}</span>
          </div>`;
          } else {
            // String type
            const truncatedValue = String(variable.value).length > 30 ?
              String(variable.value).substring(0, 30) + '...' :
              String(variable.value);
            richValueDisplay = `<code style="background: var(--color-bg); padding: 2px 6px; border-radius: var(--radius-sm); font-size: var(--font-size-xs);">${truncatedValue}</code>`;
          }

          row.innerHTML = `
          <td><strong>${variable.path}</strong></td>
          <td>${typePill}</td>
          <td>${richValueDisplay}</td>
          <td><span style="color: var(--color-text-secondary); font-size: var(--font-size-sm);">${collectionName}</span></td>
        `;

          tableBody.appendChild(row);
        });

        // Show message if there are more variables
        if (variables.length > 20) {
          const row = document.createElement('tr');
          row.innerHTML = `<td colspan="4" style="text-align: center; color: var(--color-text-secondary); font-style: italic;">Showing 20 of ${variables.length} variables</td>`;
          tableBody.appendChild(row);
        }
      }


      // Handle analysis result
      function handleAnalysisResult(data) {
        // Progress bar handled automatically by backend

        if (!data.analysis) {
          showSnackbar('Failed to analyze JSON', 'error');
          return;
        }

        // Show preview section
        const previewSection = document.getElementById('preview-section');
        previewSection.style.display = 'block';

        // Update analysis grid
        const analysisGrid = document.getElementById('analysis-grid');
        const analysis = data.analysis;

        analysisGrid.innerHTML = `
        <div class="analysis-item">
          <span class="analysis-number">${analysis.variables}</span>
          <span class="analysis-label">Variables</span>
        </div>
        <div class="analysis-item">
          <span class="analysis-number">${analysis.collections.length}</span>
          <span class="analysis-label">Collections</span>
        </div>
        <div class="analysis-item">
          <span class="analysis-number">${analysis.modes.length}</span>
          <span class="analysis-label">Modes</span>
        </div>
        <div class="analysis-item">
          <span class="analysis-number">${Object.keys(analysis.types).length}</span>
          <span class="analysis-label">Types</span>
        </div>
      `;

        // Update variables table with detailed preview
        if (data.variables && data.variables.length > 0) {
          // Convert backend variable format to preview format if needed
          const formattedVariables = data.variables.map(variable => ({
            path: variable.path || variable.name || 'Unknown',
            type: variable.type || 'UNKNOWN',
            value: variable.value,
            isAlias: typeof variable.value === 'string' && variable.value.startsWith('{') && variable.value.endsWith('}'),
            scopes: variable.scopes || [],
            codeSyntax: variable.codeSyntax || {}
          }));

          displayVariablePreview(formattedVariables);
        }

        showSnackbar('Variables preview generated successfully', 'success');
      }

      // Import variables
      function importVariables() {
        // Try new editor first, fallback to old textarea
        const newEditor = document.getElementById('json-editor-textarea');
        const oldTextarea = document.getElementById('json-input');
        const jsonInput = (newEditor ? newEditor.value : oldTextarea ? oldTextarea.value : '').trim();

        if (!jsonInput) {
          showSnackbar('Please enter JSON data to import', 'warning');
          return;
        }

        try {
          JSON.parse(jsonInput);
        } catch (error) {
          showSnackbar('Invalid JSON format', 'error');
          return;
        }

        // Show progress bar immediately
        const progressContainer = document.getElementById('import-progress-container');
        const progressBar = document.getElementById('import-progress-bar');
        const progressText = document.getElementById('import-progress-text');
        const progressPercentage = document.getElementById('import-progress-percentage');
        const progressDetails = document.getElementById('import-progress-details');

        if (progressContainer) {
          progressContainer.style.display = 'block';
          progressBar.style.width = '0%';
          progressPercentage.textContent = '0%';
          progressText.textContent = 'Starting import...';
          progressDetails.textContent = 'Preparing to import variables';
        }

        // Read preserve scopes checkbox state
        const preserveScopesCheckbox = document.getElementById('preserve-scopes-checkbox');
        const preserveScopes = preserveScopesCheckbox ? preserveScopesCheckbox.checked : false;

        sendMessage('import-json', {
          json: jsonInput,
          preserveScopes: preserveScopes
        });
      }

      // Sync variables from Figma to JSON editor
      function syncVariablesFromFigma() {

        // Get all collections
        const collectionsArray = collections.map(c => ({ id: c.id, name: c.name }));

        if (collectionsArray.length === 0) {
          showSnackbar('No collections found to sync', 'warning');
          return;
        }

        // Request W3C JSON export (combined, single file)
        sendMessage('export-json-advanced', {
          options: {
            collections: collectionsArray,
            modes: [],  // All modes
            types: [],  // All types
            exportType: 'combined',
            format: 'w3c',
            jsonOptions: {
              includeMetadata: false,
              includeAliases: true,
              useW3CKeys: true,
              prettify: true
            }
          }
        });

        showSnackbar('Syncing variables from Figma...', 'info');
      }

      // Handle import result
      // Handle import progress updates
      function handleImportProgress(data) {
        const progressContainer = document.getElementById('import-progress-container');
        const progressBar = document.getElementById('import-progress-bar');
        const progressText = document.getElementById('import-progress-text');
        const progressPercentage = document.getElementById('import-progress-percentage');
        const progressDetails = document.getElementById('import-progress-details');

        // Show progress container
        if (progressContainer) {
          progressContainer.style.display = 'block';
        }

        // Update progress bar
        if (progressBar && data.percentage !== undefined) {
          progressBar.style.width = data.percentage + '%';
        }

        // Update percentage text
        if (progressPercentage && data.percentage !== undefined) {
          progressPercentage.textContent = Math.round(data.percentage) + '%';
        }

        // Update progress text
        if (progressText && data.message) {
          progressText.textContent = data.message;
        }

        // Update details
        if (progressDetails && data.details) {
          progressDetails.textContent = data.details;
        }
      }

      function handleImportResult(data) {
        if (data.success) {
          // Show success message in progress bar
          const progressText = document.getElementById('import-progress-text');
          const progressDetails = document.getElementById('import-progress-details');

          if (progressText) {
            progressText.textContent = 'Import completed! üéâ';
          }
          if (progressDetails) {
            progressDetails.textContent = data.message;
          }

          // Keep progress bar visible for 5 seconds to show success message
          setTimeout(() => {
            const progressContainer = document.getElementById('import-progress-container');
            if (progressContainer) {
              progressContainer.style.display = 'none';
            }
          }, 5000);

          // Refresh collections without showing snackbar
          requestCollections();

          // Reset unsaved changes flag (import was successful)
          hasUnsavedChanges = false;
          jsonEditorModified = false; // Also reset modification tracking
          updateImportButtonState();

          // Update footer button (import created new collections)
          setTimeout(() => {
            updateVariablesFooterButton();
          }, 100); // Small delay to ensure collections are updated
        } else {
          // Hide progress bar immediately on error
          const progressContainer = document.getElementById('import-progress-container');
          if (progressContainer) {
            progressContainer.style.display = 'none';
          }
          showSnackbar(data.message, 'error');
        }
      }

      // Refresh plugin data from Figma (reinitialize like plugin restart)
      function refreshJsonFromFigma() {
        // Check if there are unsaved modifications
        if (jsonEditorModified) {
          const confirmed = confirm(
            'You have unsaved changes in the JSON editor.\n\n' +
            'Refreshing will reload all data from Figma and overwrite your changes.\n\n' +
            'Do you want to continue?'
          );

          if (!confirmed) {
            showSnackbar('Refresh cancelled', 'info');
            return;
          }
        }

        // Reinitialize plugin by requesting fresh data from Figma
        // This triggers the same flow as plugin startup
        sendMessage('ui-ready');

        showSnackbar('Reloading plugin data from Figma...', 'info');
      }

      // Export JSON
      function exportJson() {

        if (selectedCollections.size === 0) {
          showSnackbar('Please select at least one collection', 'warning');
          return;
        }

        // Update button state to 'generating'
        updateExportJsonButtonState('generating');

        const collectionsArray = collections.filter(c => selectedCollections.has(c.id));
        const modesArray = Array.from(selectedModes);
        const typesArray = Array.from(selectedTypes);
        const exportFormat = document.getElementById('export-format').value;
        const exportType = document.querySelector('input[name="json-export-type"]:checked').value;

        // Ensure minimum 1 second in 'generating' state
        const startTime = Date.now();

        // Build options object
        const options = {
          collections: collectionsArray,
          modes: modesArray,
          types: typesArray,
          exportType: exportType,
          format: exportFormat,
          includeModes: modesArray.length > 1, // Enable multi-mode export when multiple modes selected
          jsonOptions: {
            includeDescription: document.getElementById('include-description')?.checked || false,
            includeCodeSyntax: document.getElementById('include-code-syntax')?.checked || false
          }
        };

        // Save options for refresh functionality
        lastExportOptions = options;

        // Progress bar handled automatically by backend
        sendMessage('export-json-advanced', {
          options: options
        });
      }

      // Handle JSON result
      function handleJsonResult(data) {
        // Progress bar handled automatically by backend

        const unifiedTextarea = document.getElementById('json-export-textarea');
        const copyButton = document.getElementById('copy-json-button');
        const downloadButton = document.getElementById('download-json-button');

        if (!unifiedTextarea || !copyButton || !downloadButton) {
          console.error('[handleJsonResult] Export UI elements not found');
          showSnackbar('Error: Export UI elements not found', 'error');
          return;
        }

        if (data.success) {
          lastJsonExportResult = data; // Save for download functionality

          // Handle single JSON export or multiple files
          let jsonString;
          if (data.json) {
            // Single file export
            jsonString = data.json;
          } else if (data.files && data.files.length > 0) {
            // Multiple files export - show the first file or combine them
            if (data.files.length === 1) {
              jsonString = data.files[0].content;
            } else {
              // Multiple files - show a summary or the first file
              jsonString = JSON.stringify({
                files: data.files.map(f => ({
                  filename: f.filename,
                  preview: f.content.substring(0, 200) + (f.content.length > 200 ? '...' : '')
                }))
              }, null, 2);
            }
          } else {
            jsonString = JSON.stringify({ message: "No data available" }, null, 2);
          }

          unifiedTextarea.value = jsonString;
          showGetCodeContainer('get-code-container-json');
          // Update button text for single file
          const downloadButtonText = document.getElementById('download-button-text');
          if (downloadButtonText) {
            downloadButtonText.textContent = data.files && data.files.length > 1 ? 'Download ZIP' : 'Download';
          }
          showSnackbar(data.message, 'success');
        } else {
          hideGetCodeContainer('get-code-container-json');
          showSnackbar('Export failed: ' + data.message, 'error');
        }
      }

      // Handle JSON advanced result
      function handleJsonAdvancedResult(data) {
        // Progress bar handled automatically by backend

        const unifiedTextarea = document.getElementById('json-export-textarea');
        const copyButton = document.getElementById('copy-json-button');
        const downloadButton = document.getElementById('download-json-button');

        if (data.success) {
          lastJsonExportResult = data; // Save for download functionality

          // Transition button: generating ‚Üí generated (1 sec) ‚Üí update
          updateExportJsonButtonState('generated');
          setTimeout(() => {
            updateExportJsonButtonState('update');
          }, 1000);

          // Handle both single JSON export and multiple files
          if (data.json) {
            // Single file export
            unifiedTextarea.value = data.json;
            showGetCodeContainer('get-code-container-json');
            const downloadButtonText = document.getElementById('download-button-text');
            if (downloadButtonText) {
              downloadButtonText.textContent = 'Download';
            }

            // Update JSON editor with fresh data from Figma
            const jsonEditor = document.getElementById('json-editor-textarea');
            if (jsonEditor) {
              jsonEditor.value = data.json;
              jsonEditorModified = false; // Reset modification flag after successful refresh
            }

            showSnackbar(data.message, 'success');
          } else if (data.files && data.files.length > 0) {
            if (data.files.length === 1) {
              // Single file - show in textarea
              const file = data.files[0];
              unifiedTextarea.value = file.content;
              showGetCodeContainer('get-code-container-json');
              // Update button text for single file
              const downloadButtonText = document.getElementById('download-button-text');
              if (downloadButtonText) {
                downloadButtonText.textContent = 'Download';
              }
            } else {
              // Multiple files - show list in textarea
              const filesList = data.files.map(file =>
                `File: ${file.filename} (${Math.round(file.content.length / 1024)}KB)`
              ).join('\n');

              unifiedTextarea.value = `Export successful: ${data.message}\n\nGenerated Files:\n${filesList}\n\n(Use download button to get ZIP archive)`;
              showGetCodeContainer('get-code-container-json');
              // Update button text for multiple files
              const downloadButtonText = document.getElementById('download-button-text');
              if (downloadButtonText) {
                downloadButtonText.textContent = 'Download ZIP Archive';
              }
            }
            showSnackbar(data.message, 'success');
          } else {
            // No data to show but export was successful
            unifiedTextarea.value = 'Export completed successfully, but no data was returned.';
            hideGetCodeContainer('get-code-container-json');
            showSnackbar(data.message || 'Export completed successfully', 'warning');
          }
        } else {
          // On error, reset button to 'generate' state
          updateExportJsonButtonState('generate');
          unifiedTextarea.value = 'Export failed: ' + (data.message || 'Unknown error');
          hideGetCodeContainer('get-code-container-json');
          showSnackbar('Export failed: ' + (data.message || 'Unknown error'), 'error');
        }
      }

      // Export CSS
      function exportCss() {
        // Update button state to 'generating'
        updateExportCssButtonState('generating');

        if (isAdvancedCssMode) {
          // Pro mode - multiple collections and modes
          if (selectedCollections.size === 0) {
            showSnackbar('Please select at least one collection', 'warning');
            updateExportCssButtonState('generate'); // Reset on validation error
            return;
          }

          if (selectedModes.size === 0) {
            showSnackbar('Please select at least one mode', 'warning');
            updateExportCssButtonState('generate'); // Reset on validation error
            return;
          }

          const collectionsArray = collections.filter(c => selectedCollections.has(c.id));
          const modesArray = Array.from(selectedModes);
          const exportType = document.querySelector('input[name="css-export-type"]:checked').value;
          const format = document.getElementById('css-expert-format-select').value;

          // Get customization options if format is standard and customization is visible
          let cssOptions = {
            tokenNameStyle: 'kebab',
            colorFormat: 'hex',
            forceRemUnits: false
          };

          if (format === 'standard') {
            const customizationOptions = document.getElementById('css-customization-options');
            if (customizationOptions && customizationOptions.style.display !== 'none') {
              cssOptions = getCssCustomizationOptions();
            }
          }

          // Progress bar handled automatically by backend
          sendMessage('export-css-advanced', {
            options: {
              collections: collectionsArray,
              modes: modesArray,
              exportType: exportType,
              format: format,
              includeModes: modesArray.length > 1, // Enable multi-mode export when multiple modes selected
              cssOptions: cssOptions
            }
          });
        } else {
          // Simple mode - single collection and mode
          const collectionId = document.getElementById('css-collection-select').value;
          const mode = document.getElementById('css-mode-select').value;
          const format = document.getElementById('css-format-select').value;

          if (!collectionId) {
            showSnackbar('Please select a collection', 'warning');
            updateExportCssButtonState('generate'); // Reset on validation error
            return;
          }

          if (!mode) {
            showSnackbar('Please select a mode', 'warning');
            updateExportCssButtonState('generate'); // Reset on validation error
            return;
          }

          const selectedCollection = collections.find(c => c.id === collectionId);
          if (!selectedCollection) {
            showSnackbar('Selected collection not found', 'error');
            updateExportCssButtonState('generate'); // Reset on validation error
            return;
          }

          // Simple mode always uses basic options (no customization)
          const cssOptions = {
            tokenNameStyle: 'kebab',
            colorFormat: 'hex',
            forceRemUnits: false
          };

          // Progress bar handled automatically by backend
          sendMessage('export-css', {
            options: {
              collectionId: collectionId,
              mode: mode,
              format: format,
              cssOptions: cssOptions
            }
          });
        }
      }

      // Handle CSS result
      function handleCssResult(data) {
        // Progress bar handled automatically by backend

        const unifiedTextarea = document.getElementById('css-export-textarea');

        if (data.success) {
          lastCssExportResult = data;

          // Transition button: generating ‚Üí generated (1 sec) ‚Üí update
          updateExportCssButtonState('generated');
          setTimeout(() => {
            updateExportCssButtonState('update');
          }, 1000);

          unifiedTextarea.value = data.css;
          document.getElementById('copy-css-button').style.display = 'flex';
          document.getElementById('download-css-button').style.display = 'flex';
          showSnackbar('CSS export successful', 'success');
        } else {
          // On error, reset button to 'generate' state
          updateExportCssButtonState('generate');
          unifiedTextarea.value = 'CSS export failed: ' + (data.message || 'Unknown error');
          showSnackbar(data.message, 'error');
        }
      }

      // Handle CSS advanced result
      function handleCssAdvancedResult(data) {
        hideSophisticatedLoader();
        lastCssExportResult = data;

        const unifiedTextarea = document.getElementById('css-export-textarea');
        const copyButton = document.getElementById('copy-css-button');
        const downloadButton = document.getElementById('download-css-button');
        const downloadButtonText = document.getElementById('download-css-button-text');

        if (data.success) {
          // Transition button: generating ‚Üí generated (1 sec) ‚Üí update
          updateExportCssButtonState('generated');
          setTimeout(() => {
            updateExportCssButtonState('update');
          }, 1000);

          // Handle single CSS content (when exportType is 'single')
          if (data.css && !data.files) {
            unifiedTextarea.value = data.css;
            showGetCodeContainer('get-code-container-css');
            if (downloadButtonText) downloadButtonText.textContent = 'Download';

            showSnackbar(data.message || 'CSS export successful', 'success');
          }
          // Handle multiple files (when exportType is 'separate' or 'by-collection')
          else if (data.files && data.files.length > 0) {
            if (data.files.length === 1) {
              // Single file
              unifiedTextarea.value = data.files[0].content;
              showGetCodeContainer('get-code-container-css');
              if (downloadButtonText) downloadButtonText.textContent = 'Download';
            } else {
              // Multiple files
              const filesList = data.files.map(file =>
                `File: ${file.filename} (${(file.content.length / 1024).toFixed(1)}KB)`
              ).join('\n');
              unifiedTextarea.value = `CSS files generated successfully\n\nGenerated Files:\n${filesList}\n\n(Use download button to get ZIP archive)`;
              showGetCodeContainer('get-code-container-css');
              if (downloadButtonText) downloadButtonText.textContent = 'Download ZIP Archive';
            }

            showSnackbar(`Generated ${data.files.length} CSS file${data.files.length > 1 ? 's' : ''}`, 'success');
          } else {
            // Success but no content
            unifiedTextarea.value = 'No CSS content was generated. Please check your selected collections and variables.';
            hideGetCodeContainer('get-code-container-css');
            showSnackbar('No CSS content generated', 'warning');
          }
        } else {
          // On error, reset button to 'generate' state
          updateExportCssButtonState('generate');
          unifiedTextarea.value = 'CSS export failed: ' + (data.message || 'Unknown error');
          hideGetCodeContainer('get-code-container-css');
          showSnackbar(data.message || 'CSS export failed', 'error');
        }
      }

      // Resize functionality
      function setupResizeHandle() {
        const resizeHandle = document.getElementById('resize-handle');
        if (!resizeHandle) return;

        let isResizing = false;
        let startX, startY, startWidth, startHeight;

        // Show handle on hover
        document.addEventListener('mouseenter', () => {
          resizeHandle.style.opacity = '0.3';
        });

        document.addEventListener('mouseleave', (e) => {
          if (!isResizing && !resizeHandle.contains(e.relatedTarget)) {
            resizeHandle.style.opacity = '0';
          }
        });

        resizeHandle.addEventListener('mouseenter', () => {
          resizeHandle.style.opacity = '0.7';
        });

        resizeHandle.addEventListener('mouseleave', () => {
          if (!isResizing) {
            resizeHandle.style.opacity = '0.3';
          }
        });

        resizeHandle.addEventListener('mousedown', (e) => {
          isResizing = true;
          resizeHandle.classList.add('active');

          startX = e.clientX;
          startY = e.clientY;
          startWidth = window.innerWidth;
          startHeight = window.innerHeight;

          document.addEventListener('mousemove', handleMouseMove);
          document.addEventListener('mouseup', handleMouseUp);

          e.preventDefault();
        });

        function handleMouseMove(e) {
          if (!isResizing) return;

          const deltaX = e.clientX - startX;
          const deltaY = e.clientY - startY;

          const newWidth = Math.max(320, startWidth + deltaX);
          const newHeight = Math.max(400, startHeight + deltaY);

          // Send resize message to Figma
          sendMessage('resize', { width: newWidth, height: newHeight });
        }

        function handleMouseUp() {
          isResizing = false;
          resizeHandle.classList.remove('active');
          resizeHandle.style.opacity = '0.3';

          document.removeEventListener('mousemove', handleMouseMove);
          document.removeEventListener('mouseup', handleMouseUp);
        }

        // Handle window resize to keep handle visible
        window.addEventListener('resize', () => {
          if (isResizing) {
            resizeHandle.style.opacity = '0.7';
          }
        });
      }

      // Utility functions
      function showSnackbar(message, type = 'info') {
        // Create or update status message
        let statusEl = document.querySelector('.status-message');
        if (!statusEl) {
          statusEl = document.createElement('div');
          statusEl.className = 'status-message';
          document.body.appendChild(statusEl);
        }

        statusEl.className = `status-message ${type}`;
        statusEl.textContent = message;

        setTimeout(() => {
          if (statusEl && statusEl.parentNode) {
            statusEl.parentNode.removeChild(statusEl);
          }
        }, 5000);
      }

      function showSnackbar(message, type = 'info', duration = 3000) {
        const container = document.getElementById('snackbar-container');
        const snackbar = document.createElement('div');
        snackbar.className = `snackbar ${type}`;
        snackbar.textContent = message;

        container.appendChild(snackbar);

        // Show the snackbar
        setTimeout(() => {
          snackbar.classList.add('show');
        }, 10);

        // Hide and remove the snackbar after the specified duration
        setTimeout(() => {
          snackbar.classList.remove('show');
          snackbar.addEventListener('transitionend', () => {
            if (snackbar.parentNode) {
              snackbar.parentNode.removeChild(snackbar);
            }
          });
        }, duration);
      }

      // Upload Status Functions
      function showUploadStatus(message, type = 'info') {
        const container = document.getElementById('upload-status-container');
        const textElement = document.getElementById('upload-status-text');

        if (container && textElement) {
          container.className = `upload-status-container ${type}`;
          textElement.textContent = message;
          container.style.display = 'block';
        }
      }

      function hideUploadStatus() {
        const container = document.getElementById('upload-status-container');
        if (container) {
          container.style.display = 'none';
        }
      }

      function updateUploadProgress(current, total, fileName) {
        const textElement = document.getElementById('upload-status-text');
        if (textElement) {
          textElement.textContent = `Uploading ${fileName} (${current}/${total})...`;
        }
      }

      function copyToClipboard(text, filename = 'exported-data') {
        const cleanText = text.replace(/\\'/g, "'");

        // Try modern clipboard API first
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(cleanText).then(() => {
            showSnackbar('Copied to clipboard!', 'success');
          }).catch((error) => {
            // Fallback to download
            fallbackToDownload(cleanText, filename);
          });
        } else {
          // Try legacy method
          const textArea = document.createElement('textarea');
          textArea.value = cleanText;
          textArea.style.position = 'fixed';
          textArea.style.opacity = '0';
          document.body.appendChild(textArea);

          try {
            textArea.select();
            const successful = document.execCommand('copy');
            document.body.removeChild(textArea);

            if (successful) {
              showSnackbar('Copied to clipboard!', 'success');
            } else {
              throw new Error('execCommand failed');
            }
          } catch (error) {
            document.body.removeChild(textArea);
            // Fallback to download
            fallbackToDownload(cleanText, filename);
          }
        }
      }

      function fallbackToDownload(text, filename) {
        const fileExtension = filename.includes('.css') ? '.css' : '.json';
        const mimeType = fileExtension === '.css' ? 'text/css' : 'application/json';
        const finalFilename = filename.includes('.') ? filename : `${filename}${fileExtension}`;

        const blob = new Blob([text], { type: mimeType });
        downloadBlob(blob, finalFilename);
        showSnackbar('Download started (clipboard not available)', 'info');
      }

      function downloadJson(jsonString, filename) {

        // Add additional debugging
        if (!jsonString) {
          console.error('downloadJson: empty jsonString provided');
          showSnackbar('Error: No JSON data to download', 'error');
          return;
        }

        if (!filename) {
          console.error('downloadJson: no filename provided');
          filename = 'pelican.json';
        }

        const blob = new Blob([jsonString.replace(/\\'/g, "'")], { type: 'application/json' });

        downloadBlob(blob, filename);
      }

      function downloadCss(cssString, filename) {
        const blob = new Blob([cssString.replace(/\\'/g, "'")], { type: 'text/css' });
        downloadBlob(blob, filename);
      }

      function downloadAllFiles(files) {

        if (!files || files.length === 0) {
          console.error('No files provided to downloadAllFiles');
          showSnackbar('Error: No files to download', 'error');
          return;
        }

        if (files.length === 1) {
          const file = files[0];
          const blob = new Blob([file.content], {
            type: file.filename.endsWith('.css') ? 'text/css' : 'application/json'
          });
          downloadBlob(blob, file.filename);
        } else {
          // Download multiple files sequentially with delay
          files.forEach((file, index) => {
            setTimeout(() => {
              try {
                const blob = new Blob([file.content], {
                  type: file.filename.endsWith('.css') ? 'text/css' : 'application/json'
                });
                downloadBlob(blob, file.filename);
              } catch (error) {
                console.error(`Error downloading file ${file.filename}:`, error);
                showSnackbar(`Error downloading ${file.filename}`, 'error');
              }
            }, index * 1000); // 1000ms delay between downloads for better browser compatibility
          });

          // Show notification about multiple downloads
          showSnackbar(`Starting download of ${files.length} files...`, 'success');
        }
      }

      function downloadBlob(blob, filename) {
        try {

          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.style.display = 'none';
          a.href = url;
          a.download = filename;

          // Add to body, click, then remove
          document.body.appendChild(a);

          // Use setTimeout to ensure the element is properly attached
          setTimeout(() => {
            try {
              a.click();

              // Clean up after a delay to ensure download started
              setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
              }, 100);
            } catch (clickError) {
              console.error('Error clicking download link:', clickError);
              document.body.removeChild(a);
              URL.revokeObjectURL(url);

              // Fallback: try to save via alternative method
              tryAlternativeDownload(blob, filename);
            }
          }, 10);

        } catch (error) {
          console.error('Error in downloadBlob:', error);
          showSnackbar('Download failed: ' + error.message, 'error');

          // Fallback method
          tryAlternativeDownload(blob, filename);
        }
      }

      function tryAlternativeDownload(blob, filename) {
        try {

          // Method 1: Try using navigator.clipboard if available
          if (blob.type.includes('json') || blob.type.includes('text')) {
            blob.text().then(text => {
              if (navigator.clipboard) {
                navigator.clipboard.writeText(text).then(() => {
                  showSnackbar(`Content copied to clipboard (download blocked). Filename: ${filename}`, 'info');
                }).catch(() => {
                  showTextInModal(text, filename);
                });
              } else {
                showTextInModal(text, filename);
              }
            });
          } else {
            showSnackbar('Download blocked by browser. Please check security settings.', 'error');
          }
        } catch (error) {
          console.error('Alternative download failed:', error);
          showSnackbar('All download methods failed', 'error');
        }
      }

      function showTextInModal(text, filename) {
        // Create a modal to show the content when download fails
        const modal = document.createElement('div');
        modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.8); display: flex; align-items: center;
        justify-content: center; z-index: 10000;
      `;

        const content = document.createElement('div');
        content.style.cssText = `
        background: white; padding: 20px; border-radius: 8px;
        max-width: 80%; max-height: 80%; overflow: auto;
      `;

        const title = document.createElement('h3');
        title.textContent = `Content for ${filename} (Download failed)`;

        const textarea = document.createElement('textarea');
        textarea.style.cssText = 'width: 100%; height: 300px; margin: 10px 0;';
        textarea.value = text;
        textarea.select();

        const closeBtn = document.createElement('button');
        closeBtn.textContent = 'Close';
        closeBtn.onclick = () => document.body.removeChild(modal);

        content.appendChild(title);
        content.appendChild(textarea);
        content.appendChild(closeBtn);
        modal.appendChild(content);
        document.body.appendChild(modal);

        showSnackbar('Content displayed in modal (download blocked)', 'info');
      }

      // Download multiple files as a ZIP archive
      async function downloadZipFiles(files, zipFilename) {

        if (!files || files.length === 0) {
          console.error('No files provided to downloadZipFiles');
          showSnackbar('Error: No files to download', 'error');
          return;
        }

        if (!window.JSZip) {
          console.error('Embedded ZIP library not loaded');
          showSnackbar('Error: ZIP library not available', 'error');
          return;
        }

        try {
          showSnackbar('Creating ZIP archive...', 'info');

          const zip = new JSZip();

          // Add each file to the ZIP
          files.forEach((file, index) => {
            zip.file(file.filename, file.content);
          });

          showSnackbar('Generating ZIP file...', 'info');

          // Generate the ZIP file as blob
          const zipBlob = await zip.generateAsync();

          showSnackbar('Downloading ZIP file...', 'success');

          // Download the ZIP file
          downloadBlob(zipBlob, zipFilename);

          showSnackbar(`ZIP file downloaded successfully (${files.length} files)`, 'success');

        } catch (error) {
          console.error('Error creating ZIP file:', error);
          showSnackbar('Error creating ZIP file: ' + error.message, 'error');
        }
      }

      // Updated function to handle custom CSS mode select
      function updateCssModeSelectOnCollectionChange(collectionId) {
        const customSelect = document.getElementById('css-mode-custom-select');

        if (customSelect) {
          const dropdown = customSelect.querySelector('.custom-select-dropdown');
          const valueSpan = customSelect.querySelector('.custom-select-value');
          const hiddenInput = customSelect.parentElement.querySelector('input[type="hidden"]');

          // Reset to default state
          if (dropdown) {
            dropdown.innerHTML = '';
          }
          if (valueSpan) {
            valueSpan.textContent = 'Choose a mode...';
          }
          if (hiddenInput) {
            hiddenInput.value = '';
          }

          if (collectionId) {
            const collection = collections.find(c => c.id === collectionId);
            if (collection && dropdown) {
              dropdown.innerHTML = collection.modes.map(mode =>
                `<button class="custom-select-option" data-value="${mode}">${mode}</button>`
              ).join('');
            }
          }
        }
      }

      // ================== TEXT STYLES EXPORT FUNCTIONS ==================

      // Initialize text styles export components
      function initializeTextStylesExport() {

        // Initialize custom components for text styles tab  
        initializeCustomComponents();

        // Initialize event listeners
        setupTextStylesEventListeners();
      }

      // Setup event listeners for text styles export
      function setupTextStylesEventListeners() {
        const exportBtn = document.getElementById('export-text-styles-btn');
        const copyBtn = document.getElementById('copy-text-styles-btn');
        const downloadBtn = document.getElementById('download-text-styles-btn');

        if (exportBtn) {
          exportBtn.addEventListener('click', exportTextStyles);
        }

        if (copyBtn) {
          copyBtn.addEventListener('click', copyTextStylesResult);
        }

        if (downloadBtn) {
          downloadBtn.addEventListener('click', downloadTextStylesResult);
        }

        // Setup Select All / Deselect All buttons
        const selectAllBtn = document.getElementById('select-all-properties');
        const deselectAllBtn = document.getElementById('deselect-all-properties');

        if (selectAllBtn) {
          selectAllBtn.addEventListener('click', () => {
            document.querySelectorAll('input[name="text-style-prop"]').forEach(checkbox => {
              checkbox.checked = true;
            });
          });
        }

        if (deselectAllBtn) {
          deselectAllBtn.addEventListener('click', () => {
            document.querySelectorAll('input[name="text-style-prop"]').forEach(checkbox => {
              checkbox.checked = false;
            });
          });
        }
      }



      // Render Collections List
      function renderCollectionsList() {
        const container = document.getElementById('export-collections');
        if (!container) return;

        container.innerHTML = '';

        if (collections.length === 0) {
          const template = document.getElementById('empty-collections-template');
          if (template) container.appendChild(template.content.cloneNode(true));
          return;
        }

        collections.forEach(collection => {
          const label = document.createElement('label');
          label.className = 'collection-item';

          const input = document.createElement('input');
          input.type = 'checkbox';
          input.value = collection.id;
          input.checked = selectedCollections.has(collection.id);

          input.onchange = (e) => {
            if (e.target.checked) {
              selectedCollections.add(collection.id);
            } else {
              selectedCollections.delete(collection.id);
            }
            renderModesList();
            renderTypesList();
          };

          const indicator = document.createElement('span');
          indicator.className = 'checkbox-indicator';

          const text = document.createElement('span');
          text.textContent = collection.name;
          text.style.flex = '1';

          const badge = document.createElement('span');
          badge.className = 'badge';
          badge.textContent = `${collection.modes ? collection.modes.length : 0} modes`;
          badge.style.fontSize = '10px';
          badge.style.padding = '2px 6px';
          badge.style.background = 'var(--color-bg-secondary)';
          badge.style.borderRadius = '4px';
          badge.style.color = 'var(--color-text-secondary)';

          label.appendChild(input);
          label.appendChild(indicator);
          label.appendChild(text);
          label.appendChild(badge);
          container.appendChild(label);
        });

        renderModesList();
        renderTypesList();
      }

      // Render Modes List
      function renderModesList() {
        const container = document.getElementById('modes-list');
        if (!container) return;

        container.innerHTML = '';

        if (selectedCollections.size === 0) {
          const template = document.getElementById('empty-modes-template');
          if (template) container.appendChild(template.content.cloneNode(true));
          return;
        }

        // Gather all unique modes from selected collections
        const uniqueModes = new Set();
        collections.forEach(c => {
          if (selectedCollections.has(c.id) && c.modes) {
            c.modes.forEach(m => uniqueModes.add(m));
          }
        });

        uniqueModes.forEach(mode => {
          const label = document.createElement('label');
          label.className = 'collection-item';

          const input = document.createElement('input');
          input.type = 'checkbox';
          input.value = mode;
          input.checked = selectedModes.has(mode);

          input.onchange = (e) => {
            if (e.target.checked) {
              selectedModes.add(mode);
            } else {
              selectedModes.delete(mode);
            }
          };

          const indicator = document.createElement('span');
          indicator.className = 'checkbox-indicator';

          const text = document.createElement('span');
          text.textContent = mode;

          label.appendChild(input);
          label.appendChild(indicator);
          label.appendChild(text);
          container.appendChild(label);
        });
      }

      // Render Types List
      function renderTypesList() {
        const container = document.getElementById('types-list');
        if (!container) return;

        container.innerHTML = '';

        // Use the types initialized in selectedTypes or a standard list
        // Since selectedTypes is initialized with ['COLOR', 'FLOAT', 'STRING', 'BOOLEAN'], we use those.
        // We can also add more descriptive labels if needed.
        const types = [
          { value: 'COLOR', label: 'Color' },
          { value: 'FLOAT', label: 'Number' },
          { value: 'STRING', label: 'String' },
          { value: 'BOOLEAN', label: 'Boolean' }
        ];

        types.forEach(type => {
          const label = document.createElement('label');
          label.className = 'collection-item';

          const input = document.createElement('input');
          input.type = 'checkbox';
          input.value = type.value;
          input.checked = selectedTypes.has(type.value);

          input.onchange = (e) => {
            if (e.target.checked) {
              selectedTypes.add(type.value);
            } else {
              selectedTypes.delete(type.value);
            }
          };

          const indicator = document.createElement('span');
          indicator.className = 'checkbox-indicator';

          const text = document.createElement('span');
          text.textContent = type.label;

          label.appendChild(input);
          label.appendChild(indicator);
          label.appendChild(text);
          container.appendChild(label);
        });
      }

      // Render Brand Filter List
      function renderBrandFilterList(modes) {
        const container = document.getElementById('brand-filter-list');
        if (!container) return;

        container.innerHTML = '';

        // Filter out "Default" mode
        const filteredModes = modes.filter(m => m.name !== 'Default');

        // Add "All Brands" option
        const allLabel = document.createElement('label');
        allLabel.className = 'collection-item';

        const allInput = document.createElement('input');
        allInput.type = 'radio';
        allInput.name = 'brand-filter';
        allInput.value = '';
        allInput.checked = true;

        const allIndicator = document.createElement('span');
        allIndicator.className = 'radio-indicator'; // Assuming this exists or falls back to default

        const allText = document.createElement('span');
        allText.textContent = 'All Brands (Full Export)';

        allLabel.appendChild(allInput);
        // allLabel.appendChild(allIndicator); // Use standard radio for now to avoid styling issues
        allLabel.appendChild(allText);
        container.appendChild(allLabel);

        filteredModes.forEach(mode => {
          const label = document.createElement('label');
          label.className = 'collection-item';

          const input = document.createElement('input');
          input.type = 'radio';
          input.name = 'brand-filter';
          input.value = mode.name;

          const text = document.createElement('span');
          text.textContent = mode.name;

          label.appendChild(input);
          label.appendChild(text);
          container.appendChild(label);
        });
      }

      // Handle Collections Data
      function handleCollectionsData(data) {
        collections = data.collections;
        renderCollectionsList();
      }

      // Handle Import Result
      function handleImportResult(data) {
        const resultContainer = document.getElementById('import-result');
        const resultIcon = resultContainer.querySelector('.result-icon');
        const resultTitle = resultContainer.querySelector('h3');
        const resultMessage = resultContainer.querySelector('p');

        resultContainer.className = `result-container ${data.success ? 'success' : 'error'}`;
        resultContainer.style.display = 'flex';

        if (data.success) {
          resultIcon.innerHTML = `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M20 6L9 17L4 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
          resultTitle.textContent = 'Import Successful';
          resultMessage.textContent = data.message;

          // Refresh collections data
          sendMessage('get-collections');
        } else {
          resultIcon.innerHTML = `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
          resultTitle.textContent = 'Import Failed';
          resultMessage.textContent = data.message;
        }
      }

      // Initialize Custom Selects
      function setupCustomSelect(selectContainer) {
        const trigger = selectContainer.querySelector('.custom-select-trigger');
        const optionsContainer = selectContainer.querySelector('.custom-select-options');
        const options = selectContainer.querySelectorAll('.custom-select-option');
        const valueDisplay = selectContainer.querySelector('.custom-select-value');

        // Toggle dropdown
        trigger.onclick = (e) => {
          e.stopPropagation();
          // Close all other selects first
          document.querySelectorAll('.custom-select-container.open').forEach(el => {
            if (el !== selectContainer) el.classList.remove('open');
          });
          selectContainer.classList.toggle('open');
        };

        // Handle option selection
        options.forEach(option => {
          option.onclick = (e) => {
            e.stopPropagation();
            // Update selected state
            options.forEach(opt => opt.classList.remove('selected'));
            option.classList.add('selected');

            // Update trigger text and value
            valueDisplay.textContent = option.textContent;
            valueDisplay.dataset.value = option.dataset.value;

            // Close dropdown
            selectContainer.classList.remove('open');

            // Trigger change event if needed
            const event = new CustomEvent('change', { detail: { value: option.dataset.value } });
            selectContainer.dispatchEvent(event);
          };
        });
      }

      // Close dropdowns when clicking outside
      document.addEventListener('click', () => {
        document.querySelectorAll('.custom-select-container.open').forEach(el => {
          el.classList.remove('open');
        });
      });

      // Initialize existing custom selects
      document.querySelectorAll('.custom-select-container').forEach(setupCustomSelect);

      // Tab Switching Logic
      document.querySelectorAll('.sidebar-nav button').forEach(button => {
        button.addEventListener('click', () => {
          // Update active state for buttons
          document.querySelectorAll('.sidebar-nav button').forEach(btn => btn.classList.remove('active'));
          button.classList.add('active');

          // Update active state for content
          const tabId = button.dataset.tab;
          document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
            if (content.id === `${tabId}-tab`) {
              content.classList.add('active');
            }
          });

          // Show/Hide footer buttons based on tab
          document.querySelectorAll('.footer-btn').forEach(btn => btn.style.display = 'none');
          document.querySelectorAll('.footer-checkbox-container').forEach(container => container.style.display = 'none');

          const footerBtn = document.getElementById(`${tabId}-button`) || document.getElementById(`export-${tabId}-button`) || document.getElementById(`create-theme-button`);
          if (footerBtn) footerBtn.style.display = 'flex';

          // Show checkbox for import tab
          if (tabId === 'json-to-variables') {
            const checkbox = document.querySelector('.footer-checkbox-container[data-tab="json-to-variables"]');
            if (checkbox) checkbox.style.display = 'flex';
          }

          // Export Manager tab - no dynamic population needed anymore
          // Collections/modes/types selection removed in favor of simplified export
        });
      });

      // Helper to update CSS mode select when collection changes
      function updateCssModeSelectOnCollectionChange(collectionId) {
        const collection = collections.find(c => c.id === collectionId);
        const modeSelect = document.getElementById('css-mode-select');

        if (!modeSelect) return;

        // Clear existing options
        modeSelect.innerHTML = '<option value="">All Modes</option>';

        if (collection && collection.modes) {
          collection.modes.forEach(mode => {
            const option = document.createElement('option');
            option.value = mode; // Using name as ID is not available here easily without mapping
            option.textContent = mode;
            modeSelect.appendChild(option);
          });
        }
      }

      // Initialize CSS collection select listener
      setTimeout(() => {
        const cssCollectionHiddenInput = document.getElementById('css-collection-select');
        if (cssCollectionHiddenInput) {
          cssCollectionHiddenInput.addEventListener('change', function () {
            updateCssModeSelectOnCollectionChange(this.value);
          });
        }
      }, 100);

      // Current text styles export data
      let currentTextStylesData = null;
      let currentTextStylesFilename = null;

      // Export text styles function
      function exportTextStyles() {
        // Update button state to 'generating'
        updateExportTextStylesButtonState('generating');

        // Get selected format
        const formatSelect = document.querySelector('#text-styles-format-custom-select .custom-select-value');
        const format = formatSelect ? (formatSelect.textContent.includes('CSS') ? 'css' : 'w3c') : 'w3c';

        // Get selected brand (mode)
        const selectedBrand = document.querySelector('input[name="brand-filter"]:checked')?.value || '';

        // Always preserve aliases (Resolve Values option removed)
        const preserveAliases = true;

        // Get selected properties from checkboxes
        const selectedProperties = [];
        const checkboxes = document.querySelectorAll('input[name="text-style-prop"]:checked');
        checkboxes.forEach(checkbox => {
          selectedProperties.push(checkbox.value);
        });

        console.log('[UI] Exporting with selected properties:', selectedProperties, 'Brand:', selectedBrand);

        // Send message to backend
        sendMessage('export-text-styles', {
          format: format,
          preserveAliases: preserveAliases,
          selectedProperties: selectedProperties,
          selectedBrand: selectedBrand // üÜï Send selected brand
        });
      }

      // Handle Text Styles Export Result
      function handleTextStylesResult(data) {
        lastTextStylesExportResult = data;

        const textarea = document.getElementById('text-styles-export-textarea');
        const copyButton = document.getElementById('copy-text-styles-button');
        const downloadButton = document.getElementById('download-text-styles-button');

        if (data.success && data.data) {
          // Transition button: generating ‚Üí generated (1 sec) ‚Üí update
          updateExportTextStylesButtonState('generated');
          setTimeout(() => {
            updateExportTextStylesButtonState('update');
          }, 1000);

          // Show the result in textarea
          textarea.value = data.data;

          // Enable actions dropdown
          showGetCodeContainer('get-code-container-text-styles');

          showSnackbar(data.message || 'Text styles exported successfully', 'success');
        } else {
          // On error, reset button to 'generate' state
          updateExportTextStylesButtonState('generate');
          textarea.value = 'Text styles export failed: ' + (data.message || 'Unknown error');
          showSnackbar(data.message || 'Text styles export failed', 'error');
        }
      }

      // Download Text Styles
      function downloadTextStyles(data, filename) {
        const blob = new Blob([data], { type: 'application/json' });
        const url = URL.createObjectURL(blob);

        const a = document.createElement('a');
        a.href = url;
        a.download = filename || 'text-styles.json';
        a.click();

        URL.revokeObjectURL(url);
        showSnackbar(`Downloaded ${a.download}`, 'success');
      }

      // Panel Resize Functionality
      function initPanelResize() {
        document.querySelectorAll('.panel-separator').forEach(separator => {
          let isResizing = false;
          let startX = 0;
          let leftPanelStartWidth = 0;
          let leftPanel, rightPanel, container;

          separator.addEventListener('mousedown', (e) => {
            e.preventDefault();
            isResizing = true;
            startX = e.clientX;

            // Find the related panels
            container = separator.closest('.main-content-container');
            leftPanel = separator.previousElementSibling;
            rightPanel = separator.nextElementSibling;

            // Get initial width
            leftPanelStartWidth = leftPanel.getBoundingClientRect().width;

            // Add visual feedback
            document.body.style.cursor = 'col-resize';
            document.body.style.userSelect = 'none';
            separator.style.opacity = '0.8';

            // Add event listeners
            document.addEventListener('mousemove', handleResize);
            document.addEventListener('mouseup', stopResize);
          });

          function handleResize(e) {
            if (!isResizing) return;

            const deltaX = e.clientX - startX;
            const containerRect = container.getBoundingClientRect();
            const newLeftWidth = leftPanelStartWidth + deltaX;

            // Constraints
            const minLeftWidth = 300;
            const maxLeftWidth = containerRect.width * 0.6;
            const minRightWidth = 300;

            if (newLeftWidth >= minLeftWidth &&
              newLeftWidth <= maxLeftWidth &&
              (containerRect.width - newLeftWidth - 4) >= minRightWidth) {

              leftPanel.style.width = newLeftWidth + 'px';
              // rightPanel adjusts automatically with flex: 1
            }
          }

          function stopResize() {
            if (!isResizing) return;

            isResizing = false;

            // Remove visual feedback
            document.body.style.cursor = '';
            document.body.style.userSelect = '';
            separator.style.opacity = '0.3';

            // Remove event listeners
            document.removeEventListener('mousemove', handleResize);
            document.removeEventListener('mouseup', stopResize);

            // Save panel width to memory for session persistence
            if (leftPanel) {
              const panelWidth = leftPanel.getBoundingClientRect().width;
              window.luckinoPanelWidth = panelWidth.toString();
            }
          }
        });
      }

      // Restore panel width from memory
      function restorePanelWidths() {
        const savedWidth = window.luckinoPanelWidth;
        if (savedWidth) {
          document.querySelectorAll('.left-panel').forEach(panel => {
            const width = parseInt(savedWidth);
            if (width >= 300 && width <= window.innerWidth * 0.6) {
              panel.style.width = width + 'px';
            }
          });
        }
      }

      // Responsive button functionality
      function initResponsiveButtons() {
        // Function to update button modes based on viewport width or dev mode
        function updateButtonModes() {
          const isSmallViewport = window.innerWidth <= 600;
          const isDevMode = document.body.classList.contains('figma-dev-mode');
          const shouldUseIconMode = isSmallViewport || isDevMode;

          // Get all secondary footer buttons
          const secondaryButtons = document.querySelectorAll('.footer-btn.secondary');

          secondaryButtons.forEach(button => {
            if (shouldUseIconMode) {
              button.classList.add('icon-only');
            } else {
              button.classList.remove('icon-only');
            }
          });
        }

        // Function to detect dev mode (when plugin is in development)
        function detectDevMode() {
          // Check if we're in dev mode by looking for common dev indicators
          const urlParams = new URLSearchParams(window.location.search);
          const isDevMode = urlParams.has('dev') ||
            window.location.hostname === 'localhost' ||
            window.location.protocol === 'file:' ||
            document.body.dataset.mode === 'dev' ||
            // Figma dev mode detection
            window.location.href.includes('figma.com') ||
            document.title.includes('Development') ||
            // Check if Figma plugin is running in development
            (typeof figma !== 'undefined' && figma.mode === 'dev') ||
            // Force dev mode for testing - you can remove this line later
            true; // TEMPORARY: Always use icon mode for now

          if (isDevMode) {
            document.body.classList.add('figma-dev-mode');
          }
        }

        // Function to update tooltip content dynamically
        function updateTooltipContent() {
          // Update download button tooltips based on content
          const downloadJsonText = document.getElementById('download-button-text');
          const downloadJsonTooltip = document.getElementById('download-json-button')?.querySelector('.tooltip');
          if (downloadJsonText && downloadJsonTooltip) {
            downloadJsonTooltip.textContent = downloadJsonText.textContent;
          }

          const downloadCssText = document.getElementById('download-css-button-text');
          const downloadCssTooltip = document.getElementById('download-css-button')?.querySelector('.tooltip');
          if (downloadCssText && downloadCssTooltip) {
            downloadCssTooltip.textContent = downloadCssText.textContent;
          }

          const downloadTextStylesText = document.getElementById('download-text-styles-button-text');
          const downloadTextStylesTooltip = document.getElementById('download-text-styles-button')?.querySelector('.tooltip');
          if (downloadTextStylesText && downloadTextStylesTooltip) {
            downloadTextStylesTooltip.textContent = downloadTextStylesText.textContent;
          }
        }

        // Initial setup
        detectDevMode();
        updateButtonModes();
        updateTooltipContent();

        // Listen for window resize events
        let resizeTimeout;
        window.addEventListener('resize', () => {
          clearTimeout(resizeTimeout);
          resizeTimeout = setTimeout(() => {
            updateButtonModes();
          }, 150); // Debounce resize events
        });

        // Listen for mutation changes that might affect tooltips
        const observer = new MutationObserver(() => {
          updateTooltipContent();
        });

        // Observe changes to button text content
        document.querySelectorAll('#download-button-text, #download-css-button-text, #download-text-styles-button-text').forEach(element => {
          if (element) {
            observer.observe(element, {
              childList: true,
              characterData: true,
              subtree: true
            });
          }
        });

        // Force update when buttons become visible
        const footerButtonObserver = new MutationObserver((mutations) => {
          mutations.forEach((mutation) => {
            if (mutation.type === 'attributes' &&
              mutation.attributeName === 'style' &&
              mutation.target.classList.contains('footer-btn')) {
              setTimeout(updateTooltipContent, 10); // Small delay to ensure content is updated
            }
          });
        });

        document.querySelectorAll('.footer-btn').forEach(button => {
          footerButtonObserver.observe(button, { attributes: true });
        });
      }

      // Initialize when DOM is loaded
      // ===== DRAG & DROP FILE IMPORT =====
      function initDragAndDrop() {
        const dropZoneContainer = document.getElementById('drop-zone-container');
        const dropZoneOverlay = document.getElementById('drop-zone-overlay');
        const jsonInput = document.getElementById('json-input');

        if (!dropZoneContainer || !jsonInput) return;

        // Counter to track nested drag events
        let dragCounter = 0;

        // Prevent default drag behaviors on the whole document
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
          document.body.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
          e.preventDefault();
          e.stopPropagation();
        }

        // Handle dragenter
        dropZoneContainer.addEventListener('dragenter', (e) => {
          dragCounter++;
          dropZoneContainer.classList.add('drag-over');
        });

        // Handle dragleave
        dropZoneContainer.addEventListener('dragleave', (e) => {
          dragCounter--;
          if (dragCounter === 0) {
            dropZoneContainer.classList.remove('drag-over');
          }
        });

        // Handle dragover
        dropZoneContainer.addEventListener('dragover', (e) => {
          e.preventDefault();
          e.dataTransfer.dropEffect = 'copy';
        });

        // Handle drop
        dropZoneContainer.addEventListener('drop', async (e) => {
          e.preventDefault();
          dragCounter = 0;
          dropZoneContainer.classList.remove('drag-over');

          const files = Array.from(e.dataTransfer.files);

          // Filter only JSON files
          const jsonFiles = files.filter(file =>
            file.name.endsWith('.json') ||
            file.type === 'application/json' ||
            file.type === 'text/plain'
          );

          if (jsonFiles.length === 0) {
            showSnackbar('Please drop only JSON files', 'error');
            return;
          }

          try {
            // Read all JSON files
            const contents = await Promise.all(
              jsonFiles.map(file => readFileAsText(file))
            );

            if (contents.length === 1) {
              // Single file - just populate textarea
              jsonInput.value = contents[0];
              showSnackbar(`Loaded: ${jsonFiles[0].name}`, 'success');
            } else {
              // Multiple files - merge them
              const mergedJson = mergeJsonFiles(contents, jsonFiles.map(f => f.name));
              jsonInput.value = JSON.stringify(mergedJson, null, 2);
              showSnackbar(`Merged ${jsonFiles.length} files`, 'success');
            }

            // Trigger validation/preview if available
            if (typeof validateJson === 'function') {
              validateJson();
            }
          } catch (error) {
            console.error('Error reading dropped files:', error);
            showSnackbar('Error reading files: ' + error.message, 'error');
          }
        });

        // Helper: Read file as text
        function readFileAsText(file) {
          return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => resolve(e.target.result);
            reader.onerror = (e) => reject(new Error('Failed to read file'));
            reader.readAsText(file);
          });
        }

        // Helper: Merge multiple JSON files
        function mergeJsonFiles(contents, filenames) {
          const merged = {};

          contents.forEach((content, index) => {
            try {
              const parsed = JSON.parse(content);
              const filename = filenames[index].replace('.json', '');

              // If single root object, merge directly
              if (typeof parsed === 'object' && !Array.isArray(parsed)) {
                Object.assign(merged, parsed);
              } else {
                // Otherwise use filename as key
                merged[filename] = parsed;
              }
            } catch (error) {
              console.error(`Error parsing ${filenames[index]}:`, error);
              merged[`error_${filenames[index]}`] = {
                error: 'Invalid JSON',
                content: content.substring(0, 200) + '...'
              };
            }
          });

          return merged;
        }

      }

      // ===== JSON EDITOR ACTION BUTTONS =====
      function initJSONActionButtons() {
        const refreshBtn = document.getElementById('json-refresh-btn');
        const copyBtn = document.getElementById('json-copy-btn');
        const textarea = document.getElementById('json-editor-textarea');

        if (!textarea) return;

        // Refresh JSON functionality
        if (refreshBtn) {
          refreshBtn.addEventListener('click', () => {
            refreshJsonFromFigma();
          });
        }

        // Copy to Clipboard functionality
        if (copyBtn) {
          copyBtn.addEventListener('click', () => {
            try {
              const text = textarea.value;
              if (!text.trim()) {
                console.warn('No content to copy');
                return;
              }

              // Select the text
              textarea.select();
              textarea.setSelectionRange(0, textarea.value.length);

              // Try modern clipboard API first
              let copySuccess = false;
              if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text)
                  .then(() => {
                    showCopyFeedback();
                  })
                  .catch((err) => {
                    console.warn('Modern clipboard API failed, trying fallback:', err);
                    // Fallback to execCommand
                    copySuccess = document.execCommand('copy');
                    if (copySuccess) {
                      showCopyFeedback();
                    } else {
                      console.error('Copy failed');
                    }
                  });
              } else {
                // Fallback for older browsers or restricted contexts
                copySuccess = document.execCommand('copy');
                if (copySuccess) {
                  showCopyFeedback();
                } else {
                  console.error('Copy command failed');
                }
              }

              // Deselect after a moment
              setTimeout(() => {
                textarea.setSelectionRange(0, 0);
                textarea.blur();
              }, 100);

              function showCopyFeedback() {
                const originalHTML = copyBtn.innerHTML;
                copyBtn.innerHTML = '<svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M13.3333 4L6 11.3333L2.66667 8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>';
                copyBtn.style.color = 'var(--color-success)';

                setTimeout(() => {
                  copyBtn.innerHTML = originalHTML;
                  copyBtn.style.color = '';
                }, 1500);
              }
            } catch (err) {
              console.error('Failed to copy:', err);
            }
          });
        }

        // Track modifications to JSON editor
        textarea.addEventListener('input', () => {
          jsonEditorModified = true;
        });
      }

      // ===== JSON EDITOR FUNCTIONALITY =====
      function initJSONEditor() {
        const textarea = document.getElementById('json-editor-textarea');
        const lineNumbers = document.getElementById('json-line-numbers');
        const syntaxStatus = document.getElementById('json-syntax-status');
        const cursorPos = document.getElementById('json-cursor-pos');

        if (!textarea) return;

        // Search manager
        const searchManager = {
          matches: [],
          currentIndex: -1,
          options: {
            matchCase: false,
            wholeWord: false,
            useRegex: false
          },

          search(query) {
            this.matches = [];
            this.currentIndex = -1;

            if (!query) {
              document.getElementById('json-search-counter').textContent = '0 of 0';
              updateSyntaxHighlight(); // Clear search highlights
              return;
            }

            const text = textarea.value;

            if (this.options.useRegex) {
              try {
                const flags = this.options.matchCase ? 'g' : 'gi';
                const regex = new RegExp(query, flags);
                let match;
                while ((match = regex.exec(text)) !== null) {
                  this.matches.push({
                    start: match.index,
                    end: match.index + match[0].length
                  });
                }
              } catch (e) {
                document.getElementById('json-search-counter').textContent = 'Invalid regex';
                updateSyntaxHighlight(); // Clear on error
                return;
              }
            } else {
              let searchText = text;
              let searchQuery = query;

              if (!this.options.matchCase) {
                searchText = text.toLowerCase();
                searchQuery = query.toLowerCase();
              }

              let index = 0;
              while ((index = searchText.indexOf(searchQuery, index)) !== -1) {
                if (this.options.wholeWord) {
                  const before = text[index - 1];
                  const after = text[index + query.length];
                  if (/\w/.test(before) || /\w/.test(after)) {
                    index++;
                    continue;
                  }
                }

                this.matches.push({
                  start: index,
                  end: index + query.length
                });
                index++;
              }
            }

            this.updateCounter();
            if (this.matches.length > 0) {
              this.currentIndex = 0;
              this.scrollToMatch(0, false); // ‚úÖ Don't steal focus during search
            }

            // Update syntax highlighting with search matches
            updateSyntaxHighlight(this.matches, this.currentIndex);
          },

          goToNext() {
            if (this.matches.length === 0) return;
            this.currentIndex = (this.currentIndex + 1) % this.matches.length;
            this.scrollToMatch(this.currentIndex, true); // ‚úÖ Focus on navigation
            this.updateCounter();
            updateSyntaxHighlight(this.matches, this.currentIndex); // Update current match highlight
          },

          goToPrevious() {
            if (this.matches.length === 0) return;
            this.currentIndex = (this.currentIndex - 1 + this.matches.length) % this.matches.length;
            this.scrollToMatch(this.currentIndex, true); // ‚úÖ Focus on navigation
            this.updateCounter();
            updateSyntaxHighlight(this.matches, this.currentIndex); // Update current match highlight
          },

          scrollToMatch(index, shouldFocus = true) {
            if (index < 0 || index >= this.matches.length) return;
            const match = this.matches[index];

            // Set selection first
            textarea.setSelectionRange(match.start, match.end);

            // Calculate line number of match
            const textBeforeMatch = textarea.value.substring(0, match.start);
            const lineNumber = (textBeforeMatch.match(/\n/g) || []).length;

            // Get accurate line height
            const computedStyle = window.getComputedStyle(textarea);
            const lineHeight = parseFloat(computedStyle.lineHeight) || 20;

            // Calculate target line position in pixels
            const targetLineTop = lineNumber * lineHeight;

            // Get visible viewport height
            const viewportHeight = textarea.clientHeight;

            // Center the line in the viewport
            const centeredScrollTop = targetLineTop - (viewportHeight / 2) + (lineHeight / 2);

            // Apply smooth scroll with bounds checking
            textarea.scrollTo({
              top: Math.max(0, Math.min(centeredScrollTop, textarea.scrollHeight - viewportHeight)),
              behavior: 'smooth'
            });

            // Only focus when navigating with buttons/Enter
            if (shouldFocus) {
              textarea.focus();
            }
            // When typing in search input, don't focus (prevents background change)
          },

          updateCounter() {
            const counter = document.getElementById('json-search-counter');
            if (this.matches.length === 0) {
              counter.textContent = 'No results';
            } else {
              counter.textContent = `${this.currentIndex + 1} of ${this.matches.length}`;
            }
          },

          replace(findText, replaceText, replaceAll = false) {
            if (!findText || this.matches.length === 0) return;

            const text = textarea.value;

            if (replaceAll) {
              let newText = text;
              let offset = 0;

              for (const match of this.matches) {
                const start = match.start + offset;
                const end = match.end + offset;
                newText = newText.substring(0, start) + replaceText + newText.substring(end);
                offset += replaceText.length - (match.end - match.start);
              }

              textarea.value = newText;
              updateLineNumbers();
              validateJSON();
              updateSyntaxHighlight();
              this.search(findText);
            } else {
              if (this.currentIndex >= 0 && this.currentIndex < this.matches.length) {
                const match = this.matches[this.currentIndex];
                const newText = text.substring(0, match.start) +
                  replaceText +
                  text.substring(match.end);

                textarea.value = newText;
                updateLineNumbers();
                validateJSON();
                updateSyntaxHighlight();
                this.search(findText);

                if (this.matches.length > 0) {
                  this.goToNext();
                }
              }
            }
          }
        };

        // Update line numbers
        function updateLineNumbers() {
          const lines = textarea.value.split('\n').length;
          lineNumbers.innerHTML = Array.from({ length: lines }, (_, i) => i + 1).join('\n');
        }

        // Syntax highlighting function
        function highlightJSON(text, searchMatches = null, currentMatchIndex = -1) {
          if (!text) return '';

          // Escape HTML to prevent XSS
          const escapeHtml = (str) => str
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#039;');

          // If we have search matches, insert markers first
          let processedText = text;
          const markers = [];

          if (searchMatches && searchMatches.length > 0) {
            // Create markers for all matches (in reverse order to maintain positions)
            const sortedMatches = [...searchMatches].sort((a, b) => b.start - a.start);

            sortedMatches.forEach((match, reverseIndex) => {
              const originalIndex = searchMatches.length - 1 - reverseIndex;
              const isCurrent = originalIndex === currentMatchIndex;
              const markerClass = isCurrent ? 'json-search-match-current' : 'json-search-match';

              const before = processedText.substring(0, match.start);
              const matchText = processedText.substring(match.start, match.end);
              const after = processedText.substring(match.end);

              processedText = before + `\x00MATCHSTART${markerClass}\x00` + matchText + `\x00MATCHEND\x00` + after;
            });
          }

          let highlighted = escapeHtml(processedText);

          // Highlight in order: keys, strings, numbers, booleans, null

          // 1. Keys (property names): "key":
          highlighted = highlighted.replace(
            /&quot;([^&\x00]+?)&quot;(\s*):/g,
            '<span class="json-key">&quot;$1&quot;</span>$2:'
          );

          // 2. String values: : "value"
          highlighted = highlighted.replace(
            /:(\s*)&quot;([^&\x00]*)&quot;/g,
            ':$1<span class="json-string">&quot;$2&quot;</span>'
          );

          // 3. Numbers: : 123 or : 12.34 or : -5
          highlighted = highlighted.replace(
            /:(\s*)(-?\d+\.?\d*)/g,
            ':$1<span class="json-number">$2</span>'
          );

          // 4. Booleans: true/false
          highlighted = highlighted.replace(
            /\b(true|false)\b/g,
            '<span class="json-boolean">$1</span>'
          );

          // 5. Null
          highlighted = highlighted.replace(
            /\b(null)\b/g,
            '<span class="json-null">$1</span>'
          );

          // 6. Punctuation: {}[],: (only standalone, not already in spans)
          highlighted = highlighted.replace(
            /([{}[\],:])/g,
            '<span class="json-punctuation">$1</span>'
          );

          // Replace search match markers with actual HTML
          highlighted = highlighted.replace(
            /\x00MATCHSTART(json-search-match(?:-current)?)\x00/g,
            '<span class="$1">'
          );
          highlighted = highlighted.replace(/\x00MATCHEND\x00/g, '</span>');

          return highlighted;
        }

        // Update syntax highlighting
        function updateSyntaxHighlight(searchMatches = null, currentMatchIndex = -1) {
          const highlightDiv = document.getElementById('json-syntax-highlight');
          if (!highlightDiv) return;

          const highlighted = highlightJSON(textarea.value, searchMatches, currentMatchIndex);
          highlightDiv.innerHTML = highlighted;

          // Sync scroll with textarea
          highlightDiv.scrollTop = textarea.scrollTop;
          highlightDiv.scrollLeft = textarea.scrollLeft;
        }

        // Sync scroll
        textarea.addEventListener('scroll', () => {
          lineNumbers.scrollTop = textarea.scrollTop;
          const highlightDiv = document.getElementById('json-syntax-highlight');
          if (highlightDiv) {
            highlightDiv.scrollTop = textarea.scrollTop;
            highlightDiv.scrollLeft = textarea.scrollLeft;
          }
        });

        // Update cursor position
        function updateCursorPosition() {
          const text = textarea.value.substring(0, textarea.selectionStart);
          const lines = text.split('\n');
          const line = lines.length;
          const col = lines[lines.length - 1].length + 1;
          cursorPos.textContent = `Ln ${line}, Col ${col}`;
        }

        // Validate JSON
        function validateJSON() {
          const value = textarea.value.trim();
          if (!value) {
            syntaxStatus.textContent = '‚úì Valid JSON';
            syntaxStatus.className = 'syntax-status valid';
            return;
          }

          try {
            JSON.parse(value);
            syntaxStatus.textContent = '‚úì Valid JSON';
            syntaxStatus.className = 'syntax-status valid';
          } catch (error) {
            syntaxStatus.textContent = `‚ö† ${error.message}`;
            syntaxStatus.className = 'syntax-status error';
          }
        }

        // Event listeners
        textarea.addEventListener('input', () => {
          // Skip if update is programmatic (from tree edit, not user typing)
          if (isUpdatingProgrammatically) {
            return;
          }

          updateLineNumbers();
          updateCursorPosition();
          validateJSON();
          updateSyntaxHighlight(); // ‚ú® Syntax highlighting
          syncJSONToTokenTree(); // üÜï Sync to Token Tree (debounced)

          // Mark as having unsaved changes
          if (!hasUnsavedChanges) {
            hasUnsavedChanges = true;
            updateImportButtonState();
          }
        });

        textarea.addEventListener('click', updateCursorPosition);
        textarea.addEventListener('keyup', updateCursorPosition);

        // Tab key support
        textarea.addEventListener('keydown', (e) => {
          if (e.key === 'Tab') {
            e.preventDefault();
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            textarea.value = textarea.value.substring(0, start) + '  ' + textarea.value.substring(end);
            textarea.selectionStart = textarea.selectionEnd = start + 2;
            updateLineNumbers();
          }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
          // Only activate in Import JSON tab
          const importTab = document.getElementById('json-to-variables-tab');
          if (!importTab || !importTab.classList.contains('active')) return;

          // Check if focus is in search/replace input fields
          const searchInput = document.getElementById('json-search-input');
          const replaceInput = document.getElementById('json-replace-input');
          const activeElement = document.activeElement;
          const isInInputField = activeElement === searchInput || activeElement === replaceInput;
          const searchToolbar = document.getElementById('json-search-toolbar');

          // CMD+F or CTRL+F: Open search (always intercept)
          if ((e.metaKey || e.ctrlKey) && e.key === 'f') {
            e.preventDefault();
            searchToolbar.style.display = 'block';
            searchInput.focus();
            searchInput.select();
            return;
          }

          // ESC: Close search (only if search is open)
          if (e.key === 'Escape' && searchToolbar.style.display === 'block') {
            searchToolbar.style.display = 'none';
            searchManager.matches = [];
            searchManager.currentIndex = -1;
            updateSyntaxHighlight(); // Clear search highlights
            textarea.focus();
            return;
          }

          // Enter in search field: Next/Previous match
          if (e.key === 'Enter' && activeElement === searchInput) {
            e.preventDefault();
            if (e.shiftKey) {
              searchManager.goToPrevious();
            } else {
              searchManager.goToNext();
            }
            return;
          }

          // Option shortcuts: Only if NOT typing in input fields
          if (isInInputField) return; // ‚úÖ FIX: Don't intercept keys when typing

          if (searchToolbar.style.display === 'block') {
            // Option+C: Toggle case
            if (e.altKey && e.key === 'c') {
              e.preventDefault();
              document.getElementById('json-match-case').click();
              return;
            }

            // Option+W: Toggle whole word
            if (e.altKey && e.key === 'w') {
              e.preventDefault();
              document.getElementById('json-match-whole').click();
              return;
            }

            // Option+R: Toggle regex
            if (e.altKey && e.key === 'r') {
              e.preventDefault();
              document.getElementById('json-use-regex').click();
              return;
            }
          }
        });

        // Search input
        const searchInput = document.getElementById('json-search-input');
        searchInput.addEventListener('input', (e) => {
          searchManager.search(e.target.value);
        });

        // Search navigation buttons
        document.getElementById('json-search-next').addEventListener('click', () => {
          searchManager.goToNext();
        });

        document.getElementById('json-search-prev').addEventListener('click', () => {
          searchManager.goToPrevious();
        });

        // Toggle buttons
        document.getElementById('json-match-case').addEventListener('click', (e) => {
          e.currentTarget.classList.toggle('active');
          searchManager.options.matchCase = e.currentTarget.classList.contains('active');
          searchManager.search(searchInput.value);
        });

        document.getElementById('json-match-whole').addEventListener('click', (e) => {
          e.currentTarget.classList.toggle('active');
          searchManager.options.wholeWord = e.currentTarget.classList.contains('active');
          searchManager.search(searchInput.value);
        });

        document.getElementById('json-use-regex').addEventListener('click', (e) => {
          e.currentTarget.classList.toggle('active');
          searchManager.options.useRegex = e.currentTarget.classList.contains('active');
          searchManager.search(searchInput.value);
        });

        // Close button
        document.getElementById('json-search-close').addEventListener('click', () => {
          document.getElementById('json-search-toolbar').style.display = 'none';
          searchManager.matches = [];
          searchManager.currentIndex = -1;
          updateSyntaxHighlight(); // Clear search highlights
          textarea.focus();
        });

        // Toggle replace (start collapsed)
        const toggleReplaceBtn = document.getElementById('json-toggle-replace');
        const replaceRow = document.getElementById('json-replace-row');

        // Initialize as collapsed
        toggleReplaceBtn.classList.add('collapsed');
        replaceRow.style.display = 'none';

        toggleReplaceBtn.addEventListener('click', () => {
          toggleReplaceBtn.classList.toggle('collapsed');
          if (toggleReplaceBtn.classList.contains('collapsed')) {
            replaceRow.style.display = 'none';
          } else {
            replaceRow.style.display = 'flex';
          }
        });

        // Replace buttons
        document.getElementById('json-replace-one').addEventListener('click', () => {
          const findText = document.getElementById('json-search-input').value;
          const replaceText = document.getElementById('json-replace-input').value;
          searchManager.replace(findText, replaceText, false);
        });

        document.getElementById('json-replace-all').addEventListener('click', () => {
          const findText = document.getElementById('json-search-input').value;
          const replaceText = document.getElementById('json-replace-input').value;
          if (confirm(`Replace all ${searchManager.matches.length} occurrences?`)) {
            searchManager.replace(findText, replaceText, true);
          }
        });

        // Initialize
        updateLineNumbers();
        validateJSON();
        updateCursorPosition();
        updateSyntaxHighlight(); // Initial syntax highlighting

      }

      // ================== GITHUB INTEGRATION FUNCTIONS ==================

      // Store for current export data (for GitHub push)
      let currentExportData = null;
      let currentExportFilename = null;

      /**
       * Load GitHub config on settings tab activation
       */
      function loadGitHubConfig() {
        sendMessage('github-config-load', {});
      }

      /**
       * Handle loaded GitHub config
       */
      function handleGitHubConfigLoaded(data) {
        if (data.config) {
          document.getElementById('github-token').value = data.config.token || '';
          document.getElementById('github-repo').value = data.config.repository || '';
          document.getElementById('github-branch').value = data.config.branch || 'main';
          document.getElementById('github-path').value = data.config.path || 'tokens/';
          console.log('[GitHub] Config loaded into form');
        }
      }

      /**
       * Save GitHub config
       */
      function saveGitHubConfig() {
        const config = {
          token: document.getElementById('github-token').value,
          repository: document.getElementById('github-repo').value,
          branch: document.getElementById('github-branch').value,
          path: document.getElementById('github-path').value
        };
        sendMessage('github-config-save', config);
      }

      /**
       * Handle config saved confirmation
       */
      function handleGitHubConfigSaved(data) {
        if (data.success) {
          showSnackbar('GitHub configuration saved', 'success');
        } else {
          showSnackbar('Failed to save GitHub configuration', 'error');
        }
      }

      /**
       * Test GitHub connection (triggered from UI)
       */
      function testGitHubConnection() {
        const token = document.getElementById('github-token').value;
        const repo = document.getElementById('github-repo').value;
        const statusEl = document.getElementById('github-connection-status');

        if (!token || !repo) {
          statusEl.textContent = 'Token and repository required';
          statusEl.style.color = 'var(--color-warning)';
          return;
        }

        statusEl.textContent = 'Testing...';
        statusEl.style.color = 'var(--color-text-muted)';

        sendMessage('github-test-connection', { token, repository: repo });
      }

      /**
       * Execute the actual HTTP request for test connection (called from backend via message)
       */
      async function executeGitHubTestConnection(data) {
        const { token, repository, owner, repo } = data;
        const statusEl = document.getElementById('github-connection-status');

        try {
          const response = await fetch(`https://api.github.com/repos/${owner}/${repo}`, {
            headers: {
              'Authorization': `token ${token}`,
              'Accept': 'application/vnd.github.v3+json',
              'User-Agent': 'Figma-Plugin-Orbit-Station'
            }
          });

          if (response.ok) {
            const repoInfo = await response.json();
            statusEl.textContent = `Connected to ${repoInfo.full_name}`;
            statusEl.style.color = 'var(--color-success)';

            // Auto-save config on successful connection
            saveGitHubConfig();
          } else {
            const errorData = await response.json();
            statusEl.textContent = `Error: ${errorData.message || response.status}`;
            statusEl.style.color = 'var(--color-error)';
          }
        } catch (error) {
          statusEl.textContent = `Error: ${error.message}`;
          statusEl.style.color = 'var(--color-error)';
        }
      }

      /**
       * Handle test result (alternative path)
       */
      function handleGitHubTestResult(data) {
        const statusEl = document.getElementById('github-connection-status');
        if (data.success) {
          statusEl.textContent = data.message || 'Connected!';
          statusEl.style.color = 'var(--color-success)';
        } else {
          statusEl.textContent = data.message || 'Connection failed';
          statusEl.style.color = 'var(--color-error)';
        }
      }

      /**
       * Push current export to GitHub
       */
      function pushToGitHub(source) {
        let content, filename;

        if (source === 'json') {
          const textarea = document.getElementById('json-export-textarea');
          content = textarea ? textarea.value : null;
          filename = 'pelican.json';
        } else if (source === 'text-styles') {
          const textarea = document.getElementById('text-styles-export-textarea');
          content = textarea ? textarea.value : null;
          filename = lastTextStylesExportResult?.filename || 'text-styles.json';
        }

        if (!content) {
          showSnackbar('No content to push. Generate export first.', 'warning');
          return;
        }

        // Check if GitHub is configured
        const token = document.getElementById('github-token').value;
        const repo = document.getElementById('github-repo').value;

        if (!token || !repo) {
          showSnackbar('Please configure GitHub settings first', 'warning');
          return;
        }

        sendMessage('github-push', { content, filename });
      }

      /**
       * Execute GitHub push (HTTP request from UI)
       */
      async function executeGitHubPush(data) {
        const { content, filename, config } = data;

        try {
          const [owner, repo] = config.repository.split('/');
          const path = config.path ? `${config.path}${filename}` : filename;
          const apiUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${path}`;

          // Check if file exists (to get SHA for update)
          let existingSha = null;
          try {
            const checkResponse = await fetch(`${apiUrl}?ref=${config.branch}`, {
              headers: {
                'Authorization': `token ${config.token}`,
                'Accept': 'application/vnd.github.v3+json',
                'User-Agent': 'Figma-Plugin-Orbit-Station'
              }
            });

            if (checkResponse.ok) {
              const existingFile = await checkResponse.json();
              existingSha = existingFile.sha;
            }
          } catch (e) {
            // File doesn't exist, that's fine
          }

          // Prepare payload
          const payload = {
            message: `Update ${filename} from Orbit Station`,
            content: btoa(unescape(encodeURIComponent(content))),
            branch: config.branch
          };

          if (existingSha) {
            payload.sha = existingSha;
          }

          // Upload
          const response = await fetch(apiUrl, {
            method: 'PUT',
            headers: {
              'Authorization': `token ${config.token}`,
              'Accept': 'application/vnd.github.v3+json',
              'Content-Type': 'application/json',
              'User-Agent': 'Figma-Plugin-Orbit-Station'
            },
            body: JSON.stringify(payload)
          });

          const responseData = await response.json();

          if (response.ok) {
            showSnackbar(`Pushed to GitHub: ${path}`, 'success');
            console.log('[GitHub] Push successful:', responseData.content?.html_url);
          } else {
            throw new Error(responseData.message || `GitHub API error: ${response.status}`);
          }

        } catch (error) {
          showSnackbar(`GitHub push failed: ${error.message}`, 'error');
          console.error('[GitHub] Push error:', error);
        }
      }

      /**
       * Handle push result
       */
      function handleGitHubPushResult(data) {
        if (data.success) {
          showSnackbar('Successfully pushed to GitHub', 'success');
        } else {
          showSnackbar(`GitHub push failed: ${data.error}`, 'error');
        }
      }

      /**
       * Setup GitHub event listeners
       */
      function setupGitHubEventListeners() {
        // Test connection button
        const testBtn = document.getElementById('test-github-connection-btn');
        if (testBtn) {
          testBtn.addEventListener('click', testGitHubConnection);
        }

        // Auto-save on input blur
        ['github-token', 'github-repo', 'github-branch', 'github-path'].forEach(id => {
          const input = document.getElementById(id);
          if (input) {
            input.addEventListener('blur', () => {
              // Only save if all required fields are filled
              const token = document.getElementById('github-token').value;
              const repo = document.getElementById('github-repo').value;
              if (token && repo) {
                saveGitHubConfig();
              }
            });
          }
        });

        // Push to GitHub buttons
        const pushJsonBtn = document.getElementById('push-github-json-button');
        if (pushJsonBtn) {
          pushJsonBtn.addEventListener('click', () => pushToGitHub('json'));
        }

        const pushTextStylesBtn = document.getElementById('push-github-text-styles-button');
        if (pushTextStylesBtn) {
          pushTextStylesBtn.addEventListener('click', () => pushToGitHub('text-styles'));
        }
      }

      document.addEventListener('DOMContentLoaded', () => {
        initPlugin();
        initPanelResize();
        restorePanelWidths();
        initResponsiveButtons();
        initDragAndDrop(); // Initialize drag & drop
        initJSONEditor(); // Initialize JSON editor
        initJSONActionButtons(); // Initialize JSON action buttons (Copy, Select All)
        setupGitHubEventListeners(); // Initialize GitHub integration

        // Initialize export buttons to 'generate' state (paused animation)
        updateExportJsonButtonState('generate');
        updateExportCssButtonState('generate');
        updateExportTextStylesButtonState('generate');

        // Initialize token tooltip
        initTokenTooltip();

        // Load GitHub config
        loadGitHubConfig();
      });

      // ========== TOKEN TOOLTIP FUNCTIONALITY ==========
      function initTokenTooltip() {
        const tooltip = document.getElementById('token-tooltip');
        const tooltipName = tooltip.querySelector('.token-tooltip-name');
        const tooltipPath = tooltip.querySelector('.token-tooltip-path');
        const tooltipValue = tooltip.querySelector('.token-tooltip-value');

        // Use event delegation for dynamically created token items
        document.addEventListener('mouseover', (e) => {
          const tokenItem = e.target.closest('.token-item');
          if (!tokenItem) return;

          // Get token data from attributes
          const tokenName = tokenItem.querySelector('.token-name')?.textContent;
          const tokenPath = tokenItem.dataset.path;
          const tokenType = tokenItem.dataset.type;
          let tokenValue = tokenItem.querySelector('.token-value')?.textContent;

          // Parse raw value if available
          try {
            const rawValue = tokenItem.dataset.value;
            if (rawValue) {
              const parsed = JSON.parse(rawValue);
              if (parsed && typeof parsed === 'object' && parsed.r !== undefined) {
                // RGB color object
                const toHex = (n) => {
                  const hex = Math.round(n * 255).toString(16);
                  return hex.length === 1 ? '0' + hex : hex;
                };
                tokenValue = `#${toHex(parsed.r)}${toHex(parsed.g)}${toHex(parsed.b)}`;
              } else if (typeof parsed === 'string' || typeof parsed === 'number') {
                tokenValue = String(parsed);
              }
            }
          } catch (e) {
            // Use displayed value
          }

          // Update tooltip content
          tooltipName.textContent = tokenName || 'Token';
          tooltipPath.textContent = `{${tokenPath}}`;
          tooltipValue.textContent = tokenValue || '';

          // Style value based on type
          tooltipValue.className = 'token-tooltip-value';
          if (tokenType === 'color' && tokenValue && tokenValue.startsWith('#')) {
            tooltipValue.classList.add('color-value');
            tooltipValue.style.backgroundColor = tokenValue;
            // Calculate contrast color for text
            const hex = tokenValue.replace('#', '');
            const r = parseInt(hex.substr(0, 2), 16);
            const g = parseInt(hex.substr(2, 2), 16);
            const b = parseInt(hex.substr(4, 2), 16);
            const brightness = (r * 299 + g * 587 + b * 114) / 1000;
            tooltipValue.style.color = brightness > 128 ? '#000' : '#fff';
          } else {
            tooltipValue.style.backgroundColor = '#fff';
            tooltipValue.style.color = '#000';
          }

          // Position tooltip
          const rect = tokenItem.getBoundingClientRect();
          const tooltipRect = tooltip.getBoundingClientRect();

          // Position above the token item
          let left = rect.left + (rect.width / 2) - (tooltipRect.width / 2);
          let top = rect.top - tooltipRect.height - 8;

          // Adjust if goes off screen
          if (left < 10) left = 10;
          if (left + tooltipRect.width > window.innerWidth - 10) {
            left = window.innerWidth - tooltipRect.width - 10;
          }
          if (top < 10) {
            // Show below if no space above
            top = rect.bottom + 8;
          }

          tooltip.style.left = `${left}px`;
          tooltip.style.top = `${top}px`;
          tooltip.classList.add('visible');
        });

        document.addEventListener('mouseout', (e) => {
          const tokenItem = e.target.closest('.token-item');
          if (tokenItem && !tokenItem.contains(e.relatedTarget)) {
            tooltip.classList.remove('visible');
          }
        });
      }

    </script>

    <!-- Token Tooltip -->
    <div id="token-tooltip" class="token-tooltip">
      <div class="token-tooltip-name"></div>
      <div class="token-tooltip-info">
        <span class="token-tooltip-path"></span>
        <span class="token-tooltip-value"></span>
      </div>
    </div>

    <!-- Snackbar Notifications Container -->
    <div id="snackbar-container"></div>



</body>

</html>