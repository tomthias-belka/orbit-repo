<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ClaraIcon Set</title>

  <style>
    /* ===== DESIGN SYSTEM ===== */
    :root {
      --color-primary: #016b9d;
      --color-primary-hover: #003954;
      --color-primary-light: #E0F5F8;

      --color-success: #09a070;
      --color-success-bg: #ECFDF5;

      --color-error: #b03535;
      --color-error-bg: #fcf6f6;

      --color-gray-50: #F9FAFB;
      --color-gray-100: #F3F4F6;
      --color-gray-200: #E5E7EB;
      --color-gray-300: #D1D5DB;
      --color-gray-600: #4B5563;
      --color-gray-900: #020B1B;

      --color-bg: var(--color-gray-50);
      --color-bg-secondary: white;
      --color-border: var(--color-gray-200);
      --color-text: var(--color-gray-900);
      --color-text-secondary: var(--color-gray-600);

      --font-family: Inter, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      --space-2: 8px;
      --space-3: 12px;
      --space-4: 16px;
      --space-5: 20px;
      --space-6: 24px;

      --radius-md: 8px;
      --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: var(--font-family);
      background-color: var(--color-bg);
      color: var(--color-text);
      font-size: 14px;
      line-height: 1.5;
      overflow: hidden;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .header {
      background: var(--color-bg-secondary);
      border-bottom: 1px solid var(--color-border);
      padding: var(--space-4);
      display: flex;
      align-items: center;
      gap: var(--space-3);
    }

    .header-icon {
      width: 32px;
      height: 32px;
      background: var(--color-primary);
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
    }

    .header-title {
      font-size: 16px;
      font-weight: 600;
    }

    .content {
      flex: 1;
      overflow-y: auto;
      padding: var(--space-6);
    }

    .section {
      background: var(--color-bg-secondary);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      padding: var(--space-5);
      margin-bottom: var(--space-4);
    }

    .section-title {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: var(--space-4);
      color: var(--color-text);
    }

    .info-box {
      background: var(--color-primary-light);
      border: 1px solid var(--color-primary);
      border-radius: var(--radius-md);
      padding: var(--space-4);
      margin-bottom: var(--space-5);
    }

    .info-box-title {
      font-weight: 600;
      margin-bottom: var(--space-2);
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }

    .selection-info {
      background: var(--color-gray-100);
      padding: var(--space-3);
      border-radius: var(--radius-md);
      margin-bottom: var(--space-4);
    }

    .selection-count {
      font-weight: 600;
      color: var(--color-primary);
    }

    .selection-list {
      font-size: 12px;
      color: var(--color-text-secondary);
      max-height: 120px;
      overflow-y: auto;
      margin-top: var(--space-2);
    }

    .selection-list-item {
      padding: 4px 0;
    }

    .form-group {
      margin-bottom: var(--space-4);
    }

    .form-label {
      display: block;
      font-weight: 500;
      margin-bottom: var(--space-2);
      font-size: 13px;
    }

    .checkbox-group {
      display: flex;
      flex-direction: column;
      gap: var(--space-3);
    }

    .checkbox-label {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      cursor: pointer;
      font-size: 13px;
    }

    .checkbox-label input[type="checkbox"] {
      width: 16px;
      height: 16px;
      cursor: pointer;
    }

    .radio-group {
      display: flex;
      flex-direction: column;
      gap: var(--space-2);
    }

    .radio-label {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      cursor: pointer;
      font-size: 13px;
    }

    .radio-label input[type="radio"] {
      width: 16px;
      height: 16px;
      cursor: pointer;
    }

    .button {
      background: var(--color-primary);
      color: white;
      border: none;
      border-radius: var(--radius-md);
      padding: 12px var(--space-5);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-2);
    }

    .button:hover {
      background: var(--color-primary-hover);
    }

    .button:active {
      transform: scale(0.98);
    }

    .button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .button-secondary {
      background: var(--color-gray-100);
      color: var(--color-text);
      margin-top: var(--space-2);
    }

    .button-secondary:hover {
      background: var(--color-gray-200);
    }

    .output-section {
      background: var(--color-bg-secondary);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      padding: var(--space-5);
    }

    .output-preview {
      background: var(--color-gray-900);
      color: #ABB2BF;
      font-family: 'SF Mono', Monaco, 'Courier New', monospace;
      font-size: 12px;
      line-height: 1.5;
      padding: var(--space-4);
      border-radius: var(--radius-md);
      overflow-x: auto;
      white-space: pre-wrap;
      max-height: 300px;
      overflow-y: auto;
    }

    .empty-state {
      text-align: center;
      padding: var(--space-6);
      color: var(--color-text-secondary);
    }

    .snackbar {
      position: fixed;
      bottom: var(--space-4);
      left: 50%;
      transform: translateX(-50%);
      background: var(--color-gray-900);
      color: white;
      padding: var(--space-3) var(--space-5);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-sm);
      font-size: 13px;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.3s;
    }

    .snackbar.show {
      opacity: 1;
    }

    .snackbar.success {
      background: var(--color-success);
    }

    .snackbar.error {
      background: var(--color-error);
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <div class="header-icon">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 2L2 7L12 12L22 7L12 2Z"/>
        <path d="M2 17L12 22L22 17"/>
        <path d="M2 12L12 17L22 12"/>
      </svg>
    </div>
    <div>
      <div class="header-title">ClaraIconSet</div>
      <div style="font-size: 12px; color: var(--color-text-secondary);">React Native Icon Exporter</div>
    </div>
  </div>

  <!-- Content -->
  <div class="content">
   

    <!-- Selection Info -->
    <div class="section">
      <div class="section-title">Current Selection</div>
      <div class="selection-info">
        <div>
          <span class="selection-count" id="selection-count">0 icons selected</span>
        </div>
        <div class="selection-list" id="selection-list">
          <div style="color: var(--color-text-secondary); font-style: italic;">No icons selected</div>
        </div>
      </div>
    </div>

    <!-- Export Options -->
    <div class="section">
      <div class="section-title">Export Options (SVGR Compatible)</div>

      <!-- Info Box -->
      <div style="background: var(--color-primary-light); padding: var(--space-3); border-radius: var(--radius-md); margin-bottom: var(--space-4); font-size: 12px;">
        <div style="font-weight: 600; margin-bottom: 4px;">✨ SVGR Mode</div>
        <div>Replicates <code>svgr --native --typescript --icon</code></div>
      </div>

      <!-- Format -->
      <div class="form-group">
        <div class="form-label">Output Format</div>
        <div class="radio-group">
          <label class="radio-label">
            <input type="radio" name="format" value="tsx" checked>
            <span>TypeScript (.tsx)</span>
          </label>
          <label class="radio-label">
            <input type="radio" name="format" value="jsx">
            <span>JavaScript (.jsx)</span>
          </label>
        </div>
      </div>

      <!-- Export Button -->
      <button id="btn-export" class="button" disabled>
        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
          <path d="M11 5v10.59l-3.3-3.3-1.4 1.42L12 19.41l5.7-5.7-1.4-1.42-3.3 3.3V5h-2z"/>
        </svg>
        Export Icons
      </button>

      <button id="btn-download-all" class="button button-secondary" style="display: none;">
        Download All as ZIP
      </button>
    </div>

    <!-- Output Preview -->
    <div class="output-section">
      <div class="section-title">Preview</div>
      <div class="output-preview" id="output-preview">
        <div class="empty-state">
          Select icons and click "Export Icons" to see generated code
        </div>
      </div>
    </div>
  </div>

  <!-- Snackbar -->
  <div class="snackbar" id="snackbar"></div>

  <script>
    // Embedded ZIP Library
    class EmbeddedZip {
      constructor() {
        this.files = [];
      }

      file(name, data) {
        this.files.push({ name, data });
        return this;
      }

      async generateAsync(options = {}) {
        return this.createZipBlob();
      }

      createZipBlob() {
        const encoder = new TextEncoder();
        let offset = 0;
        const centralDirectory = [];
        const fileData = [];

        // Process each file
        this.files.forEach(file => {
          const fileName = encoder.encode(file.name);
          const fileContent = encoder.encode(file.data);

          // Local file header
          const localFileHeader = new Uint8Array(30 + fileName.length);
          const view = new DataView(localFileHeader.buffer);

          view.setUint32(0, 0x04034b50, true);
          view.setUint16(4, 20, true);
          view.setUint16(6, 0, true);
          view.setUint16(8, 0, true);
          view.setUint16(10, 0, true);
          view.setUint16(12, 0, true);
          view.setUint32(14, this.crc32(fileContent), true);
          view.setUint32(18, fileContent.length, true);
          view.setUint32(22, fileContent.length, true);
          view.setUint16(26, fileName.length, true);
          view.setUint16(28, 0, true);

          localFileHeader.set(fileName, 30);

          centralDirectory.push({
            fileName,
            fileContent,
            localHeaderOffset: offset,
            crc: this.crc32(fileContent)
          });

          fileData.push(localFileHeader);
          fileData.push(fileContent);

          offset += localFileHeader.length + fileContent.length;
        });

        // Create central directory
        const centralDirStart = offset;
        const centralDirData = [];

        centralDirectory.forEach(entry => {
          const centralDirEntry = new Uint8Array(46 + entry.fileName.length);
          const view = new DataView(centralDirEntry.buffer);

          view.setUint32(0, 0x02014b50, true);
          view.setUint16(4, 20, true);
          view.setUint16(6, 20, true);
          view.setUint16(8, 0, true);
          view.setUint16(10, 0, true);
          view.setUint16(12, 0, true);
          view.setUint16(14, 0, true);
          view.setUint32(16, entry.crc, true);
          view.setUint32(20, entry.fileContent.length, true);
          view.setUint32(24, entry.fileContent.length, true);
          view.setUint16(28, entry.fileName.length, true);
          view.setUint16(30, 0, true);
          view.setUint16(32, 0, true);
          view.setUint16(34, 0, true);
          view.setUint16(36, 0, true);
          view.setUint32(38, 0, true);
          view.setUint32(42, entry.localHeaderOffset, true);

          centralDirEntry.set(entry.fileName, 46);

          centralDirData.push(centralDirEntry);
          offset += centralDirEntry.length;
        });

        // End of central directory record
        const endOfCentralDir = new Uint8Array(22);
        const endView = new DataView(endOfCentralDir.buffer);

        endView.setUint32(0, 0x06054b50, true);
        endView.setUint16(4, 0, true);
        endView.setUint16(6, 0, true);
        endView.setUint16(8, this.files.length, true);
        endView.setUint16(10, this.files.length, true);
        endView.setUint32(12, offset - centralDirStart, true);
        endView.setUint32(16, centralDirStart, true);
        endView.setUint16(20, 0, true);

        // Combine all parts
        const totalSize = fileData.reduce((sum, arr) => sum + arr.length, 0) +
                         centralDirData.reduce((sum, arr) => sum + arr.length, 0) +
                         endOfCentralDir.length;

        const zipData = new Uint8Array(totalSize);
        let pos = 0;

        fileData.forEach(data => {
          zipData.set(data, pos);
          pos += data.length;
        });

        centralDirData.forEach(data => {
          zipData.set(data, pos);
          pos += data.length;
        });

        zipData.set(endOfCentralDir, pos);

        return new Blob([zipData], { type: 'application/zip' });
      }

      crc32(data) {
        const crcTable = this.getCrcTable();
        let crc = 0xFFFFFFFF;

        for (let i = 0; i < data.length; i++) {
          crc = (crc >>> 8) ^ crcTable[(crc ^ data[i]) & 0xFF];
        }

        return (crc ^ 0xFFFFFFFF) >>> 0;
      }

      getCrcTable() {
        if (this._crcTable) return this._crcTable;

        this._crcTable = new Array(256);
        for (let i = 0; i < 256; i++) {
          let c = i;
          for (let j = 0; j < 8; j++) {
            c = (c & 1) ? (0xEDB88320 ^ (c >>> 1)) : (c >>> 1);
          }
          this._crcTable[i] = c;
        }
        return this._crcTable;
      }
    }

    // State
    let currentSelection = [];
    let exportedIcons = [];
    let exportedBlob = null;

    // Show snackbar
    function showSnackbar(message, type = 'info') {
      const snackbar = document.getElementById('snackbar');
      snackbar.textContent = message;
      snackbar.className = 'snackbar show ' + type;
      setTimeout(() => {
        snackbar.className = 'snackbar';
      }, 3000);
    }

    // Update selection display
    function updateSelectionDisplay(selectionInfo) {
      const countEl = document.getElementById('selection-count');
      const listEl = document.getElementById('selection-list');
      const exportBtn = document.getElementById('btn-export');

      if (selectionInfo.count === 0) {
        countEl.textContent = '0 icons selected';
        listEl.innerHTML = '<div style="color: var(--color-text-secondary); font-style: italic;">No icons selected</div>';
        exportBtn.disabled = true;
      } else {
        countEl.textContent = `${selectionInfo.count} icon${selectionInfo.count > 1 ? 's' : ''} selected`;
        listEl.innerHTML = selectionInfo.nodes
          .map(node => `<div class="selection-list-item">• ${node.name}</div>`)
          .join('');
        exportBtn.disabled = false;
      }

      currentSelection = selectionInfo.nodes || [];
    }

    // Get export options (SVGR mode)
    function getExportOptions() {
      const format = document.querySelector('input[name="format"]:checked').value;

      return {
        format, // 'tsx' or 'jsx'
        selectedNodeIds: currentSelection.map(node => node.id)
      };
    }

    // Handle export button click
    document.getElementById('btn-export').addEventListener('click', () => {
      if (currentSelection.length === 0) {
        showSnackbar('Please select at least one icon', 'error');
        return;
      }

      const options = getExportOptions();
      console.log('[UI] Exporting with options:', options);

      parent.postMessage({
        pluginMessage: {
          type: 'export-rn-icons',
          options
        }
      }, '*');

      showSnackbar('Exporting icons...', 'info');
    });

    // Handle export result
    function handleExportResult(result) {
      console.log('[UI] Export result:', result);

      if (!result.success) {
        showSnackbar(result.error || 'Export failed', 'error');
        return;
      }

      exportedIcons = result.icons;
      showSnackbar(`✓ Exported ${exportedIcons.length} icons successfully`, 'success');

      // Show preview of first icon
      const previewEl = document.getElementById('output-preview');
      if (exportedIcons.length > 0) {
        previewEl.textContent = exportedIcons[0].code;
      }

      // Create ZIP and show download button
      createZipAndShowDownload();
    }

    // Create ZIP file with React Native components
    function createZipAndShowDownload() {
      if (exportedIcons.length === 0) return;

      const zip = new EmbeddedZip();
      const options = getExportOptions();

      // Add each icon as a separate file
      exportedIcons.forEach(icon => {
        const fileName = `${icon.componentName}.${options.format}`;
        zip.file(fileName, icon.code);
      });

      // Add index file
      const indexContent = exportedIcons
        .map(icon => `export { default as ${icon.componentName} } from './${icon.componentName}';`)
        .join('\n');
      zip.file('index.ts', indexContent);

      // Add README
      const readme = `# Exported Icons

Generated by ClaraIconSet
Date: ${new Date().toISOString()}
Total icons: ${exportedIcons.length}

## Usage

\`\`\`typescript
import { ${exportedIcons[0]?.componentName || 'IconName'} } from './icons';

<${exportedIcons[0]?.componentName || 'IconName'} color="#000" width={24} height={24} />
\`\`\`

## Icons List

${exportedIcons.map(icon => `- ${icon.componentName} (${icon.name})`).join('\n')}
`;
      zip.file('README.md', readme);

      // Generate ZIP and show download button
      zip.generateAsync({ type: 'blob' }).then(blob => {
        exportedBlob = blob;
        const downloadBtn = document.getElementById('btn-download-all');
        downloadBtn.style.display = 'block';
      });
    }

    // Download handler
    document.getElementById('btn-download-all').addEventListener('click', () => {
      if (!exportedBlob) return;

      const fileName = `react-native-icons-${Date.now()}.zip`;

      const link = document.createElement('a');
      link.href = URL.createObjectURL(exportedBlob);
      link.download = fileName;
      link.click();

      showSnackbar('✓ Download started', 'success');
    });

    // Message handler
    window.onmessage = async (event) => {
      const msg = event.data.pluginMessage;
      if (!msg) return;

      console.log('[UI] Received message:', msg.type);

      switch (msg.type) {
        case 'rn-selection-info':
          updateSelectionDisplay(msg);
          break;

        case 'rn-icons-result':
          handleExportResult(msg);
          break;

        default:
          console.log('[UI] Unknown message type:', msg.type);
      }
    };

    // Initialize
    console.log('=== ClaraIconSet UI Initialized ===');
    parent.postMessage({ pluginMessage: { type: 'ui-ready' } }, '*');
    parent.postMessage({ pluginMessage: { type: 'get-rn-selection' } }, '*');
  </script>
</body>
</html>
